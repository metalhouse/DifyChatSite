<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å›¾ç‰‡ä¸Šä¼ æµ‹è¯•</title>
    <link href="https://cdn.bootcdn.net/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
<div class="container mt-5">
    <h1>å›¾ç‰‡ä¸Šä¼ å’Œæ˜¾ç¤ºæµ‹è¯•</h1>
    
    <div class="card">
        <div class="card-body">
            <h5 class="card-title">ç¯å¢ƒé…ç½®æ£€æŸ¥</h5>
            <div id="envCheck" class="mb-3"></div>
            
            <h5 class="card-title">ä¸Šä¼ æµ‹è¯•</h5>
            <input type="file" id="testFileInput" accept="image/*" class="form-control mb-3">
            <button id="uploadBtn" class="btn btn-primary">ä¸Šä¼ å›¾ç‰‡</button>
            
            <div id="result" class="mt-3"></div>
            
            <h5 class="card-title mt-4">å›¾ç‰‡æ˜¾ç¤ºæµ‹è¯•</h5>
            <div id="imageDisplay"></div>
        </div>
    </div>
</div>

<script type="module">
import { ENV_CONFIG } from './config/env.js';

// æ£€æŸ¥ç¯å¢ƒé…ç½®
document.getElementById('envCheck').innerHTML = `
    <p><strong>API Base URL:</strong> ${ENV_CONFIG.getApiUrl()}</p>
    <p><strong>Environment:</strong> ${ENV_CONFIG.ENVIRONMENT}</p>
    <p><strong>Debug Mode:</strong> ${ENV_CONFIG.isDebug()}</p>
`;

// å¯¼å…¥FileAPI
import './js/api/file-api.js';

document.getElementById('uploadBtn').addEventListener('click', async () => {
    const fileInput = document.getElementById('testFileInput');
    const resultDiv = document.getElementById('result');
    const imageDiv = document.getElementById('imageDisplay');
    
    if (!fileInput.files.length) {
        resultDiv.innerHTML = '<div class="alert alert-warning">è¯·å…ˆé€‰æ‹©æ–‡ä»¶</div>';
        return;
    }
    
    const file = fileInput.files[0];
    resultDiv.innerHTML = '<div class="alert alert-info">æ­£åœ¨ä¸Šä¼ ...</div>';
    
    try {
        const fileApi = new FileAPI();
        console.log('FileAPI baseURL:', fileApi.baseURL);
        
        const result = await fileApi.uploadFile(file, 'room');
        console.log('ä¸Šä¼ ç»“æœ:', result);
        
        resultDiv.innerHTML = `
            <div class="alert alert-success">
                <h6>ä¸Šä¼ æˆåŠŸ!</h6>
                <p><strong>æ–‡ä»¶ID:</strong> ${result.id}</p>
                <p><strong>æ–‡ä»¶å:</strong> ${result.filename}</p>
                <p><strong>åŸå§‹å:</strong> ${result.original_name}</p>
                <p><strong>å¤§å°:</strong> ${result.file_size} bytes</p>
            </div>
        `;
        
        // æµ‹è¯•å›¾ç‰‡æ˜¾ç¤º
        const imageUrl = ENV_CONFIG.getApiUrl() + '/files/' + result.id + '/view';
        const thumbnailUrl = ENV_CONFIG.getApiUrl() + '/files/' + result.id + '/thumbnail?size=150';
        
        imageDiv.innerHTML = `
            <div class="row">
                <div class="col-md-6">
                    <h6>ç¼©ç•¥å›¾ (150px)</h6>
                    <p><small>${thumbnailUrl}</small></p>
                    <img src="${thumbnailUrl}" class="img-fluid border" style="max-width: 150px;" 
                         onload="console.log('âœ… ç¼©ç•¥å›¾åŠ è½½æˆåŠŸ')"
                         onerror="console.log('âŒ ç¼©ç•¥å›¾åŠ è½½å¤±è´¥'); this.src='${imageUrl}'; console.log('ğŸ”„ åˆ‡æ¢åˆ°åŸå›¾');">
                </div>
                <div class="col-md-6">
                    <h6>åŸå›¾</h6>
                    <p><small>${imageUrl}</small></p>
                    <img src="${imageUrl}" class="img-fluid border" style="max-width: 300px;"
                         onload="console.log('âœ… åŸå›¾åŠ è½½æˆåŠŸ')"
                         onerror="console.log('âŒ åŸå›¾åŠ è½½å¤±è´¥');">
                </div>
            </div>
        `;
        
    } catch (error) {
        console.error('ä¸Šä¼ å¤±è´¥:', error);
        resultDiv.innerHTML = `<div class="alert alert-danger">ä¸Šä¼ å¤±è´¥: ${error.message}</div>`;
    }
});
</script>
</body>
</html>
