<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>图片上传测试</title>
    <link href="https://cdn.bootcdn.net/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
<div class="container mt-5">
    <h1>图片上传和显示测试</h1>
    
    <div class="card">
        <div class="card-body">
            <h5 class="card-title">环境配置检查</h5>
            <div id="envCheck" class="mb-3"></div>
            
            <h5 class="card-title">上传测试</h5>
            <input type="file" id="testFileInput" accept="image/*" class="form-control mb-3">
            <button id="uploadBtn" class="btn btn-primary">上传图片</button>
            
            <div id="result" class="mt-3"></div>
            
            <h5 class="card-title mt-4">图片显示测试</h5>
            <div id="imageDisplay"></div>
        </div>
    </div>
</div>

<script type="module">
import { ENV_CONFIG } from './config/env.js';

// 检查环境配置
document.getElementById('envCheck').innerHTML = `
    <p><strong>API Base URL:</strong> ${ENV_CONFIG.getApiUrl()}</p>
    <p><strong>Environment:</strong> ${ENV_CONFIG.ENVIRONMENT}</p>
    <p><strong>Debug Mode:</strong> ${ENV_CONFIG.isDebug()}</p>
`;

// 导入FileAPI
import './js/api/file-api.js';

document.getElementById('uploadBtn').addEventListener('click', async () => {
    const fileInput = document.getElementById('testFileInput');
    const resultDiv = document.getElementById('result');
    const imageDiv = document.getElementById('imageDisplay');
    
    if (!fileInput.files.length) {
        resultDiv.innerHTML = '<div class="alert alert-warning">请先选择文件</div>';
        return;
    }
    
    const file = fileInput.files[0];
    resultDiv.innerHTML = '<div class="alert alert-info">正在上传...</div>';
    
    try {
        const fileApi = new FileAPI();
        console.log('FileAPI baseURL:', fileApi.baseURL);
        
        const result = await fileApi.uploadFile(file, 'room');
        console.log('上传结果:', result);
        
        resultDiv.innerHTML = `
            <div class="alert alert-success">
                <h6>上传成功!</h6>
                <p><strong>文件ID:</strong> ${result.id}</p>
                <p><strong>文件名:</strong> ${result.filename}</p>
                <p><strong>原始名:</strong> ${result.original_name}</p>
                <p><strong>大小:</strong> ${result.file_size} bytes</p>
            </div>
        `;
        
        // 测试图片显示
        const imageUrl = ENV_CONFIG.getApiUrl() + '/files/' + result.id + '/view';
        const thumbnailUrl = ENV_CONFIG.getApiUrl() + '/files/' + result.id + '/thumbnail?size=150';
        
        imageDiv.innerHTML = `
            <div class="row">
                <div class="col-md-6">
                    <h6>缩略图 (150px)</h6>
                    <p><small>${thumbnailUrl}</small></p>
                    <img src="${thumbnailUrl}" class="img-fluid border" style="max-width: 150px;" 
                         onload="console.log('✅ 缩略图加载成功')"
                         onerror="console.log('❌ 缩略图加载失败'); this.src='${imageUrl}'; console.log('🔄 切换到原图');">
                </div>
                <div class="col-md-6">
                    <h6>原图</h6>
                    <p><small>${imageUrl}</small></p>
                    <img src="${imageUrl}" class="img-fluid border" style="max-width: 300px;"
                         onload="console.log('✅ 原图加载成功')"
                         onerror="console.log('❌ 原图加载失败');">
                </div>
            </div>
        `;
        
    } catch (error) {
        console.error('上传失败:', error);
        resultDiv.innerHTML = `<div class="alert alert-danger">上传失败: ${error.message}</div>`;
    }
});
</script>
</body>
</html>
