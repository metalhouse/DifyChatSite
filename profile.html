<!DOCTYPE html>
<html lang="zh-CN" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸ªäººèµ„æ–™ - DifyChat</title>
    
    <!-- Favicon - å®Œæ•´å…¼å®¹æ€§é…ç½® -->
    <!-- SVGå›¾æ ‡ - ç°ä»£æµè§ˆå™¨ -->
    <link rel="icon" type="image/svg+xml" href="./assets/images/favicon.svg">
    <link rel="icon" type="image/svg+xml" href="./assets/images/favicon-16.svg" sizes="16x16">
    
    <!-- ä¼ ç»ŸICOæ ¼å¼ - æ—§æµè§ˆå™¨å…¼å®¹ -->
    <link rel="icon" type="image/x-icon" href="./favicon.ico">
    <link rel="shortcut icon" href="./favicon.ico">
    
    <!-- ç§»åŠ¨ç«¯å›¾æ ‡ -->
    <link rel="apple-touch-icon" href="./assets/images/favicon.svg">
    <link rel="apple-touch-icon" sizes="180x180" href="./assets/images/favicon.svg">
    
    <!-- æµè§ˆå™¨ä¸»é¢˜è‰² -->
    <meta name="theme-color" content="#007bff">
    <meta name="msapplication-TileColor" content="#007bff">
    
    <!-- Bootstrap 5.3 CSS -->
    <link href="./vendor/bootstrap/bootstrap.min.css" rel="stylesheet">
    
    <!-- Font Awesome 6.4 -->
    <link rel="stylesheet" href="./vendor/font-awesome/all.min.css">
    
    <style>
        :root {
            --primary-color: #007bff;
            --primary-dark: #0056b3;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
            --info-color: #17a2b8;
            --light-bg: #f8f9fa;
            --border-radius: 12px;
            --box-shadow: 0 2px 12px rgba(0,0,0,0.1);
        }

        body {
            background-color: var(--light-bg);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        }
        
        .profile-header {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            color: white;
            padding: 2rem 0;
            margin-bottom: 2rem;
        }
        
        .profile-avatar {
            width: 120px;
            height: 120px;
            background: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            color: var(--primary-color);
            margin: 0 auto 1rem;
            box-shadow: var(--box-shadow);
        }
        
        .profile-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
        }
        
        .profile-card {
            background: white;
            border: none;
            box-shadow: var(--box-shadow);
            border-radius: var(--border-radius);
            margin-bottom: 1.5rem;
        }
        
        .form-label {
            font-weight: 600;
            color: #495057;
            margin-bottom: 0.5rem;
        }
        
        .form-control {
            border-radius: 8px;
            border: 1px solid #dee2e6;
            padding: 0.75rem 1rem;
        }
        
        .form-control:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            border: none;
            border-radius: 8px;
            padding: 0.75rem 2rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover {
            background: linear-gradient(135deg, var(--primary-dark), #004085);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 123, 255, 0.3);
        }
        
        .stats-card {
            border-left: 4px solid var(--primary-color);
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 0 var(--border-radius) var(--border-radius) 0;
        }
        
        .stats-number {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-color);
        }
        
        .loading-spinner {
            display: none;
            text-align: center;
            padding: 2rem;
        }
        
        .error-message {
            color: var(--danger-color);
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        
        .success-message {
            color: var(--success-color);
            background: #d4edda;
            border: 1px solid #c3e6cb;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        
        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .profile-header {
                padding: 1rem 0;
            }
            
            .profile-avatar {
                width: 80px;
                height: 80px;
                font-size: 2rem;
            }
            
            .container {
                padding: 0 1rem;
            }
        }
    </style>
</head>
<body>
    <!-- å¯¼èˆªæ  -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container-fluid">
            <a class="navbar-brand" href="./index.html">
                <i class="fas fa-robot me-2"></i>
                DifyChat
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="./index.html">é¦–é¡µ</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="./chat.html">èŠå¤©</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="./chatroom.html">èŠå¤©å®¤</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="./profile.html">ä¸ªäººèµ„æ–™</a>
                    </li>
                </ul>
                <ul class="navbar-nav">
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                            <i class="fas fa-user me-1"></i>
                            <span id="currentUsername">ç”¨æˆ·</span>
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="./profile.html">ä¸ªäººèµ„æ–™</a></li>
                            <li><a class="dropdown-item" href="./settings.html">è®¾ç½®</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="#" id="navLogout">é€€å‡ºç™»å½•</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- ä¸ªäººèµ„æ–™å¤´éƒ¨ -->
    <div class="profile-header">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-lg-3 text-center">
                    <div class="profile-avatar" id="profileAvatar">
                        <i class="fas fa-user"></i>
                    </div>
                </div>
                <div class="col-lg-9">
                    <h1 class="mb-2" id="profileDisplayName">åŠ è½½ä¸­...</h1>
                    <p class="mb-1">
                        <i class="fas fa-at me-2"></i>
                        <span id="profileUsername">åŠ è½½ä¸­...</span>
                    </p>
                    <p class="mb-1">
                        <i class="fas fa-calendar me-2"></i>
                        åŠ å…¥æ—¶é—´ï¼š<span id="profileJoinDate">åŠ è½½ä¸­...</span>
                    </p>
                    <p class="mb-0">
                        <i class="fas fa-shield-alt me-2"></i>
                        è§’è‰²ï¼š<span id="profileRole">åŠ è½½ä¸­...</span>
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- ä¸»è¦å†…å®¹ -->
    <div class="container">
        <!-- åŠ è½½çŠ¶æ€ -->
        <div class="loading-spinner" id="loadingSpinner">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">åŠ è½½ä¸­...</span>
            </div>
            <div class="mt-2">æ­£åœ¨åŠ è½½ä¸ªäººèµ„æ–™...</div>
        </div>

        <!-- é”™è¯¯ä¿¡æ¯ -->
        <div class="error-message" id="errorMessage" style="display: none;">
            <i class="fas fa-exclamation-triangle me-2"></i>
            <span id="errorText">å‘ç”ŸæœªçŸ¥é”™è¯¯</span>
        </div>

        <!-- æˆåŠŸä¿¡æ¯ -->
        <div class="success-message" id="successMessage" style="display: none;">
            <i class="fas fa-check-circle me-2"></i>
            <span id="successText">æ“ä½œæˆåŠŸ</span>
        </div>

        <div class="row" id="mainContent">
            <!-- ç»Ÿè®¡ä¿¡æ¯ -->
            <div class="col-lg-4 mb-4">
                <div class="profile-card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-chart-bar me-2"></i>
                            ä½¿ç”¨ç»Ÿè®¡
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="stats-card mb-3">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <div class="stats-number" id="chatCount">0</div>
                                    <small class="text-muted">å¯¹è¯æ•°é‡</small>
                                </div>
                                <i class="fas fa-comments fa-2x text-primary"></i>
                            </div>
                        </div>
                        <div class="stats-card mb-3">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <div class="stats-number" id="messageCount">0</div>
                                    <small class="text-muted">æ¶ˆæ¯æ•°é‡</small>
                                </div>
                                <i class="fas fa-paper-plane fa-2x text-primary"></i>
                            </div>
                        </div>
                        <div class="stats-card">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <div class="stats-number" id="onlineTime">0h</div>
                                    <small class="text-muted">åœ¨çº¿æ—¶é•¿</small>
                                </div>
                                <i class="fas fa-clock fa-2x text-primary"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- è´¦æˆ·ä¿¡æ¯ -->
                <div class="profile-card">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-info-circle me-2"></i>
                            è´¦æˆ·ä¿¡æ¯
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <i class="fas fa-clock text-info me-2"></i>
                            <span>ä¸Šæ¬¡ç™»å½•: <span id="lastLogin">åŠ è½½ä¸­...</span></span>
                        </div>
                        <div class="mb-3">
                            <i class="fas fa-desktop text-info me-2"></i>
                            <span>å½“å‰è®¾å¤‡: Webæµè§ˆå™¨</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ä¸ªäººä¿¡æ¯è¡¨å• -->
            <div class="col-lg-8">
                <div class="profile-card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-user-edit me-2"></i>
                            ä¸ªäººä¿¡æ¯
                        </h5>
                    </div>
                    <div class="card-body">
                        <form id="profileForm">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="displayName" class="form-label">æ˜¾ç¤ºåç§°</label>
                                    <input type="text" class="form-control" id="displayName" placeholder="è¾“å…¥æ˜¾ç¤ºåç§°">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="email" class="form-label">é‚®ç®±åœ°å€</label>
                                    <input type="email" class="form-control" id="email" placeholder="è¾“å…¥é‚®ç®±åœ°å€">
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="phone" class="form-label">æ‰‹æœºå·ç </label>
                                    <input type="tel" class="form-control" id="phone" placeholder="è¾“å…¥æ‰‹æœºå·ç ">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="company" class="form-label">å…¬å¸/ç»„ç»‡</label>
                                    <input type="text" class="form-control" id="company" placeholder="è¾“å…¥å…¬å¸æˆ–ç»„ç»‡åç§°">
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="bio" class="form-label">ä¸ªäººç®€ä»‹</label>
                                <textarea class="form-control" id="bio" rows="3" placeholder="ä»‹ç»ä¸€ä¸‹è‡ªå·±..."></textarea>
                            </div>
                            <div class="d-flex gap-2">
                                <button type="submit" class="btn btn-primary" id="updateProfileBtn">
                                    <i class="fas fa-save me-2"></i>
                                    ä¿å­˜æ›´æ”¹
                                </button>
                                <button type="button" class="btn btn-outline-secondary" id="resetFormBtn">
                                    <i class="fas fa-undo me-2"></i>
                                    é‡ç½®
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- å¯†ç ä¿®æ”¹ -->
                <div class="profile-card">
                    <div class="card-header bg-warning text-dark">
                        <h5 class="mb-0">
                            <i class="fas fa-lock me-2"></i>
                            ä¿®æ”¹å¯†ç 
                        </h5>
                    </div>
                    <div class="card-body">
                        <form id="passwordForm">
                            <div class="mb-3">
                                <label for="currentPassword" class="form-label">å½“å‰å¯†ç </label>
                                <input type="password" class="form-control" id="currentPassword" placeholder="è¾“å…¥å½“å‰å¯†ç ">
                            </div>
                            <div class="mb-3">
                                <label for="newPassword" class="form-label">æ–°å¯†ç </label>
                                <input type="password" class="form-control" id="newPassword" placeholder="è¾“å…¥æ–°å¯†ç ">
                                <div class="form-text">
                                    å¯†ç å¿…é¡»è‡³å°‘8ä½ï¼ŒåŒ…å«å¤§å°å†™å­—æ¯ã€æ•°å­—å’Œç‰¹æ®Šå­—ç¬¦
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="confirmPassword" class="form-label">ç¡®è®¤æ–°å¯†ç </label>
                                <input type="password" class="form-control" id="confirmPassword" placeholder="ç¡®è®¤æ–°å¯†ç ">
                            </div>
                            <button type="submit" class="btn btn-warning" id="changePasswordBtn">
                                <i class="fas fa-key me-2"></i>
                                ä¿®æ”¹å¯†ç 
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast æç¤ºå®¹å™¨ -->
    <div class="toast-container position-fixed top-0 end-0 p-3"></div>

    <!-- Bootstrap 5.3 JS -->
    <script src="./vendor/bootstrap/bootstrap.bundle.min.js"></script>
    
    <!-- å†…è”ç‰ˆæœ¬ - é¿å…å¤–éƒ¨ä¾èµ–é—®é¢˜ -->
    <script>
        console.log('ğŸš€ å¼€å§‹åŠ è½½é¡µé¢è„šæœ¬...');
        
        // ç®€å•çš„LogoutManager
        const LogoutManager = {
            logout: function(options = {}) {
                console.log('ğŸ”„ æ‰§è¡Œç™»å‡º...');
                localStorage.removeItem('access_token');
                localStorage.removeItem('refresh_token');
                window.location.href = options.redirectUrl || './login.html';
            }
        };
        
        // ç®€å•çš„ç¯å¢ƒé…ç½®
        const ENV_CONFIG = {
            API_BASE_URL: 'http://localhost:4005',
            API_PREFIX: '/api',
            getApiUrl: function() {
                return this.API_BASE_URL + this.API_PREFIX;
            }
        };

        console.log('âš™ï¸ é…ç½®å·²åŠ è½½:', ENV_CONFIG);

        // ç®€åŒ–çš„APIå®¢æˆ·ç«¯
        class SimpleApiClient {
            constructor() {
                this.baseURL = ENV_CONFIG.getApiUrl();
                console.log('ğŸŒ APIå®¢æˆ·ç«¯åˆå§‹åŒ–:', this.baseURL);
            }

            async request(endpoint, options = {}) {
                try {
                    const url = this.baseURL + endpoint;
                    const config = {
                        method: options.method || 'GET',
                        headers: {
                            'Content-Type': 'application/json',
                            ...this.getAuthHeaders()
                        }
                    };

                    if (options.data) {
                        config.body = JSON.stringify(options.data);
                    }

                    console.log('ğŸŒ APIè¯·æ±‚:', url, config);

                    const response = await fetch(url, config);
                    const data = await response.json();

                    console.log('ğŸ“¡ APIå“åº”:', data);

                    if (!response.ok) {
                        throw new Error(data.message || `HTTP ${response.status}`);
                    }

                    return data;
                } catch (error) {
                    console.error('âŒ APIè¯·æ±‚å¤±è´¥:', error);
                    throw error;
                }
            }

            getAuthHeaders() {
                const token = localStorage.getItem('access_token');
                return token ? { 'Authorization': `Bearer ${token}` } : {};
            }
        }

        // è®¾ç½®å…¨å±€å˜é‡
        window.ENV_CONFIG = ENV_CONFIG;
        const apiClient = new SimpleApiClient();
        
        console.log('âœ… APIå®¢æˆ·ç«¯åˆ›å»ºå®Œæˆ');

        /**
         * ä¸ªäººèµ„æ–™ç®¡ç†å™¨ - è°ƒè¯•ç‰ˆæœ¬
         */
        class ProfileManager {
            constructor() {
                console.log('ğŸ—ï¸ ProfileManager æ„é€ å‡½æ•°å¼€å§‹');
                
                this.apiClient = apiClient;
                this.currentUser = null;
                this.originalFormData = {};
                
                // DOMå…ƒç´ 
                this.elements = {
                    loadingSpinner: document.getElementById('loadingSpinner'),
                    errorMessage: document.getElementById('errorMessage'),
                    successMessage: document.getElementById('successMessage'),
                    mainContent: document.getElementById('mainContent'),
                    profileForm: document.getElementById('profileForm'),
                    passwordForm: document.getElementById('passwordForm'),
                };
                
                console.log('ğŸ“‹ DOMå…ƒç´ è·å–:', this.elements);
                
                this.init();
            }

            async init() {
                try {
                    console.log('ğŸš€ åˆå§‹åŒ–ä¸ªäººèµ„æ–™ç³»ç»Ÿ...');
                    
                    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                    console.log('â³ æ˜¾ç¤ºåŠ è½½çŠ¶æ€');
                    this.showLoading(true);
                    
                    // ç«‹å³æ˜¾ç¤ºä¸€äº›å†…å®¹ä»¥ç¡®ä¿é¡µé¢ä¸ç©ºç™½
                    setTimeout(() => {
                        console.log('â° å»¶è¿ŸåŠ è½½ç”¨æˆ·èµ„æ–™');
                        this.loadUserProfile();
                    }, 500);
                    
                    // ç»‘å®šäº‹ä»¶
                    this.bindEvents();
                    
                    console.log('âœ… ä¸ªäººèµ„æ–™ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ');
                    
                } catch (error) {
                    console.error('âŒ ä¸ªäººèµ„æ–™ç³»ç»Ÿåˆå§‹åŒ–å¤±è´¥:', error);
                    this.showError('é¡µé¢åˆå§‹åŒ–å¤±è´¥ï¼š' + error.message);
                    this.showLoading(false);
                }
            }

            async loadUserProfile() {
                try {
                    console.log('ğŸ“‹ å¼€å§‹åŠ è½½ç”¨æˆ·èµ„æ–™...');
                    
                    // æ£€æŸ¥Token
                    const token = localStorage.getItem('access_token');
                    if (!token) {
                        console.log('âš ï¸ æœªæ‰¾åˆ°Tokenï¼Œæ˜¾ç¤ºæ¼”ç¤ºæ•°æ®');
                        this.showDemoData();
                        return;
                    }
                    
                    console.log('ğŸ”‘ æ‰¾åˆ°Tokenï¼Œå°è¯•åŠ è½½çœŸå®æ•°æ®');
                    
                    // è·å–ç”¨æˆ·åŸºæœ¬ä¿¡æ¯
                    const userResponse = await this.apiClient.request('/users/profile', {
                        method: 'GET'
                    });
                    
                    if (!userResponse || !userResponse.data) {
                        console.log('âš ï¸ APIå“åº”æ— æ•ˆï¼Œæ˜¾ç¤ºæ¼”ç¤ºæ•°æ®');
                        this.showDemoData();
                        return;
                    }
                    
                    const userInfo = userResponse.data;
                    this.currentUser = userInfo;
                    
                    console.log('ğŸ‘¤ ç”¨æˆ·ä¿¡æ¯åŠ è½½æˆåŠŸ:', userInfo);
                    
                    // æ›´æ–°é¡µé¢æ˜¾ç¤º
                    this.updateProfileHeader(userInfo);
                    this.fillProfileForm(userInfo);
                    this.updateNavigation(userInfo);
                    
                    // åŠ è½½ç»Ÿè®¡ä¿¡æ¯
                    await this.loadUserStats();
                    
                    console.log('âœ… ç”¨æˆ·èµ„æ–™åŠ è½½å®Œæˆ');

                } catch (error) {
                    console.error('âŒ åŠ è½½ç”¨æˆ·èµ„æ–™å¤±è´¥:', error);
                    console.log('ğŸ­ æ˜¾ç¤ºæ¼”ç¤ºæ•°æ®ä½œä¸ºå¤‡é€‰');
                    this.showDemoData();
                } finally {
                    // ç¡®ä¿æ€»æ˜¯æ˜¾ç¤ºå†…å®¹
                    this.showLoading(false);
                    this.elements.mainContent.style.display = 'block';
                }
            }

            // æ˜¾ç¤ºæ¼”ç¤ºæ•°æ®
            showDemoData() {
                console.log('ğŸ­ è®¾ç½®æ¼”ç¤ºæ•°æ®');
                
                const demoUser = {
                    username: 'demo_user',
                    display_name: 'æ¼”ç¤ºç”¨æˆ·',
                    email: 'demo@example.com',
                    phone: '13800138000',
                    created_at: new Date().toISOString(),
                    role: 'user'
                };

                this.currentUser = demoUser;
                this.updateProfileHeader(demoUser);
                this.fillProfileForm(demoUser);
                this.updateNavigation(demoUser);
                
                // è®¾ç½®æ¼”ç¤ºç»Ÿè®¡æ•°æ®
                document.getElementById('chatCount').textContent = '5';
                document.getElementById('messageCount').textContent = '23';
                document.getElementById('onlineTime').textContent = '2h';
                document.getElementById('lastLogin').textContent = 'åˆšåˆš';

                // å¼ºåˆ¶æ˜¾ç¤ºä¸»è¦å†…å®¹
                console.log('ğŸ­ å¼ºåˆ¶æ˜¾ç¤ºä¸»è¦å†…å®¹');
                this.elements.mainContent.style.display = 'block';
                this.elements.loadingSpinner.style.display = 'none';

                this.showError('å½“å‰ä¸ºæ¼”ç¤ºæ¨¡å¼ï¼Œè¯·å…ˆç™»å½•ä»¥æŸ¥çœ‹çœŸå®æ•°æ®');
                
                console.log('ğŸ­ æ¼”ç¤ºæ•°æ®è®¾ç½®å®Œæˆï¼Œä¸»å†…å®¹çŠ¶æ€:', this.elements.mainContent.style.display);
            }

            updateProfileHeader(userInfo) {
                const displayName = userInfo.display_name || userInfo.username || 'ç”¨æˆ·';
                const username = userInfo.username || userInfo.user_id || '';
                const joinDate = userInfo.created_at ? 
                    new Date(userInfo.created_at).toLocaleDateString('zh-CN') : 'æœªçŸ¥';
                const role = this.getRoleDisplayName(userInfo.role || userInfo.permissions);

                // æ›´æ–°å¤´éƒ¨ä¿¡æ¯
                document.getElementById('profileDisplayName').textContent = displayName;
                document.getElementById('profileUsername').textContent = username;
                document.getElementById('profileJoinDate').textContent = joinDate;
                document.getElementById('profileRole').textContent = role;

                // æ›´æ–°å¤´åƒ
                const avatar = document.getElementById('profileAvatar');
                if (userInfo.avatar_url) {
                    avatar.innerHTML = `<img src="${userInfo.avatar_url}" alt="å¤´åƒ" loading="lazy">`;
                } else {
                    avatar.innerHTML = `<i class="fas fa-user"></i>`;
                    avatar.style.fontSize = '3rem';
                }
            }

            fillProfileForm(userInfo) {
                const formData = {
                    displayName: userInfo.display_name || userInfo.username || '',
                    email: userInfo.email || '',
                    phone: userInfo.phone || '',
                    company: userInfo.company || '',
                    bio: userInfo.bio || ''
                };

                // å¡«å……è¡¨å•
                Object.keys(formData).forEach(key => {
                    const element = document.getElementById(key);
                    if (element) {
                        element.value = formData[key];
                    }
                });

                // ä¿å­˜åŸå§‹æ•°æ®ç”¨äºé‡ç½®
                this.originalFormData = { ...formData };
            }

            updateNavigation(userInfo) {
                const username = userInfo.display_name || userInfo.username || 'ç”¨æˆ·';
                const navUsername = document.getElementById('currentUsername');
                if (navUsername) {
                    navUsername.textContent = username;
                }
            }

            async loadUserStats() {
                try {
                    console.log('ğŸ“Š å¼€å§‹åŠ è½½ç”¨æˆ·ç»Ÿè®¡...');
                    
                    // è·å–å¯¹è¯ç»Ÿè®¡
                    const statsResponse = await this.apiClient.request('/conversations/user/stats', {
                        method: 'GET'
                    });
                    
                    if (statsResponse && statsResponse.data) {
                        const stats = statsResponse.data;
                        
                        // æ›´æ–°ç»Ÿè®¡æ˜¾ç¤º
                        document.getElementById('chatCount').textContent = stats.total_conversations || 0;
                        document.getElementById('messageCount').textContent = stats.total_messages || 0;
                        
                        // è®¡ç®—åœ¨çº¿æ—¶é•¿ï¼ˆæ¨¡æ‹Ÿï¼‰
                        const onlineHours = Math.max(1, Math.floor((stats.total_messages || 0) / 10));
                        document.getElementById('onlineTime').textContent = onlineHours + 'h';
                        
                        console.log('ğŸ“Š ç»Ÿè®¡æ•°æ®åŠ è½½æˆåŠŸ:', stats);
                    } else {
                        // ä½¿ç”¨é»˜è®¤å€¼
                        console.log('ğŸ“Š ä½¿ç”¨é»˜è®¤ç»Ÿè®¡æ•°æ®');
                        this.setDefaultStats();
                    }

                    // æ›´æ–°æœ€åç™»å½•æ—¶é—´
                    this.updateLastLogin();

                } catch (error) {
                    console.error('âŒ åŠ è½½ç»Ÿè®¡ä¿¡æ¯å¤±è´¥:', error);
                    this.setDefaultStats();
                }
            }

            setDefaultStats() {
                document.getElementById('chatCount').textContent = '0';
                document.getElementById('messageCount').textContent = '0';
                document.getElementById('onlineTime').textContent = '0h';
            }

            updateLastLogin() {
                if (this.currentUser && this.currentUser.last_login) {
                    const lastLogin = new Date(this.currentUser.last_login).toLocaleString('zh-CN');
                    document.getElementById('lastLogin').textContent = lastLogin;
                } else {
                    document.getElementById('lastLogin').textContent = 'é¦–æ¬¡ç™»å½•';
                }
            }

            getRoleDisplayName(role) {
                if (Array.isArray(role)) {
                    if (role.includes('admin')) return 'ç®¡ç†å‘˜';
                    if (role.includes('chatroom_admin')) return 'èŠå¤©å®¤ç®¡ç†å‘˜';
                    if (role.includes('chatroom_access')) return 'èŠå¤©å®¤ç”¨æˆ·';
                    return 'æ™®é€šç”¨æˆ·';
                }
                
                switch (role) {
                    case 'admin':
                    case 'administrator':
                        return 'ç®¡ç†å‘˜';
                    case 'superadmin':
                        return 'è¶…çº§ç®¡ç†å‘˜';
                    case 'chatroom_admin':
                        return 'èŠå¤©å®¤ç®¡ç†å‘˜';
                    default:
                        return 'æ™®é€šç”¨æˆ·';
                }
            }

            bindEvents() {
                // ä¸ªäººä¿¡æ¯è¡¨å•æäº¤
                this.elements.profileForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.updateProfile();
                });

                // é‡ç½®è¡¨å•
                document.getElementById('resetFormBtn').addEventListener('click', () => {
                    this.resetProfileForm();
                });

                // å¯†ç ä¿®æ”¹è¡¨å•æäº¤
                this.elements.passwordForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.changePassword();
                });

                // å¯¼èˆªç™»å‡º
                document.getElementById('navLogout').addEventListener('click', (e) => {
                    e.preventDefault();
                    this.logout();
                });
            }

            async updateProfile() {
                try {
                    const btn = document.getElementById('updateProfileBtn');
                    const originalText = btn.innerHTML;
                    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>ä¿å­˜ä¸­...';
                    btn.disabled = true;

                    const formData = {
                        display_name: document.getElementById('displayName').value.trim(),
                        email: document.getElementById('email').value.trim(),
                        phone: document.getElementById('phone').value.trim(),
                        company: document.getElementById('company').value.trim(),
                        bio: document.getElementById('bio').value.trim()
                    };

                    // åŸºæœ¬éªŒè¯
                    if (!formData.display_name) {
                        throw new Error('æ˜¾ç¤ºåç§°ä¸èƒ½ä¸ºç©º');
                    }

                    if (formData.email && !this.isValidEmail(formData.email)) {
                        throw new Error('é‚®ç®±æ ¼å¼ä¸æ­£ç¡®');
                    }

                    if (formData.phone && !this.isValidPhone(formData.phone)) {
                        throw new Error('æ‰‹æœºå·æ ¼å¼ä¸æ­£ç¡®');
                    }

                    console.log('ğŸ“¤ æ›´æ–°ä¸ªäººèµ„æ–™:', formData);

                    // è°ƒç”¨æ›´æ–°API
                    const response = await this.apiClient.request('/users/profile', {
                        method: 'PUT',
                        data: formData
                    });

                    if (response && response.success) {
                        this.showSuccess('ä¸ªäººèµ„æ–™æ›´æ–°æˆåŠŸ');
                        
                        // é‡æ–°åŠ è½½ç”¨æˆ·èµ„æ–™
                        await this.loadUserProfile();
                    } else {
                        throw new Error(response?.message || 'æ›´æ–°å¤±è´¥');
                    }

                } catch (error) {
                    console.error('âŒ æ›´æ–°ä¸ªäººèµ„æ–™å¤±è´¥:', error);
                    
                    if (error.message.includes('404')) {
                        this.showError('ä¸ªäººèµ„æ–™æ›´æ–°åŠŸèƒ½æš‚æœªå¼€æ”¾');
                    } else {
                        this.showError('æ›´æ–°å¤±è´¥ï¼š' + error.message);
                    }
                } finally {
                    const btn = document.getElementById('updateProfileBtn');
                    btn.innerHTML = '<i class="fas fa-save me-2"></i>ä¿å­˜æ›´æ”¹';
                    btn.disabled = false;
                }
            }

            resetProfileForm() {
                Object.keys(this.originalFormData).forEach(key => {
                    const element = document.getElementById(key);
                    if (element) {
                        element.value = this.originalFormData[key] || '';
                    }
                });
                this.showSuccess('è¡¨å•å·²é‡ç½®');
            }

            async changePassword() {
                try {
                    const btn = document.getElementById('changePasswordBtn');
                    const originalText = btn.innerHTML;
                    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>ä¿®æ”¹ä¸­...';
                    btn.disabled = true;

                    const currentPassword = document.getElementById('currentPassword').value.trim();
                    const newPassword = document.getElementById('newPassword').value.trim();
                    const confirmPassword = document.getElementById('confirmPassword').value.trim();

                    // éªŒè¯è¾“å…¥
                    if (!currentPassword || !newPassword || !confirmPassword) {
                        throw new Error('è¯·å¡«å†™æ‰€æœ‰å¯†ç å­—æ®µ');
                    }

                    if (newPassword !== confirmPassword) {
                        throw new Error('æ–°å¯†ç å’Œç¡®è®¤å¯†ç ä¸åŒ¹é…');
                    }

                    if (newPassword.length < 8) {
                        throw new Error('æ–°å¯†ç é•¿åº¦è‡³å°‘8ä½');
                    }

                    if (!this.isStrongPassword(newPassword)) {
                        throw new Error('å¯†ç å¿…é¡»åŒ…å«å¤§å°å†™å­—æ¯ã€æ•°å­—å’Œç‰¹æ®Šå­—ç¬¦');
                    }

                    console.log('ğŸ” å¼€å§‹ä¿®æ”¹å¯†ç ...');

                    const changeData = {
                        current_password: currentPassword,
                        new_password: newPassword,
                        confirm_password: confirmPassword
                    };

                    const response = await this.apiClient.request('/auth/change-password', {
                        method: 'POST',
                        data: changeData
                    });

                    if (response && response.success) {
                        this.showSuccess('å¯†ç ä¿®æ”¹æˆåŠŸï¼Œ3ç§’åå°†é‡æ–°ç™»å½•...');
                        
                        // æ¸…ç©ºè¡¨å•
                        this.elements.passwordForm.reset();
                        
                        // 3ç§’åè·³è½¬åˆ°ç™»å½•é¡µ
                        setTimeout(() => {
                            this.logout();
                        }, 3000);
                    } else {
                        throw new Error(response?.message || 'å¯†ç ä¿®æ”¹å¤±è´¥');
                    }

                } catch (error) {
                    console.error('âŒ ä¿®æ”¹å¯†ç å¤±è´¥:', error);
                    
                    if (error.message.includes('404')) {
                        this.showError('å¯†ç ä¿®æ”¹åŠŸèƒ½æš‚æœªå¼€æ”¾');
                    } else {
                        this.showError('ä¿®æ”¹å¯†ç å¤±è´¥ï¼š' + error.message);
                    }
                } finally {
                    const btn = document.getElementById('changePasswordBtn');
                    btn.innerHTML = '<i class="fas fa-key me-2"></i>ä¿®æ”¹å¯†ç ';
                    btn.disabled = false;
                }
            }

            // å·¥å…·æ–¹æ³•
            isValidEmail(email) {
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                return emailRegex.test(email);
            }

            isValidPhone(phone) {
                const phoneRegex = /^1[3-9]\d{9}$/;
                return phoneRegex.test(phone);
            }

            isStrongPassword(password) {
                const strongPasswordRegex = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&])[A-Za-z\d@$!%*?&]{8,100}$/;
                return strongPasswordRegex.test(password);
            }

            showLoading(show) {
                console.log('â³ è®¾ç½®åŠ è½½çŠ¶æ€:', show);
                if (this.elements.loadingSpinner) {
                    this.elements.loadingSpinner.style.display = show ? 'block' : 'none';
                }
                
                // å¦‚æœä¸æ˜¾ç¤ºåŠ è½½ï¼Œå°±æ˜¾ç¤ºä¸»å†…å®¹
                if (!show && this.elements.mainContent) {
                    console.log('ğŸ“± æ˜¾ç¤ºä¸»è¦å†…å®¹');
                    this.elements.mainContent.style.display = 'block';
                    console.log('ğŸ“± ä¸»å†…å®¹æ˜¾ç¤ºçŠ¶æ€å·²è®¾ç½®ä¸º:', this.elements.mainContent.style.display);
                }
            }

            showError(message) {
                console.log('âŒ æ˜¾ç¤ºé”™è¯¯:', message);
                if (this.elements.errorMessage && document.getElementById('errorText')) {
                    document.getElementById('errorText').textContent = message;
                    this.elements.errorMessage.style.display = 'block';
                    this.elements.successMessage.style.display = 'none';
                    
                    // ç¡®ä¿ä¸»å†…å®¹ä¹Ÿæ˜¾ç¤º
                    this.elements.mainContent.style.display = 'block';
                    
                    // è‡ªåŠ¨éšè—é”™è¯¯æ¶ˆæ¯
                    setTimeout(() => {
                        this.elements.errorMessage.style.display = 'none';
                    }, 5000);
                }
            }

            showSuccess(message) {
                console.log('âœ… æ˜¾ç¤ºæˆåŠŸ:', message);
                if (this.elements.successMessage && document.getElementById('successText')) {
                    document.getElementById('successText').textContent = message;
                    this.elements.successMessage.style.display = 'block';
                    this.elements.errorMessage.style.display = 'none';
                    
                    // è‡ªåŠ¨éšè—æˆåŠŸæ¶ˆæ¯
                    setTimeout(() => {
                        this.elements.successMessage.style.display = 'none';
                    }, 3000);
                }
            }

            redirectToLogin(message = 'è¯·å…ˆç™»å½•') {
                console.log('ğŸ”„ é‡å®šå‘åˆ°ç™»å½•é¡µé¢:', message);
                alert(message);
                window.location.href = './login.html';
            }

            logout() {
                if (typeof LogoutManager !== 'undefined') {
                    LogoutManager.logout({
                        redirectUrl: './login.html',
                        onSuccess: () => {
                            console.log('âœ… å·²é€€å‡ºç™»å½•');
                        }
                    });
                } else {
                    // ç®€å•çš„ç™»å‡º
                    localStorage.removeItem('access_token');
                    localStorage.removeItem('refresh_token');
                    window.location.href = './login.html';
                }
            }
        }

        // åˆå§‹åŒ–ç³»ç»Ÿ - å¤šç§æ–¹å¼ç¡®ä¿æ‰§è¡Œ
        console.log('ğŸ”§ å‡†å¤‡åˆå§‹åŒ–ProfileManager...');
        
        function initializeProfile() {
            console.log('ğŸ¯ æ‰§è¡ŒProfileManageråˆå§‹åŒ–');
            try {
                const profileManager = new ProfileManager();
                window.profileManager = profileManager;
                console.log('âœ… ProfileManageråˆå§‹åŒ–æˆåŠŸ');
            } catch (error) {
                console.error('âŒ ProfileManageråˆå§‹åŒ–å¤±è´¥:', error);
                
                // æ˜¾ç¤ºåŸºæœ¬é”™è¯¯é¡µé¢
                document.body.innerHTML = `
                    <div style="padding: 2rem; text-align: center; background: #f8f9fa;">
                        <h2 style="color: #dc3545; margin-bottom: 1rem;">âš ï¸ é¡µé¢åˆå§‹åŒ–å¤±è´¥</h2>
                        <p style="color: #6c757d; margin-bottom: 1rem;">é”™è¯¯ä¿¡æ¯: ${error.message}</p>
                        <button onclick="location.reload()" style="background: #007bff; color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px;">åˆ·æ–°é¡µé¢</button>
                    </div>
                `;
            }
        }

        // ç¡®ä¿åœ¨ä»»ä½•æƒ…å†µä¸‹éƒ½èƒ½æ‰§è¡Œ
        if (document.readyState === 'loading') {
            console.log('ğŸ“‹ DOMæ­£åœ¨åŠ è½½ï¼Œç­‰å¾…DOMContentLoaded');
            document.addEventListener('DOMContentLoaded', initializeProfile);
        } else {
            console.log('ğŸ“‹ DOMå·²å°±ç»ªï¼Œç«‹å³åˆå§‹åŒ–');
            initializeProfile();
        }

        // å¤‡ç”¨åˆå§‹åŒ–ï¼ˆé˜²æ­¢äº‹ä»¶ç›‘å¬å¤±è´¥ï¼‰
        setTimeout(() => {
            if (!window.profileManager) {
                console.log('â° å¤‡ç”¨åˆå§‹åŒ–è§¦å‘');
                initializeProfile();
            }
        }, 1000);

    </script>
</body>
</html>
