<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no">
    <title>ä¸ªäººèµ„æ–™ - DifyChat</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="assets/images/favicon.svg">
    <link rel="icon" type="image/svg+xml" href="assets/images/favicon-16.svg" sizes="16x16">
    <link rel="alternate icon" href="assets/images/favicon.svg">
    <meta name="theme-color" content="#28a745">
    
    <!-- Bootstrap CSS -->
    <link href="./vendor/bootstrap/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="./vendor/font-awesome/all.min.css" rel="stylesheet">
    
    <!-- é¡¹ç›®CSS -->
    <link href="assets/css/variables.css" rel="stylesheet">
    <link href="assets/css/base.css" rel="stylesheet">
    <link href="assets/css/components.css" rel="stylesheet">
    <link href="assets/css/themes.css" rel="stylesheet">
    
    <style>
        body {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            min-height: 100vh;
            font-family: var(--font-family);
            padding-top: 56px;
            margin: 0;
            overflow-x: hidden;
        }

        /* å¯¼èˆªæ æ ·å¼ */
        .navbar {
            background: linear-gradient(135deg, #28a745, #198754) !important;
            backdrop-filter: blur(10px);
            box-shadow: 0 2px 20px rgba(0,0,0,0.1);
        }

        .navbar-brand {
            font-weight: 700;
            font-size: 1.5rem;
        }

        /* ç”¨æˆ·ä¸‹æ‹‰èœå•æ ·å¼ */
        .user-dropdown-toggle {
            color: rgba(255,255,255,0.8) !important;
            transition: color 0.3s ease;
        }
        
        .user-dropdown-toggle:hover,
        .user-dropdown-toggle:focus,
        .user-dropdown-toggle.show {
            color: rgba(255,255,255,1) !important;
        }

        /* ä¸»å®¹å™¨ */
        .profile-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: clamp(1rem, 3vw, 2rem);
            min-height: calc(100vh - 56px);
        }

        /* é¡µé¢æ ‡é¢˜ */
        .page-header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: var(--radius-lg);
            padding: clamp(1.5rem, 4vw, 2rem);
            margin-bottom: clamp(1rem, 3vw, 2rem);
            box-shadow: var(--shadow-md);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .page-title {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            margin: 0;
            color: var(--text-primary);
            font-size: clamp(1.5rem, 4vw, 2rem);
            font-weight: var(--font-bold);
        }

        .page-title i {
            color: #28a745;
        }

        /* å¡ç‰‡å¸ƒå±€ */
        .profile-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: clamp(1rem, 3vw, 2rem);
        }

        @media (min-width: 992px) {
            .profile-grid {
                grid-template-columns: 1fr 1fr;
            }
        }

        /* å¡ç‰‡æ ·å¼ */
        .profile-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-md);
            border: 1px solid rgba(255, 255, 255, 0.2);
            overflow: hidden;
            transition: all var(--duration-base) var(--ease-out);
        }

        .profile-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .card-header {
            background: linear-gradient(135deg, rgba(40, 167, 69, 0.1), rgba(32, 201, 151, 0.05));
            border-bottom: 1px solid rgba(40, 167, 69, 0.2);
            padding: clamp(1rem, 3vw, 1.5rem);
        }

        .card-title {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            margin: 0;
            font-size: var(--text-lg);
            font-weight: var(--font-semibold);
            color: var(--text-primary);
        }

        .card-title i {
            color: #28a745;
        }

        .card-body {
            padding: clamp(1rem, 3vw, 1.5rem);
        }

        /* å¤´åƒåŒºåŸŸ */
        .avatar-section {
            text-align: center;
            margin-bottom: var(--space-6);
        }

        .avatar-container {
            position: relative;
            display: inline-block;
            margin-bottom: var(--space-4);
        }

        .user-avatar {
            width: clamp(80px, 15vw, 120px);
            height: clamp(80px, 15vw, 120px);
            border-radius: 50%;
            background: linear-gradient(135deg, #28a745, #20c997);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: clamp(2rem, 6vw, 3rem);
            color: white;
            font-weight: var(--font-bold);
            border: 4px solid rgba(255, 255, 255, 0.8);
            box-shadow: var(--shadow-lg);
            transition: all var(--duration-base) var(--ease-out);
        }

        .user-avatar:hover {
            transform: scale(1.05);
            box-shadow: var(--shadow-xl);
        }

        .avatar-upload {
            position: absolute;
            bottom: 0;
            right: 0;
            width: clamp(28px, 5vw, 36px);
            height: clamp(28px, 5vw, 36px);
            background: #28a745;
            border: 2px solid white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all var(--duration-fast) var(--ease-out);
        }

        .avatar-upload:hover {
            background: #198754;
            transform: scale(1.1);
        }

        .avatar-upload i {
            color: white;
            font-size: clamp(0.8rem, 2vw, 1rem);
        }

        /* è¡¨å•æ ·å¼ */
        .form-group {
            margin-bottom: var(--space-4);
        }

        .form-label {
            display: block;
            margin-bottom: var(--space-2);
            font-weight: var(--font-medium);
            color: var(--text-primary);
            font-size: var(--text-sm);
        }

        .form-control {
            width: 100%;
            padding: var(--space-3);
            border: 1px solid var(--border-medium);
            border-radius: var(--radius-md);
            font-size: var(--text-base);
            transition: all var(--duration-fast) var(--ease-out);
            background-color: var(--bg-input);
            color: var(--text-primary);
        }

        .form-control:focus {
            outline: none;
            border-color: #28a745;
            box-shadow: 0 0 0 3px rgba(40, 167, 69, 0.1);
        }

        .form-control:disabled {
            background-color: var(--bg-tertiary);
            color: var(--text-muted);
            cursor: not-allowed;
        }

        /* æŒ‰é’®æ ·å¼ */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-2);
            padding: var(--space-3) var(--space-4);
            border: 1px solid transparent;
            border-radius: var(--radius-md);
            font-weight: var(--font-medium);
            text-decoration: none;
            cursor: pointer;
            transition: all var(--duration-fast) var(--ease-out);
            font-size: var(--text-sm);
        }

        .btn-primary {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            border-color: #28a745;
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #198754, #17a085);
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .btn-secondary {
            background-color: var(--secondary-color);
            color: white;
            border-color: var(--secondary-color);
        }

        .btn-secondary:hover {
            background-color: var(--secondary-hover);
            transform: translateY(-1px);
        }

        .btn-outline {
            background-color: transparent;
            color: #28a745;
            border-color: #28a745;
        }

        .btn-outline:hover {
            background-color: #28a745;
            color: white;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        /* ä¿¡æ¯æ˜¾ç¤ºåŒºåŸŸ */
        .info-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--space-3) 0;
            border-bottom: 1px solid var(--border-light);
        }

        .info-item:last-child {
            border-bottom: none;
        }

        .info-label {
            font-weight: var(--font-medium);
            color: var(--text-secondary);
            font-size: var(--text-sm);
        }

        .info-value {
            font-weight: var(--font-medium);
            color: var(--text-primary);
            text-align: right;
        }

        /* çŠ¶æ€å¾½ç«  */
        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: var(--space-1);
            padding: var(--space-1) var(--space-2);
            border-radius: var(--radius-full);
            font-size: var(--text-xs);
            font-weight: var(--font-medium);
        }

        .status-badge.verified {
            background-color: var(--success-light);
            color: var(--success);
        }

        .status-badge.unverified {
            background-color: var(--warning-light);
            color: var(--warning);
        }

        .status-badge.active {
            background-color: var(--success-light);
            color: var(--success);
        }

        /* åŠ è½½çŠ¶æ€ */
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: var(--radius-lg);
            z-index: 10;
        }

        .spinner {
            width: 32px;
            height: 32px;
            border: 3px solid rgba(40, 167, 69, 0.2);
            border-top: 3px solid #28a745;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Toasté€šçŸ¥æ ·å¼ */
        .toast-container {
            position: fixed;
            top: var(--space-4);
            right: var(--space-4);
            z-index: var(--z-toast);
        }

        .toast {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-lg);
            padding: var(--space-4);
            margin-bottom: var(--space-3);
            min-width: 300px;
            max-width: 400px;
            animation: slideInRight 0.3s var(--ease-out);
            display: flex;
            align-items: center;
            gap: var(--space-3);
        }

        .toast.success {
            border-left: 4px solid var(--success);
        }

        .toast.error {
            border-left: 4px solid var(--error);
        }

        .toast.warning {
            border-left: 4px solid var(--warning);
        }

        .toast.info {
            border-left: 4px solid var(--info);
        }

        .toast-icon {
            font-size: var(--text-lg);
        }

        .toast.success .toast-icon {
            color: var(--success);
        }

        .toast.error .toast-icon {
            color: var(--error);
        }

        .toast.warning .toast-icon {
            color: var(--warning);
        }

        .toast.info .toast-icon {
            color: var(--info);
        }

        .toast-message {
            flex: 1;
            font-size: var(--text-sm);
            color: var(--text-primary);
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(100%);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .profile-container {
                padding: var(--space-4);
            }

            .page-header {
                padding: var(--space-4);
            }

            .card-header,
            .card-body {
                padding: var(--space-4);
            }

            .info-item {
                flex-direction: column;
                align-items: flex-start;
                gap: var(--space-1);
            }

            .info-value {
                text-align: left;
            }

            .btn {
                width: 100%;
                justify-content: center;
            }
        }

        /* åŠ¨ç”»æ•ˆæœ */
        .fade-in {
            animation: fadeIn 0.5s var(--ease-out);
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* å¯†ç å¼ºåº¦æŒ‡ç¤ºå™¨ */
        .password-strength {
            margin-top: var(--space-2);
            height: 4px;
            background-color: var(--bg-tertiary);
            border-radius: var(--radius-full);
            overflow: hidden;
        }

        .password-strength-bar {
            height: 100%;
            transition: all var(--duration-base) var(--ease-out);
            border-radius: var(--radius-full);
        }

        .password-strength.weak .password-strength-bar {
            width: 33%;
            background-color: var(--error);
        }

        .password-strength.medium .password-strength-bar {
            width: 66%;
            background-color: var(--warning);
        }

        .password-strength.strong .password-strength-bar {
            width: 100%;
            background-color: var(--success);
        }

        .password-strength-text {
            font-size: var(--text-xs);
            margin-top: var(--space-1);
            color: var(--text-muted);
        }

        /* è¾“å…¥ç»„ */
        .input-group {
            position: relative;
        }

        .input-group-append {
            position: absolute;
            right: var(--space-2);
            top: 50%;
            transform: translateY(-50%);
        }

        .input-group .form-control {
            padding-right: var(--space-10);
        }

        .password-toggle {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            padding: var(--space-2);
            border-radius: var(--radius-sm);
            transition: color var(--duration-fast) var(--ease-out);
        }

        .password-toggle:hover {
            color: var(--text-primary);
        }

        /* PINéªŒè¯ç›¸å…³æ ·å¼ */
        .pin-settings {
            margin-top: var(--space-4);
        }

        .pin-toggle-container {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: var(--space-4);
            width: 100%;
        }

        .pin-toggle-container .info-label {
            flex: 1;
        }

        .pin-toggle {
            flex-shrink: 0;
        }

        /* åˆ‡æ¢å¼€å…³æ ·å¼ */
        .switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: #28a745;
        }

        input:focus + .slider {
            box-shadow: 0 0 1px #28a745;
        }

        input:checked + .slider:before {
            transform: translateX(26px);
        }

        /* PINçŠ¶æ€ä¿¡æ¯ */
        .pin-status-info {
            margin-top: var(--space-4);
            padding: var(--space-4);
            background-color: rgba(40, 167, 69, 0.05);
            border: 1px solid rgba(40, 167, 69, 0.2);
            border-radius: var(--radius-md);
        }

        .pin-lock-time-select {
            max-width: 120px;
            padding: var(--space-2) var(--space-3);
            font-size: var(--text-sm);
        }

        .pin-actions {
            margin-top: var(--space-4);
            display: flex;
            gap: var(--space-3);
        }

        /* PINè¾“å…¥æ¡†æ ·å¼ */
        .pin-input {
            font-family: monospace;
            font-size: var(--text-lg);
            letter-spacing: 0.2em;
            text-align: center;
        }

        .pin-input:focus {
            border-color: #28a745;
            box-shadow: 0 0 0 3px rgba(40, 167, 69, 0.2);
        }

        /* PINéªŒè¯é”™è¯¯çŠ¶æ€ */
        .pin-input.is-invalid {
            border-color: var(--error);
            box-shadow: 0 0 0 3px rgba(220, 53, 69, 0.2);
        }

        .pin-verify-attempts {
            margin-top: var(--space-3);
            padding: var(--space-2);
            background-color: rgba(255, 193, 7, 0.1);
            border-radius: var(--radius-sm);
        }

        /* æ¨¡æ€æ¡†å¢å¼ºæ ·å¼ */
        .modal-content {
            border: none;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-xl);
        }

        .modal-header {
            background: linear-gradient(135deg, rgba(40, 167, 69, 0.1), rgba(32, 201, 151, 0.05));
            border-bottom: 1px solid rgba(40, 167, 69, 0.2);
            border-radius: var(--radius-lg) var(--radius-lg) 0 0;
        }

        .modal-title {
            color: var(--text-primary);
            font-weight: var(--font-semibold);
        }

        .modal-body {
            padding: var(--space-6);
        }

        .modal-footer {
            border-top: 1px solid var(--border-light);
            padding: var(--space-4) var(--space-6);
        }

        /* PINéªŒè¯æ¨¡æ€æ¡†ç‰¹æ®Šæ ·å¼ */
        #pinVerifyModal .modal-content {
            border: 2px solid #28a745;
        }

        #pinVerifyModal .modal-header {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
        }

        #pinVerifyModal .modal-title {
            color: white;
        }
    </style>
</head>
<body>
    <!-- å¯¼èˆªæ  -->
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="./index.html">
                <i class="fas fa-robot me-2"></i>
                DifyChat
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="./index.html">é¦–é¡µ</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="./chat.html">èŠå¤©</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="./chatroom.html">èŠå¤©å®¤</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="./profile.html">ä¸ªäººèµ„æ–™</a>
                    </li>
                    <li class="nav-item" id="adminNavItem" style="display: none;">
                        <a class="nav-link" href="./admin.html">
                            <i class="fas fa-cogs me-1"></i>ç®¡ç†åå°
                        </a>
                    </li>
                </ul>
                <ul class="navbar-nav">
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle user-dropdown-toggle" href="#" id="userDropdown" role="button" data-bs-toggle="dropdown">
                            <i class="fas fa-user-circle me-1"></i>
                            <span id="currentUsername">ç”¨æˆ·</span>
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item" href="./profile.html">
                                <i class="fas fa-user me-2"></i>ä¸ªäººèµ„æ–™
                            </a></li>
                            <li><a class="dropdown-item" href="./settings.html">
                                <i class="fas fa-cog me-2"></i>è®¾ç½®
                            </a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="#" id="nav-logout">
                                <i class="fas fa-sign-out-alt me-2"></i>é€€å‡ºç™»å½•
                            </a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- ä¸»å®¹å™¨ -->
    <div class="profile-container">
        <!-- é¡µé¢æ ‡é¢˜ -->
        <div class="page-header fade-in">
            <h1 class="page-title">
                <i class="fas fa-user-circle"></i>
                ä¸ªäººèµ„æ–™ç®¡ç†
            </h1>
        </div>

        <!-- ä¸»è¦å†…å®¹ -->
        <div class="profile-grid">
            <!-- åŸºæœ¬ä¿¡æ¯å¡ç‰‡ -->
            <div class="profile-card fade-in">
                <div class="card-header">
                    <h2 class="card-title">
                        <i class="fas fa-id-card"></i>
                        åŸºæœ¬ä¿¡æ¯
                    </h2>
                </div>
                <div class="card-body">
                    <!-- å¤´åƒåŒºåŸŸ -->
                    <div class="avatar-section">
                        <div class="avatar-container">
                            <div class="user-avatar" id="userAvatar">
                                <i class="fas fa-user"></i>
                            </div>
                            <div class="avatar-upload" onclick="uploadAvatar()">
                                <i class="fas fa-camera"></i>
                            </div>
                        </div>
                        <div class="user-name" id="displayName">åŠ è½½ä¸­...</div>
                    </div>

                    <!-- åŸºæœ¬ä¿¡æ¯è¡¨å• -->
                    <form id="profileForm">
                        <div class="form-group">
                            <label class="form-label" for="username">ç”¨æˆ·å</label>
                            <input type="text" class="form-control" id="username" disabled>
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="nickname">æ˜µç§° *</label>
                            <input type="text" class="form-control" id="nickname" maxlength="100" required>
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="email">é‚®ç®±åœ°å€ *</label>
                            <input type="email" class="form-control" id="email" maxlength="255" required>
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="phone">æ‰‹æœºå·ç </label>
                            <input type="tel" class="form-control" id="phone" maxlength="20">
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="company">å…¬å¸/ç»„ç»‡</label>
                            <input type="text" class="form-control" id="company" maxlength="100" placeholder="è¯·è¾“å…¥æ‚¨çš„å…¬å¸æˆ–ç»„ç»‡åç§°">
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="bio">ä¸ªäººç®€ä»‹</label>
                            <textarea class="form-control" id="bio" rows="4" maxlength="500" placeholder="ä»‹ç»ä¸€ä¸‹æ‚¨è‡ªå·±..."></textarea>
                        </div>

                        <div class="form-group">
                            <button type="submit" class="btn btn-primary" id="saveProfileBtn">
                                <i class="fas fa-save"></i>
                                ä¿å­˜èµ„æ–™
                            </button>
                            <button type="button" class="btn btn-outline" onclick="resetForm()">
                                <i class="fas fa-undo"></i>
                                é‡ç½®
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- è´¦æˆ·å®‰å…¨å¡ç‰‡ -->
            <div class="profile-card fade-in">
                <div class="card-header">
                    <h2 class="card-title">
                        <i class="fas fa-shield-alt"></i>
                        è´¦æˆ·å®‰å…¨
                    </h2>
                </div>
                <div class="card-body">
                    <!-- è´¦æˆ·ä¿¡æ¯ -->
                    <div class="info-item">
                        <span class="info-label">è´¦æˆ·çŠ¶æ€</span>
                        <span class="info-value">
                            <span class="status-badge active" id="accountStatus">
                                <i class="fas fa-check-circle"></i>
                                æ­£å¸¸
                            </span>
                        </span>
                    </div>

                    <div class="info-item">
                        <span class="info-label">é‚®ç®±éªŒè¯</span>
                        <span class="info-value">
                            <span class="status-badge verified" id="emailVerificationStatus">
                                <i class="fas fa-check-circle"></i>
                                å·²éªŒè¯
                            </span>
                        </span>
                    </div>

                    <div class="info-item">
                        <span class="info-label">æ‰‹æœºéªŒè¯</span>
                        <span class="info-value">
                            <span class="status-badge unverified" id="phoneVerificationStatus">
                                <i class="fas fa-exclamation-circle"></i>
                                æœªéªŒè¯
                            </span>
                        </span>
                    </div>

                    <div class="info-item">
                        <span class="info-label">æœ€åç™»å½•</span>
                        <span class="info-value" id="lastLoginTime">-</span>
                    </div>

                    <div class="info-item">
                        <span class="info-label">ç™»å½•æ¬¡æ•°</span>
                        <span class="info-value" id="loginCount">-</span>
                    </div>

                    <div class="info-item">
                        <span class="info-label">æ³¨å†Œæ—¶é—´</span>
                        <span class="info-value" id="registerTime">-</span>
                    </div>

                    <!-- PINéªŒè¯è®¾ç½® -->
                    <hr style="margin: var(--space-6) 0;">
                    <h3 style="margin-bottom: var(--space-4); font-size: var(--text-lg); color: var(--text-primary);">
                        <i class="fas fa-lock me-2"></i>PINéªŒè¯è®¾ç½®
                    </h3>

                    <div class="pin-settings">
                        <div class="info-item">
                            <div class="pin-toggle-container">
                                <span class="info-label">
                                    <i class="fas fa-shield-alt me-2"></i>
                                    æ•æ„ŸåŒºåŸŸPINéªŒè¯
                                    <small class="text-muted d-block">å¯ç”¨åè¿›å…¥èŠå¤©å®¤æˆ–å¥½å‹ç§èŠéœ€è¦éªŒè¯PINç </small>
                                </span>
                                <div class="pin-toggle">
                                    <label class="switch">
                                        <input type="checkbox" id="pinEnabledToggle">
                                        <span class="slider"></span>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <div class="pin-status-info" id="pinStatusInfo" style="display: none;">
                            <div class="info-item">
                                <span class="info-label">PINçŠ¶æ€</span>
                                <span class="info-value">
                                    <span class="status-badge" id="pinStatus">
                                        <i class="fas fa-check-circle"></i>
                                        å·²è®¾ç½®
                                    </span>
                                </span>
                            </div>

                            <div class="info-item">
                                <span class="info-label">è‡ªåŠ¨é”å®šæ—¶é—´</span>
                                <div class="info-value">
                                    <select class="form-control pin-lock-time-select" id="pinLockTimeSelect">
                                        <option value="0.5">30ç§’</option>
                                        <option value="1">1åˆ†é’Ÿ</option>
                                        <option value="5" selected>5åˆ†é’Ÿ</option>
                                        <option value="30">30åˆ†é’Ÿ</option>
                                        <option value="60">1å°æ—¶</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="pin-actions" id="pinActions" style="display: none;">
                            <button type="button" class="btn btn-outline" id="setPinBtn" onclick="showSetPinModal()">
                                <i class="fas fa-plus"></i>
                                è®¾ç½®PINç 
                            </button>
                            <button type="button" class="btn btn-secondary" id="changePinBtn" onclick="showChangePinModal()" style="display: none;">
                                <i class="fas fa-edit"></i>
                                ä¿®æ”¹PINç 
                            </button>
                        </div>
                    </div>

                    <!-- ä¿®æ”¹å¯†ç è¡¨å• -->
                    <hr style="margin: var(--space-6) 0;">
                    <h3 style="margin-bottom: var(--space-4); font-size: var(--text-lg); color: var(--text-primary);">
                        <i class="fas fa-key me-2"></i>ä¿®æ”¹å¯†ç 
                    </h3>

                    <form id="passwordForm">
                        <div class="form-group">
                            <label class="form-label" for="currentPassword">å½“å‰å¯†ç  *</label>
                            <div class="input-group">
                                <input type="password" class="form-control" id="currentPassword" required>
                                <div class="input-group-append">
                                    <button type="button" class="password-toggle" onclick="togglePassword('currentPassword')">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="newPassword">æ–°å¯†ç  *</label>
                            <div class="input-group">
                                <input type="password" class="form-control" id="newPassword" required>
                                <div class="input-group-append">
                                    <button type="button" class="password-toggle" onclick="togglePassword('newPassword')">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="password-strength" id="passwordStrength" style="display: none;">
                                <div class="password-strength-bar"></div>
                            </div>
                            <div class="password-strength-text" id="passwordStrengthText"></div>
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="confirmPassword">ç¡®è®¤æ–°å¯†ç  *</label>
                            <div class="input-group">
                                <input type="password" class="form-control" id="confirmPassword" required>
                                <div class="input-group-append">
                                    <button type="button" class="password-toggle" onclick="togglePassword('confirmPassword')">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <button type="submit" class="btn btn-primary" id="changePasswordBtn">
                                <i class="fas fa-lock"></i>
                                ä¿®æ”¹å¯†ç 
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Toasté€šçŸ¥å®¹å™¨ -->
    <div class="toast-container" id="toastContainer">
        <!-- Toastæ¶ˆæ¯å°†åŠ¨æ€æ·»åŠ åˆ°è¿™é‡Œ -->
    </div>

    <!-- è®¾ç½®PINç æ¨¡æ€æ¡† -->
    <div class="modal fade" id="setPinModal" tabindex="-1" aria-labelledby="setPinModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="setPinModalLabel">
                        <i class="fas fa-shield-alt me-2"></i>
                        è®¾ç½®PINç 
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="å…³é—­"></button>
                </div>
                <div class="modal-body">
                    <p class="text-muted mb-3">
                        <i class="fas fa-info-circle me-1"></i>
                        PINç ç”¨äºä¿æŠ¤æ•æ„Ÿæ“ä½œï¼Œå¦‚è¿›å…¥èŠå¤©å®¤æˆ–å¥½å‹ç§èŠã€‚è¯·è®¾ç½®4-6ä½æ•°å­—PINç ã€‚
                    </p>
                    <form id="setPinForm">
                        <div class="form-group">
                            <label class="form-label" for="newPin">PINç  *</label>
                            <input type="password" class="form-control pin-input" id="newPin" autocomplete="off"
                                   placeholder="è¯·è¾“å…¥4-6ä½æ•°å­—" maxlength="6" 
                                   pattern="[0-9]*" inputmode="numeric" required>
                            <small class="form-text text-muted">åªèƒ½åŒ…å«æ•°å­—0-9</small>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="confirmNewPin">ç¡®è®¤PINç  *</label>
                            <input type="password" class="form-control pin-input" id="confirmNewPin" autocomplete="off"
                                   placeholder="è¯·å†æ¬¡è¾“å…¥PINç " maxlength="6" 
                                   pattern="[0-9]*" inputmode="numeric" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                    <button type="button" class="btn btn-primary" onclick="confirmSetPin()">
                        <i class="fas fa-check"></i>
                        è®¾ç½®PINç 
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ä¿®æ”¹PINç æ¨¡æ€æ¡† -->
    <div class="modal fade" id="changePinModal" tabindex="-1" aria-labelledby="changePinModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="changePinModalLabel">
                        <i class="fas fa-edit me-2"></i>
                        ä¿®æ”¹PINç 
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="å…³é—­"></button>
                </div>
                <div class="modal-body">
                    <p class="text-muted mb-3">
                        <i class="fas fa-info-circle me-1"></i>
                        ä¸ºäº†å®‰å…¨ï¼Œä¿®æ”¹PINç éœ€è¦éªŒè¯å½“å‰PINç ã€‚
                    </p>
                    <form id="changePinForm">
                        <div class="form-group">
                            <label class="form-label" for="currentPin">å½“å‰PINç  *</label>
                            <input type="password" class="form-control pin-input" id="currentPin" autocomplete="off"
                                   placeholder="è¯·è¾“å…¥å½“å‰PINç " maxlength="6" 
                                   pattern="[0-9]*" inputmode="numeric" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="newPinChange">æ–°PINç  *</label>
                            <input type="password" class="form-control pin-input" id="newPinChange" autocomplete="off"
                                   placeholder="è¯·è¾“å…¥4-6ä½æ•°å­—" maxlength="6" 
                                   pattern="[0-9]*" inputmode="numeric" required>
                            <small class="form-text text-muted">åªèƒ½åŒ…å«æ•°å­—0-9</small>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="confirmNewPinChange">ç¡®è®¤æ–°PINç  *</label>
                            <input type="password" class="form-control pin-input" id="confirmNewPinChange" autocomplete="off"
                                   placeholder="è¯·å†æ¬¡è¾“å…¥æ–°PINç " maxlength="6" 
                                   pattern="[0-9]*" inputmode="numeric" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                    <button type="button" class="btn btn-primary" onclick="confirmChangePin()">
                        <i class="fas fa-check"></i>
                        ä¿®æ”¹PINç 
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- éšè—çš„æ–‡ä»¶ä¸Šä¼ è¾“å…¥ -->
    <input type="file" id="avatarInput" accept="image/*" style="display: none;">

    <!-- Bootstrap JS -->
    <script src="./vendor/bootstrap/bootstrap.bundle.min.js"></script>
    
    <!-- PINéªŒè¯æœåŠ¡ -->
    <script src="js/services/pin-verification-service.js"></script>
    
    <!-- é¡¹ç›®JS -->
    <script type="module">
        import { ENV_CONFIG } from './config/env.js';
        import apiClient from './js/api/api-client.js';

        // å…¨å±€å˜é‡
        let currentUserData = null;
        let isLoading = false;

        // åˆå§‹åŒ–é¡µé¢
        async function initProfile() {
            try {
                console.log('ğŸš€ åˆå§‹åŒ–ä¸ªäººèµ„æ–™é¡µé¢...');
                
                // æ£€æŸ¥ç™»å½•çŠ¶æ€
                const token = localStorage.getItem('dify_access_token');
                if (!token) {
                    window.location.href = './login.html?return=' + encodeURIComponent(window.location.href);
                    return;
                }

                // åŠ è½½ç”¨æˆ·èµ„æ–™
                await loadUserProfile();
                
                // ç»‘å®šäº‹ä»¶
                bindEvents();
                
                console.log('âœ… ä¸ªäººèµ„æ–™é¡µé¢åˆå§‹åŒ–å®Œæˆ');
                
            } catch (error) {
                console.error('âŒ åˆå§‹åŒ–å¤±è´¥:', error);
                showToast('é¡µé¢åˆå§‹åŒ–å¤±è´¥: ' + error.message, 'error');
            }
        }

        // åŠ è½½ç”¨æˆ·èµ„æ–™
        async function loadUserProfile() {
            try {
                showLoading(true);
                
                const response = await apiClient.get('/users/profile');
                
                if (response.success && response.data) {
                    currentUserData = response.data;
                    displayUserProfile(currentUserData);
                    showToast('ç”¨æˆ·èµ„æ–™åŠ è½½æˆåŠŸ', 'success');
                } else {
                    throw new Error(response.message || 'åŠ è½½ç”¨æˆ·èµ„æ–™å¤±è´¥');
                }
            } catch (error) {
                console.error('åŠ è½½ç”¨æˆ·èµ„æ–™å¤±è´¥:', error);
                showToast('åŠ è½½ç”¨æˆ·èµ„æ–™å¤±è´¥: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        // æ˜¾ç¤ºç”¨æˆ·èµ„æ–™
        function displayUserProfile(user) {
            document.getElementById('username').value = user.username || '';
            document.getElementById('nickname').value = user.nickname || '';
            document.getElementById('email').value = user.email || '';
            document.getElementById('phone').value = user.phone || '';
            document.getElementById('company').value = user.company || '';
            document.getElementById('bio').value = user.bio || '';

            document.getElementById('displayName').textContent = user.nickname || user.username || 'ç”¨æˆ·';
            
            // å¤´åƒæ˜¾ç¤ºé€»è¾‘
            const userAvatarElement = document.getElementById('userAvatar');
            if (user.avatar) {
                userAvatarElement.innerHTML = `<img src="${user.avatar}" alt="Avatar" style="width:100%; height:100%; border-radius:50%; object-fit:cover;">`;
            } else {
                userAvatarElement.innerHTML = `<i class="fas fa-user"></i>`;
            }

            // è´¦æˆ·å®‰å…¨ä¿¡æ¯
            document.getElementById('accountStatus').textContent = user.status === 'active' ? 'æ­£å¸¸' : 'å¼‚å¸¸';
            document.getElementById('accountStatus').className = `status-badge ${user.status === 'active' ? 'active' : 'unverified'}`;

            const emailVerificationStatus = document.getElementById('emailVerificationStatus');
            if (user.emailVerified) {
                emailVerificationStatus.innerHTML = `<i class="fas fa-check-circle"></i> å·²éªŒè¯`;
                emailVerificationStatus.className = 'status-badge verified';
            } else {
                emailVerificationStatus.innerHTML = `<i class="fas fa-exclamation-circle"></i> æœªéªŒè¯`;
                emailVerificationStatus.className = 'status-badge unverified';
            }

            const phoneVerificationStatus = document.getElementById('phoneVerificationStatus');
            if (user.phoneVerified) {
                phoneVerificationStatus.innerHTML = `<i class="fas fa-check-circle"></i> å·²éªŒè¯`;
                phoneVerificationStatus.className = 'status-badge verified';
            } else {
                phoneVerificationStatus.innerHTML = `<i class="fas fa-exclamation-circle"></i> æœªéªŒè¯`;
                phoneVerificationStatus.className = 'status-badge unverified';
            }

            document.getElementById('lastLoginTime').textContent = user.lastLoginAt ? new Date(user.lastLoginAt).toLocaleString() : '-';
            document.getElementById('loginCount').textContent = user.loginCount || 0;
            document.getElementById('registerTime').textContent = user.createdAt ? new Date(user.createdAt).toLocaleString() : '-';

            // æ›´æ–°å¯¼èˆªæ ç”¨æˆ·å
            const currentUsernameNav = document.getElementById('currentUsername');
            if (currentUsernameNav) {
                currentUsernameNav.textContent = user.nickname || user.username || 'ç”¨æˆ·';
            }

            // åˆå§‹åŒ–PINéªŒè¯çŠ¶æ€
            initPinSettings();
        }

        // ç»‘å®šäº‹ä»¶
        function bindEvents() {
            document.getElementById('profileForm').addEventListener('submit', saveProfile);
            document.getElementById('passwordForm').addEventListener('submit', changePassword);
            document.getElementById('newPassword').addEventListener('input', checkPasswordStrength);
            document.getElementById('avatarInput').addEventListener('change', handleAvatarUpload);
            
            // PINéªŒè¯ç›¸å…³äº‹ä»¶ç»‘å®š
            const pinToggle = document.getElementById('pinEnabledToggle');
            if (pinToggle) {
                pinToggle.addEventListener('change', handlePinToggleChange);
            }
            
            const pinLockTimeSelect = document.getElementById('pinLockTimeSelect');
            if (pinLockTimeSelect) {
                pinLockTimeSelect.addEventListener('change', handlePinLockTimeChange);
            }
            
            // å¯¼èˆªæ é€€å‡ºç™»å½•
            const logoutBtn = document.getElementById('nav-logout');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    if (confirm('ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ')) {
                        localStorage.removeItem('dify_access_token');
                        localStorage.removeItem('userInfo');
                        window.location.href = './login.html';
                    }
                });
            }

            // æ£€æŸ¥ç®¡ç†å‘˜æƒé™å¹¶æ˜¾ç¤ºç®¡ç†åå°é“¾æ¥
            checkAdminPermission();
        }

        // æ£€æŸ¥ç®¡ç†å‘˜æƒé™
        function checkAdminPermission() {
            try {
                const userInfo = JSON.parse(localStorage.getItem('userInfo') || '{}');
                const userRole = userInfo.role || '';
                if (userRole === 'admin' || userRole === 'superadmin' || userRole === 'administrator') {
                    const adminNavItem = document.getElementById('adminNavItem');
                    if (adminNavItem) {
                        adminNavItem.style.display = 'block';
                    }
                }
            } catch (error) {
                console.log('æ£€æŸ¥ç®¡ç†å‘˜æƒé™æ—¶å‡ºé”™:', error);
            }
        }

        // ä¿å­˜èµ„æ–™
        async function saveProfile(event) {
            event.preventDefault();
            if (isLoading) return;

            const saveBtn = document.getElementById('saveProfileBtn');
            const originalBtnText = saveBtn.innerHTML;
            saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ä¿å­˜ä¸­...';
            saveBtn.disabled = true;
            isLoading = true;

            try {
                const nickname = document.getElementById('nickname').value.trim();
                const email = document.getElementById('email').value.trim();
                const phone = document.getElementById('phone').value.trim();
                const company = document.getElementById('company').value.trim();
                const bio = document.getElementById('bio').value.trim();

                // æ„å»ºæ›´æ–°æ•°æ®å¯¹è±¡ï¼ŒåªåŒ…å«æœ‰å˜åŒ–çš„å­—æ®µ
                const updateData = {};
                
                // æ£€æŸ¥æ¯ä¸ªå­—æ®µæ˜¯å¦æœ‰å˜åŒ–
                if (currentUserData.nickname !== nickname) {
                    updateData.nickname = nickname;
                }
                if (currentUserData.email !== email) {
                    updateData.email = email;
                }
                // åªæœ‰å½“æ‰‹æœºå·æœ‰å˜åŒ–ä¸”ä¸ä¸ºç©ºæ—¶æ‰åŒ…å«
                if (phone && currentUserData.phone !== phone) {
                    updateData.phone = phone;
                }
                // å¦‚æœæ‰‹æœºå·ä»æœ‰å€¼å˜ä¸ºç©ºï¼Œä¹Ÿéœ€è¦æ›´æ–°
                if (!phone && currentUserData.phone) {
                    updateData.phone = null;
                }
                if (currentUserData.company !== company) {
                    updateData.company = company;
                }
                if (currentUserData.bio !== bio) {
                    updateData.bio = bio;
                }

                // å¦‚æœæ²¡æœ‰ä»»ä½•å˜åŒ–ï¼Œç›´æ¥è¿”å›
                if (Object.keys(updateData).length === 0) {
                    showToast('æ²¡æœ‰æ£€æµ‹åˆ°ä»»ä½•å˜åŒ–', 'info');
                    return;
                }

                console.log('ğŸ“¤ å‘é€æ›´æ–°æ•°æ®:', updateData);

                const response = await apiClient.put('/users/profile', updateData);

                if (response.success) {
                    showToast('ç”¨æˆ·èµ„æ–™æ›´æ–°æˆåŠŸï¼', 'success');
                    // é‡æ–°åŠ è½½ç”¨æˆ·èµ„æ–™ä»¥ç¡®ä¿æ˜¾ç¤ºæœ€æ–°æ•°æ®
                    await loadUserProfile();
                } else {
                    throw new Error(response.message || 'æ›´æ–°å¤±è´¥');
                }
            } catch (error) {
                console.error('ä¿å­˜èµ„æ–™å¤±è´¥:', error);
                showToast('ä¿å­˜èµ„æ–™å¤±è´¥: ' + error.message, 'error');
            } finally {
                saveBtn.innerHTML = originalBtnText;
                saveBtn.disabled = false;
                isLoading = false;
            }
        }

        // ä¿®æ”¹å¯†ç 
        async function changePassword(event) {
            event.preventDefault();
            if (isLoading) return;

            const changePasswordBtn = document.getElementById('changePasswordBtn');
            const originalBtnText = changePasswordBtn.innerHTML;
            changePasswordBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ä¿®æ”¹ä¸­...';
            changePasswordBtn.disabled = true;
            isLoading = true;

            try {
                const currentPassword = document.getElementById('currentPassword').value;
                const newPassword = document.getElementById('newPassword').value;
                const confirmPassword = document.getElementById('confirmPassword').value;

                if (newPassword !== confirmPassword) {
                    throw new Error('æ–°å¯†ç å’Œç¡®è®¤å¯†ç ä¸åŒ¹é…ï¼');
                }

                // å¯†ç å¼ºåº¦éªŒè¯ (8-100å­—ç¬¦ï¼ŒåŒ…å«å¤§å°å†™å­—æ¯ã€æ•°å­—ã€ç‰¹æ®Šå­—ç¬¦)
                const passwordRegex = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[!@#$%^&*()_+[\]{};':"\\|,.<>/?]).{8,100}$/;
                if (!passwordRegex.test(newPassword)) {
                    throw new Error('æ–°å¯†ç å¿…é¡»åŒ…å«å¤§å°å†™å­—æ¯ã€æ•°å­—ã€ç‰¹æ®Šå­—ç¬¦ï¼Œä¸”é•¿åº¦åœ¨8-100ä¹‹é—´ã€‚');
                }

                const response = await apiClient.post('/auth/change-password', {
                    currentPassword: currentPassword,
                    newPassword: newPassword,
                    confirmPassword: confirmPassword
                });

                if (response.success) {
                    showToast('å¯†ç ä¿®æ”¹æˆåŠŸï¼', 'success');
                    document.getElementById('passwordForm').reset(); // æ¸…ç©ºè¡¨å•
                    document.getElementById('passwordStrength').style.display = 'none';
                    document.getElementById('passwordStrengthText').textContent = '';
                } else {
                    throw new Error(response.message || 'å¯†ç ä¿®æ”¹å¤±è´¥');
                }
            } catch (error) {
                console.error('ä¿®æ”¹å¯†ç å¤±è´¥:', error);
                showToast('ä¿®æ”¹å¯†ç å¤±è´¥: ' + error.message, 'error');
            } finally {
                changePasswordBtn.innerHTML = originalBtnText;
                changePasswordBtn.disabled = false;
                isLoading = false;
            }
        }

        // é‡ç½®èµ„æ–™è¡¨å•
        function resetForm() {
            if (currentUserData) {
                displayUserProfile(currentUserData);
                showToast('èµ„æ–™è¡¨å•å·²é‡ç½®', 'info');
            }
        }

        // æ˜¾ç¤ºToasté€šçŸ¥
        function showToast(message, type = 'info') {
            const toastContainer = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <i class="toast-icon fas ${getToastIcon(type)}"></i>
                <span class="toast-message">${message}</span>
            `;
            
            toastContainer.appendChild(toast);
            
            setTimeout(() => toast.classList.add('show'), 100);
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        function getToastIcon(type) {
            switch (type) {
                case 'success': return 'fa-check-circle';
                case 'error': return 'fa-times-circle';
                case 'warning': return 'fa-exclamation-triangle';
                case 'info': return 'fa-info-circle';
                default: return 'fa-info-circle';
            }
        }

        // æ˜¾ç¤º/éšè—åŠ è½½çŠ¶æ€
        function showLoading(show) {
            const profileCard = document.querySelector('.profile-card'); // å‡è®¾åŠ è½½è¦†ç›–ç¬¬ä¸€ä¸ªå¡ç‰‡
            let loadingOverlay = profileCard.querySelector('.loading-overlay');

            if (show) {
                if (!loadingOverlay) {
                    loadingOverlay = document.createElement('div');
                    loadingOverlay.className = 'loading-overlay';
                    loadingOverlay.innerHTML = '<div class="spinner"></div>';
                    profileCard.style.position = 'relative'; // ç¡®ä¿çˆ¶å…ƒç´ æœ‰å®šä½
                    profileCard.appendChild(loadingOverlay);
                }
                loadingOverlay.style.display = 'flex';
            } else {
                if (loadingOverlay) {
                    loadingOverlay.style.display = 'none';
                }
            }
        }

        // åˆ‡æ¢å¯†ç å¯è§æ€§
        function togglePassword(id) {
            const input = document.getElementById(id);
            const icon = input.nextElementSibling.querySelector('i');
            if (input.type === 'password') {
                input.type = 'text';
                icon.className = 'fas fa-eye-slash';
            } else {
                input.type = 'password';
                icon.className = 'fas fa-eye';
            }
        }

        // æ£€æŸ¥å¯†ç å¼ºåº¦
        function checkPasswordStrength() {
            const newPassword = document.getElementById('newPassword').value;
            const strengthBar = document.getElementById('passwordStrength');
            const strengthText = document.getElementById('passwordStrengthText');

            if (newPassword.length === 0) {
                strengthBar.style.display = 'none';
                strengthText.textContent = '';
                return;
            }

            strengthBar.style.display = 'block';
            let score = 0;
            if (newPassword.length >= 8) score++;
            if (newPassword.length >= 12) score++;
            if (/[A-Z]/.test(newPassword)) score++;
            if (/[a-z]/.test(newPassword)) score++;
            if (/\d/.test(newPassword)) score++;
            if (/[!@#$%^&*()_+[\]{};':"\\|,.<>/?]/.test(newPassword)) score++;

            let strength = '';
            let barClass = '';
            if (score < 3) {
                strength = 'å¼±';
                barClass = 'weak';
            } else if (score < 5) {
                strength = 'ä¸­';
                barClass = 'medium';
            } else {
                strength = 'å¼º';
                barClass = 'strong';
            }

            strengthBar.className = `password-strength ${barClass}`;
            strengthText.textContent = `å¯†ç å¼ºåº¦: ${strength}`;
        }

        // å¤´åƒä¸Šä¼ 
        function uploadAvatar() {
            document.getElementById('avatarInput').click();
        }

        async function handleAvatarUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (file.size > 2 * 1024 * 1024) { // 2MB é™åˆ¶
                showToast('å›¾ç‰‡å¤§å°ä¸èƒ½è¶…è¿‡2MB', 'warning');
                return;
            }

            const formData = new FormData();
            formData.append('file', file);

            try {
                showLoading(true);
                // å‡è®¾åç«¯æœ‰ä¸€ä¸ªæ–‡ä»¶ä¸Šä¼ APIï¼Œè¿™é‡Œéœ€è¦æ ¹æ®å®é™…APIè°ƒæ•´
                // ä¾‹å¦‚ï¼š/api/upload/avatar
                const response = await apiClient.post('/upload/avatar', formData, {
                    headers: {
                        'Content-Type': 'multipart/form-data'
                    }
                });

                if (response.success && response.data && response.data.url) {
                    // æ›´æ–°ç”¨æˆ·èµ„æ–™ä¸­çš„å¤´åƒURL
                    const updateData = { avatar: response.data.url };
                    const profileUpdateResponse = await apiClient.put('/users/profile', updateData);

                    if (profileUpdateResponse.success) {
                        showToast('å¤´åƒä¸Šä¼ æˆåŠŸï¼', 'success');
                        await loadUserProfile(); // é‡æ–°åŠ è½½ç”¨æˆ·èµ„æ–™ä»¥æ›´æ–°å¤´åƒæ˜¾ç¤º
                    } else {
                        throw new Error(profileUpdateResponse.message || 'æ›´æ–°ç”¨æˆ·èµ„æ–™å¤±è´¥');
                    }
                } else {
                    throw new Error(response.message || 'å¤´åƒä¸Šä¼ å¤±è´¥');
                }
            } catch (error) {
                console.error('å¤´åƒä¸Šä¼ å¤±è´¥:', error);
                showToast('å¤´åƒä¸Šä¼ å¤±è´¥: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        // PINéªŒè¯ç›¸å…³åŠŸèƒ½ - ä½¿ç”¨æ–°çš„PINéªŒè¯æœåŠ¡
        // åˆå§‹åŒ–PINè®¾ç½®
        async function initPinSettings() {
            try {
                if (!window.pinVerificationService) {
                    console.warn('PINéªŒè¯æœåŠ¡æœªåŠ è½½');
                    return;
                }

                const pinService = window.pinVerificationService;
                
                // ä»æœåŠ¡å™¨è·å–æœ€æ–°PINçŠ¶æ€
                await pinService.refreshPinStatus();
                const settings = pinService.getSettings();
                
                console.log('ğŸ“Œ åˆå§‹åŒ–PINè®¾ç½®:', settings);
                updatePinUI();
            } catch (error) {
                console.error('åˆå§‹åŒ–PINè®¾ç½®å¤±è´¥:', error);
                showToast('åŠ è½½PINè®¾ç½®å¤±è´¥: ' + error.message, 'warning');
            }
        }

        // æ›´æ–°PIN UI
        function updatePinUI() {
            if (!window.pinVerificationService) return;

            const pinService = window.pinVerificationService;
            const settings = pinService.getSettings();

            const pinToggle = document.getElementById('pinEnabledToggle');
            const pinStatusInfo = document.getElementById('pinStatusInfo');
            const pinActions = document.getElementById('pinActions');
            const setPinBtn = document.getElementById('setPinBtn');
            const changePinBtn = document.getElementById('changePinBtn');
            const pinStatus = document.getElementById('pinStatus');
            const pinLockTimeSelect = document.getElementById('pinLockTimeSelect');

            if (pinToggle) {
                pinToggle.checked = settings.enabled;
            }

            if (pinStatusInfo && pinActions) {
                if (settings.enabled) {
                    pinStatusInfo.style.display = 'block';
                    pinActions.style.display = 'block';

                    if (settings.hasPin) {
                        setPinBtn.style.display = 'none';
                        changePinBtn.style.display = 'inline-block';
                        pinStatus.innerHTML = '<i class="fas fa-check-circle"></i> å·²è®¾ç½®';
                        pinStatus.className = 'status-badge verified';
                    } else {
                        setPinBtn.style.display = 'inline-block';
                        changePinBtn.style.display = 'none';
                        pinStatus.innerHTML = '<i class="fas fa-exclamation-circle"></i> æœªè®¾ç½®';
                        pinStatus.className = 'status-badge unverified';
                    }
                } else {
                    pinStatusInfo.style.display = 'none';
                    pinActions.style.display = 'none';
                }
            }

            if (pinLockTimeSelect) {
                pinLockTimeSelect.value = settings.lockTimeMinutes || 5;
                console.log(`ğŸ“ è®¾ç½®é”å®šæ—¶é—´é€‰æ‹©å™¨å€¼ä¸º: ${settings.lockTimeMinutes || 5} åˆ†é’Ÿ`);
            }
        }

        // å¤„ç†PINå¼€å…³å˜åŒ–
        async function handlePinToggleChange(event) {
            if (!window.pinVerificationService) return;

            const pinService = window.pinVerificationService;
            const isEnabled = event.target.checked;
            const currentSettings = pinService.getSettings();
            
            try {
                // åˆ·æ–°æœ€æ–°PINçŠ¶æ€
                await pinService.refreshPinStatus();
                const latestSettings = pinService.getSettings();
                
                if (isEnabled) {
                    // ç”¨æˆ·æƒ³è¦å¼€å¯PINéªŒè¯
                    if (!latestSettings.hasPin) {
                        // æ²¡æœ‰PINç ï¼Œæç¤ºç”¨æˆ·å…ˆè®¾ç½®
                        event.target.checked = false; // é‡ç½®å¼€å…³
                        showToast('è¯·å…ˆè®¾ç½®PINç æ‰èƒ½å¯ç”¨éªŒè¯åŠŸèƒ½', 'warning');
                        showSetPinModal(); // è‡ªåŠ¨æ‰“å¼€è®¾ç½®PINçš„æ¨¡æ€æ¡†
                        return;
                    } else {
                        // æœ‰PINç ï¼Œç›´æ¥å¯ç”¨
                        await pinService.togglePinEnabled(true);
                        showToast('PINéªŒè¯å·²å¯ç”¨', 'success');
                    }
                } else {
                    // ç”¨æˆ·æƒ³è¦å…³é—­PINéªŒè¯ï¼Œéœ€è¦éªŒè¯å½“å‰PIN
                    if (latestSettings.hasPin && latestSettings.enabled) {
                        // éœ€è¦éªŒè¯PINæ‰èƒ½å…³é—­
                        event.target.checked = true; // å…ˆä¿æŒå¼€å¯çŠ¶æ€
                        
                        try {
                            const isValid = await pinService.showVerificationDialog('è¯·è¾“å…¥PINç ä»¥å…³é—­éªŒè¯åŠŸèƒ½');
                            if (isValid) {
                                await pinService.togglePinEnabled(false);
                                event.target.checked = false; // éªŒè¯æˆåŠŸåå…³é—­å¼€å…³
                                showToast('PINéªŒè¯å·²å…³é—­', 'success');
                            } else {
                                // éªŒè¯å¤±è´¥ï¼Œä¿æŒå¼€å¯çŠ¶æ€
                                showToast('PINéªŒè¯å¤±è´¥ï¼Œæ— æ³•å…³é—­', 'error');
                            }
                        } catch (error) {
                            console.error('PINéªŒè¯è¿‡ç¨‹å‡ºé”™:', error);
                            showToast('PINéªŒè¯å¤±è´¥: ' + error.message, 'error');
                        }
                    } else {
                        // å½“å‰æœªå¯ç”¨ï¼Œç›´æ¥è®¾ç½®ä¸ºå…³é—­
                        await pinService.togglePinEnabled(false);
                        showToast('PINéªŒè¯å·²å…³é—­', 'success');
                    }
                }
                
                // æ›´æ–°UI
                updatePinUI();
                
            } catch (error) {
                console.error('PINå¼€å…³åˆ‡æ¢å¤±è´¥:', error);
                showToast('æ“ä½œå¤±è´¥: ' + error.message, 'error');
                // æ¢å¤å¼€å…³çŠ¶æ€
                event.target.checked = currentSettings.enabled;
            }
        }

        // å¤„ç†è‡ªåŠ¨é”å®šæ—¶é—´å˜åŒ–
        async function handlePinLockTimeChange(event) {
            if (!window.pinVerificationService) return;

            const minutes = parseFloat(event.target.value);
            window.pinVerificationService.setLockTimeMinutes(minutes);
            
            // å¦‚æœå½“å‰åœ¨chatroomé¡µé¢ä¸”æœ‰èŠå¤©å®¤æ§åˆ¶å™¨ï¼Œé‡æ–°å¯åŠ¨å®šæ—¶å™¨
            if (window.chatroomController && typeof window.chatroomController.resetAutoLockTimer === 'function') {
                await window.chatroomController.resetAutoLockTimer();
                console.log(`ğŸ”„ å·²é‡ç½®è‡ªåŠ¨é”å®šå®šæ—¶å™¨ä¸º${minutes}åˆ†é’Ÿ`);
            }
            
            // æ˜¾ç¤ºå‹å¥½çš„æ—¶é—´æ ¼å¼
            const timeText = minutes < 1 ? `${minutes * 60}ç§’` : `${minutes}åˆ†é’Ÿ`;
            showToast(`è‡ªåŠ¨é”å®šæ—¶é—´å·²è®¾ç½®ä¸º${timeText}`, 'success');
        }

        // æ˜¾ç¤ºè®¾ç½®PINæ¨¡æ€æ¡†
        function showSetPinModal() {
            const modal = new bootstrap.Modal(document.getElementById('setPinModal'));
            modal.show();
            
            // æ¸…ç©ºè¾“å…¥æ¡†
            document.getElementById('newPin').value = '';
            document.getElementById('confirmNewPin').value = '';
            
            // èšç„¦åˆ°ç¬¬ä¸€ä¸ªè¾“å…¥æ¡†
            document.getElementById('newPin').focus();
        }

        // æ˜¾ç¤ºä¿®æ”¹PINæ¨¡æ€æ¡†
        function showChangePinModal() {
            const modal = new bootstrap.Modal(document.getElementById('changePinModal'));
            modal.show();
            
            // æ¸…ç©ºè¾“å…¥æ¡†
            document.getElementById('currentPin').value = '';
            document.getElementById('newPinChange').value = '';
            document.getElementById('confirmNewPinChange').value = '';
            
            // èšç„¦åˆ°ç¬¬ä¸€ä¸ªè¾“å…¥æ¡†
            document.getElementById('currentPin').focus();
        }

        // ç¡®è®¤è®¾ç½®PIN
        async function confirmSetPin() {
            if (!window.pinVerificationService) {
                showToast('PINéªŒè¯æœåŠ¡æœªåŠ è½½', 'error');
                return;
            }

            const newPin = document.getElementById('newPin').value;
            const confirmNewPin = document.getElementById('confirmNewPin').value;

            // éªŒè¯PINæ ¼å¼
            if (!window.pinVerificationService.validatePinFormat(newPin)) {
                showToast('PINå¿…é¡»æ˜¯4åˆ°6ä½æ•°å­—', 'error');
                return;
            }

            if (newPin !== confirmNewPin) {
                showToast('ä¸¤æ¬¡è¾“å…¥çš„PINç ä¸ä¸€è‡´', 'error');
                return;
            }

            try {
                // è®¾ç½®PINç 
                await window.pinVerificationService.setPin(newPin);
                
                // è®¾ç½®æˆåŠŸåï¼Œè‡ªåŠ¨å¯ç”¨PINéªŒè¯åŠŸèƒ½
                await window.pinVerificationService.togglePinEnabled(true);
                
                showToast('PINè®¾ç½®æˆåŠŸå¹¶å·²å¯ç”¨éªŒè¯åŠŸèƒ½', 'success');
                updatePinUI();
                
                // å…³é—­æ¨¡æ€æ¡†
                const modal = bootstrap.Modal.getInstance(document.getElementById('setPinModal'));
                modal.hide();
            } catch (error) {
                console.error('è®¾ç½®PINå¤±è´¥:', error);
                showToast('è®¾ç½®PINå¤±è´¥: ' + error.message, 'error');
            }
        }

        // ç¡®è®¤ä¿®æ”¹PIN
        async function confirmChangePin() {
            if (!window.pinVerificationService) {
                showToast('PINéªŒè¯æœåŠ¡æœªåŠ è½½', 'error');
                return;
            }

            const currentPin = document.getElementById('currentPin').value;
            const newPin = document.getElementById('newPinChange').value;
            const confirmNewPin = document.getElementById('confirmNewPinChange').value;

            // éªŒè¯è¾“å…¥
            if (!currentPin) {
                showToast('è¯·è¾“å…¥å½“å‰PINç ', 'error');
                return;
            }

            if (!window.pinVerificationService.validatePinFormat(newPin)) {
                showToast('æ–°PINå¿…é¡»æ˜¯4åˆ°6ä½æ•°å­—', 'error');
                return;
            }

            if (newPin !== confirmNewPin) {
                showToast('ä¸¤æ¬¡è¾“å…¥çš„æ–°PINç ä¸ä¸€è‡´', 'error');
                return;
            }

            if (currentPin === newPin) {
                showToast('æ–°PINä¸èƒ½ä¸å½“å‰PINç›¸åŒ', 'error');
                return;
            }

            try {
                await window.pinVerificationService.changePin(currentPin, newPin);
                showToast('PINä¿®æ”¹æˆåŠŸ', 'success');
                
                // å…³é—­æ¨¡æ€æ¡†
                const modal = bootstrap.Modal.getInstance(document.getElementById('changePinModal'));
                modal.hide();
            } catch (error) {
                console.error('ä¿®æ”¹PINå¤±è´¥:', error);
                showToast('ä¿®æ”¹PINå¤±è´¥: ' + error.message, 'error');
            }
        }

        // å…¨å±€å‡½æ•°å£°æ˜
        window.showSetPinModal = showSetPinModal;
        window.showChangePinModal = showChangePinModal;
        window.confirmSetPin = confirmSetPin;
        window.confirmChangePin = confirmChangePin;

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', initProfile);
    </script>
</body>
</html>
