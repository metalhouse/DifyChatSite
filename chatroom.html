<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocket聊天室 - DifyChat</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="assets/images/favicon.svg">
    <link rel="icon" type="image/svg+xml" href="assets/images/favicon-16.svg" sizes="16x16">
    <link rel="alternate icon" href="assets/images/favicon.svg">
    <meta name="theme-color" content="#28a745">
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Socket.IO Client -->
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    
    <style>
        body {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            min-height: 100vh;
            font-family: 'Microsoft YaHei', sans-serif;
            padding-top: 56px;
            margin: 0;
            overflow-x: hidden;
        }

        /* 导航栏样式 */
        .navbar {
            background: linear-gradient(135deg, #28a745, #198754) !important;
            backdrop-filter: blur(10px);
            box-shadow: 0 2px 20px rgba(0,0,0,0.1);
        }

        .navbar-brand {
            font-weight: 700;
            font-size: 1.5rem;
        }

        .user-dropdown-toggle {
            color: rgba(255,255,255,0.8) !important;
            transition: color 0.3s ease;
        }
        
        .user-dropdown-toggle:hover,
        .user-dropdown-toggle:focus,
        .user-dropdown-toggle.show {
            color: rgba(255,255,255,1) !important;
        }

        /* 聊天室容器 */
        .chatroom-container {
            height: calc(100vh - 56px);
            display: flex;
            overflow: hidden;
            width: 100vw;
            max-width: 100%;
        }

        /* 侧边栏 - 聊天室和好友列表 */
        .room-sidebar {
            width: clamp(280px, 25vw, 380px);
            background: rgba(255, 255, 255, 0.95);
            border-right: 1px solid rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
        }

        .sidebar-header {
            padding: clamp(0.5rem, 1.5vw, 0.75rem);
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
            background: transparent;
            color: #1A1A1A;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-shrink: 0;
        }

        /* 侧边栏标签页 */
        .sidebar-tabs {
            border: none;
            flex: 1;
        }

        .sidebar-tabs .nav-link {
            border: none;
            color: #666;
            padding: 0.5rem 0.75rem;
            border-radius: 8px;
            margin-right: 0.25rem;
            font-size: clamp(0.8rem, 2vw, 0.9rem);
            transition: all 0.2s ease;
        }

        .sidebar-tabs .nav-link:hover {
            background: rgba(40, 167, 69, 0.1);
            color: #28a745;
        }

        .sidebar-tabs .nav-link.active {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            box-shadow: 0 2px 8px rgba(40, 167, 69, 0.3);
        }

        /* 好友tab通知红点 */
        .friend-notification-badge {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 8px;
            height: 8px;
            background: #dc3545;
            border-radius: 50%;
            border: 2px solid white;
            animation: pulse-red 2s infinite;
        }

        @keyframes pulse-red {
            0% { 
                transform: scale(1); 
                opacity: 1; 
            }
            50% { 
                transform: scale(1.2); 
                opacity: 0.7; 
            }
            100% { 
                transform: scale(1); 
                opacity: 1; 
            }
        }

        .sidebar-actions {
            display: flex;
            gap: 0.25rem;
        }

        .create-btn {
            background: #28a745;
            color: white;
            border: none;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .create-btn:hover {
            background: #20c997;
            transform: scale(1.05);
        }

        .delete-mode-btn {
            background: #dc3545 !important;
        }

        .delete-mode-btn:hover {
            background: #c82333 !important;
        }

        .delete-mode-btn.active {
            background: #bd2130 !important;
            box-shadow: 0 0 0 3px rgba(220, 53, 69, 0.3);
        }

        .confirm-delete-btn {
            background: #dc3545 !important;
            animation: pulse-red 2s infinite;
        }

        .confirm-delete-btn:hover {
            background: #c82333 !important;
        }

        @keyframes pulse-red {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        /* 标签页内容区域 */
        .tab-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
        }

        .tab-pane {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
        }

        /* 好友搜索 */
        .friend-search {
            padding: 0.75rem;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
            flex-shrink: 0;
        }

        .friend-search .form-control {
            border-radius: 20px;
            border: 1px solid rgba(0, 0, 0, 0.2);
            font-size: 0.85rem;
        }

        .friend-search .form-control:focus {
            border-color: #28a745;
            box-shadow: 0 0 0 0.2rem rgba(40, 167, 69, 0.25);
        }

        .friend-search .btn {
            border-radius: 0 20px 20px 0;
        }

        /* 好友请求提示 */
        .friend-requests-badge {
            padding: 0.5rem;
            flex-shrink: 0;
        }

        .friend-requests-badge .alert {
            padding: 0.5rem;
            margin: 0;
            border-radius: 8px;
            font-size: 0.8rem;
            border: none;
            background: linear-gradient(135deg, #e3f2fd, #bbdefb);
            color: #1565c0;
        }

        .room-list, .friend-list {
            flex: 1;
            overflow-y: auto;
            padding: 0.5rem;
            min-height: 0;
        }

        /* 好友项目样式 */
        .friend-item {
            display: flex;
            align-items: center;
            padding: clamp(0.5rem, 1.5vw, 0.75rem);
            margin-bottom: clamp(0.3rem, 1vw, 0.5rem);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            background: rgba(255, 255, 255, 0.8);
            border: 1px solid transparent;
            color: #1A1A1A;
            position: relative;
        }

        .friend-item:hover {
            background: rgba(40, 167, 69, 0.1);
            border-color: rgba(40, 167, 69, 0.3);
            transform: translateY(-1px);
        }

        .friend-item.active {
            background: linear-gradient(135deg, #17a2b8, #138496);
            color: white;
            box-shadow: 0 4px 12px rgba(23, 162, 184, 0.3);
        }

        .friend-avatar {
            width: clamp(40px, 6vw, 45px);
            height: clamp(40px, 6vw, 45px);
            border-radius: 50%;
            background: linear-gradient(135deg, #17a2b8, #138496);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            margin-right: clamp(0.5rem, 1.5vw, 0.75rem);
            font-size: clamp(0.9rem, 2vw, 1.1rem);
            position: relative;
        }

        .friend-item.active .friend-avatar {
            background: rgba(255, 255, 255, 0.2);
        }

        .friend-info {
            flex: 1;
            min-width: 0;
        }

        .friend-name {
            font-weight: 600;
            margin: 0;
            font-size: clamp(0.8rem, 2vw, 0.9rem);
            color: #1A1A1A;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .friend-item.active .friend-name {
            color: white !important;
        }

        .friend-meta {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-top: 0.25rem;
        }

        .friend-status {
            font-size: clamp(0.65rem, 1.8vw, 0.7rem);
            opacity: 0.7;
            color: #666;
        }

        .friend-item.active .friend-status {
            color: rgba(255, 255, 255, 0.8) !important;
        }

        .online-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #28a745;
            position: absolute;
            bottom: 2px;
            right: 2px;
            border: 2px solid white;
        }

        .offline-indicator {
            background: #6c757d;
        }

        .unread-badge {
            background: #dc3545;
            color: white;
            border-radius: 10px;
            padding: 0.2rem 0.4rem;
            font-size: 0.7rem;
            font-weight: 600;
            min-width: 18px;
            text-align: center;
        }

        /* 房间项目 */
        .room-item {
            display: flex;
            align-items: center;
            padding: clamp(0.5rem, 1.5vw, 0.75rem);
            margin-bottom: clamp(0.3rem, 1vw, 0.5rem);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            background: rgba(255, 255, 255, 0.8);
            border: 1px solid transparent;
            color: #1A1A1A;
        }

        .room-item:hover {
            background: rgba(40, 167, 69, 0.1);
            border-color: rgba(40, 167, 69, 0.3);
            transform: translateY(-1px);
        }

        .room-item.active {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
        }

        .room-avatar {
            width: clamp(40px, 6vw, 50px);
            height: clamp(40px, 6vw, 50px);
            border-radius: 50%;
            background: linear-gradient(135deg, #28a745, #20c997);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            margin-right: clamp(0.5rem, 1.5vw, 0.75rem);
            font-size: clamp(1rem, 2vw, 1.3rem);
        }

        .room-item.active .room-avatar {
            background: rgba(255, 255, 255, 0.2);
        }

        .room-info {
            flex: 1;
        }

        .room-name {
            font-weight: 600;
            margin: 0;
            font-size: clamp(0.8rem, 2vw, 0.95rem);
            color: #1A1A1A;
        }

        .room-item.active .room-name {
            color: white !important;
        }

        .room-meta {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-top: 0.25rem;
        }

        .room-members {
            font-size: clamp(0.7rem, 1.8vw, 0.75rem);
            opacity: 0.7;
            color: #666;
        }

        .room-item.active .room-members {
            color: rgba(255, 255, 255, 0.8) !important;
        }

        .room-status {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #28a745;
            margin-left: 0.5rem;
        }

        .room-status.inactive {
            background: #6c757d;
        }

        /* 房间删除模式样式 */
        .room-delete-mode .room-item {
            cursor: default !important;
        }

        .room-delete-mode .room-item:hover {
            transform: none !important;
        }

        .room-checkbox-wrapper {
            position: absolute;
            top: 50%;
            left: 10px;
            transform: translateY(-50%);
            z-index: 2;
        }

        .room-checkbox {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: #dc3545;
        }

        .room-delete-mode .room-item {
            padding-left: 40px;
            position: relative;
        }

        .room-delete-mode .room-avatar.disabled {
            opacity: 0.5;
            filter: grayscale(50%);
        }

        .room-delete-mode .room-item .room-info {
            opacity: 1;
        }

        .room-delete-mode .room-item:has(.room-checkbox:checked) {
            background: rgba(220, 53, 69, 0.1);
            border-color: #dc3545;
        }

        .room-delete-mode .room-item:has(.room-checkbox:checked) .room-name {
            color: #dc3545;
            font-weight: 600;
        }

        /* 聊天区域 */
        .chat-area {
            flex: 1;
            min-width: 0;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* 聊天头部 */
        .chat-header {
            padding: clamp(0.5rem, 2vw, 1rem);
            background: transparent;
            color: #333;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            justify-content: space-between;
            height: clamp(60px, 8vh, 80px);
            flex-shrink: 0;
        }

        .chat-header-left {
            display: flex;
            align-items: center;
        }

        .chat-header h5 {
            margin: 0;
            color: #FDFBF7;
            font-weight: 600;
        }

        .connection-status {
            margin-left: 1rem;
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-size: 0.75rem;
            display: flex;
            align-items: center;
        }

        .connection-status.connected {
            background: rgba(40, 167, 69, 0.2);
            color: #28a745;
        }

        .connection-status.disconnected {
            background: rgba(220, 53, 69, 0.2);
            color: #dc3545;
        }

        .connection-status.connecting {
            background: rgba(255, 193, 7, 0.2);
            color: #ffc107;
        }

        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 0.5rem;
            background: currentColor;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .online-members {
            display: flex;
            align-items: center;
            color: #FDFBF7;
            font-size: 0.85rem;
        }

        .member-avatars {
            display: flex;
            align-items: center;
            margin: var(--space-2, 0.5rem) 0;
        }

        .member-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: linear-gradient(135deg, #007bff, #0056b3);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.875rem;
            font-weight: 600;
            margin: 0 4px;
            border: 2px solid rgba(255, 255, 255, 0.2);
            cursor: pointer;
            transition: all 0.2s ease;
            user-select: none;
            position: relative;
            z-index: 1;
        }

        .member-avatar:hover {
            transform: translateY(-2px) scale(1.1);
            box-shadow: 0 8px 25px rgba(0, 123, 255, 0.3);
            z-index: 10;
            border-color: #007bff;
        }

        .member-avatar:active {
            transform: translateY(-1px) scale(1.05);
        }

        /* 房间管理按钮样式 */
        #deleteRoomBtn {
            background: linear-gradient(135deg, #dc3545, #c82333) !important;
            color: white !important;
            border: none !important;
            transition: all 0.2s ease;
            opacity: 0.9;
        }

        #deleteRoomBtn:hover {
            background: linear-gradient(135deg, #c82333, #bd2130) !important;
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(220, 53, 69, 0.4);
            opacity: 1;
        }

        #deleteRoomBtn:focus {
            box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25) !important;
        }

        #manageMembersBtn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            transition: all 0.2s ease;
        }

        #manageMembersBtn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.05);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        #leaveRoomBtn {
            background: linear-gradient(135deg, #ffc107, #ffca2c) !important;
            color: #212529 !important;
            border: none !important;
            transition: all 0.2s ease;
            opacity: 0.9;
        }

        #leaveRoomBtn:hover {
            background: linear-gradient(135deg, #ffca2c, #ffd43b) !important;
            color: #212529 !important;
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(255, 193, 7, 0.4);
            opacity: 1;
        }

        #leaveRoomBtn:focus {
            box-shadow: 0 0 0 0.2rem rgba(255, 193, 7, 0.25) !important;
        }

        /* 消息区域 */
        .chat-messages {
            flex: 1;
            padding: clamp(0.5rem, 2vw, 1rem);
            overflow-y: auto;
            overflow-x: hidden;
            background: rgba(255, 255, 255, 0.95);
            min-height: 0;
        }

        /* 消息样式 */
        .message {
            margin-bottom: 1rem;
            animation: fadeInUp 0.3s ease;
        }

        .message-user {
            display: flex;
            justify-content: flex-end;
        }

        .message-other {
            display: flex;
            justify-content: flex-start;
        }

        .message-system {
            display: flex;
            justify-content: center;
        }

        .message-agent {
            display: flex;
            justify-content: flex-start;
        }

        /* 发送中消息样式 */
        .message.sending {
            opacity: 0.6;
        }

        .message.sending .message-bubble {
            background: linear-gradient(135deg, #ffc107, #fd7e14) !important;
        }

        .message.sending .message-time {
            color: #856404;
            font-style: italic;
        }

        .message-bubble {
            max-width: clamp(250px, 75vw, 600px);
            padding: clamp(0.5rem, 1.5vw, 0.75rem) clamp(0.75rem, 2vw, 1rem);
            border-radius: 18px;
            position: relative;
            word-wrap: break-word;
            font-size: clamp(0.8rem, 2.2vw, 0.9rem);
            line-height: 1.4;
        }

        .message-user .message-bubble {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
        }

        /* 发送中的消息样式 */
        .message.sending .message-bubble {
            opacity: 0.7;
            background: linear-gradient(135deg, #6c757d, #495057) !important;
        }

        .message.sending .message-time {
            font-style: italic;
            animation: pulse-sending 1.5s infinite;
        }

        @keyframes pulse-sending {
            0%, 100% { opacity: 0.5; }
            50% { opacity: 1; }
        }

        .message-other .message-bubble {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            color: #495057;
            border: 1px solid rgba(0, 0, 0, 0.1);
        }

        .message-agent .message-bubble {
            background: linear-gradient(135deg, #e3f2fd, #bbdefb);
            color: #1565c0;
            border: 1px solid rgba(25, 118, 210, 0.2);
        }

        .message-system .message-bubble {
            background: rgba(255, 193, 7, 0.2);
            color: #856404;
            border: 1px solid rgba(255, 193, 7, 0.3);
            text-align: center;
            font-style: italic;
        }

        .message-header {
            display: flex;
            align-items: center;
            margin-bottom: 0.25rem;
            font-size: 0.75rem;
            opacity: 0.8;
        }

        .message-sender {
            font-weight: 600;
            margin-right: 0.5rem;
        }

        .message-time {
            font-size: 0.7rem;
            opacity: 0.7;
        }

        .message-content {
            margin-bottom: 0.25rem;
        }

        /* 消息已读状态指示器 */
        .message-read-status {
            position: relative;
            display: inline-block;
            margin-left: 0.5rem;
        }

        .message-read-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #6f42c1; /* 改为紫色 */
            display: inline-block;
            position: relative;
            animation: read-pulse 2s ease-in-out;
        }

        @keyframes read-pulse {
            0% {
                opacity: 0;
                transform: scale(0.5);
            }
            50% {
                opacity: 1;
                transform: scale(1.2);
            }
            100% {
                opacity: 1;
                transform: scale(1);
            }
        }

        .message-read-indicator::after {
            content: '';
            position: absolute;
            width: 4px;
            height: 4px;
            border-radius: 50%;
            background-color: rgba(255, 255, 255, 0.8);
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        /* 只在用户自己发送的消息上显示已读指示器 */
        .message-user .message-read-status {
            position: absolute;
            bottom: 4px;
            right: 8px;
        }

        .reply-preview {
            background: rgba(0, 0, 0, 0.1);
            padding: 0.25rem 0.5rem;
            border-radius: 6px;
            margin-bottom: 0.5rem;
            font-size: 0.8em;
            border-left: 3px solid rgba(0, 0, 0, 0.3);
        }

        /* 正在输入指示器 */
        .typing-indicators {
            padding: 0.5rem 1rem;
            background: rgba(255, 255, 255, 0.9);
            border-top: 1px solid rgba(0, 0, 0, 0.1);
            min-height: 40px;
            display: flex;
            align-items: center;
        }

        .typing-indicator {
            display: flex;
            align-items: center;
            font-size: 0.85rem;
            color: #666;
        }

        .typing-dots {
            display: inline-block;
            margin-left: 0.5rem;
        }

        .typing-dot {
            display: inline-block;
            width: 4px;
            height: 4px;
            border-radius: 50%;
            background: #666;
            margin: 0 1px;
            animation: typing 1.5s infinite;
        }

        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {
            0%, 60%, 100% {
                transform: translateY(0);
            }
            30% {
                transform: translateY(-10px);
            }
        }

        /* 输入区域 */
        .chat-input {
            padding: clamp(0.5rem, 2vw, 1rem);
            background: rgba(255, 255, 255, 0.95);
            border-top: 1px solid rgba(0, 0, 0, 0.1);
            flex-shrink: 0;
        }

        .input-group {
            display: flex;
            gap: clamp(0.3rem, 1vw, 0.5rem);
            align-items: flex-end;
        }

        .input-group textarea {
            flex: 1;
            min-width: 0;
            border-radius: 20px;
            border: 1px solid rgba(0, 0, 0, 0.2);
            padding: clamp(0.5rem, 1.5vw, 0.75rem) clamp(0.75rem, 2vw, 1rem);
            resize: none;
            font-size: clamp(0.8rem, 2vw, 0.9rem);
            max-width: 100%;
            box-sizing: border-box;
            min-height: 44px;
            max-height: 120px;
        }

        .input-group textarea:focus {
            border-color: #28a745;
            box-shadow: 0 0 0 0.2rem rgba(40, 167, 69, 0.25);
        }

        .input-actions {
            display: flex;
            gap: 0.5rem;
        }

        .action-button {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .send-button {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
        }

        .send-button:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
        }

        .send-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .mention-button {
            background: linear-gradient(135deg, #17a2b8, #138496);
            color: white;
        }

        .mention-button:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(23, 162, 184, 0.3);
        }

        /* 加载状态 */
        /* 模态框和好友功能样式 */
        .user-search-result {
            display: flex;
            align-items: center;
            padding: 0.75rem;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            margin-bottom: 0.5rem;
            transition: all 0.2s ease;
        }

        .user-search-result:hover {
            background: rgba(40, 167, 69, 0.05);
            border-color: #28a745;
        }

        .search-result-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #6c757d, #495057);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            margin-right: 0.75rem;
            font-weight: 600;
        }

        .search-result-info {
            flex: 1;
        }

        .search-result-name {
            font-weight: 600;
            margin: 0;
            color: #212529;
        }

        .search-result-status {
            font-size: 0.8rem;
            color: #6c757d;
            margin-top: 0.25rem;
        }

        .friend-request-item {
            display: flex;
            align-items: center;
            padding: 1rem;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            margin-bottom: 0.75rem;
            background: white;
            transition: all 0.2s ease;
        }

        .friend-request-item:hover {
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            transform: translateY(-1px);
        }

        .request-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #17a2b8, #138496);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            margin-right: 1rem;
            font-weight: 600;
            font-size: 1.2rem;
        }

        .request-info {
            flex: 1;
        }

        .request-name {
            font-weight: 600;
            margin: 0 0 0.25rem 0;
            color: #212529;
        }

        .request-message {
            font-size: 0.9rem;
            color: #6c757d;
            margin: 0 0 0.25rem 0;
        }

        .request-time {
            font-size: 0.8rem;
            color: #adb5bd;
        }

        .request-actions {
            display: flex;
            gap: 0.5rem;
        }

        .status-badge {
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-badge.pending {
            background: rgba(255, 193, 7, 0.2);
            color: #856404;
        }

        .status-badge.accepted {
            background: rgba(40, 167, 69, 0.2);
            color: #155724;
        }

        .status-badge.declined {
            background: rgba(220, 53, 69, 0.2);
            color: #721c24;
        }

        .status-badge.none {
            background: rgba(108, 117, 125, 0.2);
            color: #495057;
        }

        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            color: #6c757d;
        }

        .spinner {
            width: 32px;
            height: 32px;
            border: 3px solid rgba(0, 0, 0, 0.1);
            border-top: 3px solid #28a745;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 0.5rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Toast通知样式 */
        #toastContainer {
            z-index: 1100;
        }

        .toast-notification {
            padding: 1rem 1.25rem;
            margin-bottom: 0.5rem;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            opacity: 0;
            transform: translateX(100%);
            transition: all 0.3s ease;
            max-width: 350px;
            word-wrap: break-word;
        }

        .toast-notification.show {
            opacity: 1;
            transform: translateX(0);
        }

        .toast-notification.toast-success {
            background: linear-gradient(135deg, #28a745, #20c997);
        }

        .toast-notification.toast-error {
            background: linear-gradient(135deg, #dc3545, #c82333);
        }

        .toast-notification.toast-warning {
            background: linear-gradient(135deg, #ffc107, #e0a800);
            color: #856404;
        }

        .toast-notification.toast-info {
            background: linear-gradient(135deg, #17a2b8, #138496);
        }

        /* 响应式设计 */
        @media (max-width: 768px) {
            .room-sidebar {
                position: fixed;
                left: -100%;
                top: 56px;
                height: calc(100vh - 56px);
                z-index: 1000;
                transition: left 0.3s ease;
                background: rgba(255, 255, 255, 0.98) !important;
                backdrop-filter: blur(10px);
                width: 80vw !important;
                max-width: 320px;
            }

            .room-sidebar.show {
                left: 0;
            }

            .chatroom-container {
                width: 100%;
            }

            .chat-area {
                width: 100%;
            }

            .chat-header h5 {
                font-size: 1.1rem;
            }

            .online-members {
                display: none;
            }
        }

        /* 侧边栏遮罩层 */
        .sidebar-overlay {
            display: none;
            position: fixed;
            top: 56px;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 999;
        }

        @media (max-width: 768px) {
            .room-sidebar.show ~ .sidebar-overlay {
                display: block;
            }
        }

        /* 滚动条样式 */
        .room-list::-webkit-scrollbar,
        .chat-messages::-webkit-scrollbar {
            width: 6px;
        }

        .room-list::-webkit-scrollbar-track,
        .chat-messages::-webkit-scrollbar-track {
            background: transparent;
        }

        .room-list::-webkit-scrollbar-thumb,
        .chat-messages::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 3px;
        }

        .room-list::-webkit-scrollbar-thumb:hover,
        .chat-messages::-webkit-scrollbar-thumb:hover {
            background: rgba(0, 0, 0, 0.3);
        }

        /* 消息管理相关样式 */
        .message-select-wrapper {
            position: relative;
            display: flex;
            align-items: flex-start;
        }

        .message-checkbox {
            margin-right: 0.5rem;
            margin-top: 0.25rem;
            flex-shrink: 0;
        }

        .message-actions {
            position: absolute;
            top: 0;
            right: 0;
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .message:hover .message-actions {
            opacity: 1;
        }

        .message-selection-toolbar {
            position: sticky;
            top: 0;
            z-index: 10;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
            border-radius: 8px 8px 0 0;
        }

        .message-context-menu {
            position: fixed;
            z-index: 1050;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .search-result-item {
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .search-result-item:hover {
            background-color: #f8f9fa;
        }

        .search-result-content mark {
            background-color: #fff3cd;
            padding: 0.1em 0.2em;
            border-radius: 3px;
        }

        /* 私聊操作按钮样式 */
        .private-chat-actions .btn {
            border-color: rgba(255, 255, 255, 0.5);
            color: rgba(255, 255, 255, 0.8);
        }

        .private-chat-actions .btn:hover {
            border-color: rgba(255, 255, 255, 0.8);
            color: white;
            background-color: rgba(255, 255, 255, 0.1);
        }

        /* 快捷删除按钮特殊样式 */
        .private-chat-actions .btn-outline-danger {
            border-color: rgba(220, 53, 69, 0.8);
            color: rgba(220, 53, 69, 0.9);
        }

        .private-chat-actions .btn-outline-danger:hover:not(:disabled) {
            border-color: #dc3545;
            color: white;
            background-color: #dc3545;
        }

        .private-chat-actions .btn-outline-danger:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* 房间成员管理相关样式 */
        .room-members-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .member-item {
            display: flex;
            align-items: center;
            padding: 12px;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            margin-bottom: 8px;
            transition: all 0.3s ease;
        }

        .member-item:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-color: #28a745;
        }

        .member-avatar {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            font-weight: bold;
            margin-right: 12px;
        }

        .member-info {
            flex: 1;
        }

        .member-name {
            font-weight: 600;
            color: #333;
            margin-bottom: 2px;
        }

        .member-role {
            font-size: 0.8rem;
            color: #666;
        }

        .member-role.admin {
            color: #dc3545;
        }

        .member-role.moderator {
            color: #fd7e14;
        }

        .member-actions {
            display: flex;
            gap: 5px;
        }

        .friends-to-invite-list {
            max-height: 350px;
            overflow-y: auto;
        }

        .friend-invite-item {
            display: flex;
            align-items: center;
            padding: 10px;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            margin-bottom: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .friend-invite-item:hover {
            background-color: #f8f9fa;
            border-color: #28a745;
        }

        .friend-invite-item.selected {
            background-color: #d4edda;
            border-color: #28a745;
        }

        .friend-avatar {
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, #6c757d, #495057);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            font-weight: bold;
            margin-right: 10px;
        }

        .selected-friends-list {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .selected-friend-tag {
            display: inline-flex;
            align-items: center;
            padding: 4px 8px;
            background-color: #28a745;
            color: white;
            border-radius: 20px;
            font-size: 0.8rem;
        }

        .selected-friend-tag .remove-btn {
            margin-left: 6px;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .member-status {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-left: 8px;
        }

        .member-status.online {
            background-color: #28a745;
        }

        .member-status.offline {
            background-color: #6c757d;
        }
    </style>
</head>
<body>
    <!-- 导航栏 -->
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="./index.html">
                <i class="fas fa-robot me-2"></i>
                DifyChat
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="./index.html">首页</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="./chat.html">聊天</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="./chatroom.html">聊天室</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="./profile.html">个人资料</a>
                    </li>
                    <li class="nav-item" id="adminNavItem" style="display: none;">
                        <a class="nav-link" href="./admin.html">
                            <i class="fas fa-cogs me-1"></i>管理后台
                        </a>
                    </li>
                </ul>
                <ul class="navbar-nav">
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle user-dropdown-toggle" href="#" id="userDropdown" role="button" data-bs-toggle="dropdown">
                            <i class="fas fa-user-circle me-1"></i>
                            <span id="currentUsername">用户</span>
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item" href="./profile.html">
                                <i class="fas fa-user me-2"></i>个人资料
                            </a></li>
                            <li><a class="dropdown-item" href="./settings.html">
                                <i class="fas fa-cog me-2"></i>设置
                            </a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="#" id="nav-logout">
                                <i class="fas fa-sign-out-alt me-2"></i>退出登录
                            </a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="chatroom-container">
        <!-- 移动端侧边栏遮罩 -->
        <div class="sidebar-overlay" onclick="toggleSidebar()"></div>
        
        <!-- 聊天侧边栏 -->
        <div class="room-sidebar" id="roomSidebar">
            <!-- 侧边栏标签头 -->
            <div class="sidebar-header">
                <ul class="nav nav-tabs sidebar-tabs" id="sidebarTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="rooms-tab" data-bs-toggle="tab" data-bs-target="#rooms-panel" type="button" role="tab">
                            <i class="fas fa-comments me-1"></i>
                            <span class="d-none d-sm-inline">聊天室</span>
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="friends-tab" data-bs-toggle="tab" data-bs-target="#friends-panel" type="button" role="tab">
                            <i class="fas fa-user-friends me-1"></i>
                            <span class="d-none d-sm-inline">好友</span>
                            <span class="friend-notification-badge" id="friendNotificationBadge" style="display: none;"></span>
                        </button>
                    </li>
                </ul>
                <div class="sidebar-actions">
                    <button class="create-btn" id="createRoomBtn" onclick="showCreateRoomModal()" title="创建聊天室">
                        <i class="fas fa-plus"></i>
                    </button>
                    <button class="create-btn delete-mode-btn" id="deleteModeBtn" onclick="toggleDeleteMode()" title="删除房间模式" style="display: block; background: #dc3545;">
                        <i class="fas fa-minus"></i>
                    </button>
                    <button class="create-btn" id="cancelDeleteBtn" onclick="toggleDeleteMode()" title="取消删除" style="display: none; background: #6c757d;">
                        <i class="fas fa-times"></i>
                    </button>
                    <button class="create-btn confirm-delete-btn" id="confirmDeleteBtn" onclick="confirmBatchDelete()" title="确认删除选中的房间" style="display: none; background: #dc3545;">
                        <i class="fas fa-trash"></i>
                    </button>
                    <button class="create-btn" id="addFriendBtn" onclick="showAddFriendModal()" title="添加好友" style="display:none;">
                        <i class="fas fa-user-plus"></i>
                    </button>
                </div>
            </div>

            <!-- 标签页内容 -->
            <div class="tab-content" id="sidebarTabContent">
                <!-- 聊天室列表 -->
                <div class="tab-pane fade show active" id="rooms-panel" role="tabpanel">
                    <div class="room-list" id="roomList">
                        <div class="loading">
                            <div class="spinner"></div>
                            <span>加载聊天室...</span>
                        </div>
                    </div>
                </div>

                <!-- 好友列表 -->
                <div class="tab-pane fade" id="friends-panel" role="tabpanel">
                    <!-- 好友搜索 -->
                    <div class="friend-search">
                        <div class="input-group input-group-sm">
                            <input type="text" class="form-control" id="friendSearchInput" placeholder="搜索好友...">
                            <button class="btn btn-outline-secondary" type="button" id="friendSearchBtn">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                    </div>

                    <!-- 好友请求提示 -->
                    <div class="friend-requests-badge" id="friendRequestsBadge" style="display:none;">
                        <div class="alert alert-info alert-sm">
                            <i class="fas fa-user-clock me-2"></i>
                            <span id="requestsCount">0</span> 个好友请求
                            <button class="btn btn-link btn-sm p-0 ms-2" onclick="showFriendRequestsModal()">查看</button>
                        </div>
                    </div>

                    <!-- 好友列表 -->
                    <div class="friend-list" id="friendList">
                        <div class="loading">
                            <div class="spinner"></div>
                            <span>加载好友列表...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 聊天区域 -->
        <div class="chat-area">
            <!-- 聊天头部 -->
            <div class="chat-header">
                <div class="chat-header-left">
                    <h5 id="currentRoomName">
                        <i class="fas fa-users me-2"></i>
                        请选择聊天室
                    </h5>
                    <div class="connection-status connecting" id="connectionStatus">
                        <span class="status-indicator"></span>
                        <span id="statusText">连接中...</span>
                    </div>
                </div>
                <div class="d-flex align-items-center">
                    <!-- 群聊模式：在线成员显示 -->
                    <div class="online-members" id="onlineMembers">
                        <span>在线成员:</span>
                        <div class="member-avatars" id="memberAvatars">
                            <!-- 在线成员头像将动态添加 -->
                        </div>
                        <button class="btn btn-outline-light btn-sm ms-2" onclick="showRoomMembersModal()" title="管理房间成员" id="manageMembersBtn">
                            <i class="fas fa-cog"></i>
                        </button>
                        <button class="btn btn-warning btn-sm ms-2" onclick="confirmLeaveRoom()" title="离开房间" id="leaveRoomBtn" style="display: none;">
                            <i class="fas fa-sign-out-alt"></i>
                        </button>
                        <button class="btn btn-danger btn-sm ms-2" onclick="confirmDeleteRoom()" title="删除房间" id="deleteRoomBtn">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                    
                    <!-- 私聊模式：搜索和管理按钮 -->
                    <div class="private-chat-actions" id="privateChatActions" style="display: none;">
                        <button class="btn btn-outline-light btn-sm" onclick="window.friendsManager.showSearchDialog()" title="搜索聊天记录">
                            <i class="fas fa-search"></i>
                        </button>
                        <button class="btn btn-outline-light btn-sm ms-2" onclick="window.friendsManager.enterSelectionMode()" title="管理消息">
                            <i class="fas fa-tasks"></i>
                        </button>
                        <!-- 多选模式下显示的按钮 -->
                        <button class="btn btn-outline-danger btn-sm ms-2" id="quickDeleteBtn" style="display: none;" onclick="window.friendsManager.deleteSelectedMessages()" title="删除选中的消息">
                            <i class="fas fa-trash"></i> 删除
                        </button>
                        <button class="btn btn-outline-secondary btn-sm ms-1" id="exitSelectionBtn" style="display: none;" onclick="window.friendsManager.exitSelectionMode()" title="退出选择模式">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    
                    <button class="btn btn-outline-light btn-sm ms-3 d-md-none" onclick="toggleSidebar()" title="显示/隐藏侧边栏">
                        <i class="fas fa-bars"></i>
                    </button>
                </div>
            </div>

            <!-- 消息区域 -->
            <div class="chat-messages" id="chatMessages">
                <div class="text-center text-muted mt-5">
                    <i class="fas fa-users fa-3x mb-3"></i>
                    <h5>欢迎使用 WebSocket 聊天室</h5>
                    <p>请从左侧选择一个聊天室开始群聊，或创建新的聊天室</p>
                </div>
            </div>

            <!-- 正在输入指示器 -->
            <div class="typing-indicators" id="typingIndicators" style="display: none;">
                <!-- 正在输入的用户列表将动态添加 -->
            </div>

            <!-- 输入区域 -->
            <div class="chat-input">
                <div class="input-group">
                    <textarea 
                        id="messageInput" 
                        placeholder="输入您的消息... (Shift+Enter换行，Enter发送，@智能体名 可以@智能体)"
                        rows="1"
                        disabled
                    ></textarea>
                    <div class="input-actions">
                        <button id="mentionButton" class="action-button mention-button" title="@智能体" disabled>
                            <i class="fas fa-at"></i>
                        </button>
                        <button id="sendButton" class="action-button send-button" type="button" title="发送消息" disabled>
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast通知容器 -->
    <div id="toastContainer" class="position-fixed top-0 end-0 p-3" style="z-index: 1100;">
        <!-- Toast消息将动态添加到这里 -->
    </div>

    <!-- 创建聊天室模态框 -->
    <div class="modal fade" id="createRoomModal" tabindex="-1" aria-labelledby="createRoomModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="createRoomModalLabel">
                        <i class="fas fa-plus me-2"></i>创建聊天室
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="createRoomForm">
                        <div class="mb-3">
                            <label for="roomName" class="form-label">聊天室名称</label>
                            <input type="text" class="form-control" id="roomName" placeholder="请输入聊天室名称" required>
                        </div>
                        <div class="mb-3">
                            <label for="roomDescription" class="form-label">聊天室描述 (可选)</label>
                            <textarea class="form-control" id="roomDescription" rows="3" placeholder="请输入聊天室描述"></textarea>
                        </div>
                        <div class="mb-3">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="isPrivate">
                                <label class="form-check-label" for="isPrivate">
                                    私密聊天室 (需要邀请才能加入)
                                </label>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-success" id="modalCreateRoomBtn">
                        <i class="fas fa-plus me-1"></i>创建
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 添加好友模态框 -->
    <div class="modal fade" id="addFriendModal" tabindex="-1" aria-labelledby="addFriendModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addFriendModalLabel">
                        <i class="fas fa-user-plus me-2"></i>
                        添加好友
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- 搜索用户 -->
                    <div class="mb-3">
                        <label for="userSearchInput" class="form-label">搜索用户</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="userSearchInput" placeholder="输入用户名搜索...">
                            <button class="btn btn-outline-primary" type="button" id="userSearchBtn">
                                <i class="fas fa-search"></i> 搜索
                            </button>
                        </div>
                    </div>
                    
                    <!-- 搜索结果 -->
                    <div id="userSearchResults" style="display:none;">
                        <h6 class="mb-3">搜索结果</h6>
                        <div id="searchResultsList">
                            <!-- 搜索结果将动态添加 -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 好友请求管理模态框 -->
    <div class="modal fade" id="friendRequestsModal" tabindex="-1" aria-labelledby="friendRequestsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="friendRequestsModalLabel">
                        <i class="fas fa-user-clock me-2"></i>
                        好友请求
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <ul class="nav nav-tabs mb-3" id="requestTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="received-tab" data-bs-toggle="tab" data-bs-target="#received-requests" type="button" role="tab">
                                <i class="fas fa-inbox me-1"></i>
                                收到的请求
                                <span class="badge bg-primary ms-2" id="receivedCount">0</span>
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="sent-tab" data-bs-toggle="tab" data-bs-target="#sent-requests" type="button" role="tab">
                                <i class="fas fa-paper-plane me-1"></i>
                                发送的请求
                                <span class="badge bg-secondary ms-2" id="sentCount">0</span>
                            </button>
                        </li>
                    </ul>
                    
                    <div class="tab-content" id="requestTabContent">
                        <!-- 收到的好友请求 -->
                        <div class="tab-pane fade show active" id="received-requests" role="tabpanel">
                            <div id="receivedRequestsList">
                                <div class="loading">
                                    <div class="spinner"></div>
                                    <span>加载中...</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 发送的好友请求 -->
                        <div class="tab-pane fade" id="sent-requests" role="tabpanel">
                            <div id="sentRequestsList">
                                <div class="loading">
                                    <div class="spinner"></div>
                                    <span>加载中...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- @智能体选择模态框 -->
    <div class="modal fade" id="mentionAgentModal" tabindex="-1" aria-labelledby="mentionAgentModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="mentionAgentModalLabel">
                        <i class="fas fa-at me-2"></i>选择智能体
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="list-group" id="agentList">
                        <div class="loading">
                            <div class="spinner"></div>
                            <span>加载智能体列表...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 房间成员管理模态框 -->
    <div class="modal fade" id="roomMembersModal" tabindex="-1" aria-labelledby="roomMembersModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="roomMembersModalLabel">
                        <i class="fas fa-users me-2"></i>房间成员管理
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- 功能标签页 -->
                    <ul class="nav nav-tabs mb-3" id="memberManagementTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="members-list-tab" data-bs-toggle="tab" data-bs-target="#members-list" type="button" role="tab">
                                <i class="fas fa-users me-1"></i>
                                当前成员
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="invite-friends-tab" data-bs-toggle="tab" data-bs-target="#invite-friends" type="button" role="tab">
                                <i class="fas fa-user-plus me-1"></i>
                                邀请好友
                            </button>
                        </li>
                    </ul>
                    
                    <div class="tab-content" id="memberManagementTabContent">
                        <!-- 当前成员标签页 -->
                        <div class="tab-pane fade show active" id="members-list" role="tabpanel">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <span class="text-muted">房间成员列表</span>
                                <button class="btn btn-outline-primary btn-sm" onclick="refreshRoomMembers()">
                                    <i class="fas fa-sync-alt me-1"></i>刷新
                                </button>
                            </div>
                            <div class="room-members-list" id="roomMembersList">
                                <div class="loading">
                                    <div class="spinner"></div>
                                    <span>加载成员列表...</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 邀请好友标签页 -->
                        <div class="tab-pane fade" id="invite-friends" role="tabpanel">
                            <div class="mb-3">
                                <div class="input-group">
                                    <input type="text" class="form-control" id="inviteFriendSearch" placeholder="搜索好友...">
                                    <button class="btn btn-outline-secondary" type="button" onclick="searchFriendsToInvite()">
                                        <i class="fas fa-search"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <div class="selected-friends mb-3" id="selectedFriendsContainer" style="display: none;">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <span class="text-muted">已选择的好友:</span>
                                    <button class="btn btn-link btn-sm p-0" onclick="clearSelectedFriends()">清空选择</button>
                                </div>
                                <div class="selected-friends-list" id="selectedFriendsList"></div>
                            </div>
                            
                            <div class="friends-to-invite-list" id="friendsToInviteList">
                                <div class="loading">
                                    <div class="spinner"></div>
                                    <span>加载好友列表...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <div class="d-flex justify-content-between w-100">
                        <div id="inviteActionButtons" style="display: none;">
                            <button type="button" class="btn btn-success" onclick="inviteSelectedFriends()" id="inviteBtn">
                                <i class="fas fa-paper-plane me-1"></i>
                                邀请选中的好友 (<span id="selectedCount">0</span>)
                            </button>
                        </div>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 删除房间确认模态框 -->
    <div class="modal fade" id="deleteRoomModal" tabindex="-1" aria-labelledby="deleteRoomModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title" id="deleteRoomModalLabel">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        删除房间确认
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-danger">
                        <i class="fas fa-warning me-2"></i>
                        <strong>警告：</strong>此操作不可撤销！
                    </div>
                    <p>您即将删除房间：</p>
                    <div class="border rounded p-3 mb-3 bg-light">
                        <div class="d-flex align-items-center">
                            <div class="room-avatar me-3" style="width: 40px; height: 40px; background: linear-gradient(135deg, #dc3545, #c82333);">
                                <i class="fas fa-users"></i>
                            </div>
                            <div>
                                <h6 class="mb-1" id="deleteRoomName">房间名称</h6>
                                <small class="text-muted">
                                    <span id="deleteRoomMemberCount">0</span> 个成员
                                </small>
                            </div>
                        </div>
                    </div>
                    <p class="text-danger">
                        <i class="fas fa-info-circle me-1"></i>
                        删除房间后，所有聊天记录和成员关系将被永久删除，无法恢复。
                    </p>
                    <div class="mb-3">
                        <label for="confirmRoomName" class="form-label">
                            为确认删除，请输入房间名称：
                        </label>
                        <input type="text" class="form-control" id="confirmRoomName" placeholder="输入房间名称确认删除">
                        <div class="form-text">只有输入正确的房间名称才能删除</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i>取消
                    </button>
                    <button type="button" class="btn btn-danger" id="confirmDeleteRoomBtn" disabled onclick="executeDeleteRoom()">
                        <i class="fas fa-trash me-1"></i>确认删除房间
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 离开房间确认模态框 -->
    <div class="modal fade" id="leaveRoomModal" tabindex="-1" aria-labelledby="leaveRoomModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-warning text-dark">
                    <h5 class="modal-title" id="leaveRoomModalLabel">
                        <i class="fas fa-sign-out-alt me-2"></i>
                        离开房间确认
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>提示：</strong>您可以随时重新加入此房间。
                    </div>
                    <p>您即将离开房间：</p>
                    <div class="border rounded p-3 mb-3 bg-light">
                        <div class="d-flex align-items-center">
                            <div class="room-avatar me-3" style="width: 40px; height: 40px; background: linear-gradient(135deg, #ffc107, #ffca2c);">
                                <i class="fas fa-users"></i>
                            </div>
                            <div>
                                <h6 class="mb-1" id="leaveRoomName">房间名称</h6>
                                <small class="text-muted">
                                    您将离开此房间
                                </small>
                            </div>
                        </div>
                    </div>
                    <p class="text-muted">
                        <i class="fas fa-info-circle me-1"></i>
                        离开房间后，您将不再收到此房间的消息通知，但可以随时重新加入。
                    </p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i>取消
                    </button>
                    <button type="button" class="btn btn-warning" id="confirmLeaveRoomBtn" onclick="executeLeaveRoom()">
                        <i class="fas fa-sign-out-alt me-1"></i>确认离开房间
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 批量删除确认对话框 -->
    <div class="modal fade" id="confirmBatchDeleteModal" tabindex="-1" aria-labelledby="confirmBatchDeleteModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title" id="confirmBatchDeleteModalLabel">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        确认删除房间
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="关闭"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-warning d-flex align-items-center mb-3">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <div>
                            <strong>警告：</strong>此操作将永久删除选中的房间及其所有消息记录，无法恢复！
                        </div>
                    </div>
                    
                    <p class="mb-2">您即将删除以下 <strong id="deleteRoomCount">0</strong> 个房间：</p>
                    <ul class="list-group mb-3" id="selectedRoomsList">
                        <!-- 动态填充房间列表 -->
                    </ul>
                    
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="confirmDeleteCheckbox">
                        <label class="form-check-label text-danger" for="confirmDeleteCheckbox">
                            <strong>我确认要删除这些房间</strong>
                        </label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-danger" id="executeBatchDeleteBtn" onclick="chatroomController.executeBatchDelete()" disabled>
                        <i class="fas fa-trash-alt me-1"></i>
                        确认删除
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- 开发工具 -->
    <script src="js/utils/dev-tools.js?v=1.0.0"></script>
    <script src="js/utils/health-checker.js?v=1.0.0"></script>
    
    <!-- 全局配置 -->
    <script type="module" src="config/env.js?v=2.0.0"></script>
    <script type="module" src="config/global-config.js?v=2.0.0"></script>
    <script src="config/global-config-simple.js"></script>
    
    <!-- 引入工具类和服务 -->
    <script src="js/utils/storage-simple.js"></script>
    <script src="js/utils/token-manager.js"></script>
    <script src="js/utils/error-handler-simple.js"></script>
    <script src="js/services/auth-service-simple.js"></script>
    
    <!-- 房间管理服务 (ES模块) -->
    <script type="module" src="js/services/room-management.js"></script>
    
    <!-- 好友API服务 -->
    <script src="js/api/friends-api.js"></script>
    
    <!-- 好友管理器 -->
    <script src="js/services/friends-manager.js"></script>
    
    <!-- 聊天室页面控制器 -->
    <script src="js/controllers/chatroom-controller.js"></script>
    
    <!-- 调试工具（开发环境） -->
    <script src="debug-read-status.js"></script>

    <script>
        // 等待环境配置加载完成
        function waitForEnvConfig(callback, maxAttempts = 50) {
            let attempts = 0;
            
            function check() {
                attempts++;
                
                if (window.ENV_CONFIG) {
                    console.log('✅ 环境配置已加载');
                    callback();
                } else if (attempts < maxAttempts) {
                    setTimeout(check, 100);
                } else {
                    console.warn('⚠️ 环境配置加载超时，使用降级配置');
                    callback();
                }
            }
            
            check();
        }
        
        // 页面初始化
        document.addEventListener('DOMContentLoaded', function() {
            console.log('页面DOM加载完成');
            
            // 初始时隐藏所有房间管理按钮
            const deleteRoomBtn = document.getElementById('deleteRoomBtn');
            const leaveRoomBtn = document.getElementById('leaveRoomBtn');
            const onlineMembers = document.getElementById('onlineMembers');
            if (deleteRoomBtn) {
                deleteRoomBtn.style.display = 'none';
            }
            if (leaveRoomBtn) {
                leaveRoomBtn.style.display = 'none';
            }
            if (onlineMembers) {
                onlineMembers.style.display = 'none';
            }
            
            // 检查用户登录状态
            if (!TokenManager || !TokenManager.getAccessToken()) {
                console.log('用户未登录，跳转到登录页面');
                window.location.href = './login.html';
                return;
            }

            // 初始化标签页切换处理
            handleTabSwitch();

            // 等待环境配置加载完成后初始化
            waitForEnvConfig(function() {
                try {
                    // 初始化聊天室控制器
                    console.log('初始化聊天室控制器');
                    window.chatroomController = new ChatroomController();
                    window.chatroomController.initialize();
                } catch (error) {
                    console.error('初始化聊天室控制器失败:', error);
                    showToast('聊天室初始化失败: ' + error.message, 'error');
                }
            });

            // 好友搜索功能
            const userSearchBtn = document.getElementById('userSearchBtn');
            const userSearchInput = document.getElementById('userSearchInput');
            
            if (userSearchBtn && userSearchInput) {
                userSearchBtn.addEventListener('click', handleUserSearch);
                userSearchInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        handleUserSearch();
                    }
                });
            }

            // 好友列表搜索
            const friendSearchBtn = document.getElementById('friendSearchBtn');
            const friendSearchInput = document.getElementById('friendSearchInput');
            
            if (friendSearchBtn && friendSearchInput) {
                friendSearchBtn.addEventListener('click', handleFriendSearch);
                friendSearchInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        handleFriendSearch();
                    }
                });
            }
        });

        // 用户搜索处理函数
        async function handleUserSearch() {
            const searchInput = document.getElementById('userSearchInput');
            const searchResults = document.getElementById('userSearchResults');
            const resultsList = document.getElementById('searchResultsList');
            
            if (!searchInput || !searchResults || !resultsList) return;
            
            const username = searchInput.value.trim();
            if (!username) {
                showToast('请输入用户名进行搜索', 'warning');
                return;
            }
            
            try {
                resultsList.innerHTML = '<div class="loading"><div class="spinner"></div><span>搜索中...</span></div>';
                searchResults.style.display = 'block';
                
                // 调用好友管理器的搜索功能
                if (window.chatroomController && window.chatroomController.friendsManager) {
                    await window.chatroomController.friendsManager.searchUsers(username, resultsList);
                } else {
                    throw new Error('好友管理器未初始化');
                }
            } catch (error) {
                console.error('搜索用户失败:', error);
                resultsList.innerHTML = '<div class="text-danger">搜索失败: ' + error.message + '</div>';
            }
        }

        // 好友搜索处理函数
        async function handleFriendSearch() {
            const searchInput = document.getElementById('friendSearchInput');
            if (!searchInput) return;
            
            const keyword = searchInput.value.trim();
            
            try {
                if (window.chatroomController && window.chatroomController.friendsManager) {
                    await window.chatroomController.friendsManager.searchFriends(keyword);
                }
            } catch (error) {
                console.error('搜索好友失败:', error);
                showToast('搜索好友失败: ' + error.message, 'error');
            }
        }

        // 侧边栏切换函数
        function toggleSidebar() {
            const sidebar = document.getElementById('roomSidebar');
            sidebar.classList.toggle('show');
        }

        // 创建聊天室模态框
        function showCreateRoomModal() {
            console.log('显示创建房间模态框');
            
            // 清空表单内容
            const form = document.getElementById('createRoomForm');
            if (form) {
                form.reset();
            }
            
            const modal = new bootstrap.Modal(document.getElementById('createRoomModal'));
            modal.show();
        }

        // 添加好友模态框
        function showAddFriendModal() {
            console.log('显示添加好友模态框');
            const modal = new bootstrap.Modal(document.getElementById('addFriendModal'));
            modal.show();
            
            // 清空搜索结果
            document.getElementById('userSearchResults').style.display = 'none';
            document.getElementById('userSearchInput').value = '';
        }

        // 显示好友请求模态框
        function showFriendRequestsModal() {
            console.log('显示好友请求模态框');
            const modal = new bootstrap.Modal(document.getElementById('friendRequestsModal'));
            modal.show();
            
            // 加载好友请求
            if (window.chatroomController && window.chatroomController.friendsManager) {
                window.chatroomController.friendsManager.loadFriendRequests();
            }
        }

        // 标签页切换处理
        function handleTabSwitch() {
            const friendsTab = document.getElementById('friends-tab');
            const roomsTab = document.getElementById('rooms-tab');
            const createRoomBtn = document.getElementById('createRoomBtn');
            const addFriendBtn = document.getElementById('addFriendBtn');
            
            if (friendsTab && roomsTab && createRoomBtn && addFriendBtn) {
                friendsTab.addEventListener('shown.bs.tab', function () {
                    createRoomBtn.style.display = 'none';
                    addFriendBtn.style.display = 'block';
                    
                    // 加载好友列表
                    if (window.chatroomController && window.chatroomController.friendsManager) {
                        window.chatroomController.friendsManager.loadFriendsList();
                        window.chatroomController.friendsManager.loadFriendRequests();
                    }
                });

                roomsTab.addEventListener('shown.bs.tab', function () {
                    createRoomBtn.style.display = 'block';
                    addFriendBtn.style.display = 'none';
                });
            }
        }

        // 全局函数供HTML调用
        window.showCreateRoomModal = showCreateRoomModal;
        window.showAddFriendModal = showAddFriendModal;
        window.showFriendRequestsModal = showFriendRequestsModal;
        
        // 房间成员管理功能
        let selectedFriends = [];
        let currentRoomMembers = [];
        
        // 显示房间成员管理模态框
        function showRoomMembersModal() {
            const modal = new bootstrap.Modal(document.getElementById('roomMembersModal'));
            modal.show();
            
            // 加载房间成员列表
            loadRoomMembers();
            // 加载可邀请的好友列表
            loadFriendsToInvite();
        }
        
        // 加载房间成员列表
        async function loadRoomMembers() {
            const membersList = document.getElementById('roomMembersList');
            
            if (!window.chatroomController?.currentRoom?.id) {
                membersList.innerHTML = '<div class="text-muted">请先选择一个聊天室</div>';
                return;
            }
            
            try {
                membersList.innerHTML = `
                    <div class="loading">
                        <div class="spinner"></div>
                        <span>加载成员列表...</span>
                    </div>
                `;
                
                const roomService = window.chatroomController.roomManagementService;
                if (!roomService) {
                    throw new Error('房间管理服务未初始化');
                }
                
                const members = await roomService.getRoomMembers(window.chatroomController.currentRoom.id);
                currentRoomMembers = members;
                renderRoomMembers(members);
                
            } catch (error) {
                console.error('加载房间成员失败:', error);
                membersList.innerHTML = `<div class="text-danger">加载成员列表失败: ${error.message}</div>`;
            }
        }
        
        // 渲染房间成员列表
        function renderRoomMembers(members) {
            const membersList = document.getElementById('roomMembersList');
            
            if (!members || members.length === 0) {
                membersList.innerHTML = '<div class="text-muted">暂无成员</div>';
                return;
            }
            
            const membersHTML = members.map(member => {
                const initial = (member.username || '?').charAt(0).toUpperCase();
                const isCurrentUser = member.userId === window.chatroomController?.currentUser?.id;
                const canKick = !isCurrentUser && (member.role !== 'admin');
                
                return `
                    <div class="member-item">
                        <div class="member-avatar">${initial}</div>
                        <div class="member-info">
                            <div class="member-name">${member.username || '未知用户'}</div>
                            <div class="member-role ${member.role || 'member'}">${getRoleDisplayName(member.role || 'member')}</div>
                        </div>
                        <div class="member-status ${member.isOnline ? 'online' : 'offline'}"></div>
                        <div class="member-actions">
                            ${canKick ? `
                                <button class="btn btn-outline-danger btn-sm" onclick="kickMember('${member.userId}', '${member.username}')" title="踢出成员">
                                    <i class="fas fa-user-times"></i>
                                </button>
                            ` : ''}
                            ${isCurrentUser ? '<span class="badge bg-primary">我</span>' : ''}
                        </div>
                    </div>
                `;
            }).join('');
            
            membersList.innerHTML = membersHTML;
        }
        
        // 获取角色显示名称
        function getRoleDisplayName(role) {
            const roleNames = {
                'admin': '管理员',
                'moderator': '版主',
                'member': '成员'
            };
            return roleNames[role] || '成员';
        }
        
        // 踢出成员
        async function kickMember(userId, username) {
            if (!confirm(`确定要踢出成员 "${username}" 吗？`)) {
                return;
            }
            
            try {
                const roomService = window.chatroomController.roomManagementService;
                await roomService.removeMember(window.chatroomController.currentRoom.id, userId);
                
                showToast(`成功踢出成员 "${username}"`, 'success');
                loadRoomMembers(); // 重新加载成员列表
                
            } catch (error) {
                console.error('踢出成员失败:', error);
                showToast(`踢出成员失败: ${error.message}`, 'error');
            }
        }
        
        // 刷新房间成员
        function refreshRoomMembers() {
            loadRoomMembers();
        }
        
        // 加载可邀请的好友列表
        async function loadFriendsToInvite() {
            const friendsList = document.getElementById('friendsToInviteList');
            
            try {
                friendsList.innerHTML = `
                    <div class="loading">
                        <div class="spinner"></div>
                        <span>加载好友列表...</span>
                    </div>
                `;
                
                const friendsManager = window.chatroomController?.friendsManager;
                if (!friendsManager) {
                    throw new Error('好友管理器未初始化');
                }
                
                // 确保好友列表已加载
                if (!friendsManager.friends || friendsManager.friends.length === 0) {
                    await friendsManager.loadFriendsList();
                }
                
                // 使用已经处理好的好友数据
                const friends = friendsManager.friends || [];
                
                // 过滤已经在房间里的好友
                const availableFriends = friends.filter(friend => 
                    !currentRoomMembers.some(member => member.userId === friend.id)
                );
                
                renderFriendsToInvite(availableFriends);
                
            } catch (error) {
                console.error('加载好友列表失败:', error);
                friendsList.innerHTML = `<div class="text-danger">加载好友列表失败: ${error.message}</div>`;
            }
        }
        
        // 渲染可邀请的好友列表
        function renderFriendsToInvite(friends) {
            const friendsList = document.getElementById('friendsToInviteList');
            
            if (!friends || friends.length === 0) {
                friendsList.innerHTML = '<div class="text-muted">暂无可邀请的好友或所有好友都已在房间中</div>';
                return;
            }
            
            const friendsHTML = friends.map(friend => {
                const initial = (friend.username || '?').charAt(0).toUpperCase();
                const isSelected = selectedFriends.includes(friend.id);
                
                return `
                    <div class="friend-invite-item ${isSelected ? 'selected' : ''}" onclick="toggleFriendSelection('${friend.id}', '${friend.username}')">
                        <div class="friend-avatar">${initial}</div>
                        <div class="flex-grow-1">
                            <div class="fw-bold">${friend.username || '未知用户'}</div>
                            <div class="text-muted small">${friend.email || ''}</div>
                        </div>
                        <div class="ms-2">
                            <i class="fas fa-check-circle text-success" style="display: ${isSelected ? 'block' : 'none'}"></i>
                        </div>
                    </div>
                `;
            }).join('');
            
            friendsList.innerHTML = friendsHTML;
        }
        
        // 切换好友选择状态
        function toggleFriendSelection(friendId, friendName) {
            const index = selectedFriends.findIndex(f => f.id === friendId);
            
            if (index > -1) {
                // 取消选择
                selectedFriends.splice(index, 1);
            } else {
                // 添加选择
                selectedFriends.push({ id: friendId, name: friendName });
            }
            
            updateSelectedFriendsDisplay();
            updateInviteButton();
        }
        
        // 更新选中好友的显示
        function updateSelectedFriendsDisplay() {
            const container = document.getElementById('selectedFriendsContainer');
            const list = document.getElementById('selectedFriendsList');
            
            if (selectedFriends.length === 0) {
                container.style.display = 'none';
                return;
            }
            
            container.style.display = 'block';
            
            const tagsHTML = selectedFriends.map(friend => `
                <span class="selected-friend-tag">
                    ${friend.name}
                    <span class="remove-btn" onclick="removeFriendSelection('${friend.id}')">&times;</span>
                </span>
            `).join('');
            
            list.innerHTML = tagsHTML;
            
            // 更新UI中的选中状态
            document.querySelectorAll('.friend-invite-item').forEach(item => {
                const friendId = item.getAttribute('onclick').match(/'([^']+)'/)[1];
                const isSelected = selectedFriends.some(f => f.id === friendId);
                
                item.classList.toggle('selected', isSelected);
                const checkIcon = item.querySelector('.fa-check-circle');
                if (checkIcon) {
                    checkIcon.style.display = isSelected ? 'block' : 'none';
                }
            });
        }
        
        // 移除好友选择
        function removeFriendSelection(friendId) {
            const index = selectedFriends.findIndex(f => f.id === friendId);
            if (index > -1) {
                selectedFriends.splice(index, 1);
                updateSelectedFriendsDisplay();
                updateInviteButton();
            }
        }
        
        // 清空选择
        function clearSelectedFriends() {
            selectedFriends = [];
            updateSelectedFriendsDisplay();
            updateInviteButton();
        }
        
        // 更新邀请按钮状态
        function updateInviteButton() {
            const actionButtons = document.getElementById('inviteActionButtons');
            const countSpan = document.getElementById('selectedCount');
            const inviteBtn = document.getElementById('inviteBtn');
            
            if (selectedFriends.length === 0) {
                actionButtons.style.display = 'none';
            } else {
                actionButtons.style.display = 'block';
                countSpan.textContent = selectedFriends.length;
                inviteBtn.disabled = false;
            }
        }
        
        // 邀请选中的好友
        async function inviteSelectedFriends() {
            if (selectedFriends.length === 0) {
                showToast('请先选择要邀请的好友', 'warning');
                return;
            }
            
            const inviteBtn = document.getElementById('inviteBtn');
            const originalText = inviteBtn.innerHTML;
            
            try {
                inviteBtn.disabled = true;
                inviteBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>邀请中...';
                
                const friendIds = selectedFriends.map(f => f.id);
                
                console.log('📋 选中的好友数据:', selectedFriends);
                console.log('📤 提取的好友IDs:', friendIds);
                
                const roomService = window.chatroomController?.roomManagementService;
                
                if (!roomService) {
                    throw new Error('房间管理服务未初始化');
                }
                
                // 使用房间管理服务邀请用户
                const currentRoomId = window.chatroomController.currentRoom.id || 
                                    window.chatroomController.currentRoom.roomId;
                
                if (!currentRoomId) {
                    throw new Error('无法获取当前房间ID');
                }
                
                console.log('🏠 邀请到房间ID:', currentRoomId, '邀请好友IDs:', friendIds);
                
                const result = await roomService.inviteUsers(
                    currentRoomId, 
                    friendIds,
                    'member'
                );
                
                console.log('📥 API响应结果:', result);
                
                // 根据后端API响应格式处理结果
                if (result && result.success && result.data) {
                    const { invited_count, failed_invites } = result.data;
                    
                    if (invited_count > 0) {
                        showToast(`成功邀请 ${invited_count} 位好友加入房间`, 'success');
                    }
                    
                    if (failed_invites && failed_invites.length > 0) {
                        console.warn('部分邀请失败:', failed_invites);
                        const failedCount = failed_invites.length;
                        showToast(`已邀请 ${invited_count} 位好友，${failedCount} 位邀请失败`, 'warning');
                    }
                    
                    if (invited_count === 0 && (!failed_invites || failed_invites.length === 0)) {
                        showToast('没有好友被邀请', 'info');
                    }
                } else if (result && result.success) {
                    // 处理只有success标志的情况
                    showToast(result.message || '邀请发送成功', 'success');
                } else {
                    throw new Error(result?.message || '邀请响应格式异常');
                }
                
                // 重置选择状态
                clearSelectedFriends();
                // 重新加载成员列表和好友列表
                loadRoomMembers();
                loadFriendsToInvite();
                
            } catch (error) {
                console.error('邀请好友失败:', error);
                
                // 尝试提取具体的API错误信息
                let errorMessage = error.message;
                if (error.response && error.response.data) {
                    errorMessage = error.response.data.message || error.message;
                }
                
                showToast(`邀请好友失败: ${errorMessage}`, 'error');
            } finally {
                inviteBtn.disabled = false;
                inviteBtn.innerHTML = originalText;
            }
        }
        
        // 搜索可邀请的好友
        function searchFriendsToInvite() {
            const searchInput = document.getElementById('inviteFriendSearch');
            const keyword = searchInput.value.trim().toLowerCase();
            
            const friendItems = document.querySelectorAll('.friend-invite-item');
            friendItems.forEach(item => {
                const name = item.querySelector('.fw-bold').textContent.toLowerCase();
                const email = item.querySelector('.text-muted').textContent.toLowerCase();
                
                if (name.includes(keyword) || email.includes(keyword)) {
                    item.style.display = 'flex';
                } else {
                    item.style.display = 'none';
                }
            });
        }
        
        // 将房间成员管理功能添加到全局
        window.showRoomMembersModal = showRoomMembersModal;
        window.loadRoomMembers = loadRoomMembers;
        window.loadFriendsToInvite = loadFriendsToInvite;
        window.refreshRoomMembers = refreshRoomMembers;
        window.kickMember = kickMember;
        window.toggleFriendSelection = toggleFriendSelection;
        window.removeFriendSelection = removeFriendSelection;
        window.clearSelectedFriends = clearSelectedFriends;
        window.inviteSelectedFriends = inviteSelectedFriends;
        window.searchFriendsToInvite = searchFriendsToInvite;

        // ========================================
        // 🗑️ 删除房间功能
        // ========================================
        
        // 确认删除房间 - 显示确认对话框
        function confirmDeleteRoom() {
            if (!window.chatroomController || !window.chatroomController.currentRoom) {
                showToast('请先选择一个房间', 'warning');
                return;
            }
            
            const currentRoom = window.chatroomController.currentRoom;
            const currentUser = window.chatroomController.currentUser;
            
            // 检查权限 - 只有房间创建者或管理员可以删除房间
            if (currentRoom.createdBy !== currentUser?.id && 
                currentRoom.owner !== currentUser?.id && 
                currentRoom.ownerId !== currentUser?.id) {
                showToast('只有房间创建者可以删除房间', 'error');
                return;
            }
            
            // 填充模态框信息
            document.getElementById('deleteRoomName').textContent = currentRoom.name || currentRoom.roomName || '未知房间';
            document.getElementById('deleteRoomMemberCount').textContent = currentRoom.memberCount || currentRoom.members?.length || 0;
            
            // 重置表单状态
            const confirmInput = document.getElementById('confirmRoomName');
            const confirmBtn = document.getElementById('confirmDeleteRoomBtn');
            
            confirmInput.value = '';
            confirmBtn.disabled = true;
            confirmBtn.innerHTML = '<i class="fas fa-lock me-1"></i>输入房间名称确认';
            confirmBtn.classList.remove('btn-danger');
            confirmBtn.classList.add('btn-secondary');
            
            // 显示模态框
            const deleteModal = new bootstrap.Modal(document.getElementById('deleteRoomModal'));
            deleteModal.show();
        }
        
        // 监听输入框变化，验证房间名称
        document.addEventListener('DOMContentLoaded', function() {
            const confirmRoomNameInput = document.getElementById('confirmRoomName');
            const confirmDeleteBtn = document.getElementById('confirmDeleteRoomBtn');
            
            if (confirmRoomNameInput && confirmDeleteBtn) {
                confirmRoomNameInput.addEventListener('input', function() {
                    const inputName = this.value.trim();
                    const actualRoomName = document.getElementById('deleteRoomName').textContent;
                    
                    if (inputName === actualRoomName) {
                        confirmDeleteBtn.disabled = false;
                        confirmDeleteBtn.innerHTML = '<i class="fas fa-trash me-1"></i>确认删除房间';
                        confirmDeleteBtn.classList.remove('btn-secondary');
                        confirmDeleteBtn.classList.add('btn-danger');
                    } else {
                        confirmDeleteBtn.disabled = true;
                        confirmDeleteBtn.innerHTML = '<i class="fas fa-lock me-1"></i>输入房间名称确认';
                        confirmDeleteBtn.classList.remove('btn-danger');
                        confirmDeleteBtn.classList.add('btn-secondary');
                    }
                });
            }
        });
        
        // 执行删除房间
        async function executeDeleteRoom() {
            const confirmDeleteBtn = document.getElementById('confirmDeleteRoomBtn');
            const currentRoom = window.chatroomController.currentRoom;
            
            if (!currentRoom) {
                showToast('无法获取当前房间信息', 'error');
                return;
            }
            
            try {
                // 更新按钮状态
                confirmDeleteBtn.disabled = true;
                confirmDeleteBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>删除中...';
                
                // 获取房间管理服务
                const roomService = window.chatroomController.roomManagementService;
                if (!roomService) {
                    throw new Error('房间管理服务未初始化');
                }
                
                console.log('🗑️ 正在删除房间:', currentRoom.id || currentRoom.roomId);
                
                // 调用删除房间API
                const result = await roomService.deleteRoom(currentRoom.id || currentRoom.roomId);
                
                if (result === true) {
                    showToast(`房间 "${currentRoom.name}" 已成功删除`, 'success');
                    
                    // 关闭模态框
                    const deleteModal = bootstrap.Modal.getInstance(document.getElementById('deleteRoomModal'));
                    if (deleteModal) {
                        deleteModal.hide();
                    }
                    
                    // 断开WebSocket连接
                    if (window.chatroomController.websocket) {
                        window.chatroomController.websocket.emit('leave-room', { roomId: currentRoom.id || currentRoom.roomId });
                    }
                    
                    // 清空当前房间状态
                    window.chatroomController.currentRoom = null;
                    
                    // 更新UI
                    document.getElementById('currentRoomName').innerHTML = '<i class="fas fa-users me-2"></i>请选择聊天室';
                    document.getElementById('chatMessages').innerHTML = `
                        <div class="text-center text-muted mt-5">
                            <i class="fas fa-users fa-3x mb-3"></i>
                            <h5>欢迎使用 WebSocket 聊天室</h5>
                            <p>请从左侧选择一个聊天室开始群聊，或创建新的聊天室</p>
                        </div>
                    `;
                    
                    // 隐藏删除按钮和其他房间相关按钮
                    document.getElementById('deleteRoomBtn').style.display = 'none';
                    document.getElementById('leaveRoomBtn').style.display = 'none';
                    document.getElementById('manageMembersBtn').style.display = 'none';
                    document.getElementById('onlineMembers').style.display = 'none';
                    
                    // 禁用输入
                    document.getElementById('messageInput').disabled = true;
                    document.getElementById('sendButton').disabled = true;
                    document.getElementById('mentionButton').disabled = true;
                    
                    // 刷新房间列表
                    setTimeout(() => {
                        if (window.chatroomController && window.chatroomController.loadRooms) {
                            window.chatroomController.loadRooms();
                        }
                    }, 1000);
                    
                } else {
                    throw new Error('删除房间失败');
                }
                
            } catch (error) {
                console.error('删除房间失败:', error);
                showToast(`删除房间失败: ${error.message}`, 'error');
                
                // 恢复按钮状态
                confirmDeleteBtn.disabled = false;
                confirmDeleteBtn.innerHTML = '<i class="fas fa-trash me-1"></i>确认删除房间';
            }
        }
        
        // ========================================
        // 🚪 离开房间功能
        // ========================================
        
        // 确认离开房间 - 显示确认对话框
        function confirmLeaveRoom() {
            if (!window.chatroomController || !window.chatroomController.currentRoom) {
                showToast('请先选择一个房间', 'warning');
                return;
            }
            
            const currentRoom = window.chatroomController.currentRoom;
            const currentUser = window.chatroomController.currentUser;
            
            // 检查是否为房主
            if (currentRoom.creatorId === currentUser?.id) {
                showToast('房主不能离开房间，如需解散房间请使用删除功能', 'error');
                return;
            }
            
            // 填充模态框信息
            document.getElementById('leaveRoomName').textContent = currentRoom.name || currentRoom.roomName || '未知房间';
            
            // 显示模态框
            const leaveModal = new bootstrap.Modal(document.getElementById('leaveRoomModal'));
            leaveModal.show();
        }
        
        // 执行离开房间
        async function executeLeaveRoom() {
            try {
                if (!window.chatroomController || !window.chatroomController.currentRoom) {
                    showToast('请先选择一个房间', 'warning');
                    return;
                }

                const confirmLeaveBtn = document.getElementById('confirmLeaveRoomBtn');
                const originalText = confirmLeaveBtn.innerHTML;
                
                // 显示加载状态
                confirmLeaveBtn.disabled = true;
                confirmLeaveBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>离开中...';

                // 调用控制器的离开房间方法
                await window.chatroomController.leaveRoom();

                // 关闭模态框
                const modal = bootstrap.Modal.getInstance(document.getElementById('leaveRoomModal'));
                if (modal) {
                    modal.hide();
                }

                showToast('已成功离开房间', 'success');
                
            } catch (error) {
                console.error('离开房间失败:', error);
                showToast(`离开房间失败: ${error.message}`, 'error');
                
                // 恢复按钮状态
                const confirmLeaveBtn = document.getElementById('confirmLeaveRoomBtn');
                confirmLeaveBtn.disabled = false;
                confirmLeaveBtn.innerHTML = '<i class="fas fa-sign-out-alt me-1"></i>确认离开房间';
            }
        }
        
        // 将删除房间功能添加到全局
        window.confirmDeleteRoom = confirmDeleteRoom;
        window.executeDeleteRoom = executeDeleteRoom;
        
        // 将离开房间功能添加到全局
        window.confirmLeaveRoom = confirmLeaveRoom;
        window.executeLeaveRoom = executeLeaveRoom;

        // 调试：手动显示删除按钮
        window.showDeleteButton = function() {
            const deleteBtn = document.getElementById('deleteRoomBtn');
            if (deleteBtn) {
                deleteBtn.style.display = 'inline-block';
                deleteBtn.style.visibility = 'visible';
                console.log('🔧 [调试] 手动显示删除按钮');
            } else {
                console.log('❌ [调试] 未找到删除按钮元素');
            }
        };

        // 调试：检查按钮状态
        window.checkDeleteButton = function() {
            const deleteBtn = document.getElementById('deleteRoomBtn');
            if (deleteBtn) {
                console.log('🔍 [调试] 删除按钮状态:', {
                    display: getComputedStyle(deleteBtn).display,
                    visibility: getComputedStyle(deleteBtn).visibility,
                    opacity: getComputedStyle(deleteBtn).opacity,
                    element: deleteBtn
                });
            } else {
                console.log('❌ [调试] 删除按钮不存在');
            }
        };

        // Toast通知函数
        function showToast(message, type = 'info') {
            const toastContainer = document.getElementById('toastContainer');
            const toastId = 'toast-' + Date.now();
            
            const toastHTML = `
                <div id="${toastId}" class="toast-notification toast-${type}">
                    ${message}
                </div>
            `;
            
            toastContainer.insertAdjacentHTML('beforeend', toastHTML);
            
            const toastElement = document.getElementById(toastId);
            
            // 显示动画
            setTimeout(() => {
                toastElement.classList.add('show');
            }, 100);
            
            // 自动隐藏
            setTimeout(() => {
                toastElement.classList.remove('show');
                setTimeout(() => {
                    if (toastElement && toastElement.parentNode) {
                        toastElement.parentNode.removeChild(toastElement);
                    }
                }, 300);
            }, 3000);
        }

        // 全局错误处理
        window.addEventListener('error', function(event) {
            console.error('页面错误:', event.error);
            showToast('页面发生错误，请刷新重试', 'error');
        });

        // 导航栏退出登录
        document.getElementById('nav-logout').addEventListener('click', function(e) {
            e.preventDefault();
            if (window.chatroomController && window.chatroomController.websocket) {
                window.chatroomController.websocket.disconnect();
            }
            AuthService.logout();
            window.location.href = './login.html';
        });

        // 测试辅助函数 - 全局可用
        window.testReadStatus = function() {
            if (window.friendsManager) {
                return window.friendsManager.testReadStatus();
            } else {
                console.log('❌ FriendsManager 未初始化');
                return null;
            }
        };

        window.testWebSocketTiming = function() {
            if (window.friendsManager) {
                return window.friendsManager.testWebSocketTiming();
            } else {
                console.log('❌ FriendsManager 未初始化');
                return null;
            }
        };

        // 显示测试帮助信息
        window.showTestHelp = function() {
            console.log('\n📋 已读状态测试工具');
            console.log('='.repeat(50));
            console.log('🧪 testReadStatus()           - 完整测试已读状态功能');
            console.log('⚡ testWebSocketTiming()      - 快速测试WebSocket延迟');
            console.log('� testWebSocketConnection()  - 测试WebSocket连接状态');
            console.log('�💡 showTestHelp()             - 显示此帮助信息');
            console.log('\n使用方法：');
            console.log('1. 在浏览器控制台输入函数名即可运行');
            console.log('2. 建议先选择一个聊天对象再进行测试');
            console.log('3. 测试期间请观察控制台输出');
            console.log('\n示例：');
            console.log('  testReadStatus();');
            console.log('  testWebSocketTiming();');
            console.log('  testWebSocketConnection();');
            console.log('');
        };

        // 更新帮助信息
        window.showTestHelp = function() {
            console.log('\n📋 已读状态测试工具');
            console.log('='.repeat(60));
            console.log('🧪 testReadStatus()           - 完整测试已读状态功能');
            console.log('⚡ testWebSocketTiming()      - 快速测试WebSocket延迟');
            console.log('🔗 testWebSocketConnection()  - 测试WebSocket连接状态');
            console.log('🔄 forceReconnectWebSocket()  - 强制重新连接WebSocket');
            console.log('🎉 testWebSocketFix()         - 验证WebSocket修复效果（新功能）');
            console.log('💡 showTestHelp()             - 显示此帮助信息');
            console.log('\n🔧 WebSocket问题诊断流程：');
            console.log('1. 运行 testWebSocketConnection() 检查连接状态');
            console.log('2. 如果未连接，运行 forceReconnectWebSocket() 重连');
            console.log('3. 运行 testWebSocketFix() 验证实时通知效果');
            console.log('4. 运行 testReadStatus() 验证完整功能');
            console.log('\n🎯 WebSocket修复验证：');
            console.log('1. testWebSocketFix() - 测试20-30ms实时通知');
            console.log('2. 发送消息后让好友读取，观察延迟时间');
            console.log('3. 预期结果：极低延迟的已读指示器显示');
            console.log('\n使用方法：');
            console.log('1. 在浏览器控制台输入函数名即可运行');
            console.log('2. 建议先选择一个聊天对象再进行测试');
            console.log('3. 测试期间请观察控制台输出');
            console.log('\n示例：');
            console.log('  testWebSocketConnection();  // 先检查连接');
            console.log('  forceReconnectWebSocket();  // 如果需要重连');
            console.log('  testReadStatus();           // 完整功能测试');
            console.log('');
        };

        // WebSocket连接测试
        window.testWebSocketConnection = function() {
            console.log('🔗 WebSocket连接诊断...');
            
            if (!window.chatroomController) {
                console.log('❌ ChatroomController 未初始化');
                return { status: 'controller_not_found' };
            }
            
            const ws = window.chatroomController.websocket;
            if (!ws) {
                console.log('❌ WebSocket客户端不存在');
                console.log('🔍 检查初始化过程...');
                
                // 检查token
                const token = localStorage.getItem('dify_access_token');
                if (!token) {
                    console.log('❌ 未找到访问令牌');
                    return { status: 'no_token' };
                } else {
                    console.log('✅ 访问令牌存在:', token.substring(0, 30) + '...');
                }
                
                // 检查配置
                const config = window.ENV_CONFIG;
                if (config) {
                    console.log('✅ 环境配置存在:');
                    console.log('  API_BASE_URL:', config.API_BASE_URL);
                    console.log('  WS_URL:', config.getWsUrl ? config.getWsUrl() : 'getWsUrl方法不存在');
                    console.log('  ENABLE_WEBSOCKET:', config.ENABLE_WEBSOCKET);
                } else {
                    console.log('❌ 环境配置不存在');
                }
                
                return { status: 'websocket_not_initialized' };
            }
            
            console.log('📊 WebSocket状态信息:');
            console.log('  Connected:', ws.connected);
            console.log('  Socket ID:', ws.id);
            console.log('  Transport:', ws.io?.engine?.transport?.name);
            console.log('  URL:', ws.io?.uri);
            console.log('  ReadyState:', ws.readyState);
            console.log('  Disconnected:', ws.disconnected);
            
            // 详细连接信息
            if (ws.io) {
                console.log('📡 Socket.IO详细信息:');
                console.log('  Engine connected:', ws.io.engine?.readyState);
                console.log('  Engine transport:', ws.io.engine?.transport?.name);
                console.log('  Reconnection attempts:', ws.io._reconnectionAttempts);
                console.log('  Auth:', ws.auth);
            }
            
            // 测试事件发送
            if (ws.connected) {
                console.log('📤 测试事件发送...');
                
                // 测试ping事件（通用测试）
                ws.emit('ping', { timestamp: Date.now(), test: 'websocket_diagnostic' });
                
                // 监听pong响应
                const pongTimeout = setTimeout(() => {
                    console.log('⚠️ 3秒内未收到pong响应，但这可能是正常的（后端可能没有实现ping/pong）');
                }, 3000);
                
                ws.once('pong', (data) => {
                    clearTimeout(pongTimeout);
                    console.log('✅ WebSocket双向通信正常:', data);
                });
                
                // 添加message-read事件专门测试
                console.log('📤 测试message-read事件监听...');
                const originalHandler = window.chatroomController.handleMessageRead;
                let messageReadReceived = false;
                
                // 临时拦截message-read事件
                window.chatroomController.handleMessageRead = (data) => {
                    messageReadReceived = true;
                    console.log('✅ message-read事件响应正常:', data);
                    originalHandler.call(window.chatroomController, data);
                };
                
                // 3秒后检查message-read事件是否能正常接收
                setTimeout(() => {
                    window.chatroomController.handleMessageRead = originalHandler;
                    if (!messageReadReceived) {
                        console.log('ℹ️ message-read事件监听器已就绪，等待实际消息已读事件');
                    }
                }, 3000);
                
            } else {
                console.log('❌ WebSocket未连接，无法测试双向通信');
                
                // 尝试手动连接
                console.log('🔄 尝试手动连接WebSocket...');
                ws.connect();
            }
            
            return {
                status: 'websocket_exists',
                connected: ws.connected,
                id: ws.id,
                transport: ws.io?.engine?.transport?.name,
                url: ws.io?.uri
            };
        };

        // WebSocket强制重连功能
        window.forceReconnectWebSocket = function() {
            console.log('🔄 强制重新连接WebSocket...');
            
            if (!window.chatroomController) {
                console.log('❌ ChatroomController 未初始化');
                return;
            }
            
            // 如果已有连接，先断开
            if (window.chatroomController.websocket) {
                console.log('📴 断开现有WebSocket连接...');
                window.chatroomController.websocket.disconnect();
                window.chatroomController.websocket = null;
            }
            
            // 等待一秒后重新初始化
            setTimeout(() => {
                console.log('🔌 重新初始化WebSocket连接...');
                try {
                    window.chatroomController.initializeWebSocket();
                    console.log('✅ WebSocket重连已启动，请等待连接结果');
                } catch (error) {
                    console.error('❌ WebSocket重连失败:', error);
                }
            }, 1000);
        };

        // 快速验证WebSocket修复效果的测试
        window.testWebSocketFix = function() {
            console.log('🎉 测试WebSocket修复效果...');
            
            if (!window.chatroomController?.websocket?.connected) {
                console.log('❌ WebSocket未连接，请先运行 forceReconnectWebSocket()');
                return;
            }
            
            if (!window.friendsManager?.currentPrivateChat) {
                console.log('❌ 请先选择一个好友开始聊天');
                return;
            }
            
            console.log('✅ 环境检查通过');
            console.log('📊 当前配置:');
            console.log('  - 定期刷新:', window.ENV_CONFIG?.ENABLE_PERIODIC_REFRESH ? '启用' : '已禁用（优化后）');
            console.log('  - 焦点刷新:', window.ENV_CONFIG?.ENABLE_FOCUS_REFRESH ? '启用' : '已禁用（优化后）');
            console.log('  - WebSocket实时:', window.ENV_CONFIG?.WEBSOCKET_REALTIME_READY ? '已修复' : '待修复');
            
            let messageReadReceived = false;
            const startTime = Date.now();
            
            // 监听message-read事件
            const originalHandler = window.chatroomController.handleMessageRead;
            window.chatroomController.handleMessageRead = (data) => {
                if (!messageReadReceived) {
                    messageReadReceived = true;
                    const delay = Date.now() - startTime;
                    console.log(`🎯 message-read事件接收延迟: ${delay}ms`);
                    
                    if (delay < 100) {
                        console.log('🎉 优秀！延迟极低，符合后端20-30ms的预期');
                    } else if (delay < 500) {
                        console.log('✅ 良好！延迟可接受');
                    } else {
                        console.log('⚠️ 延迟较高，可能需要检查网络或服务器');
                    }
                }
                originalHandler.call(window.chatroomController, data);
            };
            
            console.log('👂 message-read事件监听器已就绪');
            console.log('📝 请让好友读取你的消息，观察实时通知效果');
            console.log('⏱️ 根据后端反馈，应该在20-30ms内收到通知');
            
            // 30秒后恢复原处理器
            setTimeout(() => {
                window.chatroomController.handleMessageRead = originalHandler;
                if (!messageReadReceived) {
                    console.log('ℹ️ 未收到message-read事件，请确保好友确实读取了消息');
                } else {
                    console.log('✅ WebSocket实时通知测试完成！');
                }
            }, 30000);
            
            return {
                status: 'monitoring',
                message: '正在监听message-read事件，请让好友读取消息'
            };
        };

        // 全局函数供HTML调用
        window.toggleDeleteMode = () => {
            chatroomController.toggleDeleteMode();
        };

        window.updateDeleteButtonState = () => {
            chatroomController.updateDeleteButtonState();
        };

        window.confirmBatchDelete = () => {
            chatroomController.confirmBatchDelete();
        };

        // 处理确认复选框
        document.getElementById('confirmDeleteCheckbox').addEventListener('change', function() {
            const executeBtn = document.getElementById('executeBatchDeleteBtn');
            executeBtn.disabled = !this.checked;
        });

        // 在线用户测试功能
        window.testOnlineUsers = function() {
            console.log('🔬 测试在线用户功能...');
            if (!window.chatroomController) {
                console.log('❌ ChatroomController 未初始化');
                return;
            }
            
            // 调用测试方法
            window.chatroomController.testRequestOnlineUsers();
            
            // 显示当前在线用户状态
            console.log('👥 当前在线用户:', window.chatroomController.onlineUsers);
            
            // 检查memberAvatars元素
            const memberAvatars = document.getElementById('memberAvatars');
            console.log('🎭 头像容器元素:', memberAvatars);
            console.log('🎭 头像容器内容:', memberAvatars?.innerHTML);
        };

        // 页面加载完成后显示测试提示
        setTimeout(() => {
            if (window.ENV_CONFIG && window.ENV_CONFIG.DEV_TOOLS_ENABLED) {
                console.log('\n🔧 开发工具已启用');
                console.log('输入 showTestHelp() 查看已读状态测试命令');
                console.log('输入 testOnlineUsers() 测试在线用户功能');
            }
        }, 2000);
    </script>
</body>
</html>
