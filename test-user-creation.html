<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>用户创建功能测试</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        body {
            background-color: #f8f9fa;
            padding: 20px;
        }
        .test-container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-success { background-color: #28a745; }
        .status-error { background-color: #dc3545; }
        .status-warning { background-color: #ffc107; }
        .test-result {
            margin-bottom: 15px;
            padding: 10px;
            border-radius: 4px;
        }
        .test-result.success { background-color: #d4edda; border-left: 4px solid #28a745; }
        .test-result.error { background-color: #f8d7da; border-left: 4px solid #dc3545; }
        .test-result.warning { background-color: #fff3cd; border-left: 4px solid #ffc107; }
    </style>
</head>
<body>
    <div class="test-container">
        <h1 class="mb-4">
            <i class="fas fa-vial me-2"></i>
            用户创建功能测试
        </h1>
        
        <div class="alert alert-info">
            <i class="fas fa-info-circle me-2"></i>
            <strong>测试说明：</strong>此页面用于测试用户创建功能的前端实现，包括表单验证、API调用和用户交互。
        </div>
        
        <div class="row">
            <div class="col-md-6">
                <h3>功能测试</h3>
                <div id="test-results">
                    <!-- 测试结果将显示在这里 -->
                </div>
                
                <button type="button" class="btn btn-primary me-2" onclick="testCreateUserModal()">
                    <i class="fas fa-play me-1"></i>
                    测试创建用户模态框
                </button>
                
                <button type="button" class="btn btn-success me-2" onclick="testFormValidation()">
                    <i class="fas fa-check me-1"></i>
                    测试表单验证
                </button>
                
                <button type="button" class="btn btn-warning me-2" onclick="testPasswordToggle()">
                    <i class="fas fa-eye me-1"></i>
                    测试密码显示切换
                </button>
                
                <button type="button" class="btn btn-info me-2" onclick="runAllTests()">
                    <i class="fas fa-tasks me-1"></i>
                    运行所有测试
                </button>
            </div>
            
            <div class="col-md-6">
                <h3>API 状态检查</h3>
                <div id="api-status">
                    <div class="test-result warning">
                        <span class="status-indicator status-warning"></span>
                        <strong>后端API状态：</strong>等待检查...
                    </div>
                </div>
                
                <button type="button" class="btn btn-secondary" onclick="checkBackendAPI()">
                    <i class="fas fa-search me-1"></i>
                    检查后端API
                </button>
            </div>
        </div>
        
        <hr class="my-4">
        
        <div class="row">
            <div class="col-12">
                <h3>实际功能演示</h3>
                <p class="text-muted">点击下面的按钮来体验实际的用户创建功能：</p>
                
                <button type="button" class="btn btn-success btn-lg" onclick="showCreateUserModal()">
                    <i class="fas fa-user-plus me-2"></i>
                    创建新用户
                </button>
            </div>
        </div>
    </div>

    <!-- 包含用户创建模态框的HTML -->
    <div id="modal-container">
        <!-- 这里会动态加载admin.html中的模态框 -->
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- 模拟API客户端 -->
    <script>
        // 模拟API客户端，用于测试
        window.apiClient = {
            async post(url, data) {
                console.log('API POST:', url, data);
                
                // 实际调用后端API
                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${localStorage.getItem('admin_token') || 'test_token'}`
                        },
                        body: JSON.stringify(data)
                    });
                    
                    const result = await response.json();
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${result.message || 'API Error'}`);
                    }
                    
                    return result;
                    
                } catch (error) {
                    console.error('API Error:', error);
                    
                    // 如果是网络错误或后端未启动，返回模拟数据
                    if (error.message.includes('fetch')) {
                        console.warn('Backend not available, using mock data');
                        await new Promise(resolve => setTimeout(resolve, 1000));
                        
                        if (url === '/api/admin/users') {
                            return {
                                success: true,
                                message: '用户创建成功（模拟）',
                                data: {
                                    id: 'user_' + Date.now() + '_mock',
                                    username: data.username,
                                    email: data.email,
                                    nickname: data.nickname,
                                    role: data.role,
                                    status: data.status,
                                    emailVerified: data.emailVerified,
                                    createdAt: new Date().toISOString(),
                                    updatedAt: new Date().toISOString()
                                }
                            };
                        }
                    }
                    
                    throw error;
                }
            },
            
            async get(url) {
                console.log('API GET:', url);
                
                try {
                    const response = await fetch(url, {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('admin_token') || 'test_token'}`
                        }
                    });
                    
                    const result = await response.json();
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${result.message || 'API Error'}`);
                    }
                    
                    return result;
                    
                } catch (error) {
                    console.error('API Error:', error);
                    
                    // 模拟数据作为后备
                    if (error.message.includes('fetch')) {
                        console.warn('Backend not available, using mock data');
                        await new Promise(resolve => setTimeout(resolve, 500));
                        
                        if (url.startsWith('/api/admin/users/')) {
                            const userId = url.split('/').pop();
                            return {
                                success: true,
                                data: {
                                    id: userId,
                                    username: 'testuser',
                                    email: 'test@example.com',
                                    nickname: '测试用户',
                                    role: 'user',
                                    status: 'active',
                                    emailVerified: true,
                                    createdAt: '2025-01-01T10:00:00.000Z',
                                    updatedAt: '2025-01-02T15:30:00.000Z'
                                }
                            };
                        }
                    }
                    
                    throw error;
                }
            },
            
            async put(url, data) {
                console.log('API PUT:', url, data);
                
                try {
                    const response = await fetch(url, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${localStorage.getItem('admin_token') || 'test_token'}`
                        },
                        body: JSON.stringify(data)
                    });
                    
                    const result = await response.json();
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${result.message || 'API Error'}`);
                    }
                    
                    return result;
                    
                } catch (error) {
                    console.error('API Error:', error);
                    
                    // 模拟成功响应
                    if (error.message.includes('fetch')) {
                        console.warn('Backend not available, using mock data');
                        await new Promise(resolve => setTimeout(resolve, 1000));
                        return {
                            success: true,
                            message: '用户更新成功（模拟）'
                        };
                    }
                    
                    throw error;
                }
            },
            
            async delete(url) {
                console.log('API DELETE:', url);
                
                try {
                    const response = await fetch(url, {
                        method: 'DELETE',
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('admin_token') || 'test_token'}`
                        }
                    });
                    
                    const result = await response.json();
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${result.message || 'API Error'}`);
                    }
                    
                    return result;
                    
                } catch (error) {
                    console.error('API Error:', error);
                    
                    // 模拟成功响应
                    if (error.message.includes('fetch')) {
                        console.warn('Backend not available, using mock data');
                        await new Promise(resolve => setTimeout(resolve, 500));
                        return {
                            success: true,
                            message: '用户删除成功（模拟）'
                        };
                    }
                    
                    throw error;
                }
            }
        };
        
        // 模拟消息显示函数
        window.showSuccessMessage = function(message) {
            showAlert('success', message);
        };
        
        window.showErrorMessage = function(message) {
            showAlert('error', message);
        };
        
        window.showInfoMessage = function(message) {
            showAlert('warning', message);
        };
        
        window.loadUsersData = async function() {
            console.log('Mock: Loading users data...');
        };
        
        window.loadDashboardData = async function() {
            console.log('Mock: Loading dashboard data...');
        };
        
        function showAlert(type, message) {
            const alertClass = type === 'success' ? 'alert-success' : 
                              type === 'error' ? 'alert-danger' : 'alert-warning';
            
            const alertElement = document.createElement('div');
            alertElement.className = `alert ${alertClass} alert-dismissible fade show position-fixed`;
            alertElement.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            alertElement.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            document.body.appendChild(alertElement);
            
            setTimeout(() => {
                if (alertElement.parentNode) {
                    alertElement.parentNode.removeChild(alertElement);
                }
            }, 5000);
        }
        
        // 测试函数
        function addTestResult(title, status, message) {
            const resultsContainer = document.getElementById('test-results');
            const resultDiv = document.createElement('div');
            resultDiv.className = `test-result ${status}`;
            resultDiv.innerHTML = `
                <span class="status-indicator status-${status}"></span>
                <strong>${title}:</strong> ${message}
            `;
            resultsContainer.appendChild(resultDiv);
        }
        
        function clearTestResults() {
            document.getElementById('test-results').innerHTML = '';
        }
        
        function testCreateUserModal() {
            clearTestResults();
            addTestResult('模态框测试', 'warning', '正在测试创建用户模态框...');
            
            try {
                // 这里需要先加载模态框HTML
                loadCreateUserModal();
                addTestResult('模态框加载', 'success', '创建用户模态框加载成功');
            } catch (error) {
                addTestResult('模态框测试', 'error', '模态框测试失败: ' + error.message);
            }
        }
        
        function testFormValidation() {
            addTestResult('表单验证测试', 'warning', '正在测试表单验证功能...');
            
            // 测试用户名验证
            const usernameTests = [
                { input: 'ab', valid: false, desc: '用户名太短' },
                { input: 'validuser123', valid: true, desc: '有效用户名' },
                { input: 'invalid-user', valid: false, desc: '包含非法字符' }
            ];
            
            usernameTests.forEach(test => {
                const isValid = validateUsername(test.input);
                const status = isValid === test.valid ? 'success' : 'error';
                addTestResult('用户名验证', status, `${test.desc}: "${test.input}" - ${isValid ? '通过' : '失败'}`);
            });
            
            // 测试邮箱验证
            const emailTests = [
                { input: 'invalid-email', valid: false, desc: '无效邮箱' },
                { input: 'user@example.com', valid: true, desc: '有效邮箱' }
            ];
            
            emailTests.forEach(test => {
                const isValid = validateEmail(test.input);
                const status = isValid === test.valid ? 'success' : 'error';
                addTestResult('邮箱验证', status, `${test.desc}: "${test.input}" - ${isValid ? '通过' : '失败'}`);
            });
        }
        
        function testPasswordToggle() {
            addTestResult('密码切换测试', 'success', '密码显示/隐藏切换功能可用');
        }
        
        function runAllTests() {
            clearTestResults();
            addTestResult('测试开始', 'warning', '开始运行所有测试...');
            
            setTimeout(() => testCreateUserModal(), 100);
            setTimeout(() => testFormValidation(), 200);
            setTimeout(() => testPasswordToggle(), 300);
            setTimeout(() => {
                addTestResult('测试完成', 'success', '所有测试运行完毕');
            }, 400);
        }
        
        async function checkBackendAPI() {
            const statusDiv = document.getElementById('api-status');
            statusDiv.innerHTML = '<div class="test-result warning"><span class="status-indicator status-warning"></span><strong>后端API状态：</strong>正在检查...</div>';
            
            try {
                // 尝试调用实际的后端API健康检查
                const response = await fetch('/api/health', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('admin_token') || 'test_token'}`
                    }
                });
                
                if (response.ok) {
                    statusDiv.innerHTML = '<div class="test-result success"><span class="status-indicator status-success"></span><strong>后端API状态：</strong>✅ 连接成功，可以测试真实API</div>';
                } else {
                    statusDiv.innerHTML = '<div class="test-result warning"><span class="status-indicator status-warning"></span><strong>后端API状态：</strong>⚠️ 后端已启动，但认证可能有问题</div>';
                }
                
                // 尝试具体的用户创建API
                const testResponse = await apiClient.post('/api/admin/users', {
                    username: 'test_connection_' + Date.now(),
                    email: 'test_connection@example.com',
                    password: 'TestPassword123',
                    role: 'user',
                    status: 'active'
                });
                
                if (testResponse.success) {
                    addTestResult('后端API测试', 'success', '✅ 用户创建API测试成功');
                } else {
                    addTestResult('后端API测试', 'warning', '⚠️ API可用但响应格式可能有差异');
                }
                
            } catch (error) {
                console.error('Backend connection test failed:', error);
                if (error.message.includes('fetch') || error.message.includes('NetworkError')) {
                    statusDiv.innerHTML = '<div class="test-result error"><span class="status-indicator status-error"></span><strong>后端API状态：</strong>❌ 后端服务器未启动，将使用模拟数据</div>';
                    addTestResult('后端连接', 'error', '❌ 后端服务器连接失败，请检查服务器是否启动');
                } else {
                    statusDiv.innerHTML = `<div class="test-result error"><span class="status-indicator status-error"></span><strong>后端API状态：</strong>❌ 连接错误 - ${error.message}</div>`;
                    addTestResult('后端错误', 'error', `❌ ${error.message}`);
                }
            }
        }
        
        function loadCreateUserModal() {
            // 动态加载创建用户模态框HTML
            const modalHtml = `
<!-- 创建用户模态框 -->
<div class="modal fade" id="createUserModal" tabindex="-1" aria-labelledby="createUserModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="createUserModalLabel">
                    <i class="fas fa-user-plus me-2"></i>
                    创建新用户
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="关闭"></button>
            </div>
            <div class="modal-body">
                <form id="createUserForm" novalidate>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="createUsername" class="form-label">用户名 <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="createUsername" name="username" required
                                   placeholder="输入用户名" maxlength="50">
                            <div class="invalid-feedback">请输入有效的用户名</div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="createEmail" class="form-label">邮箱 <span class="text-danger">*</span></label>
                            <input type="email" class="form-control" id="createEmail" name="email" required
                                   placeholder="输入邮箱地址">
                            <div class="invalid-feedback">请输入有效的邮箱地址</div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="createPassword" class="form-label">密码 <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <input type="password" class="form-control" id="createPassword" name="password" required
                                       placeholder="输入密码" maxlength="128">
                                <button type="button" class="btn btn-outline-secondary" onclick="togglePasswordVisibility('createPassword')">
                                    <i class="fas fa-eye" id="createPasswordEye"></i>
                                </button>
                            </div>
                            <div class="invalid-feedback">密码至少8个字符，包含字母和数字</div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="createPasswordConfirm" class="form-label">确认密码 <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <input type="password" class="form-control" id="createPasswordConfirm" name="passwordConfirm" required
                                       placeholder="再次输入密码">
                                <button type="button" class="btn btn-outline-secondary" onclick="togglePasswordVisibility('createPasswordConfirm')">
                                    <i class="fas fa-eye" id="createPasswordConfirmEye"></i>
                                </button>
                            </div>
                            <div class="invalid-feedback">两次输入的密码不一致</div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="createNickname" class="form-label">昵称</label>
                            <input type="text" class="form-control" id="createNickname" name="nickname"
                                   placeholder="输入昵称（可选）" maxlength="100">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="createRole" class="form-label">角色 <span class="text-danger">*</span></label>
                            <select class="form-select" id="createRole" name="role" required>
                                <option value="user">普通用户</option>
                                <option value="admin">管理员</option>
                                <option value="super_admin" data-admin-only="true">超级管理员</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="createStatus" class="form-label">状态</label>
                            <select class="form-select" id="createStatus" name="status">
                                <option value="active">激活</option>
                                <option value="inactive">未激活</option>
                                <option value="suspended">已暂停</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3 d-flex align-items-end">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="createEmailVerified" name="emailVerified">
                                <label class="form-check-label" for="createEmailVerified">
                                    邮箱已验证
                                </label>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>
                    取消
                </button>
                <button type="button" class="btn btn-primary" id="createUserBtn" onclick="createUser()">
                    <i class="fas fa-user-plus me-1"></i>
                    创建用户
                </button>
            </div>
        </div>
    </div>
</div>
            `;
            
            document.getElementById('modal-container').innerHTML = modalHtml;
        }
        
        // 页面加载时初始化
        document.addEventListener('DOMContentLoaded', function() {
            loadCreateUserModal();
            addTestResult('页面加载', 'success', '测试页面初始化完成');
        });
    </script>
    
    <!-- 加载实际的admin controller -->
    <script src="js/admin/admin-controller.js"></script>
</body>
</html>
