# ğŸ”§ 401æœªæˆæƒé”™è¯¯ä¿®å¤æŠ¥å‘Š

## ğŸ¯ é—®é¢˜è¯Šæ–­

### é”™è¯¯ç°è±¡
```
Failed to load resource: the server responded with a status of 401 (Unauthorized)
:4005/api/pin/verify:1  Failed to load resource: the server responded with a status of 401 (Unauthorized)
```

### æ ¹æœ¬åŸå› 
**Tokené”®åä¸ä¸€è‡´å¯¼è‡´çš„è®¤è¯å¤±è´¥**

1. **ç³»ç»Ÿæ ‡å‡†Tokené”®å**: `dify_access_token`ï¼ˆTokenManagerä½¿ç”¨ï¼‰
2. **FriendsApiåŸå§‹é…ç½®**: ä¼˜å…ˆæŸ¥æ‰¾ `access_token`
3. **ç»“æœ**: FriendsApiæ‰¾ä¸åˆ°æ­£ç¡®çš„Tokenï¼Œå¯¼è‡´401é”™è¯¯

## ğŸ”¨ ä¿®å¤æªæ–½

### 1. ä¿®å¤FriendsApi Tokenè·å–é€»è¾‘
**æ–‡ä»¶**: `js/api/friends-api.js`

**ä¿®æ”¹å‰**:
```javascript
// æŒ‰ç…§APIæ–‡æ¡£ï¼Œä¼˜å…ˆä½¿ç”¨access_token
let token = localStorage.getItem('access_token');

// å¦‚æœæ²¡æœ‰access_tokenï¼Œå°è¯•å…¶ä»–å¯èƒ½çš„é”®å
if (!token || token === 'null' || token === 'undefined') {
    const fallbackKeys = [
        'dify_access_token',  // ä½œä¸ºå¤‡é€‰é¡¹
        // ...
    ];
}
```

**ä¿®æ”¹å**:
```javascript
// æŒ‰ç…§TokenManagerçš„æ ‡å‡†ï¼Œä¼˜å…ˆä½¿ç”¨dify_access_token
let token = localStorage.getItem('dify_access_token');

// å¦‚æœæ²¡æœ‰dify_access_tokenï¼Œå°è¯•å…¶ä»–å¯èƒ½çš„é”®å
if (!token || token === 'null' || token === 'undefined') {
    const fallbackKeys = [
        'access_token',  // ä½œä¸ºå¤‡é€‰é¡¹
        // ...
    ];
}
```

### 2. æ·»åŠ TokençŠ¶æ€è°ƒè¯•
**æ–‡ä»¶**: `chatroom.html`

æ·»åŠ äº†`debugTokenStatus()`å‡½æ•°æ¥å®æ—¶ç›‘æ§TokençŠ¶æ€ï¼š
```javascript
function debugTokenStatus() {
    console.log('ğŸ”‘ TokençŠ¶æ€æ£€æŸ¥:');
    console.log('- dify_access_token:', !!localStorage.getItem('dify_access_token'));
    console.log('- access_token:', !!localStorage.getItem('access_token'));
    
    if (window.TokenManager) {
        console.log('- TokenManager.getAccessToken():', !!TokenManager.getAccessToken());
    }
}
```

## âœ… ä¿®å¤éªŒè¯

### Tokenè·å–ä¼˜å…ˆçº§ï¼ˆä¿®å¤åï¼‰
1. **ç¬¬ä¸€ä¼˜å…ˆçº§**: `dify_access_token` âœ…
2. **å¤‡é€‰æ–¹æ¡ˆ**: `access_token`ã€`jwt_token`ç­‰

### ç³»ç»Ÿä¸€è‡´æ€§
- **TokenManager**: ä½¿ç”¨ `dify_access_token` âœ…
- **FriendsApi**: ä¼˜å…ˆä½¿ç”¨ `dify_access_token` âœ…
- **PINéªŒè¯æœåŠ¡**: ä½¿ç”¨ `dify_access_token` âœ…
- **å…¶ä»–æœåŠ¡**: ä½¿ç”¨ `TokenManager.getAccessToken()` âœ…

## ğŸ‰ é¢„æœŸç»“æœ

ä¿®å¤åï¼Œä»¥ä¸‹é—®é¢˜å°†å¾—åˆ°è§£å†³ï¼š
1. âœ… **å¥½å‹è¯·æ±‚åŠ è½½ä¸å†æ˜¾ç¤º"å¤±è´¥"**
2. âœ… **PINéªŒè¯APIè°ƒç”¨æˆåŠŸ**
3. âœ… **401æœªæˆæƒé”™è¯¯æ¶ˆé™¤**
4. âœ… **å¥½å‹ç³»ç»ŸåŠŸèƒ½æ­£å¸¸å·¥ä½œ**

## ğŸ” æµ‹è¯•å»ºè®®

### æµè§ˆå™¨æ§åˆ¶å°æ£€æŸ¥
1. æ‰“å¼€chatroom.htmlé¡µé¢
2. æŸ¥çœ‹æ§åˆ¶å°ä¸­çš„"ğŸ”‘ TokençŠ¶æ€æ£€æŸ¥"è¾“å‡º
3. ç¡®è®¤`dify_access_token`å­˜åœ¨ä¸”æœ‰æ•ˆ
4. éªŒè¯å¥½å‹è¯·æ±‚åŠ è½½æ— é”™è¯¯

### åŠŸèƒ½æµ‹è¯•
1. **å¥½å‹æœç´¢** - åº”è¯¥èƒ½æ­£å¸¸æœç´¢ç”¨æˆ·
2. **å¥½å‹è¯·æ±‚** - åº”è¯¥èƒ½æ­£å¸¸å‘é€å’Œæ¥æ”¶è¯·æ±‚
3. **å¥½å‹åˆ—è¡¨** - åº”è¯¥èƒ½æ­£å¸¸åŠ è½½å¥½å‹åˆ—è¡¨
4. **æ²¡æœ‰401é”™è¯¯** - ç½‘ç»œé€‰é¡¹å¡ä¸­ä¸åº”å†å‡ºç°401é”™è¯¯

## ğŸ“ å­¦ä¹ æ€»ç»“

### é—®é¢˜æ•™è®­
1. **Tokené”®åæ ‡å‡†åŒ–å¾ˆé‡è¦** - ç³»ç»Ÿå†…æ‰€æœ‰ç»„ä»¶åº”ä½¿ç”¨ç»Ÿä¸€çš„Tokené”®å
2. **ä¼˜å…ˆçº§è®¾ç½®è¦æ­£ç¡®** - APIåº”è¯¥ä¼˜å…ˆä½¿ç”¨ç³»ç»Ÿæ ‡å‡†é”®å
3. **è°ƒè¯•ä¿¡æ¯å¾ˆæœ‰ä»·å€¼** - æ·»åŠ TokençŠ¶æ€è°ƒè¯•å¸®åŠ©å¿«é€Ÿå®šä½é—®é¢˜

### æœ€ä½³å®è·µ
1. **ç»Ÿä¸€ä½¿ç”¨TokenManager** - æ‰€æœ‰Tokenæ“ä½œéƒ½é€šè¿‡TokenManager
2. **æ ‡å‡†åŒ–é”®å** - åšæŒä½¿ç”¨`dify_access_token`ä½œä¸ºæ ‡å‡†
3. **å®Œå–„çš„å¤‡é€‰æœºåˆ¶** - æä¾›å¤‡é€‰é”®åä»¥å¢å¼ºå…¼å®¹æ€§

---
**ä¿®å¤æ—¶é—´**: 2025-09-07  
**ä¿®å¤çŠ¶æ€**: âœ… å·²å®Œæˆ  
**å½±å“èŒƒå›´**: å¥½å‹ç³»ç»Ÿã€PINéªŒè¯ã€APIè®¤è¯  
**ä¸‹ä¸€æ­¥**: æµ‹è¯•éªŒè¯ä¿®å¤æ•ˆæœ
