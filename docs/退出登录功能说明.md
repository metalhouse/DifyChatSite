# 🚪 退出登录功能完整说明

## 🎯 功能概述

DifyChatSite 现在具备了完整的退出登录功能，支持多种退出方式和自动数据清理。

## 📍 退出登录按钮位置

### 1. 首页 (`index.html`)
- **导航栏用户菜单**: 点击用户头像 → "退出登录"
- **用户名下拉菜单**: 登录后显示的用户菜单中

### 2. 聊天页面 (`chat.html`)  
- **侧边栏用户区域**: 用户信息右侧的退出按钮
- **按钮样式**: 红色退出图标按钮

### 3. 登录页面 (`login.html`)
- **自动检测**: 如果用户已登录会自动跳转

## 🛠️ 技术实现

### LogoutManager 工具类
位置: `js/utils/logout-manager.js`

#### 主要功能:
- ✅ 统一的退出登录API调用
- ✅ 完整的用户数据清理
- ✅ 灵活的配置选项
- ✅ 自动按钮绑定
- ✅ Toast提示支持

#### 核心方法:

```javascript
// 基础退出登录
await LogoutManager.logout();

// 自定义配置退出
await LogoutManager.logout({
    confirm: false,           // 跳过确认对话框
    redirectUrl: './home.html', // 自定义跳转URL
    onSuccess: () => {...},   // 成功回调
    onError: (error) => {...} // 失败回调
});

// 强制退出（无API调用）
LogoutManager.forceLogout('./login.html');

// 检查登录状态
const isLoggedIn = LogoutManager.isLoggedIn();
```

## 📋 数据清理范围

### localStorage 清理项目:
- `dify_access_token` - 访问令牌
- `dify_refresh_token` - 刷新令牌  
- `dify_user_info` - 用户信息
- `dify_user_profile` - 用户配置
- `remember_me` - 记住登录状态

### sessionStorage 清理项目:
- `dify_session_id` - 会话ID
- `dify_current_conversation` - 当前对话

## 🔄 退出登录流程

1. **用户触发**: 点击退出按钮
2. **确认对话框**: 显示"确定要退出登录吗？"（可配置跳过）
3. **API调用**: 调用后端 `/auth/logout` 接口
4. **数据清理**: 清除所有本地存储的认证数据
5. **UI反馈**: 显示成功/失败Toast提示
6. **页面跳转**: 跳转到登录页面（可自定义）

## 🎨 UI设计

### 按钮样式:
- **图标**: Font Awesome `fa-sign-out-alt`
- **颜色**: 危险色调（红色系）
- **交互**: 悬停效果和确认提示

### Toast提示:
- **成功**: 绿色背景，勾选图标
- **失败**: 红色背景，感叹号图标
- **自动消失**: 3秒后自动隐藏

## 🧪 测试功能

### 测试页面: `logout-test.html`
提供完整的退出登录功能测试：

#### 测试项目:
- ✅ 标准退出登录
- ✅ 无确认退出
- ✅ 自定义跳转URL
- ✅ 强制退出
- ✅ 数据清理验证
- ✅ 自动按钮绑定

#### 使用方法:
1. 先在 `login.html` 登录（演示模式）
2. 访问 `logout-test.html`
3. 执行各种退出登录测试
4. 查看测试日志和结果

## 🔧 集成指南

### 在新页面中添加退出登录:

1. **引入脚本**:
```html
<script src="js/api/dify-api.js"></script>
<script src="js/utils/logout-manager.js"></script>
```

2. **添加按钮**（自动绑定）:
```html
<!-- 这些ID/Class会被自动绑定 -->
<button id="logoutBtn">退出登录</button>
<button id="user-logout">退出登录</button>
<button class="logout-btn">退出登录</button>
<button data-action="logout">退出登录</button>
```

3. **手动绑定**:
```javascript
// 绑定特定按钮
LogoutManager.bindLogoutButton('#myLogoutBtn', {
    confirm: false,
    redirectUrl: './home.html'
});

// 直接调用
document.getElementById('myBtn').addEventListener('click', async () => {
    await LogoutManager.logout();
});
```

## 🔍 调试和故障排除

### 常见问题:

1. **按钮无响应**
   - 检查是否引入了 `logout-manager.js`
   - 检查控制台是否有错误信息

2. **数据未清理**
   - 使用测试页面检查 localStorage/sessionStorage
   - 确认 `LogoutManager.clearUserData()` 被调用

3. **API调用失败**
   - 检查网络连接
   - 验证 `dify-api.js` 是否正常加载

### 调试工具:

```javascript
// 检查登录状态
console.log('登录状态:', LogoutManager.isLoggedIn());

// 检查存储数据
console.log('Token:', localStorage.getItem('dify_access_token'));

// 手动清理数据
LogoutManager.clearUserData();
```

## 📱 响应式支持

- ✅ 桌面端完整功能
- ✅ 移动端触摸友好
- ✅ 平板端适配
- ✅ 键盘导航支持

## 🔒 安全考虑

- ✅ Token 安全清理
- ✅ 防止数据残留
- ✅ 会话完全结束
- ✅ 后端状态同步

## 📊 性能优化

- ✅ 懒加载脚本
- ✅ 异步API调用
- ✅ 最小化DOM操作
- ✅ 内存泄漏防护

---

**当前状态**: ✅ 退出登录功能已完全实现并经过测试

**测试页面**: 访问 `logout-test.html` 进行功能测试

**集成情况**: 
- ✅ index.html - 已集成
- ✅ chat.html - 已集成  
- ✅ login.html - 已集成
- ✅ api-test.html - 已集成
