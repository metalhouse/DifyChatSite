# DifyChatSite æ‰‹åŠ¨éƒ¨ç½²æŒ‡å— - Ubuntu 24

## ğŸ¯ éƒ¨ç½²æ¦‚è§ˆ

### æ¶æ„è¯´æ˜
```
ç”¨æˆ· â†’ https://www.pznas.com:7990 (Nginx SSL) â†’ http://127.0.0.1:4005 (Node.jsåç«¯)
```

### ç«¯å£åˆ†é…
- **Matrix**: `www.pznas.com:6300` (ä½ ç°æœ‰çš„æœåŠ¡)
- **DifyChatSite**: `www.pznas.com:7990` (æ–°éƒ¨ç½²çš„æœåŠ¡)
- **åç«¯**: `127.0.0.1:4005` (ä»…æœ¬åœ°è®¿é—®)

---

## ğŸ“‹ Step 1: ç¯å¢ƒå‡†å¤‡

### 1.1 æ£€æŸ¥ç³»ç»Ÿè¦æ±‚
```bash
# æ£€æŸ¥Ubuntuç‰ˆæœ¬
lsb_release -a

# æ£€æŸ¥å·²å®‰è£…è½¯ä»¶
node --version
npm --version
nginx -v
```

### 1.2 å®‰è£…å¿…è¦è½¯ä»¶ï¼ˆå¦‚æœç¼ºå¤±ï¼‰
```bash
# æ›´æ–°åŒ…ç®¡ç†å™¨
sudo apt update

# å®‰è£…Node.jså’Œnpm
sudo apt install nodejs npm -y

# éªŒè¯å®‰è£…
node --version  # åº”è¯¥æ˜¾ç¤º v18+ æˆ– v20+
npm --version
```

---

## ğŸ“‹ Step 2: éƒ¨ç½²å‰ç«¯æ–‡ä»¶

### 2.1 åˆ›å»ºå‰ç«¯ç›®å½•
```bash
sudo mkdir -p /var/www/DifyChatSite
```

### 2.2 å¤åˆ¶å‰ç«¯æ–‡ä»¶
```bash
# å‡è®¾ä½ åœ¨DifyChatSiteé¡¹ç›®ç›®å½•ä¸­
sudo cp -r *.html /var/www/DifyChatSite/
sudo cp -r assets/ /var/www/DifyChatSite/
sudo cp -r config/ /var/www/DifyChatSite/
sudo cp -r js/ /var/www/DifyChatSite/
sudo cp -r pages/ /var/www/DifyChatSite/
sudo cp favicon.ico /var/www/DifyChatSite/
```

### 2.3 è®¾ç½®æƒé™
```bash
# è®¾ç½®æ‰€æœ‰è€…ä¸ºnginxç”¨æˆ·
sudo chown -R www-data:www-data /var/www/DifyChatSite

# è®¾ç½®æ–‡ä»¶æƒé™
sudo chmod -R 644 /var/www/DifyChatSite
sudo find /var/www/DifyChatSite -type d -exec chmod 755 {} \;
```

---

## ğŸ“‹ Step 3: é…ç½®Nginx

### 3.1 å¤åˆ¶nginxé…ç½®
```bash
# å¤åˆ¶é…ç½®æ–‡ä»¶åˆ°nginxé…ç½®ç›®å½•
sudo cp nginx/difychat-manual.conf /etc/nginx/conf.d/difychat.conf
```

### 3.2 éªŒè¯è¯ä¹¦æ–‡ä»¶å­˜åœ¨
```bash
# æ£€æŸ¥SSLè¯ä¹¦æ–‡ä»¶
sudo ls -la /etc/ssl/certs/www.pznas.com_bundle.pem
sudo ls -la /etc/ssl/private/www.pznas.com.key

# å¦‚æœä¸å­˜åœ¨ï¼Œéœ€è¦å…ˆé…ç½®SSLè¯ä¹¦ï¼ˆè§æ­¥éª¤6ï¼‰
```

### 3.3 æµ‹è¯•nginxé…ç½®
```bash
# æµ‹è¯•é…ç½®è¯­æ³•
sudo nginx -t

# å¦‚æœæ˜¾ç¤º "syntax is ok" å’Œ "test is successful" åˆ™ç»§ç»­
# å¦‚æœæœ‰é”™è¯¯ï¼Œæ£€æŸ¥é…ç½®æ–‡ä»¶è¯­æ³•
```

### 3.4 é‡å¯nginx
```bash
# é‡å¯nginxæœåŠ¡
sudo systemctl restart nginx

# æ£€æŸ¥nginxçŠ¶æ€
sudo systemctl status nginx

# æ£€æŸ¥ç«¯å£ç›‘å¬
sudo netstat -tlnp | grep nginx
```

---

## ğŸ“‹ Step 4: éƒ¨ç½²åç«¯æœåŠ¡

### 4.1 åˆ›å»ºåç«¯ç›®å½•
```bash
sudo mkdir -p /opt/DifyChatSite-backend
```

### 4.2 å¤åˆ¶åç«¯ä»£ç 
```bash
# å‡è®¾åç«¯ä»£ç åœ¨ ../DifySiteBack ç›®å½•
sudo cp -r ../DifySiteBack/* /opt/DifyChatSite-backend/

# æˆ–è€…å¦‚æœåç«¯ä»£ç åœ¨å…¶ä»–ä½ç½®ï¼Œç›¸åº”è°ƒæ•´è·¯å¾„
```

### 4.3 å®‰è£…åç«¯ä¾èµ–
```bash
cd /opt/DifyChatSite-backend
sudo npm install --production
```

### 4.4 åˆ›å»ºç¯å¢ƒé…ç½®æ–‡ä»¶
```bash
sudo tee /opt/DifyChatSite-backend/.env << 'EOF'
NODE_ENV=production
PORT=4005
HOST=127.0.0.1

# æ•°æ®åº“é…ç½®ï¼ˆæ ¹æ®ä½ çš„å®é™…æƒ…å†µä¿®æ”¹ï¼‰
DB_HOST=localhost
DB_PORT=5432
DB_NAME=difychat_prod
DB_USER=difychat
DB_PASSWORD=your_secure_password

# JWTé…ç½®
JWT_SECRET=your_very_secure_jwt_secret_here_change_this
JWT_EXPIRES_IN=24h

# CORSé…ç½®
CORS_ORIGIN=https://www.pznas.com:7990
CORS_CREDENTIALS=true

# WebSocketé…ç½®
WS_CORS_ORIGIN=https://www.pznas.com:7990

# å…¶ä»–é…ç½®
LOG_LEVEL=info
UPLOAD_MAX_SIZE=50971520
SESSION_SECRET=your_session_secret_here_change_this
EOF
```

### 4.5 è®¾ç½®æƒé™
```bash
sudo chown -R www-data:www-data /opt/DifyChatSite-backend
sudo chmod 600 /opt/DifyChatSite-backend/.env
```

---

## ğŸ“‹ Step 5: åˆ›å»ºç³»ç»ŸæœåŠ¡

### 5.1 åˆ›å»ºsystemdæœåŠ¡æ–‡ä»¶
```bash
sudo tee /etc/systemd/system/difychat.service << 'EOF'
[Unit]
Description=DifyChatSite Backend Service
After=network.target

[Service]
Type=simple
User=www-data
Group=www-data
WorkingDirectory=/opt/DifyChatSite-backend
ExecStart=/usr/bin/node server.js
Restart=always
RestartSec=10
Environment=NODE_ENV=production

# å®‰å…¨é…ç½®
NoNewPrivileges=yes
PrivateTmp=yes

# æ—¥å¿—é…ç½®
StandardOutput=journal
StandardError=journal

[Install]
WantedBy=multi-user.target
EOF
```

### 5.2 å¯åŠ¨æœåŠ¡
```bash
# é‡æ–°åŠ è½½systemdé…ç½®
sudo systemctl daemon-reload

# å¯ç”¨æœåŠ¡è‡ªå¯åŠ¨
sudo systemctl enable difychat

# å¯åŠ¨æœåŠ¡
sudo systemctl start difychat

# æ£€æŸ¥æœåŠ¡çŠ¶æ€
sudo systemctl status difychat
```

---

## ğŸ“‹ Step 6: SSLè¯ä¹¦é…ç½®ï¼ˆå¦‚æœéœ€è¦ï¼‰

### 6.1 å¦‚æœä½ è¿˜æ²¡æœ‰SSLè¯ä¹¦
```bash
# ä½¿ç”¨certbotè·å–å…è´¹SSLè¯ä¹¦ï¼ˆæ¨èï¼‰
sudo apt install certbot python3-certbot-nginx -y

# ä¸ºåŸŸåè·å–è¯ä¹¦
sudo certbot certonly --standalone -d www.pznas.com

# è¯ä¹¦ä¼šä¿å­˜åœ¨ /etc/letsencrypt/live/www.pznas.com/
```

### 6.2 å¦‚æœä½¿ç”¨Let's Encryptè¯ä¹¦ï¼Œæ›´æ–°nginxé…ç½®
```bash
# ç¼–è¾‘é…ç½®æ–‡ä»¶
sudo nano /etc/nginx/conf.d/difychat.conf

# ä¿®æ”¹SSLè¯ä¹¦è·¯å¾„ä¸ºï¼š
# ssl_certificate /etc/letsencrypt/live/www.pznas.com/fullchain.pem;
# ssl_certificate_key /etc/letsencrypt/live/www.pznas.com/privkey.pem;
```

---

## ğŸ“‹ Step 7: é˜²ç«å¢™é…ç½®

### 7.1 æ£€æŸ¥å½“å‰é˜²ç«å¢™çŠ¶æ€
```bash
sudo ufw status
```

### 7.2 å¼€æ”¾å¿…è¦ç«¯å£
```bash
# å¼€æ”¾DifyChatSiteç«¯å£
sudo ufw allow 7990/tcp

# å¦‚æœéœ€è¦å¼€æ”¾HTTPï¼ˆç”¨äºé‡å®šå‘ï¼‰
sudo ufw allow 80/tcp

# æ£€æŸ¥è§„åˆ™
sudo ufw status numbered
```

---

## ğŸ“‹ Step 8: éªŒè¯éƒ¨ç½²

### 8.1 æ£€æŸ¥æœåŠ¡çŠ¶æ€
```bash
# æ£€æŸ¥nginx
sudo systemctl status nginx
sudo netstat -tlnp | grep :7990

# æ£€æŸ¥åç«¯æœåŠ¡
sudo systemctl status difychat
sudo netstat -tlnp | grep :4005

# æŸ¥çœ‹æœåŠ¡æ—¥å¿—
sudo journalctl -u nginx -f --no-pager -n 20
sudo journalctl -u difychat -f --no-pager -n 20
```

### 8.2 æµ‹è¯•è¿æ¥
```bash
# æµ‹è¯•åç«¯å¥åº·æ£€æŸ¥
curl http://127.0.0.1:4005/health

# æµ‹è¯•å‰ç«¯è®¿é—®
curl -k https://www.pznas.com:7990

# æµ‹è¯•APIä»£ç†
curl -k https://www.pznas.com:7990/api/health
```

### 8.3 æµè§ˆå™¨æµ‹è¯•
1. æ‰“å¼€æµè§ˆå™¨è®¿é—®ï¼š`https://www.pznas.com:7990`
2. æ£€æŸ¥é¡µé¢æ˜¯å¦æ­£å¸¸åŠ è½½
3. æ‰“å¼€æµè§ˆå™¨å¼€å‘è€…å·¥å…·ï¼ŒæŸ¥çœ‹ï¼š
   - ç½‘ç»œè¯·æ±‚æ˜¯å¦æ­£å¸¸
   - WebSocketè¿æ¥æ˜¯å¦å»ºç«‹
   - æ§åˆ¶å°æ˜¯å¦æœ‰é”™è¯¯

---

## ğŸ”§ æ•…éšœæ’æŸ¥

### é—®é¢˜1: nginxé…ç½®æµ‹è¯•å¤±è´¥
```bash
# æ£€æŸ¥é…ç½®è¯­æ³•
sudo nginx -t

# æŸ¥çœ‹è¯¦ç»†é”™è¯¯
sudo nginx -t -c /etc/nginx/nginx.conf

# æ£€æŸ¥é…ç½®æ–‡ä»¶æƒé™
sudo ls -la /etc/nginx/conf.d/difychat.conf
```

### é—®é¢˜2: åç«¯æœåŠ¡å¯åŠ¨å¤±è´¥
```bash
# æŸ¥çœ‹æœåŠ¡æ—¥å¿—
sudo journalctl -u difychat -f

# æ‰‹åŠ¨æµ‹è¯•åç«¯
cd /opt/DifyChatSite-backend
sudo -u www-data node server.js

# æ£€æŸ¥ç«¯å£å ç”¨
sudo netstat -tlnp | grep 4005
```

### é—®é¢˜3: SSLè¯ä¹¦é—®é¢˜
```bash
# æ£€æŸ¥è¯ä¹¦æ–‡ä»¶
sudo ls -la /etc/ssl/certs/www.pznas.com_bundle.pem
sudo ls -la /etc/ssl/private/www.pznas.com.key

# æµ‹è¯•è¯ä¹¦
sudo openssl x509 -in /etc/ssl/certs/www.pznas.com_bundle.pem -text -noout

# æ£€æŸ¥è¯ä¹¦æƒé™
sudo chmod 644 /etc/ssl/certs/www.pznas.com_bundle.pem
sudo chmod 600 /etc/ssl/private/www.pznas.com.key
```

### é—®é¢˜4: WebSocketè¿æ¥å¤±è´¥
```bash
# æ£€æŸ¥nginx WebSocketé…ç½®
sudo grep -A 10 "socket.io" /etc/nginx/conf.d/difychat.conf

# æµ‹è¯•WebSocketå‡çº§
curl -i -N -H "Connection: Upgrade" -H "Upgrade: websocket" \
  -H "Sec-WebSocket-Key: test" -H "Sec-WebSocket-Version: 13" \
  https://www.pznas.com:7990/socket.io/
```

---

## ğŸ“‹ æ—¥å¸¸ç»´æŠ¤

### æŸ¥çœ‹æ—¥å¿—
```bash
# Nginxè®¿é—®æ—¥å¿—
sudo tail -f /var/log/nginx/difychat-access.log

# Nginxé”™è¯¯æ—¥å¿—
sudo tail -f /var/log/nginx/difychat-error.log

# åç«¯æœåŠ¡æ—¥å¿—
sudo journalctl -u difychat -f
```

### é‡å¯æœåŠ¡
```bash
# é‡å¯nginx
sudo systemctl restart nginx

# é‡å¯åç«¯æœåŠ¡
sudo systemctl restart difychat

# é‡å¯æ‰€æœ‰ç›¸å…³æœåŠ¡
sudo systemctl restart nginx difychat
```

### æ›´æ–°ä»£ç 
```bash
# æ›´æ–°å‰ç«¯
sudo cp -r æ–°çš„å‰ç«¯æ–‡ä»¶/* /var/www/DifyChatSite/
sudo systemctl reload nginx

# æ›´æ–°åç«¯
sudo cp -r æ–°çš„åç«¯æ–‡ä»¶/* /opt/DifyChatSite-backend/
cd /opt/DifyChatSite-backend
sudo npm install --production
sudo systemctl restart difychat
```

---

## âœ… éƒ¨ç½²å®Œæˆæ£€æŸ¥æ¸…å•

- [ ] âœ… å‰ç«¯æ–‡ä»¶å·²éƒ¨ç½²åˆ° `/var/www/DifyChatSite/`
- [ ] âœ… Nginxé…ç½®æ–‡ä»¶å·²åˆ›å»ºå¹¶æµ‹è¯•é€šè¿‡
- [ ] âœ… SSLè¯ä¹¦é…ç½®æ­£ç¡®
- [ ] âœ… åç«¯ä»£ç å·²éƒ¨ç½²åˆ° `/opt/DifyChatSite-backend/`
- [ ] âœ… åç«¯ç¯å¢ƒé…ç½®å·²åˆ›å»º
- [ ] âœ… systemdæœåŠ¡å·²åˆ›å»ºå¹¶å¯åŠ¨
- [ ] âœ… é˜²ç«å¢™ç«¯å£å·²å¼€æ”¾
- [ ] âœ… æœåŠ¡çŠ¶æ€æ­£å¸¸
- [ ] âœ… æµè§ˆå™¨è®¿é—®æ­£å¸¸
- [ ] âœ… WebSocketè¿æ¥æ­£å¸¸
- [ ] âœ… APIè¯·æ±‚æ­£å¸¸

**ğŸ‰ éƒ¨ç½²å®Œæˆï¼è®¿é—®åœ°å€ï¼šhttps://www.pznas.com:7990**
