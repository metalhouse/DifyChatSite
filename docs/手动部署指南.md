# DifyChatSite 手动部署指南 - Ubuntu 24

## 🎯 部署概览

### 架构说明
```
用户 → https://www.pznas.com:7990 (Nginx SSL) → http://127.0.0.1:4005 (Node.js后端)
```

### 端口分配
- **Matrix**: `www.pznas.com:6300` (你现有的服务)
- **DifyChatSite**: `www.pznas.com:7990` (新部署的服务)
- **后端**: `127.0.0.1:4005` (仅本地访问)

---

## 📋 Step 1: 环境准备

### 1.1 检查系统要求
```bash
# 检查Ubuntu版本
lsb_release -a

# 检查已安装软件
node --version
npm --version
nginx -v
```

### 1.2 安装必要软件（如果缺失）
```bash
# 更新包管理器
sudo apt update

# 安装Node.js和npm
sudo apt install nodejs npm -y

# 验证安装
node --version  # 应该显示 v18+ 或 v20+
npm --version
```

---

## 📋 Step 2: 部署前端文件

### 2.1 创建前端目录
```bash
sudo mkdir -p /var/www/DifyChatSite
```

### 2.2 复制前端文件
```bash
# 假设你在DifyChatSite项目目录中
sudo cp -r *.html /var/www/DifyChatSite/
sudo cp -r assets/ /var/www/DifyChatSite/
sudo cp -r config/ /var/www/DifyChatSite/
sudo cp -r js/ /var/www/DifyChatSite/
sudo cp -r pages/ /var/www/DifyChatSite/
sudo cp favicon.ico /var/www/DifyChatSite/
```

### 2.3 设置权限
```bash
# 设置所有者为nginx用户
sudo chown -R www-data:www-data /var/www/DifyChatSite

# 设置文件权限
sudo chmod -R 644 /var/www/DifyChatSite
sudo find /var/www/DifyChatSite -type d -exec chmod 755 {} \;
```

---

## 📋 Step 3: 配置Nginx

### 3.1 复制nginx配置
```bash
# 复制配置文件到nginx配置目录
sudo cp nginx/difychat-manual.conf /etc/nginx/conf.d/difychat.conf
```

### 3.2 验证证书文件存在
```bash
# 检查SSL证书文件
sudo ls -la /etc/ssl/certs/www.pznas.com_bundle.pem
sudo ls -la /etc/ssl/private/www.pznas.com.key

# 如果不存在，需要先配置SSL证书（见步骤6）
```

### 3.3 测试nginx配置
```bash
# 测试配置语法
sudo nginx -t

# 如果显示 "syntax is ok" 和 "test is successful" 则继续
# 如果有错误，检查配置文件语法
```

### 3.4 重启nginx
```bash
# 重启nginx服务
sudo systemctl restart nginx

# 检查nginx状态
sudo systemctl status nginx

# 检查端口监听
sudo netstat -tlnp | grep nginx
```

---

## 📋 Step 4: 部署后端服务

### 4.1 创建后端目录
```bash
sudo mkdir -p /opt/DifyChatSite-backend
```

### 4.2 复制后端代码
```bash
# 假设后端代码在 ../DifySiteBack 目录
sudo cp -r ../DifySiteBack/* /opt/DifyChatSite-backend/

# 或者如果后端代码在其他位置，相应调整路径
```

### 4.3 安装后端依赖
```bash
cd /opt/DifyChatSite-backend
sudo npm install --production
```

### 4.4 创建环境配置文件
```bash
sudo tee /opt/DifyChatSite-backend/.env << 'EOF'
NODE_ENV=production
PORT=4005
HOST=127.0.0.1

# 数据库配置（根据你的实际情况修改）
DB_HOST=localhost
DB_PORT=5432
DB_NAME=difychat_prod
DB_USER=difychat
DB_PASSWORD=your_secure_password

# JWT配置
JWT_SECRET=your_very_secure_jwt_secret_here_change_this
JWT_EXPIRES_IN=24h

# CORS配置
CORS_ORIGIN=https://www.pznas.com:7990
CORS_CREDENTIALS=true

# WebSocket配置
WS_CORS_ORIGIN=https://www.pznas.com:7990

# 其他配置
LOG_LEVEL=info
UPLOAD_MAX_SIZE=50971520
SESSION_SECRET=your_session_secret_here_change_this
EOF
```

### 4.5 设置权限
```bash
sudo chown -R www-data:www-data /opt/DifyChatSite-backend
sudo chmod 600 /opt/DifyChatSite-backend/.env
```

---

## 📋 Step 5: 创建系统服务

### 5.1 创建systemd服务文件
```bash
sudo tee /etc/systemd/system/difychat.service << 'EOF'
[Unit]
Description=DifyChatSite Backend Service
After=network.target

[Service]
Type=simple
User=www-data
Group=www-data
WorkingDirectory=/opt/DifyChatSite-backend
ExecStart=/usr/bin/node server.js
Restart=always
RestartSec=10
Environment=NODE_ENV=production

# 安全配置
NoNewPrivileges=yes
PrivateTmp=yes

# 日志配置
StandardOutput=journal
StandardError=journal

[Install]
WantedBy=multi-user.target
EOF
```

### 5.2 启动服务
```bash
# 重新加载systemd配置
sudo systemctl daemon-reload

# 启用服务自启动
sudo systemctl enable difychat

# 启动服务
sudo systemctl start difychat

# 检查服务状态
sudo systemctl status difychat
```

---

## 📋 Step 6: SSL证书配置（如果需要）

### 6.1 如果你还没有SSL证书
```bash
# 使用certbot获取免费SSL证书（推荐）
sudo apt install certbot python3-certbot-nginx -y

# 为域名获取证书
sudo certbot certonly --standalone -d www.pznas.com

# 证书会保存在 /etc/letsencrypt/live/www.pznas.com/
```

### 6.2 如果使用Let's Encrypt证书，更新nginx配置
```bash
# 编辑配置文件
sudo nano /etc/nginx/conf.d/difychat.conf

# 修改SSL证书路径为：
# ssl_certificate /etc/letsencrypt/live/www.pznas.com/fullchain.pem;
# ssl_certificate_key /etc/letsencrypt/live/www.pznas.com/privkey.pem;
```

---

## 📋 Step 7: 防火墙配置

### 7.1 检查当前防火墙状态
```bash
sudo ufw status
```

### 7.2 开放必要端口
```bash
# 开放DifyChatSite端口
sudo ufw allow 7990/tcp

# 如果需要开放HTTP（用于重定向）
sudo ufw allow 80/tcp

# 检查规则
sudo ufw status numbered
```

---

## 📋 Step 8: 验证部署

### 8.1 检查服务状态
```bash
# 检查nginx
sudo systemctl status nginx
sudo netstat -tlnp | grep :7990

# 检查后端服务
sudo systemctl status difychat
sudo netstat -tlnp | grep :4005

# 查看服务日志
sudo journalctl -u nginx -f --no-pager -n 20
sudo journalctl -u difychat -f --no-pager -n 20
```

### 8.2 测试连接
```bash
# 测试后端健康检查
curl http://127.0.0.1:4005/health

# 测试前端访问
curl -k https://www.pznas.com:7990

# 测试API代理
curl -k https://www.pznas.com:7990/api/health
```

### 8.3 浏览器测试
1. 打开浏览器访问：`https://www.pznas.com:7990`
2. 检查页面是否正常加载
3. 打开浏览器开发者工具，查看：
   - 网络请求是否正常
   - WebSocket连接是否建立
   - 控制台是否有错误

---

## 🔧 故障排查

### 问题1: nginx配置测试失败
```bash
# 检查配置语法
sudo nginx -t

# 查看详细错误
sudo nginx -t -c /etc/nginx/nginx.conf

# 检查配置文件权限
sudo ls -la /etc/nginx/conf.d/difychat.conf
```

### 问题2: 后端服务启动失败
```bash
# 查看服务日志
sudo journalctl -u difychat -f

# 手动测试后端
cd /opt/DifyChatSite-backend
sudo -u www-data node server.js

# 检查端口占用
sudo netstat -tlnp | grep 4005
```

### 问题3: SSL证书问题
```bash
# 检查证书文件
sudo ls -la /etc/ssl/certs/www.pznas.com_bundle.pem
sudo ls -la /etc/ssl/private/www.pznas.com.key

# 测试证书
sudo openssl x509 -in /etc/ssl/certs/www.pznas.com_bundle.pem -text -noout

# 检查证书权限
sudo chmod 644 /etc/ssl/certs/www.pznas.com_bundle.pem
sudo chmod 600 /etc/ssl/private/www.pznas.com.key
```

### 问题4: WebSocket连接失败
```bash
# 检查nginx WebSocket配置
sudo grep -A 10 "socket.io" /etc/nginx/conf.d/difychat.conf

# 测试WebSocket升级
curl -i -N -H "Connection: Upgrade" -H "Upgrade: websocket" \
  -H "Sec-WebSocket-Key: test" -H "Sec-WebSocket-Version: 13" \
  https://www.pznas.com:7990/socket.io/
```

---

## 📋 日常维护

### 查看日志
```bash
# Nginx访问日志
sudo tail -f /var/log/nginx/difychat-access.log

# Nginx错误日志
sudo tail -f /var/log/nginx/difychat-error.log

# 后端服务日志
sudo journalctl -u difychat -f
```

### 重启服务
```bash
# 重启nginx
sudo systemctl restart nginx

# 重启后端服务
sudo systemctl restart difychat

# 重启所有相关服务
sudo systemctl restart nginx difychat
```

### 更新代码
```bash
# 更新前端
sudo cp -r 新的前端文件/* /var/www/DifyChatSite/
sudo systemctl reload nginx

# 更新后端
sudo cp -r 新的后端文件/* /opt/DifyChatSite-backend/
cd /opt/DifyChatSite-backend
sudo npm install --production
sudo systemctl restart difychat
```

---

## ✅ 部署完成检查清单

- [ ] ✅ 前端文件已部署到 `/var/www/DifyChatSite/`
- [ ] ✅ Nginx配置文件已创建并测试通过
- [ ] ✅ SSL证书配置正确
- [ ] ✅ 后端代码已部署到 `/opt/DifyChatSite-backend/`
- [ ] ✅ 后端环境配置已创建
- [ ] ✅ systemd服务已创建并启动
- [ ] ✅ 防火墙端口已开放
- [ ] ✅ 服务状态正常
- [ ] ✅ 浏览器访问正常
- [ ] ✅ WebSocket连接正常
- [ ] ✅ API请求正常

**🎉 部署完成！访问地址：https://www.pznas.com:7990**
