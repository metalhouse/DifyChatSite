# 反代部署检查清单

## 🎯 部署目标
- **前端域名**: `https://nas.pznas.com:7990`
- **后端API**: `https://nas.pznas.com:7990/api`
- **WebSocket**: `wss://nas.pznas.com:7990/ws`

## ✅ 前端配置检查

### 1. 环境配置文件
- [x] `config/env.js` - 已添加反代域名检测
- [x] `config/global-config.js` - 已添加反代环境标识
- [x] `config/app-config.js` - 已添加反代API配置
- [x] `config/reverse-proxy-config.js` - 新增专用反代配置

### 2. HTML文件配置
- [x] `index.html` - 已添加反代meta标签和启动检查
- [ ] `login.html` - 需要添加反代配置引用
- [ ] `chat.html` - 需要添加反代配置引用
- [ ] 其他HTML文件根据需要添加

### 3. JavaScript工具
- [x] `js/utils/reverse-proxy-startup-check.js` - 启动检查脚本
- [x] `js/utils/reverse-proxy-diagnostics.js` - 诊断工具
- [ ] 确保所有页面都引用了相关脚本

## 🔧 后端配置检查

### 1. CORS设置
```javascript
// 需要在后端添加的CORS配置
const corsOptions = {
  origin: [
    'https://nas.pznas.com:7990',  // 反代地址
    'http://localhost:6005',       // 开发环境
    'http://127.0.0.1:6005'        // 开发环境
  ],
  credentials: true,
  methods: ['GET', 'POST', 'PUT', 'DELETE', 'OPTIONS', 'PATCH'],
  allowedHeaders: [
    'Origin', 'X-Requested-With', 'Content-Type', 
    'Accept', 'Authorization'
  ]
};
```

### 2. 环境变量
```bash
# 后端 .env 文件需要添加
CORS_ORIGINS=https://nas.pznas.com:7990,http://localhost:6005
FRONTEND_URL=https://nas.pznas.com:7990
USE_SSL=true
```

### 3. WebSocket配置
确保WebSocket服务器支持WSS协议并正确配置CORS。

## 🌐 反代服务器配置

### 1. Nginx配置示例
```nginx
server {
    listen 7990 ssl;
    server_name nas.pznas.com;
    
    # SSL配置
    ssl_certificate /path/to/cert.pem;
    ssl_certificate_key /path/to/key.pem;
    
    # 前端静态文件
    location / {
        root /path/to/DifyChatSite;
        index index.html;
        try_files $uri $uri/ /index.html;
        
        # 添加安全头
        add_header X-Frame-Options DENY;
        add_header X-Content-Type-Options nosniff;
        add_header X-XSS-Protection "1; mode=block";
    }
    
    # API反代
    location /api/ {
        proxy_pass http://backend-server:4005/api/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        
        # CORS头部
        add_header Access-Control-Allow-Origin https://nas.pznas.com:7990;
        add_header Access-Control-Allow-Credentials true;
    }
    
    # WebSocket反代
    location /ws/ {
        proxy_pass http://backend-server:4005/ws/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "Upgrade";
        proxy_set_header Host $host;
    }
    
    # 健康检查
    location /health {
        proxy_pass http://backend-server:4005/health;
    }
}
```

## 🧪 部署测试步骤

### 1. 基础连接测试
```bash
# 1. 测试前端访问
curl -I https://nas.pznas.com:7990/

# 2. 测试API连接
curl -I https://nas.pznas.com:7990/api/health

# 3. 测试健康检查
curl https://nas.pznas.com:7990/health
```

### 2. 浏览器测试
1. 访问 `https://nas.pznas.com:7990`
2. 打开开发者工具，检查Console输出
3. 查看是否有反代配置加载成功的消息
4. 检查Network面板，确认API请求正常

### 3. 功能测试
1. 用户注册/登录功能
2. API请求功能
3. WebSocket连接（如果使用）
4. 文件上传功能（如果有）

### 4. 诊断工具测试
在浏览器控制台运行：
```javascript
// 运行完整诊断
window.runReverseProxyDiagnostics().then(report => {
    console.log('诊断结果:', report);
});

// 检查配置
console.log('环境配置:', window.ENV_CONFIG);
console.log('反代配置:', window.REVERSE_PROXY_CONFIG);
console.log('是否反代环境:', window.isReverseProxyEnvironment());
```

## 🚨 常见问题解决

### 1. CORS错误
- 检查后端CORS配置是否包含完整域名和端口
- 确认预检请求（OPTIONS）正确处理
- 验证 `credentials: true` 设置

### 2. 404错误
- 检查反代服务器路径配置
- 确认后端服务正常运行
- 验证API端点路径正确

### 3. SSL/TLS错误
- 确认SSL证书有效
- 检查证书是否包含正确的域名
- 验证证书链完整

### 4. WebSocket连接失败
- 确认使用WSS协议
- 检查反代服务器WebSocket配置
- 验证后端WebSocket服务正常

### 5. 性能问题
- 启用gzip压缩
- 配置浏览器缓存
- 优化静态资源加载
- 考虑CDN加速

## 📝 部署后验证清单

- [ ] 前端页面正常加载
- [ ] API连接正常
- [ ] 用户认证功能正常
- [ ] WebSocket连接正常（如果使用）
- [ ] 所有功能模块测试通过
- [ ] 性能指标符合预期
- [ ] 安全配置正确
- [ ] 错误处理机制正常
- [ ] 监控和日志配置完成

## 🔧 维护工具

### 快速健康检查
```javascript
// 在浏览器控制台运行
window.reverseProxyHealthCheck().then(result => {
    console.log('健康检查:', result);
});
```

### 配置重置
```javascript
// 重置为默认配置
localStorage.removeItem('backend_base_url');
window.location.reload();
```

### 诊断报告导出
```javascript
// 导出诊断报告
const report = window.REVERSE_PROXY_DIAGNOSTICS_REPORT;
if (report) {
    const blob = new Blob([JSON.stringify(report, null, 2)], {
        type: 'application/json'
    });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'reverse-proxy-diagnostics.json';
    a.click();
}
```
