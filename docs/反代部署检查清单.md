# åä»£éƒ¨ç½²æ£€æŸ¥æ¸…å•

## ğŸ¯ éƒ¨ç½²ç›®æ ‡
- **å‰ç«¯åŸŸå**: `https://nas.pznas.com:7990`
- **åç«¯API**: `https://nas.pznas.com:7990/api`
- **WebSocket**: `wss://nas.pznas.com:7990/ws`

## âœ… å‰ç«¯é…ç½®æ£€æŸ¥

### 1. ç¯å¢ƒé…ç½®æ–‡ä»¶
- [x] `config/env.js` - å·²æ·»åŠ åä»£åŸŸåæ£€æµ‹
- [x] `config/global-config.js` - å·²æ·»åŠ åä»£ç¯å¢ƒæ ‡è¯†
- [x] `config/app-config.js` - å·²æ·»åŠ åä»£APIé…ç½®
- [x] `config/reverse-proxy-config.js` - æ–°å¢ä¸“ç”¨åä»£é…ç½®

### 2. HTMLæ–‡ä»¶é…ç½®
- [x] `index.html` - å·²æ·»åŠ åä»£metaæ ‡ç­¾å’Œå¯åŠ¨æ£€æŸ¥
- [ ] `login.html` - éœ€è¦æ·»åŠ åä»£é…ç½®å¼•ç”¨
- [ ] `chat.html` - éœ€è¦æ·»åŠ åä»£é…ç½®å¼•ç”¨
- [ ] å…¶ä»–HTMLæ–‡ä»¶æ ¹æ®éœ€è¦æ·»åŠ 

### 3. JavaScriptå·¥å…·
- [x] `js/utils/reverse-proxy-startup-check.js` - å¯åŠ¨æ£€æŸ¥è„šæœ¬
- [x] `js/utils/reverse-proxy-diagnostics.js` - è¯Šæ–­å·¥å…·
- [ ] ç¡®ä¿æ‰€æœ‰é¡µé¢éƒ½å¼•ç”¨äº†ç›¸å…³è„šæœ¬

## ğŸ”§ åç«¯é…ç½®æ£€æŸ¥

### 1. CORSè®¾ç½®
```javascript
// éœ€è¦åœ¨åç«¯æ·»åŠ çš„CORSé…ç½®
const corsOptions = {
  origin: [
    'https://nas.pznas.com:7990',  // åä»£åœ°å€
    'http://localhost:6005',       // å¼€å‘ç¯å¢ƒ
    'http://127.0.0.1:6005'        // å¼€å‘ç¯å¢ƒ
  ],
  credentials: true,
  methods: ['GET', 'POST', 'PUT', 'DELETE', 'OPTIONS', 'PATCH'],
  allowedHeaders: [
    'Origin', 'X-Requested-With', 'Content-Type', 
    'Accept', 'Authorization'
  ]
};
```

### 2. ç¯å¢ƒå˜é‡
```bash
# åç«¯ .env æ–‡ä»¶éœ€è¦æ·»åŠ 
CORS_ORIGINS=https://nas.pznas.com:7990,http://localhost:6005
FRONTEND_URL=https://nas.pznas.com:7990
USE_SSL=true
```

### 3. WebSocketé…ç½®
ç¡®ä¿WebSocketæœåŠ¡å™¨æ”¯æŒWSSåè®®å¹¶æ­£ç¡®é…ç½®CORSã€‚

## ğŸŒ åä»£æœåŠ¡å™¨é…ç½®

### 1. Nginxé…ç½®ç¤ºä¾‹
```nginx
server {
    listen 7990 ssl;
    server_name nas.pznas.com;
    
    # SSLé…ç½®
    ssl_certificate /path/to/cert.pem;
    ssl_certificate_key /path/to/key.pem;
    
    # å‰ç«¯é™æ€æ–‡ä»¶
    location / {
        root /path/to/DifyChatSite;
        index index.html;
        try_files $uri $uri/ /index.html;
        
        # æ·»åŠ å®‰å…¨å¤´
        add_header X-Frame-Options DENY;
        add_header X-Content-Type-Options nosniff;
        add_header X-XSS-Protection "1; mode=block";
    }
    
    # APIåä»£
    location /api/ {
        proxy_pass http://backend-server:4005/api/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        
        # CORSå¤´éƒ¨
        add_header Access-Control-Allow-Origin https://nas.pznas.com:7990;
        add_header Access-Control-Allow-Credentials true;
    }
    
    # WebSocketåä»£
    location /ws/ {
        proxy_pass http://backend-server:4005/ws/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "Upgrade";
        proxy_set_header Host $host;
    }
    
    # å¥åº·æ£€æŸ¥
    location /health {
        proxy_pass http://backend-server:4005/health;
    }
}
```

## ğŸ§ª éƒ¨ç½²æµ‹è¯•æ­¥éª¤

### 1. åŸºç¡€è¿æ¥æµ‹è¯•
```bash
# 1. æµ‹è¯•å‰ç«¯è®¿é—®
curl -I https://nas.pznas.com:7990/

# 2. æµ‹è¯•APIè¿æ¥
curl -I https://nas.pznas.com:7990/api/health

# 3. æµ‹è¯•å¥åº·æ£€æŸ¥
curl https://nas.pznas.com:7990/health
```

### 2. æµè§ˆå™¨æµ‹è¯•
1. è®¿é—® `https://nas.pznas.com:7990`
2. æ‰“å¼€å¼€å‘è€…å·¥å…·ï¼Œæ£€æŸ¥Consoleè¾“å‡º
3. æŸ¥çœ‹æ˜¯å¦æœ‰åä»£é…ç½®åŠ è½½æˆåŠŸçš„æ¶ˆæ¯
4. æ£€æŸ¥Networké¢æ¿ï¼Œç¡®è®¤APIè¯·æ±‚æ­£å¸¸

### 3. åŠŸèƒ½æµ‹è¯•
1. ç”¨æˆ·æ³¨å†Œ/ç™»å½•åŠŸèƒ½
2. APIè¯·æ±‚åŠŸèƒ½
3. WebSocketè¿æ¥ï¼ˆå¦‚æœä½¿ç”¨ï¼‰
4. æ–‡ä»¶ä¸Šä¼ åŠŸèƒ½ï¼ˆå¦‚æœæœ‰ï¼‰

### 4. è¯Šæ–­å·¥å…·æµ‹è¯•
åœ¨æµè§ˆå™¨æ§åˆ¶å°è¿è¡Œï¼š
```javascript
// è¿è¡Œå®Œæ•´è¯Šæ–­
window.runReverseProxyDiagnostics().then(report => {
    console.log('è¯Šæ–­ç»“æœ:', report);
});

// æ£€æŸ¥é…ç½®
console.log('ç¯å¢ƒé…ç½®:', window.ENV_CONFIG);
console.log('åä»£é…ç½®:', window.REVERSE_PROXY_CONFIG);
console.log('æ˜¯å¦åä»£ç¯å¢ƒ:', window.isReverseProxyEnvironment());
```

## ğŸš¨ å¸¸è§é—®é¢˜è§£å†³

### 1. CORSé”™è¯¯
- æ£€æŸ¥åç«¯CORSé…ç½®æ˜¯å¦åŒ…å«å®Œæ•´åŸŸåå’Œç«¯å£
- ç¡®è®¤é¢„æ£€è¯·æ±‚ï¼ˆOPTIONSï¼‰æ­£ç¡®å¤„ç†
- éªŒè¯ `credentials: true` è®¾ç½®

### 2. 404é”™è¯¯
- æ£€æŸ¥åä»£æœåŠ¡å™¨è·¯å¾„é…ç½®
- ç¡®è®¤åç«¯æœåŠ¡æ­£å¸¸è¿è¡Œ
- éªŒè¯APIç«¯ç‚¹è·¯å¾„æ­£ç¡®

### 3. SSL/TLSé”™è¯¯
- ç¡®è®¤SSLè¯ä¹¦æœ‰æ•ˆ
- æ£€æŸ¥è¯ä¹¦æ˜¯å¦åŒ…å«æ­£ç¡®çš„åŸŸå
- éªŒè¯è¯ä¹¦é“¾å®Œæ•´

### 4. WebSocketè¿æ¥å¤±è´¥
- ç¡®è®¤ä½¿ç”¨WSSåè®®
- æ£€æŸ¥åä»£æœåŠ¡å™¨WebSocketé…ç½®
- éªŒè¯åç«¯WebSocketæœåŠ¡æ­£å¸¸

### 5. æ€§èƒ½é—®é¢˜
- å¯ç”¨gzipå‹ç¼©
- é…ç½®æµè§ˆå™¨ç¼“å­˜
- ä¼˜åŒ–é™æ€èµ„æºåŠ è½½
- è€ƒè™‘CDNåŠ é€Ÿ

## ğŸ“ éƒ¨ç½²åéªŒè¯æ¸…å•

- [ ] å‰ç«¯é¡µé¢æ­£å¸¸åŠ è½½
- [ ] APIè¿æ¥æ­£å¸¸
- [ ] ç”¨æˆ·è®¤è¯åŠŸèƒ½æ­£å¸¸
- [ ] WebSocketè¿æ¥æ­£å¸¸ï¼ˆå¦‚æœä½¿ç”¨ï¼‰
- [ ] æ‰€æœ‰åŠŸèƒ½æ¨¡å—æµ‹è¯•é€šè¿‡
- [ ] æ€§èƒ½æŒ‡æ ‡ç¬¦åˆé¢„æœŸ
- [ ] å®‰å…¨é…ç½®æ­£ç¡®
- [ ] é”™è¯¯å¤„ç†æœºåˆ¶æ­£å¸¸
- [ ] ç›‘æ§å’Œæ—¥å¿—é…ç½®å®Œæˆ

## ğŸ”§ ç»´æŠ¤å·¥å…·

### å¿«é€Ÿå¥åº·æ£€æŸ¥
```javascript
// åœ¨æµè§ˆå™¨æ§åˆ¶å°è¿è¡Œ
window.reverseProxyHealthCheck().then(result => {
    console.log('å¥åº·æ£€æŸ¥:', result);
});
```

### é…ç½®é‡ç½®
```javascript
// é‡ç½®ä¸ºé»˜è®¤é…ç½®
localStorage.removeItem('backend_base_url');
window.location.reload();
```

### è¯Šæ–­æŠ¥å‘Šå¯¼å‡º
```javascript
// å¯¼å‡ºè¯Šæ–­æŠ¥å‘Š
const report = window.REVERSE_PROXY_DIAGNOSTICS_REPORT;
if (report) {
    const blob = new Blob([JSON.stringify(report, null, 2)], {
        type: 'application/json'
    });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'reverse-proxy-diagnostics.json';
    a.click();
}
```
