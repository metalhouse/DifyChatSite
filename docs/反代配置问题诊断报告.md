# 反代配置问题诊断报告

## 问题诊断结果

经过测试发现，反向代理服务器配置存在问题：

### 测试结果

| 路径 | 状态 | 说明 |
|------|------|------|
| `https://nas.pznas.com:7990/` | ✅ 200 | 正常，返回前端HTML页面 |
| `https://nas.pznas.com:7990/api/` | ❌ 404 | **失败，返回文件未找到错误** |
| `https://nas.pznas.com:7990/health` | ❌ 404 | 失败，返回文件未找到错误 |
| `https://nas.pznas.com:7990/api/health` | ❌ 404 | **失败，返回文件未找到错误** |

### 问题分析

1. **前端路径正常**：`/` 路径能正确返回前端页面，说明反向代理的基本功能正常
2. **API路径未配置**：`/api/` 路径返回 "File not found" 错误，说明反向代理没有将API请求转发到后端服务器
3. **错误类型**：返回的是HTTP服务器的标准404页面，而不是后端API的404响应

## 反向代理配置修复建议

### 如果使用Nginx

检查并修改 Nginx 配置文件（通常在 `/etc/nginx/sites-available/` 或 `/etc/nginx/conf.d/`）：

```nginx
server {
    listen 443 ssl;
    server_name nas.pznas.com;
    
    # SSL 配置
    ssl_certificate /path/to/cert.pem;
    ssl_certificate_key /path/to/key.pem;
    
    # API 请求转发到后端服务器
    location /api/ {
        proxy_pass http://your-backend-server:4005/api/;
        # 或者如果后端不需要 /api 前缀：
        # proxy_pass http://your-backend-server:4005/;
        
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }
    
    # 直接健康检查（如果后端支持）
    location /health {
        proxy_pass http://your-backend-server:4005/health;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    
    # WebSocket 支持
    location /ws/ {
        proxy_pass http://your-backend-server:4005/ws/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "Upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    
    # 前端静态文件
    location / {
        proxy_pass http://your-frontend-server:8080/;
        # 或者直接服务静态文件：
        # root /path/to/frontend/dist;
        # try_files $uri $uri/ /index.html;
        
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```

### 如果使用Apache

检查并修改 Apache 配置文件：

```apache
<VirtualHost *:443>
    ServerName nas.pznas.com
    
    # SSL 配置
    SSLEngine on
    SSLCertificateFile /path/to/cert.pem
    SSLCertificateKeyFile /path/to/key.pem
    
    # API 请求转发到后端
    ProxyPreserveHost On
    ProxyPass /api/ http://your-backend-server:4005/api/
    ProxyPassReverse /api/ http://your-backend-server:4005/api/
    
    # 健康检查转发
    ProxyPass /health http://your-backend-server:4005/health
    ProxyPassReverse /health http://your-backend-server:4005/health
    
    # WebSocket 支持
    ProxyPass /ws/ ws://your-backend-server:4005/ws/
    ProxyPassReverse /ws/ ws://your-backend-server:4005/ws/
    
    # 前端静态文件
    ProxyPass / http://your-frontend-server:8080/
    ProxyPassReverse / http://your-frontend-server:8080/
</VirtualHost>
```

### 如果使用Traefik

检查 docker-compose.yml 或 Traefik 配置：

```yaml
services:
  frontend:
    labels:
      - "traefik.http.routers.frontend.rule=Host(`nas.pznas.com`) && PathPrefix(`/`)"
      - "traefik.http.routers.frontend.priority=1"
      
  backend:
    labels:
      - "traefik.http.routers.backend.rule=Host(`nas.pznas.com`) && PathPrefix(`/api/`)"
      - "traefik.http.routers.backend.priority=2"
      - "traefik.http.routers.health.rule=Host(`nas.pznas.com`) && Path(`/health`)"
      - "traefik.http.routers.health.priority=3"
```

## 配置检查步骤

1. **找到反向代理配置文件**
   - Nginx: `/etc/nginx/sites-available/` 或 `/etc/nginx/conf.d/`
   - Apache: `/etc/apache2/sites-available/` 或 `/etc/httpd/conf.d/`
   - 其他：检查具体的配置位置

2. **添加API路径转发规则**
   - 确保 `/api/` 请求被转发到后端API服务器
   - 确保后端服务器正在端口4005（或其他配置的端口）运行

3. **重新加载配置**
   ```bash
   # Nginx
   sudo nginx -t && sudo systemctl reload nginx
   
   # Apache
   sudo apachectl configtest && sudo systemctl reload apache2
   ```

4. **验证配置**
   - 测试 `https://nas.pznas.com:7990/api/health` 是否返回后端响应
   - 检查后端日志是否收到请求

## 临时解决方案

在修复反向代理配置之前，你可以：

1. **直接访问后端**：如果后端在不同端口运行，可以直接访问（如 `http://nas.pznas.com:4005/api/health`）
2. **修改前端配置**：临时将API_BASE_URL指向后端的直接地址
3. **使用开发环境**：在本地运行前后端进行开发和测试

## 后续步骤

1. 首先修复反向代理配置，确保 `/api/` 路径正确转发
2. 确认后端API服务器正在运行并监听正确的端口
3. 测试API端点是否可以访问
4. 然后前端配置就会正常工作

**关键点**：这不是前端配置问题，而是反向代理服务器配置问题。前端代码是正确的。
