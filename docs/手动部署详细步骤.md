# 🚀 DifyChatSite 手动部署详细步骤

## 📋 环境信息确认
- **服务器**: Ubuntu 24
- **现有配置**: matrix.conf 使用端口6300，证书在 `/etc/ssl/certs/` 和 `/etc/ssl/private/`
- **新部署**: DifyChatSite 使用端口7990
- **域名**: nas.pznas.com

## 🎯 部署架构
```
用户 → https://nas.pznas.com:7990 (Nginx) → http://127.0.0.1:4005 (Node.js后端)
```

---

## 📁 步骤1: 准备SSL证书

### 1.1 检查现有证书
```bash
# 查看现有证书
sudo ls -la /etc/ssl/certs/ | grep pznas
sudo ls -la /etc/ssl/private/ | grep pznas
```

### 1.2 准备DifyChatSite证书
```bash
# 如果你有nas.pznas.com的证书，放置到标准位置
sudo cp nas.pznas.com_bundle.pem /etc/ssl/certs/
sudo cp nas.pznas.com.key /etc/ssl/private/

# 设置正确权限
sudo chmod 644 /etc/ssl/certs/nas.pznas.com_bundle.pem
sudo chmod 600 /etc/ssl/private/nas.pznas.com.key
sudo chown root:ssl-cert /etc/ssl/private/nas.pznas.com.key
```

### 1.3 如果使用相同证书（通配符证书）
```bash
# 如果www.pznas.com证书支持*.pznas.com，可以直接使用
sudo ln -s /etc/ssl/certs/www.pznas.com_bundle.pem /etc/ssl/certs/nas.pznas.com_bundle.pem
sudo ln -s /etc/ssl/private/www.pznas.com.key /etc/ssl/private/nas.pznas.com.key
```

---

## 📁 步骤2: 创建系统用户和目录

### 2.1 创建服务用户
```bash
# 创建专用用户运行后端服务
sudo useradd --system --shell /bin/false --home-dir /opt/difychat --create-home difychat
```

### 2.2 创建目录结构
```bash
# 创建前端目录
sudo mkdir -p /var/www/difychat

# 创建后端目录
sudo mkdir -p /opt/difychat

# 创建日志目录
sudo mkdir -p /var/log/difychat

# 创建上传目录
sudo mkdir -p /var/uploads/difychat

# 设置权限
sudo chown -R www-data:www-data /var/www/difychat
sudo chown -R difychat:difychat /opt/difychat
sudo chown -R difychat:difychat /var/log/difychat
sudo chown -R difychat:difychat /var/uploads/difychat
```

---

## 📁 步骤3: 部署前端文件

### 3.1 复制前端文件到Web目录
```bash
# 进入项目目录
cd /path/to/DifyChatSite

# 复制所有前端文件
sudo cp *.html /var/www/difychat/
sudo cp -r assets /var/www/difychat/
sudo cp -r config /var/www/difychat/
sudo cp -r js /var/www/difychat/
sudo cp -r pages /var/www/difychat/
sudo cp favicon.ico /var/www/difychat/

# 设置正确权限
sudo chown -R www-data:www-data /var/www/difychat
sudo find /var/www/difychat -type f -exec chmod 644 {} \;
sudo find /var/www/difychat -type d -exec chmod 755 {} \;
```

### 3.2 验证前端文件
```bash
# 检查文件结构
sudo ls -la /var/www/difychat/

# 应该看到:
# index.html, chat.html, login.html 等HTML文件
# assets/, config/, js/, pages/ 目录
# favicon.ico
```

---

## 📁 步骤4: 配置Nginx

### 4.1 复制配置文件
```bash
# 复制配置到nginx目录
sudo cp nginx/difychat-manual.conf /etc/nginx/conf.d/difychat.conf
```

### 4.2 编辑配置文件（如果需要调整）
```bash
sudo nano /etc/nginx/conf.d/difychat.conf
```

**需要确认的配置项**:
- SSL证书路径是否正确
- 域名是否正确（nas.pznas.com）
- 端口是否正确（7990）

### 4.3 测试Nginx配置
```bash
# 测试配置语法
sudo nginx -t

# 如果有错误，查看具体信息并修复
```

### 4.4 重启Nginx
```bash
sudo systemctl restart nginx
sudo systemctl status nginx
```

---

## 📁 步骤5: 部署后端服务

### 5.1 准备后端代码
```bash
# 假设你的后端代码在 ../backend 目录
# 或者从Git仓库克隆后端代码
sudo cp -r /path/to/backend/* /opt/difychat/
sudo chown -R difychat:difychat /opt/difychat
```

### 5.2 安装Node.js依赖
```bash
# 切换到后端目录
cd /opt/difychat

# 以difychat用户身份安装依赖
sudo -u difychat npm install --production
```

### 5.3 创建环境配置文件
```bash
sudo -u difychat tee /opt/difychat/.env << 'EOF'
# 生产环境配置
NODE_ENV=production
PORT=4005
HOST=127.0.0.1

# 数据库配置（根据实际情况修改）
DB_HOST=localhost
DB_PORT=5432
DB_NAME=difychat_prod
DB_USER=difychat
DB_PASSWORD=your_secure_database_password

# JWT配置
JWT_SECRET=your_very_secure_jwt_secret_key_here_at_least_32_characters
JWT_EXPIRES_IN=24h

# CORS配置 - 重要！
CORS_ORIGIN=https://nas.pznas.com:7990
CORS_CREDENTIALS=true

# WebSocket配置
WS_CORS_ORIGIN=https://nas.pznas.com:7990

# Dify API配置（如果使用）
DIFY_API_BASE_URL=http://127.0.0.1:8000
DIFY_API_KEY=your_dify_api_key

# 日志配置
LOG_LEVEL=info
LOG_FILE=/var/log/difychat/app.log

# 文件上传配置
UPLOAD_MAX_SIZE=52428800
UPLOAD_DIR=/var/uploads/difychat

# Session配置
SESSION_SECRET=your_session_secret_key_here
SESSION_SECURE=true
SESSION_HTTP_ONLY=true
SESSION_SAME_SITE=lax

# Redis配置（如果使用）
# REDIS_HOST=127.0.0.1
# REDIS_PORT=6379
# REDIS_PASSWORD=your_redis_password
EOF

# 设置文件权限
sudo chmod 600 /opt/difychat/.env
```

### 5.4 创建systemd服务
```bash
sudo tee /etc/systemd/system/difychat.service << 'EOF'
[Unit]
Description=DifyChatSite Backend Service
Documentation=https://github.com/your-repo/difychatsite
After=network.target

[Service]
Type=simple
User=difychat
Group=difychat
WorkingDirectory=/opt/difychat
ExecStart=/usr/bin/node server.js
Restart=always
RestartSec=10

# 环境变量
Environment=NODE_ENV=production

# 安全配置
NoNewPrivileges=yes
PrivateTmp=yes
ProtectSystem=strict
ProtectHome=yes
ReadWritePaths=/var/log/difychat /var/uploads/difychat

# 限制资源使用
LimitNOFILE=65536
LimitNPROC=4096

# 日志配置
StandardOutput=append:/var/log/difychat/stdout.log
StandardError=append:/var/log/difychat/stderr.log
SyslogIdentifier=difychat

[Install]
WantedBy=multi-user.target
EOF
```

### 5.5 启动后端服务
```bash
# 重新加载systemd配置
sudo systemctl daemon-reload

# 启用开机自启
sudo systemctl enable difychat

# 启动服务
sudo systemctl start difychat

# 检查服务状态
sudo systemctl status difychat
```

---

## 📁 步骤6: 配置防火墙

### 6.1 开放必要端口
```bash
# 开放HTTPS端口7990
sudo ufw allow 7990/tcp

# 检查防火墙状态
sudo ufw status
```

### 6.2 确保内部端口安全
```bash
# 确认4005端口只监听本地（在服务启动后检查）
sudo netstat -tlnp | grep 4005
# 应该显示: 127.0.0.1:4005 而不是 0.0.0.0:4005
```

---

## 📁 步骤7: 验证部署

### 7.1 检查服务状态
```bash
# 检查Nginx
sudo systemctl status nginx

# 检查DifyChatSite后端
sudo systemctl status difychat

# 检查端口监听
sudo netstat -tlnp | grep -E "(7990|4005)"
```

### 7.2 检查日志
```bash
# 查看Nginx访问日志
sudo tail -f /var/log/nginx/difychat-access.log

# 查看Nginx错误日志
sudo tail -f /var/log/nginx/difychat-error.log

# 查看后端应用日志
sudo tail -f /var/log/difychat/app.log

# 查看systemd服务日志
sudo journalctl -u difychat -f
```

### 7.3 功能测试
```bash
# 测试后端健康检查
curl http://127.0.0.1:4005/health

# 测试前端访问（在服务器上）
curl -k https://nas.pznas.com:7990

# 测试API访问
curl -k https://nas.pznas.com:7990/api/health
```

### 7.4 浏览器访问测试
1. 打开浏览器访问: `https://nas.pznas.com:7990`
2. 检查是否正常加载页面
3. 打开浏览器开发者工具，检查：
   - 是否有SSL证书错误
   - 是否有CORS错误
   - WebSocket连接是否正常
   - API请求是否成功

---

## 🔧 常见问题排查

### 问题1: SSL证书错误
```bash
# 检查证书文件是否存在
sudo ls -la /etc/ssl/certs/nas.pznas.com_bundle.pem
sudo ls -la /etc/ssl/private/nas.pznas.com.key

# 检查证书有效性
sudo openssl x509 -in /etc/ssl/certs/nas.pznas.com_bundle.pem -text -noout | grep -E "(Subject|Issuer|Not Before|Not After)"
```

### 问题2: 502 Bad Gateway
```bash
# 检查后端服务是否运行
sudo systemctl status difychat

# 检查后端日志
sudo journalctl -u difychat -n 50

# 检查端口是否监听
sudo netstat -tlnp | grep 4005
```

### 问题3: CORS错误
```bash
# 检查后端环境变量
sudo cat /opt/difychat/.env | grep CORS

# 确认前端访问的是正确域名
# 应该是 https://nas.pznas.com:7990 而不是直接IP访问
```

### 问题4: WebSocket连接失败
```bash
# 检查nginx WebSocket配置
sudo grep -A 10 "socket.io" /etc/nginx/conf.d/difychat.conf

# 测试WebSocket端点
curl -H "Connection: Upgrade" -H "Upgrade: websocket" https://nas.pznas.com:7990/socket.io/
```

---

## 📋 部署完成检查清单

- [ ] ✅ SSL证书配置正确，浏览器无证书警告
- [ ] ✅ Nginx配置测试通过 (`nginx -t`)
- [ ] ✅ 前端文件部署完成，页面正常加载
- [ ] ✅ 后端服务启动成功 (`systemctl status difychat`)
- [ ] ✅ 端口监听正常 (7990和4005)
- [ ] ✅ 防火墙配置正确
- [ ] ✅ API请求正常，无CORS错误
- [ ] ✅ WebSocket连接正常
- [ ] ✅ 日志记录正常
- [ ] ✅ 用户注册/登录功能测试
- [ ] ✅ 聊天功能测试（消息发送/接收）

---

## 🛠️ 日常维护命令

```bash
# 重启服务
sudo systemctl restart difychat nginx

# 查看实时日志
sudo tail -f /var/log/difychat/app.log
sudo tail -f /var/log/nginx/difychat-error.log

# 备份配置
sudo tar -czf ~/difychat-backup-$(date +%Y%m%d).tar.gz \
  /etc/nginx/conf.d/difychat.conf \
  /opt/difychat/.env \
  /var/www/difychat

# 更新应用代码
sudo systemctl stop difychat
cd /path/to/source
sudo cp -r frontend-files/* /var/www/difychat/
sudo cp -r backend-files/* /opt/difychat/
sudo chown -R www-data:www-data /var/www/difychat
sudo chown -R difychat:difychat /opt/difychat
sudo systemctl start difychat
```

---

## 🎉 部署完成！

如果所有步骤都成功完成，你现在可以通过 `https://nas.pznas.com:7990` 访问你的DifyChatSite应用了！

记得定期备份重要数据和配置文件。
