# ğŸš€ DifyChatSite æ‰‹åŠ¨éƒ¨ç½²è¯¦ç»†æ­¥éª¤

## ğŸ“‹ ç¯å¢ƒä¿¡æ¯ç¡®è®¤
- **æœåŠ¡å™¨**: Ubuntu 24
- **ç°æœ‰é…ç½®**: matrix.conf ä½¿ç”¨ç«¯å£6300ï¼Œè¯ä¹¦åœ¨ `/etc/ssl/certs/` å’Œ `/etc/ssl/private/`
- **æ–°éƒ¨ç½²**: DifyChatSite ä½¿ç”¨ç«¯å£7990
- **åŸŸå**: nas.pznas.com

## ğŸ¯ éƒ¨ç½²æ¶æ„
```
ç”¨æˆ· â†’ https://nas.pznas.com:7990 (Nginx) â†’ http://127.0.0.1:4005 (Node.jsåç«¯)
```

---

## ğŸ“ æ­¥éª¤1: å‡†å¤‡SSLè¯ä¹¦

### 1.1 æ£€æŸ¥ç°æœ‰è¯ä¹¦
```bash
# æŸ¥çœ‹ç°æœ‰è¯ä¹¦
sudo ls -la /etc/ssl/certs/ | grep pznas
sudo ls -la /etc/ssl/private/ | grep pznas
```

### 1.2 å‡†å¤‡DifyChatSiteè¯ä¹¦
```bash
# å¦‚æœä½ æœ‰nas.pznas.comçš„è¯ä¹¦ï¼Œæ”¾ç½®åˆ°æ ‡å‡†ä½ç½®
sudo cp nas.pznas.com_bundle.pem /etc/ssl/certs/
sudo cp nas.pznas.com.key /etc/ssl/private/

# è®¾ç½®æ­£ç¡®æƒé™
sudo chmod 644 /etc/ssl/certs/nas.pznas.com_bundle.pem
sudo chmod 600 /etc/ssl/private/nas.pznas.com.key
sudo chown root:ssl-cert /etc/ssl/private/nas.pznas.com.key
```

### 1.3 å¦‚æœä½¿ç”¨ç›¸åŒè¯ä¹¦ï¼ˆé€šé…ç¬¦è¯ä¹¦ï¼‰
```bash
# å¦‚æœwww.pznas.comè¯ä¹¦æ”¯æŒ*.pznas.comï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨
sudo ln -s /etc/ssl/certs/www.pznas.com_bundle.pem /etc/ssl/certs/nas.pznas.com_bundle.pem
sudo ln -s /etc/ssl/private/www.pznas.com.key /etc/ssl/private/nas.pznas.com.key
```

---

## ğŸ“ æ­¥éª¤2: åˆ›å»ºç³»ç»Ÿç”¨æˆ·å’Œç›®å½•

### 2.1 åˆ›å»ºæœåŠ¡ç”¨æˆ·
```bash
# åˆ›å»ºä¸“ç”¨ç”¨æˆ·è¿è¡Œåç«¯æœåŠ¡
sudo useradd --system --shell /bin/false --home-dir /opt/difychat --create-home difychat
```

### 2.2 åˆ›å»ºç›®å½•ç»“æ„
```bash
# åˆ›å»ºå‰ç«¯ç›®å½•
sudo mkdir -p /var/www/difychat

# åˆ›å»ºåç«¯ç›®å½•
sudo mkdir -p /opt/difychat

# åˆ›å»ºæ—¥å¿—ç›®å½•
sudo mkdir -p /var/log/difychat

# åˆ›å»ºä¸Šä¼ ç›®å½•
sudo mkdir -p /var/uploads/difychat

# è®¾ç½®æƒé™
sudo chown -R www-data:www-data /var/www/difychat
sudo chown -R difychat:difychat /opt/difychat
sudo chown -R difychat:difychat /var/log/difychat
sudo chown -R difychat:difychat /var/uploads/difychat
```

---

## ğŸ“ æ­¥éª¤3: éƒ¨ç½²å‰ç«¯æ–‡ä»¶

### 3.1 å¤åˆ¶å‰ç«¯æ–‡ä»¶åˆ°Webç›®å½•
```bash
# è¿›å…¥é¡¹ç›®ç›®å½•
cd /path/to/DifyChatSite

# å¤åˆ¶æ‰€æœ‰å‰ç«¯æ–‡ä»¶
sudo cp *.html /var/www/difychat/
sudo cp -r assets /var/www/difychat/
sudo cp -r config /var/www/difychat/
sudo cp -r js /var/www/difychat/
sudo cp -r pages /var/www/difychat/
sudo cp favicon.ico /var/www/difychat/

# è®¾ç½®æ­£ç¡®æƒé™
sudo chown -R www-data:www-data /var/www/difychat
sudo find /var/www/difychat -type f -exec chmod 644 {} \;
sudo find /var/www/difychat -type d -exec chmod 755 {} \;
```

### 3.2 éªŒè¯å‰ç«¯æ–‡ä»¶
```bash
# æ£€æŸ¥æ–‡ä»¶ç»“æ„
sudo ls -la /var/www/difychat/

# åº”è¯¥çœ‹åˆ°:
# index.html, chat.html, login.html ç­‰HTMLæ–‡ä»¶
# assets/, config/, js/, pages/ ç›®å½•
# favicon.ico
```

---

## ğŸ“ æ­¥éª¤4: é…ç½®Nginx

### 4.1 å¤åˆ¶é…ç½®æ–‡ä»¶
```bash
# å¤åˆ¶é…ç½®åˆ°nginxç›®å½•
sudo cp nginx/difychat-manual.conf /etc/nginx/conf.d/difychat.conf
```

### 4.2 ç¼–è¾‘é…ç½®æ–‡ä»¶ï¼ˆå¦‚æœéœ€è¦è°ƒæ•´ï¼‰
```bash
sudo nano /etc/nginx/conf.d/difychat.conf
```

**éœ€è¦ç¡®è®¤çš„é…ç½®é¡¹**:
- SSLè¯ä¹¦è·¯å¾„æ˜¯å¦æ­£ç¡®
- åŸŸåæ˜¯å¦æ­£ç¡®ï¼ˆnas.pznas.comï¼‰
- ç«¯å£æ˜¯å¦æ­£ç¡®ï¼ˆ7990ï¼‰

### 4.3 æµ‹è¯•Nginxé…ç½®
```bash
# æµ‹è¯•é…ç½®è¯­æ³•
sudo nginx -t

# å¦‚æœæœ‰é”™è¯¯ï¼ŒæŸ¥çœ‹å…·ä½“ä¿¡æ¯å¹¶ä¿®å¤
```

### 4.4 é‡å¯Nginx
```bash
sudo systemctl restart nginx
sudo systemctl status nginx
```

---

## ğŸ“ æ­¥éª¤5: éƒ¨ç½²åç«¯æœåŠ¡

### 5.1 å‡†å¤‡åç«¯ä»£ç 
```bash
# å‡è®¾ä½ çš„åç«¯ä»£ç åœ¨ ../backend ç›®å½•
# æˆ–è€…ä»Gitä»“åº“å…‹éš†åç«¯ä»£ç 
sudo cp -r /path/to/backend/* /opt/difychat/
sudo chown -R difychat:difychat /opt/difychat
```

### 5.2 å®‰è£…Node.jsä¾èµ–
```bash
# åˆ‡æ¢åˆ°åç«¯ç›®å½•
cd /opt/difychat

# ä»¥difychatç”¨æˆ·èº«ä»½å®‰è£…ä¾èµ–
sudo -u difychat npm install --production
```

### 5.3 åˆ›å»ºç¯å¢ƒé…ç½®æ–‡ä»¶
```bash
sudo -u difychat tee /opt/difychat/.env << 'EOF'
# ç”Ÿäº§ç¯å¢ƒé…ç½®
NODE_ENV=production
PORT=4005
HOST=127.0.0.1

# æ•°æ®åº“é…ç½®ï¼ˆæ ¹æ®å®é™…æƒ…å†µä¿®æ”¹ï¼‰
DB_HOST=localhost
DB_PORT=5432
DB_NAME=difychat_prod
DB_USER=difychat
DB_PASSWORD=your_secure_database_password

# JWTé…ç½®
JWT_SECRET=your_very_secure_jwt_secret_key_here_at_least_32_characters
JWT_EXPIRES_IN=24h

# CORSé…ç½® - é‡è¦ï¼
CORS_ORIGIN=https://nas.pznas.com:7990
CORS_CREDENTIALS=true

# WebSocketé…ç½®
WS_CORS_ORIGIN=https://nas.pznas.com:7990

# Dify APIé…ç½®ï¼ˆå¦‚æœä½¿ç”¨ï¼‰
DIFY_API_BASE_URL=http://127.0.0.1:8000
DIFY_API_KEY=your_dify_api_key

# æ—¥å¿—é…ç½®
LOG_LEVEL=info
LOG_FILE=/var/log/difychat/app.log

# æ–‡ä»¶ä¸Šä¼ é…ç½®
UPLOAD_MAX_SIZE=52428800
UPLOAD_DIR=/var/uploads/difychat

# Sessioné…ç½®
SESSION_SECRET=your_session_secret_key_here
SESSION_SECURE=true
SESSION_HTTP_ONLY=true
SESSION_SAME_SITE=lax

# Redisé…ç½®ï¼ˆå¦‚æœä½¿ç”¨ï¼‰
# REDIS_HOST=127.0.0.1
# REDIS_PORT=6379
# REDIS_PASSWORD=your_redis_password
EOF

# è®¾ç½®æ–‡ä»¶æƒé™
sudo chmod 600 /opt/difychat/.env
```

### 5.4 åˆ›å»ºsystemdæœåŠ¡
```bash
sudo tee /etc/systemd/system/difychat.service << 'EOF'
[Unit]
Description=DifyChatSite Backend Service
Documentation=https://github.com/your-repo/difychatsite
After=network.target

[Service]
Type=simple
User=difychat
Group=difychat
WorkingDirectory=/opt/difychat
ExecStart=/usr/bin/node server.js
Restart=always
RestartSec=10

# ç¯å¢ƒå˜é‡
Environment=NODE_ENV=production

# å®‰å…¨é…ç½®
NoNewPrivileges=yes
PrivateTmp=yes
ProtectSystem=strict
ProtectHome=yes
ReadWritePaths=/var/log/difychat /var/uploads/difychat

# é™åˆ¶èµ„æºä½¿ç”¨
LimitNOFILE=65536
LimitNPROC=4096

# æ—¥å¿—é…ç½®
StandardOutput=append:/var/log/difychat/stdout.log
StandardError=append:/var/log/difychat/stderr.log
SyslogIdentifier=difychat

[Install]
WantedBy=multi-user.target
EOF
```

### 5.5 å¯åŠ¨åç«¯æœåŠ¡
```bash
# é‡æ–°åŠ è½½systemdé…ç½®
sudo systemctl daemon-reload

# å¯ç”¨å¼€æœºè‡ªå¯
sudo systemctl enable difychat

# å¯åŠ¨æœåŠ¡
sudo systemctl start difychat

# æ£€æŸ¥æœåŠ¡çŠ¶æ€
sudo systemctl status difychat
```

---

## ğŸ“ æ­¥éª¤6: é…ç½®é˜²ç«å¢™

### 6.1 å¼€æ”¾å¿…è¦ç«¯å£
```bash
# å¼€æ”¾HTTPSç«¯å£7990
sudo ufw allow 7990/tcp

# æ£€æŸ¥é˜²ç«å¢™çŠ¶æ€
sudo ufw status
```

### 6.2 ç¡®ä¿å†…éƒ¨ç«¯å£å®‰å…¨
```bash
# ç¡®è®¤4005ç«¯å£åªç›‘å¬æœ¬åœ°ï¼ˆåœ¨æœåŠ¡å¯åŠ¨åæ£€æŸ¥ï¼‰
sudo netstat -tlnp | grep 4005
# åº”è¯¥æ˜¾ç¤º: 127.0.0.1:4005 è€Œä¸æ˜¯ 0.0.0.0:4005
```

---

## ğŸ“ æ­¥éª¤7: éªŒè¯éƒ¨ç½²

### 7.1 æ£€æŸ¥æœåŠ¡çŠ¶æ€
```bash
# æ£€æŸ¥Nginx
sudo systemctl status nginx

# æ£€æŸ¥DifyChatSiteåç«¯
sudo systemctl status difychat

# æ£€æŸ¥ç«¯å£ç›‘å¬
sudo netstat -tlnp | grep -E "(7990|4005)"
```

### 7.2 æ£€æŸ¥æ—¥å¿—
```bash
# æŸ¥çœ‹Nginxè®¿é—®æ—¥å¿—
sudo tail -f /var/log/nginx/difychat-access.log

# æŸ¥çœ‹Nginxé”™è¯¯æ—¥å¿—
sudo tail -f /var/log/nginx/difychat-error.log

# æŸ¥çœ‹åç«¯åº”ç”¨æ—¥å¿—
sudo tail -f /var/log/difychat/app.log

# æŸ¥çœ‹systemdæœåŠ¡æ—¥å¿—
sudo journalctl -u difychat -f
```

### 7.3 åŠŸèƒ½æµ‹è¯•
```bash
# æµ‹è¯•åç«¯å¥åº·æ£€æŸ¥
curl http://127.0.0.1:4005/health

# æµ‹è¯•å‰ç«¯è®¿é—®ï¼ˆåœ¨æœåŠ¡å™¨ä¸Šï¼‰
curl -k https://nas.pznas.com:7990

# æµ‹è¯•APIè®¿é—®
curl -k https://nas.pznas.com:7990/api/health
```

### 7.4 æµè§ˆå™¨è®¿é—®æµ‹è¯•
1. æ‰“å¼€æµè§ˆå™¨è®¿é—®: `https://nas.pznas.com:7990`
2. æ£€æŸ¥æ˜¯å¦æ­£å¸¸åŠ è½½é¡µé¢
3. æ‰“å¼€æµè§ˆå™¨å¼€å‘è€…å·¥å…·ï¼Œæ£€æŸ¥ï¼š
   - æ˜¯å¦æœ‰SSLè¯ä¹¦é”™è¯¯
   - æ˜¯å¦æœ‰CORSé”™è¯¯
   - WebSocketè¿æ¥æ˜¯å¦æ­£å¸¸
   - APIè¯·æ±‚æ˜¯å¦æˆåŠŸ

---

## ğŸ”§ å¸¸è§é—®é¢˜æ’æŸ¥

### é—®é¢˜1: SSLè¯ä¹¦é”™è¯¯
```bash
# æ£€æŸ¥è¯ä¹¦æ–‡ä»¶æ˜¯å¦å­˜åœ¨
sudo ls -la /etc/ssl/certs/nas.pznas.com_bundle.pem
sudo ls -la /etc/ssl/private/nas.pznas.com.key

# æ£€æŸ¥è¯ä¹¦æœ‰æ•ˆæ€§
sudo openssl x509 -in /etc/ssl/certs/nas.pznas.com_bundle.pem -text -noout | grep -E "(Subject|Issuer|Not Before|Not After)"
```

### é—®é¢˜2: 502 Bad Gateway
```bash
# æ£€æŸ¥åç«¯æœåŠ¡æ˜¯å¦è¿è¡Œ
sudo systemctl status difychat

# æ£€æŸ¥åç«¯æ—¥å¿—
sudo journalctl -u difychat -n 50

# æ£€æŸ¥ç«¯å£æ˜¯å¦ç›‘å¬
sudo netstat -tlnp | grep 4005
```

### é—®é¢˜3: CORSé”™è¯¯
```bash
# æ£€æŸ¥åç«¯ç¯å¢ƒå˜é‡
sudo cat /opt/difychat/.env | grep CORS

# ç¡®è®¤å‰ç«¯è®¿é—®çš„æ˜¯æ­£ç¡®åŸŸå
# åº”è¯¥æ˜¯ https://nas.pznas.com:7990 è€Œä¸æ˜¯ç›´æ¥IPè®¿é—®
```

### é—®é¢˜4: WebSocketè¿æ¥å¤±è´¥
```bash
# æ£€æŸ¥nginx WebSocketé…ç½®
sudo grep -A 10 "socket.io" /etc/nginx/conf.d/difychat.conf

# æµ‹è¯•WebSocketç«¯ç‚¹
curl -H "Connection: Upgrade" -H "Upgrade: websocket" https://nas.pznas.com:7990/socket.io/
```

---

## ğŸ“‹ éƒ¨ç½²å®Œæˆæ£€æŸ¥æ¸…å•

- [ ] âœ… SSLè¯ä¹¦é…ç½®æ­£ç¡®ï¼Œæµè§ˆå™¨æ— è¯ä¹¦è­¦å‘Š
- [ ] âœ… Nginxé…ç½®æµ‹è¯•é€šè¿‡ (`nginx -t`)
- [ ] âœ… å‰ç«¯æ–‡ä»¶éƒ¨ç½²å®Œæˆï¼Œé¡µé¢æ­£å¸¸åŠ è½½
- [ ] âœ… åç«¯æœåŠ¡å¯åŠ¨æˆåŠŸ (`systemctl status difychat`)
- [ ] âœ… ç«¯å£ç›‘å¬æ­£å¸¸ (7990å’Œ4005)
- [ ] âœ… é˜²ç«å¢™é…ç½®æ­£ç¡®
- [ ] âœ… APIè¯·æ±‚æ­£å¸¸ï¼Œæ— CORSé”™è¯¯
- [ ] âœ… WebSocketè¿æ¥æ­£å¸¸
- [ ] âœ… æ—¥å¿—è®°å½•æ­£å¸¸
- [ ] âœ… ç”¨æˆ·æ³¨å†Œ/ç™»å½•åŠŸèƒ½æµ‹è¯•
- [ ] âœ… èŠå¤©åŠŸèƒ½æµ‹è¯•ï¼ˆæ¶ˆæ¯å‘é€/æ¥æ”¶ï¼‰

---

## ğŸ› ï¸ æ—¥å¸¸ç»´æŠ¤å‘½ä»¤

```bash
# é‡å¯æœåŠ¡
sudo systemctl restart difychat nginx

# æŸ¥çœ‹å®æ—¶æ—¥å¿—
sudo tail -f /var/log/difychat/app.log
sudo tail -f /var/log/nginx/difychat-error.log

# å¤‡ä»½é…ç½®
sudo tar -czf ~/difychat-backup-$(date +%Y%m%d).tar.gz \
  /etc/nginx/conf.d/difychat.conf \
  /opt/difychat/.env \
  /var/www/difychat

# æ›´æ–°åº”ç”¨ä»£ç 
sudo systemctl stop difychat
cd /path/to/source
sudo cp -r frontend-files/* /var/www/difychat/
sudo cp -r backend-files/* /opt/difychat/
sudo chown -R www-data:www-data /var/www/difychat
sudo chown -R difychat:difychat /opt/difychat
sudo systemctl start difychat
```

---

## ğŸ‰ éƒ¨ç½²å®Œæˆï¼

å¦‚æœæ‰€æœ‰æ­¥éª¤éƒ½æˆåŠŸå®Œæˆï¼Œä½ ç°åœ¨å¯ä»¥é€šè¿‡ `https://nas.pznas.com:7990` è®¿é—®ä½ çš„DifyChatSiteåº”ç”¨äº†ï¼

è®°å¾—å®šæœŸå¤‡ä»½é‡è¦æ•°æ®å’Œé…ç½®æ–‡ä»¶ã€‚
