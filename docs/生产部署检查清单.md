# DifyChatSite 生产部署检查清单

## 部署架构确认
- [ ] ✅ **架构理解**：前后端同服务器，Nginx统一入口，无CORS问题
- [ ] ✅ **安全性**：外部HTTPS，内部HTTP，后端不暴露公网
- [ ] ✅ **简化配置**：后端无需SSL，Nginx统一处理证书

## 环境准备 ✅

### 服务器环境
- [ ] Linux服务器（推荐Ubuntu 20.04+/CentOS 8+）
- [ ] 或 Windows Server 2019+
- [ ] 至少 2GB RAM，10GB 磁盘空间
- [ ] 网络连接正常

### 必要软件安装
- [ ] **Node.js** 16.x+ 和 npm
- [ ] **Nginx** 1.18+
- [ ] **Git**（用于代码部署）
- [ ] **数据库**（如PostgreSQL/MySQL，如果需要）

### 域名和证书
- [ ] 域名解析到服务器IP：`nas.pznas.com`
- [ ] SSL证书准备就绪
  - [ ] 证书文件：`certificate.crt`
  - [ ] 私钥文件：`private.key`
  - [ ] 证书路径配置正确

## 前端部署 ✅

### 静态文件
- [ ] HTML文件复制到Web目录
- [ ] CSS/JS/图片资源复制完成
- [ ] 文件权限设置正确（644文件，755目录）
- [ ] 配置文件更新：
  - [ ] `config/env.js` - 生产环境配置
  - [ ] API_BASE_URL使用相对路径
  - [ ] WebSocket URL配置正确

### Nginx配置
- [ ] Nginx配置文件创建：`/etc/nginx/sites-available/difychat`
- [ ] 站点启用：`ln -s /etc/nginx/sites-available/difychat /etc/nginx/sites-enabled/`
- [ ] SSL证书路径正确
- [ ] 静态文件服务配置
- [ ] API代理配置（`/api/` -> `http://127.0.0.1:4005`）
- [ ] WebSocket代理配置（`/socket.io/`）
- [ ] Nginx配置测试通过：`nginx -t`
- [ ] Nginx重启成功

## 后端部署 ✅

### 代码部署
- [ ] 后端代码复制到服务目录
- [ ] 依赖安装：`npm install --production`
- [ ] 环境变量配置：`.env` 文件
  - [ ] 监听地址：`HOST=127.0.0.1`
  - [ ] 端口配置：`PORT=4005`
  - [ ] 数据库连接配置
  - [ ] JWT密钥配置
  - [ ] CORS配置：`CORS_ORIGIN=https://nas.pznas.com:7990`

### 服务配置
- [ ] 系统服务创建：`/etc/systemd/system/difychat.service`
- [ ] 服务用户创建（非root）
- [ ] 日志目录权限设置
- [ ] 服务启动：`systemctl start difychat`
- [ ] 服务自启动：`systemctl enable difychat`

## 安全配置 ✅

### 防火墙设置
- [ ] 开放HTTPS端口：7990
- [ ] 关闭后端端口：4005（仅本地访问）
- [ ] SSH端口保护（如22）

### 服务安全
- [ ] 后端服务以非特权用户运行
- [ ] 敏感文件权限限制（如.env文件600权限）
- [ ] SSL安全配置（TLS 1.2+）
- [ ] HTTP自动重定向HTTPS

### 应用安全
- [ ] JWT密钥足够复杂
- [ ] 数据库密码强度
- [ ] 文件上传限制
- [ ] 请求速率限制

## 功能验证 ✅

### 基础连通性
- [ ] **前端访问**：`https://nas.pznas.com:7990`
- [ ] **页面加载**：index.html正常显示
- [ ] **静态资源**：CSS/JS/图片正常加载
- [ ] **HTTPS**：SSL证书有效，无安全警告

### API功能测试
- [ ] **健康检查**：`https://nas.pznas.com:7990/api/health`
- [ ] **用户认证**：登录功能正常
- [ ] **API请求**：无CORS错误
- [ ] **响应正常**：API返回预期数据

### WebSocket测试
- [ ] **连接建立**：WebSocket连接成功
- [ ] **实时消息**：聊天消息实时传送
- [ ] **连接稳定**：无频繁断线重连
- [ ] **WSS协议**：使用安全WebSocket

### 性能测试
- [ ] **页面响应**：< 2秒加载完成
- [ ] **API响应**：< 500ms响应时间
- [ ] **并发处理**：多用户同时访问正常
- [ ] **内存使用**：服务内存占用合理

## 监控和维护 ✅

### 日志配置
- [ ] **Nginx日志**：`/var/log/nginx/difychat-*.log`
- [ ] **应用日志**：`/var/log/difychat/app.log`
- [ ] **系统服务日志**：`journalctl -u difychat`
- [ ] **日志轮转**：配置logrotate防止日志过大

### 监控检查
- [ ] **服务状态**：`systemctl status difychat nginx`
- [ ] **端口监听**：`netstat -tlnp | grep -E ':(4005|7990)'`
- [ ] **进程状态**：确认Node.js和Nginx进程正常
- [ ] **磁盘空间**：确保有足够空间

### 备份计划
- [ ] **代码备份**：定期备份前后端代码
- [ ] **配置备份**：Nginx配置和环境变量
- [ ] **数据库备份**：如果使用数据库
- [ ] **SSL证书备份**：证书文件备份

## 部署后验收 ✅

### 完整流程测试
- [ ] **用户注册/登录**
- [ ] **创建聊天室**
- [ ] **发送消息**（确认只显示一条，不重复）
- [ ] **实时接收消息**
- [ ] **WebSocket重连**
- [ ] **多窗口测试**
- [ ] **移动设备兼容性**

### 异常情况测试
- [ ] **服务重启后**：功能正常恢复
- [ ] **网络中断后**：自动重连工作
- [ ] **高并发测试**：多用户同时使用
- [ ] **长时间运行**：24小时稳定性

## 优化建议 💡

### 性能优化
- [ ] 静态文件缓存配置
- [ ] Gzip压缩启用
- [ ] CDN配置（可选）
- [ ] 数据库连接池优化

### 安全加固
- [ ] Nginx安全头配置
- [ ] 请求频率限制
- [ ] SQL注入防护
- [ ] XSS防护

## 故障排查指南 🔧

### 常见问题检查
- [ ] **502 Bad Gateway**：检查后端服务是否启动
- [ ] **WebSocket连接失败**：检查代理配置
- [ ] **CORS错误**：确认通过Nginx访问而非直连后端
- [ ] **SSL证书错误**：检查证书路径和有效期
- [ ] **消息重复显示**：已修复，确认前端代码是最新版

### 调试命令
```bash
# 检查服务状态
systemctl status difychat nginx

# 查看日志
journalctl -u difychat -f
tail -f /var/log/nginx/difychat-error.log

# 检查端口
netstat -tlnp | grep -E ':(4005|7990)'

# 测试后端API
curl http://127.0.0.1:4005/health

# 测试前端访问
curl -k https://nas.pznas.com:7990
```

---

## 📋 部署完成确认

- [ ] **所有检查项目完成** ✅
- [ ] **生产环境访问正常** ✅
- [ ] **功能测试通过** ✅
- [ ] **性能表现满意** ✅
- [ ] **安全配置到位** ✅
- [ ] **监控和日志就绪** ✅

**部署负责人签名**: _________________ **日期**: _________________

**验收人签名**: _________________ **日期**: _________________

---

🎉 **恭喜！DifyChatSite 生产环境部署完成！**
