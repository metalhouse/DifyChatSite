# ğŸš€ DifyChatSite ç”Ÿäº§ç¯å¢ƒå¿«é€Ÿéƒ¨ç½²æŒ‡å—

## ğŸ“‹ éƒ¨ç½²æ¶æ„

```
å¤–éƒ¨ç”¨æˆ· â†’ HTTPS/WSS (Nginx:7990) â†’ HTTP/WS (Node.js:4005)
         åŒä¸€æœåŠ¡å™¨ï¼Œæ— CORSé—®é¢˜ï¼ŒSSLç»Ÿä¸€å¤„ç†
```

**ä¼˜åŠ¿**ï¼š
- âœ… æ— CORSé—®é¢˜ï¼ˆåŒæºè®¿é—®ï¼‰
- âœ… SSLç»Ÿä¸€ç®¡ç†ï¼ˆåªéœ€åœ¨Nginxé…ç½®ï¼‰
- âœ… åç«¯ç®€åŒ–ï¼ˆæ— éœ€SSLè¯ä¹¦ï¼‰
- âœ… å®‰å…¨å¯é ï¼ˆåç«¯ä¸æš´éœ²å…¬ç½‘ï¼‰

## ğŸ¯ ä¸€é”®éƒ¨ç½²ï¼ˆLinuxï¼‰

```bash
# 1. è·å–ä»£ç 
git clone your-repo-url
cd DifyChatSite

# 2. æ‰§è¡Œéƒ¨ç½²è„šæœ¬
sudo chmod +x deploy-production.sh
sudo ./deploy-production.sh

# 3. æŒ‰æç¤ºé…ç½®SSLè¯ä¹¦
# 4. ä¿®æ”¹åç«¯é…ç½®æ–‡ä»¶
sudo nano /opt/difychat-backend/.env

# 5. å¯åŠ¨æœåŠ¡
sudo systemctl start difychat
sudo systemctl restart nginx
```

## ğŸ¯ æ‰‹åŠ¨éƒ¨ç½²æ­¥éª¤

### 1. ç¯å¢ƒå‡†å¤‡
```bash
# å®‰è£…å¿…è¦è½¯ä»¶
sudo apt update
sudo apt install nginx nodejs npm git -y

# åˆ›å»ºéƒ¨ç½²ç›®å½•
sudo mkdir -p /var/www/difychat
sudo mkdir -p /opt/difychat-backend
```

### 2. å‰ç«¯éƒ¨ç½²
```bash
# å¤åˆ¶å‰ç«¯æ–‡ä»¶
sudo cp -r *.html /var/www/difychat/
sudo cp -r assets config js pages /var/www/difychat/
sudo cp favicon.ico /var/www/difychat/

# è®¾ç½®æƒé™
sudo chown -R www-data:www-data /var/www/difychat
```

### 3. Nginxé…ç½®
```bash
# å¤åˆ¶é…ç½®æ–‡ä»¶
sudo cp nginx/production-deploy.conf /etc/nginx/sites-available/difychat

# ç¼–è¾‘SSLè¯ä¹¦è·¯å¾„
sudo nano /etc/nginx/sites-available/difychat

# å¯ç”¨ç«™ç‚¹
sudo ln -s /etc/nginx/sites-available/difychat /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl restart nginx
```

### 4. åç«¯éƒ¨ç½²
```bash
# å¤åˆ¶åç«¯ä»£ç ï¼ˆå‡è®¾åœ¨../backendç›®å½•ï¼‰
sudo cp -r ../backend/* /opt/difychat-backend/
cd /opt/difychat-backend

# å®‰è£…ä¾èµ–
sudo npm install --production

# åˆ›å»ºç¯å¢ƒé…ç½®
sudo tee .env << EOF
NODE_ENV=production
PORT=4005
HOST=127.0.0.1
CORS_ORIGIN=https://nas.pznas.com:7990
WS_CORS_ORIGIN=https://nas.pznas.com:7990
# å…¶ä»–é…ç½®...
EOF

# åˆ›å»ºç³»ç»ŸæœåŠ¡
sudo tee /etc/systemd/system/difychat.service << EOF
[Unit]
Description=DifyChatSite Backend
After=network.target

[Service]
Type=simple
User=www-data
WorkingDirectory=/opt/difychat-backend
ExecStart=/usr/bin/node server.js
Restart=always

[Install]
WantedBy=multi-user.target
EOF

# å¯åŠ¨æœåŠ¡
sudo systemctl daemon-reload
sudo systemctl enable difychat
sudo systemctl start difychat
```

## ğŸ”§ Windowséƒ¨ç½²

```batch
# 1. è¿è¡Œéƒ¨ç½²è„šæœ¬
deploy-production.bat

# 2. é…ç½®SSLè¯ä¹¦åˆ° C:\nginx\ssl\

# 3. ä¿®æ”¹Nginxä¸»é…ç½®æ–‡ä»¶ï¼ŒåŒ…å«difychat.conf

# 4. ä½¿ç”¨ manage-services.bat ç®¡ç†æœåŠ¡
```

## âœ… éªŒè¯éƒ¨ç½²

### åŸºç¡€æ£€æŸ¥
```bash
# æ£€æŸ¥æœåŠ¡çŠ¶æ€
sudo systemctl status nginx difychat

# æ£€æŸ¥ç«¯å£ç›‘å¬
sudo netstat -tlnp | grep -E ':(4005|7990)'

# æ£€æŸ¥åç«¯å¥åº·
curl http://127.0.0.1:4005/health
```

### åŠŸèƒ½æµ‹è¯•
1. è®¿é—®ï¼š`https://nas.pznas.com:7990`
2. æ³¨å†Œ/ç™»å½•ç”¨æˆ·
3. åˆ›å»ºèŠå¤©å®¤
4. å‘é€æ¶ˆæ¯ï¼ˆç¡®è®¤ä¸é‡å¤ï¼‰
5. æµ‹è¯•WebSocketè¿æ¥

## ğŸ“Š å…³é”®é…ç½®æ–‡ä»¶

### å‰ç«¯ç¯å¢ƒé…ç½®ï¼ˆconfig/env.jsï¼‰
```javascript
// ç”Ÿäº§ç¯å¢ƒè‡ªåŠ¨ä½¿ç”¨åŒæºé…ç½®
API_BASE_URL: `${window.location.protocol}//${window.location.host}`,
WS_URL: `${window.location.protocol.replace('http', 'ws')}//${window.location.host}`
```

### åç«¯ç¯å¢ƒé…ç½®ï¼ˆ.envï¼‰
```env
NODE_ENV=production
HOST=127.0.0.1
PORT=4005
CORS_ORIGIN=https://nas.pznas.com:7990
```

### Nginxæ ¸å¿ƒé…ç½®
```nginx
server {
    listen 7990 ssl;
    server_name nas.pznas.com;
    
    # SSLé…ç½®
    ssl_certificate /path/to/certificate.crt;
    ssl_private_key /path/to/private.key;
    
    # å‰ç«¯é™æ€æ–‡ä»¶
    location / {
        root /var/www/difychat;
        try_files $uri $uri/ /index.html;
    }
    
    # APIä»£ç†
    location /api/ {
        proxy_pass http://127.0.0.1:4005;
        proxy_set_header Host $host;
    }
    
    # WebSocketä»£ç†
    location /socket.io/ {
        proxy_pass http://127.0.0.1:4005;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }
}
```

## ğŸ” æ•…éšœæ’æŸ¥

### 502 Bad Gateway
```bash
# æ£€æŸ¥åç«¯æœåŠ¡
sudo systemctl status difychat
sudo journalctl -u difychat -f

# æ£€æŸ¥åç«¯ç«¯å£
sudo netstat -tlnp | grep 4005
```

### WebSocketè¿æ¥å¤±è´¥
```bash
# æ£€æŸ¥Nginx WebSocketé…ç½®
sudo nginx -t
grep -A 10 "socket.io" /etc/nginx/sites-enabled/difychat
```

### CORSé”™è¯¯
- âœ… ç¡®ä¿é€šè¿‡ `https://nas.pznas.com:7990` è®¿é—®
- âŒ ä¸è¦ç›´æ¥è®¿é—® `http://ip:4005`

## ğŸ“± ç§»åŠ¨ç«¯é…ç½®

H5å’Œå°ç¨‹åºWebViewéƒ½ä½¿ç”¨ç›¸åŒé…ç½®ï¼š
- URL: `https://nas.pznas.com:7990`
- WebSocket: è‡ªåŠ¨å‡çº§ä¸ºWSS
- æ— éœ€ç‰¹æ®ŠCORSé…ç½®

## ğŸ›¡ï¸ å®‰å…¨æ£€æŸ¥

- [ ] åç«¯åªç›‘å¬127.0.0.1:4005
- [ ] é˜²ç«å¢™å…³é—­4005ç«¯å£å¤–éƒ¨è®¿é—®
- [ ] SSLè¯ä¹¦æœ‰æ•ˆæœŸæ£€æŸ¥
- [ ] å¼ºå¯†ç ç­–ç•¥
- [ ] å®šæœŸå®‰å…¨æ›´æ–°

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–

### Nginxä¼˜åŒ–
```nginx
# å¯ç”¨Gzip
gzip on;
gzip_types text/css application/javascript;

# é™æ€æ–‡ä»¶ç¼“å­˜
location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg)$ {
    expires 1y;
    add_header Cache-Control "public, immutable";
}
```

### åç«¯ä¼˜åŒ–
- å¯ç”¨é›†ç¾¤æ¨¡å¼ï¼ˆPM2ï¼‰
- æ•°æ®åº“è¿æ¥æ± 
- Redisç¼“å­˜ï¼ˆå¯é€‰ï¼‰

## ğŸ”„ å‡çº§å’Œç»´æŠ¤

```bash
# å¤‡ä»½é…ç½®
sudo cp -r /etc/nginx/sites-available/difychat ~/backup/
sudo cp /opt/difychat-backend/.env ~/backup/

# æ›´æ–°ä»£ç 
git pull origin master

# é‡æ–°éƒ¨ç½²
sudo systemctl restart difychat nginx
```

---

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚æœ‰é—®é¢˜ï¼Œè¯·æ£€æŸ¥ï¼š
1. [å®Œæ•´éƒ¨ç½²æ£€æŸ¥æ¸…å•](./ç”Ÿäº§éƒ¨ç½²æ£€æŸ¥æ¸…å•.md)
2. ç³»ç»Ÿæ—¥å¿—ï¼š`journalctl -u difychat nginx -f`
3. åº”ç”¨æ—¥å¿—ï¼š`/var/log/difychat/app.log`

**ğŸ‰ éƒ¨ç½²æˆåŠŸï¼äº«å—ä½ çš„èŠå¤©åº”ç”¨å§ï¼**
