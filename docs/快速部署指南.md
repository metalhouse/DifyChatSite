# 🚀 DifyChatSite 生产环境快速部署指南

## 📋 部署架构

```
外部用户 → HTTPS/WSS (Nginx:7990) → HTTP/WS (Node.js:4005)
         同一服务器，无CORS问题，SSL统一处理
```

**优势**：
- ✅ 无CORS问题（同源访问）
- ✅ SSL统一管理（只需在Nginx配置）
- ✅ 后端简化（无需SSL证书）
- ✅ 安全可靠（后端不暴露公网）

## 🎯 一键部署（Linux）

```bash
# 1. 获取代码
git clone your-repo-url
cd DifyChatSite

# 2. 执行部署脚本
sudo chmod +x deploy-production.sh
sudo ./deploy-production.sh

# 3. 按提示配置SSL证书
# 4. 修改后端配置文件
sudo nano /opt/difychat-backend/.env

# 5. 启动服务
sudo systemctl start difychat
sudo systemctl restart nginx
```

## 🎯 手动部署步骤

### 1. 环境准备
```bash
# 安装必要软件
sudo apt update
sudo apt install nginx nodejs npm git -y

# 创建部署目录
sudo mkdir -p /var/www/difychat
sudo mkdir -p /opt/difychat-backend
```

### 2. 前端部署
```bash
# 复制前端文件
sudo cp -r *.html /var/www/difychat/
sudo cp -r assets config js pages /var/www/difychat/
sudo cp favicon.ico /var/www/difychat/

# 设置权限
sudo chown -R www-data:www-data /var/www/difychat
```

### 3. Nginx配置
```bash
# 复制配置文件
sudo cp nginx/production-deploy.conf /etc/nginx/sites-available/difychat

# 编辑SSL证书路径
sudo nano /etc/nginx/sites-available/difychat

# 启用站点
sudo ln -s /etc/nginx/sites-available/difychat /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl restart nginx
```

### 4. 后端部署
```bash
# 复制后端代码（假设在../backend目录）
sudo cp -r ../backend/* /opt/difychat-backend/
cd /opt/difychat-backend

# 安装依赖
sudo npm install --production

# 创建环境配置
sudo tee .env << EOF
NODE_ENV=production
PORT=4005
HOST=127.0.0.1
CORS_ORIGIN=https://nas.pznas.com:7990
WS_CORS_ORIGIN=https://nas.pznas.com:7990
# 其他配置...
EOF

# 创建系统服务
sudo tee /etc/systemd/system/difychat.service << EOF
[Unit]
Description=DifyChatSite Backend
After=network.target

[Service]
Type=simple
User=www-data
WorkingDirectory=/opt/difychat-backend
ExecStart=/usr/bin/node server.js
Restart=always

[Install]
WantedBy=multi-user.target
EOF

# 启动服务
sudo systemctl daemon-reload
sudo systemctl enable difychat
sudo systemctl start difychat
```

## 🔧 Windows部署

```batch
# 1. 运行部署脚本
deploy-production.bat

# 2. 配置SSL证书到 C:\nginx\ssl\

# 3. 修改Nginx主配置文件，包含difychat.conf

# 4. 使用 manage-services.bat 管理服务
```

## ✅ 验证部署

### 基础检查
```bash
# 检查服务状态
sudo systemctl status nginx difychat

# 检查端口监听
sudo netstat -tlnp | grep -E ':(4005|7990)'

# 检查后端健康
curl http://127.0.0.1:4005/health
```

### 功能测试
1. 访问：`https://nas.pznas.com:7990`
2. 注册/登录用户
3. 创建聊天室
4. 发送消息（确认不重复）
5. 测试WebSocket连接

## 📊 关键配置文件

### 前端环境配置（config/env.js）
```javascript
// 生产环境自动使用同源配置
API_BASE_URL: `${window.location.protocol}//${window.location.host}`,
WS_URL: `${window.location.protocol.replace('http', 'ws')}//${window.location.host}`
```

### 后端环境配置（.env）
```env
NODE_ENV=production
HOST=127.0.0.1
PORT=4005
CORS_ORIGIN=https://nas.pznas.com:7990
```

### Nginx核心配置
```nginx
server {
    listen 7990 ssl;
    server_name nas.pznas.com;
    
    # SSL配置
    ssl_certificate /path/to/certificate.crt;
    ssl_private_key /path/to/private.key;
    
    # 前端静态文件
    location / {
        root /var/www/difychat;
        try_files $uri $uri/ /index.html;
    }
    
    # API代理
    location /api/ {
        proxy_pass http://127.0.0.1:4005;
        proxy_set_header Host $host;
    }
    
    # WebSocket代理
    location /socket.io/ {
        proxy_pass http://127.0.0.1:4005;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }
}
```

## 🔍 故障排查

### 502 Bad Gateway
```bash
# 检查后端服务
sudo systemctl status difychat
sudo journalctl -u difychat -f

# 检查后端端口
sudo netstat -tlnp | grep 4005
```

### WebSocket连接失败
```bash
# 检查Nginx WebSocket配置
sudo nginx -t
grep -A 10 "socket.io" /etc/nginx/sites-enabled/difychat
```

### CORS错误
- ✅ 确保通过 `https://nas.pznas.com:7990` 访问
- ❌ 不要直接访问 `http://ip:4005`

## 📱 移动端配置

H5和小程序WebView都使用相同配置：
- URL: `https://nas.pznas.com:7990`
- WebSocket: 自动升级为WSS
- 无需特殊CORS配置

## 🛡️ 安全检查

- [ ] 后端只监听127.0.0.1:4005
- [ ] 防火墙关闭4005端口外部访问
- [ ] SSL证书有效期检查
- [ ] 强密码策略
- [ ] 定期安全更新

## 📈 性能优化

### Nginx优化
```nginx
# 启用Gzip
gzip on;
gzip_types text/css application/javascript;

# 静态文件缓存
location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg)$ {
    expires 1y;
    add_header Cache-Control "public, immutable";
}
```

### 后端优化
- 启用集群模式（PM2）
- 数据库连接池
- Redis缓存（可选）

## 🔄 升级和维护

```bash
# 备份配置
sudo cp -r /etc/nginx/sites-available/difychat ~/backup/
sudo cp /opt/difychat-backend/.env ~/backup/

# 更新代码
git pull origin master

# 重新部署
sudo systemctl restart difychat nginx
```

---

## 📞 技术支持

如有问题，请检查：
1. [完整部署检查清单](./生产部署检查清单.md)
2. 系统日志：`journalctl -u difychat nginx -f`
3. 应用日志：`/var/log/difychat/app.log`

**🎉 部署成功！享受你的聊天应用吧！**
