<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è®¤è¯çŠ¶æ€æ£€æŸ¥è°ƒè¯•å·¥å…·</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .warning { background: #fff3cd; color: #856404; }
        .info { background: #d1ecf1; color: #0c5460; }
        .btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .btn:hover { background: #0056b3; }
        .debug-output {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <h1>ğŸ” è®¤è¯çŠ¶æ€æ£€æŸ¥è°ƒè¯•å·¥å…·</h1>
    
    <div class="card">
        <h3>å½“å‰çŠ¶æ€æ£€æŸ¥</h3>
        <button class="btn" onclick="checkCurrentStatus()">æ£€æŸ¥å½“å‰è®¤è¯çŠ¶æ€</button>
        <button class="btn" onclick="testAuthFlow()">æµ‹è¯•è®¤è¯æµç¨‹</button>
        <button class="btn" onclick="clearStorage()">æ¸…é™¤å­˜å‚¨</button>
        <div id="currentStatus" class="debug-output"></div>
    </div>

    <div class="card">
        <h3>æ¨¡æ‹Ÿç™»å½•åæ£€æŸ¥</h3>
        <button class="btn" onclick="simulateLogin()">æ¨¡æ‹Ÿç™»å½•æˆåŠŸ</button>
        <button class="btn" onclick="testSelectConversation()">æµ‹è¯•"é€‰æ‹©ä¼šè¯"åŠŸèƒ½</button>
        <div id="simulationResult" class="debug-output"></div>
    </div>

    <div class="card">
        <h3>å­˜å‚¨æ•°æ®æ£€æŸ¥</h3>
        <button class="btn" onclick="checkStorage()">æ£€æŸ¥å­˜å‚¨æ•°æ®</button>
        <div id="storageData" class="debug-output"></div>
    </div>

    <script type="module">
        // å¯¼å…¥å¿…è¦çš„æ¨¡å—
        let authService, storageManager;
        
        try {
            const authModule = await import('./js/services/auth-service.js');
            const storageModule = await import('./js/utils/storage.js');
            authService = authModule.default;
            storageManager = storageModule.default;
            
            console.log('âœ… æ¨¡å—åŠ è½½æˆåŠŸ');
        } catch (error) {
            console.error('âŒ æ¨¡å—åŠ è½½å¤±è´¥:', error);
            document.getElementById('currentStatus').textContent = 'æ¨¡å—åŠ è½½å¤±è´¥: ' + error.message;
        }

        // æ£€æŸ¥å½“å‰è®¤è¯çŠ¶æ€
        window.checkCurrentStatus = function() {
            const output = document.getElementById('currentStatus');
            const results = [];
            
            try {
                // 1. æ£€æŸ¥å­˜å‚¨ä¸­çš„æ•°æ®
                const accessToken = localStorage.getItem('dify_access_token');
                const refreshToken = localStorage.getItem('dify_refresh_token');
                const userInfo = localStorage.getItem('dify_user_info');
                const expiresAt = localStorage.getItem('dify_token_expires_at');
                
                results.push('=== å­˜å‚¨æ£€æŸ¥ ===');
                results.push(`Access Token: ${accessToken ? 'å­˜åœ¨ (' + accessToken.length + ' å­—ç¬¦)' : 'ä¸å­˜åœ¨'}`);
                results.push(`Refresh Token: ${refreshToken ? 'å­˜åœ¨ (' + refreshToken.length + ' å­—ç¬¦)' : 'ä¸å­˜åœ¨'}`);
                results.push(`User Info: ${userInfo ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨'}`);
                results.push(`Expires At: ${expiresAt ? new Date(parseInt(expiresAt)).toLocaleString() : 'ä¸å­˜åœ¨'}`);
                
                if (expiresAt) {
                    const now = Date.now();
                    const expiry = parseInt(expiresAt);
                    const isExpired = now > expiry;
                    const timeLeft = isExpired ? 0 : Math.round((expiry - now) / 1000);
                    results.push(`TokençŠ¶æ€: ${isExpired ? 'å·²è¿‡æœŸ' : 'æœ‰æ•ˆï¼Œå‰©ä½™' + timeLeft + 'ç§’'}`);
                }
                
                // 2. æ£€æŸ¥è®¤è¯æœåŠ¡çŠ¶æ€
                if (authService) {
                    results.push('\\n=== è®¤è¯æœåŠ¡çŠ¶æ€ ===');
                    results.push(`Auth State: ${authService.getAuthState()}`);
                    results.push(`Current User: ${authService.getCurrentUser() ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨'}`);
                    results.push(`Is Authenticated: ${authService.isAuthenticated()}`);
                    
                    const user = authService.getCurrentUser();
                    if (user) {
                        results.push(`ç”¨æˆ·ä¿¡æ¯:`);
                        results.push(`  - ID: ${user.id || 'N/A'}`);
                        results.push(`  - ç”¨æˆ·å: ${user.username || 'N/A'}`);
                        results.push(`  - é‚®ç®±: ${user.email || 'N/A'}`);
                    }
                }
                
                // 3. æ£€æŸ¥å­˜å‚¨ç®¡ç†å™¨
                if (storageManager) {
                    results.push('\\n=== å­˜å‚¨ç®¡ç†å™¨çŠ¶æ€ ===');
                    results.push(`getAccessToken(): ${storageManager.getAccessToken() ? 'æœ‰token' : 'æ— token'}`);
                    results.push(`getRefreshToken(): ${storageManager.getRefreshToken() ? 'æœ‰token' : 'æ— token'}`);
                    results.push(`getUserInfo(): ${storageManager.getUserInfo() ? 'æœ‰ç”¨æˆ·ä¿¡æ¯' : 'æ— ç”¨æˆ·ä¿¡æ¯'}`);
                    results.push(`isTokenExpired(): ${storageManager.isTokenExpired()}`);
                }
                
            } catch (error) {
                results.push('\\nâŒ æ£€æŸ¥è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯:');
                results.push(error.message);
                results.push(error.stack);
            }
            
            output.textContent = results.join('\\n');
        };

        // æ¨¡æ‹Ÿç™»å½•
        window.simulateLogin = function() {
            const output = document.getElementById('simulationResult');
            const results = [];
            
            try {
                // æ¨¡æ‹Ÿç™»å½•æˆåŠŸçš„æ•°æ®
                const mockLoginData = {
                    accessToken: 'mock_access_token_' + Date.now(),
                    refreshToken: 'mock_refresh_token_' + Date.now(),
                    expiresIn: 3600, // 1å°æ—¶
                    user: {
                        id: 'user_123',
                        username: 'testuser',
                        email: 'test@example.com',
                        nickname: 'æµ‹è¯•ç”¨æˆ·'
                    }
                };
                
                results.push('=== æ¨¡æ‹Ÿç™»å½•è¿‡ç¨‹ ===');
                results.push('1. è®¾ç½®Token...');
                
                // ç›´æ¥è®¾ç½®å­˜å‚¨æ•°æ®
                if (storageManager) {
                    storageManager.setTokens(
                        mockLoginData.accessToken, 
                        mockLoginData.refreshToken, 
                        mockLoginData.expiresIn
                    );
                    storageManager.setUserInfo(mockLoginData.user);
                }
                
                results.push('2. æ›´æ–°è®¤è¯æœåŠ¡çŠ¶æ€...');
                
                // æ›´æ–°è®¤è¯æœåŠ¡çŠ¶æ€
                if (authService) {
                    authService.currentUser = mockLoginData.user;
                    authService.authState = 'authenticated';
                }
                
                results.push('3. éªŒè¯è®¾ç½®ç»“æœ...');
                
                // éªŒè¯ç»“æœ
                setTimeout(() => {
                    const isAuth = authService ? authService.isAuthenticated() : false;
                    results.push(`isAuthenticated(): ${isAuth}`);
                    results.push('\\nâœ… æ¨¡æ‹Ÿç™»å½•å®Œæˆ');
                    output.textContent = results.join('\\n');
                }, 100);
                
            } catch (error) {
                results.push('\\nâŒ æ¨¡æ‹Ÿç™»å½•å¤±è´¥:');
                results.push(error.message);
            }
            
            output.textContent = results.join('\\n');
        };

        // æµ‹è¯•é€‰æ‹©ä¼šè¯åŠŸèƒ½
        window.testSelectConversation = async function() {
            const output = document.getElementById('simulationResult');
            const results = [];
            
            try {
                results.push('=== æµ‹è¯•é€‰æ‹©ä¼šè¯åŠŸèƒ½ ===');
                
                // æ¨¡æ‹Ÿ checkAuthBeforeAction å‡½æ•°çš„é€»è¾‘
                results.push('1. æ‰§è¡Œè®¤è¯æ£€æŸ¥...');
                
                if (!authService) {
                    throw new Error('è®¤è¯æœåŠ¡æœªåŠ è½½');
                }
                
                const isAuthenticated = authService.isAuthenticated();
                results.push(`è®¤è¯æ£€æŸ¥ç»“æœ: ${isAuthenticated}`);
                
                if (!isAuthenticated) {
                    results.push('âŒ è®¤è¯æ£€æŸ¥å¤±è´¥ï¼Œä¼šè§¦å‘ç™»å½•è¶…æ—¶æ¨¡æ€æ¡†');
                    results.push('\\nè¯¦ç»†çŠ¶æ€:');
                    results.push(`  - authState: ${authService.getAuthState()}`);
                    results.push(`  - currentUser: ${authService.getCurrentUser() ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨'}`);
                    results.push(`  - accessToken: ${storageManager.getAccessToken() ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨'}`);
                } else {
                    results.push('âœ… è®¤è¯æ£€æŸ¥é€šè¿‡ï¼Œå¯ä»¥æ­£å¸¸æ‰§è¡Œé€‰æ‹©ä¼šè¯åŠŸèƒ½');
                }
                
            } catch (error) {
                results.push('\\nâŒ æµ‹è¯•è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯:');
                results.push(error.message);
            }
            
            output.textContent = results.join('\\n');
        };

        // æ£€æŸ¥å­˜å‚¨æ•°æ®
        window.checkStorage = function() {
            const output = document.getElementById('storageData');
            const results = [];
            
            results.push('=== localStorage æ•°æ® ===');
            
            const keys = [
                'dify_access_token',
                'dify_refresh_token', 
                'dify_token_expires_at',
                'dify_user_info'
            ];
            
            keys.forEach(key => {
                const value = localStorage.getItem(key);
                if (value) {
                    if (key === 'dify_user_info') {
                        try {
                            const parsed = JSON.parse(value);
                            results.push(`${key}: ${JSON.stringify(parsed, null, 2)}`);
                        } catch (e) {
                            results.push(`${key}: ${value}`);
                        }
                    } else if (key.includes('token')) {
                        // åªæ˜¾ç¤ºtokençš„å‰åå‡ ä½
                        const display = value.length > 20 ? 
                            value.substring(0, 10) + '...' + value.substring(value.length - 10) :
                            value;
                        results.push(`${key}: ${display} (é•¿åº¦: ${value.length})`);
                    } else {
                        results.push(`${key}: ${value}`);
                    }
                } else {
                    results.push(`${key}: (ç©º)`);
                }
            });
            
            output.textContent = results.join('\\n');
        };

        // æ¸…é™¤å­˜å‚¨
        window.clearStorage = function() {
            localStorage.removeItem('dify_access_token');
            localStorage.removeItem('dify_refresh_token');
            localStorage.removeItem('dify_token_expires_at');
            localStorage.removeItem('dify_user_info');
            
            if (authService) {
                authService.currentUser = null;
                authService.authState = 'unauthenticated';
            }
            
            alert('å­˜å‚¨å·²æ¸…é™¤');
        };

        // é¡µé¢åŠ è½½å®Œæˆåè‡ªåŠ¨æ£€æŸ¥ä¸€æ¬¡
        window.addEventListener('load', () => {
            setTimeout(checkCurrentStatus, 500);
        });
    </script>
</body>
</html>