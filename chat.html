<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no">
    <title>AIæ™ºèƒ½å¯¹è¯ - DifyChat</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="assets/images/favicon.svg">
    <link rel="icon" type="image/svg+xml" href="assets/images/favicon-16.svg" sizes="16x16">
    <link rel="alternate icon" href="assets/images/favicon.svg">
    <meta name="theme-color" content="#28a745">
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <style>
        body {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            min-height: 100vh;
            font-family: 'Microsoft YaHei', sans-serif;
            padding-top: 56px; /* ä¸ºå¯¼èˆªæ ç•™å‡ºç©ºé—´ */
            margin: 0;
            overflow-x: hidden; /* é˜²æ­¢æ°´å¹³æ»šåŠ¨ */
        }

        /* å¯¼èˆªæ æ ·å¼ */
        .navbar {
            background: linear-gradient(135deg, #28a745, #198754) !important;
            backdrop-filter: blur(10px);
            box-shadow: 0 2px 20px rgba(0,0,0,0.1);
        }

        .navbar-brand {
            font-weight: 700;
            font-size: 1.5rem;
        }

        /* ç”¨æˆ·ä¸‹æ‹‰èœå•æ ·å¼ */
        .user-dropdown-toggle {
            color: rgba(255,255,255,0.8) !important;
            transition: color 0.3s ease;
        }
        
        .user-dropdown-toggle:hover,
        .user-dropdown-toggle:focus,
        .user-dropdown-toggle.show {
            color: rgba(255,255,255,1) !important;
        }

        .chat-container {
            height: calc(100vh - 56px); /* å‡å»å¯¼èˆªæ é«˜åº¦ */
            display: flex;
            overflow: hidden; /* é˜²æ­¢æº¢å‡º */
            width: 100vw; /* ä½¿ç”¨è§†å£å®½åº¦ */
            max-width: 100%; /* é˜²æ­¢è¶…å‡º */
        }

        /* ä¾§è¾¹æ  */
        .sidebar {
            width: clamp(200px, 25vw, 350px); /* ä½¿ç”¨clampå‡½æ•°å®ç°å“åº”å¼å®½åº¦ */
            background: rgba(255, 255, 255, 0.95);
            border-right: 1px solid rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            flex-shrink: 0; /* é˜²æ­¢è¢«å‹ç¼©å¤ªå° */
        }

        .sidebar-header {
            padding: clamp(0.5rem, 2vw, 1rem);
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
            background: transparent;
            color: #1A1A1A; /* ç‚­é»‘è‰² */
            height: clamp(50px, 8vh, 70px); /* å“åº”å¼é«˜åº¦ */
            display: flex;
            align-items: center;
        }

        .sidebar-header h6 {
            margin: 0;
            font-weight: 600;
            font-size: clamp(0.9rem, 2.5vw, 1.25rem); /* å“åº”å¼å­—ä½“ */
            line-height: 1.2;
            color: #1A1A1A; /* ç‚­é»‘è‰² */
        }

        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: 0.5rem;
        }

        /* æ™ºèƒ½ä½“é¡¹ç›® */
        .agent-item {
            display: flex;
            align-items: center;
            padding: clamp(0.5rem, 1.5vw, 0.75rem);
            margin-bottom: clamp(0.3rem, 1vw, 0.5rem);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            background: rgba(255, 255, 255, 0.8);
            border: 1px solid transparent;
            color: #1A1A1A; /* ç‚­é»‘è‰²å­—ä½“ */
            /* ç§»åŠ¨ç«¯è§¦æ‘¸ä¼˜åŒ– */
            -webkit-tap-highlight-color: rgba(40, 167, 69, 0.3);
            touch-action: manipulation;
            user-select: none;
            -webkit-user-select: none;
        }

        .agent-item:hover {
            background: rgba(40, 167, 69, 0.1);
            border-color: rgba(40, 167, 69, 0.3);
            transform: translateY(-1px);
        }

        .agent-item.active {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
        }

        .agent-item.active .agent-name {
            color: white !important; /* activeçŠ¶æ€æ—¶åå­—ä¸ºç™½è‰² */
        }

        .agent-item.active .agent-description {
            color: rgba(255, 255, 255, 0.8) !important; /* activeçŠ¶æ€æ—¶æè¿°ä¸ºåŠé€æ˜ç™½è‰² */
        }

        .agent-avatar {
            width: clamp(32px, 6vw, 45px);
            height: clamp(32px, 6vw, 45px);
            border-radius: 50%;
            background: linear-gradient(135deg, #28a745, #20c997);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            margin-right: clamp(0.5rem, 1.5vw, 0.75rem);
            font-size: clamp(0.9rem, 2vw, 1.2rem);
        }

        .agent-item.active .agent-avatar {
            background: rgba(255, 255, 255, 0.2);
        }

        .agent-info {
            flex: 1;
        }

        .agent-name {
            font-weight: 600;
            margin: 0;
            font-size: clamp(0.75rem, 2vw, 0.9rem);
            color: #1A1A1A; /* ç‚­é»‘è‰² */
        }

        .agent-description {
            font-size: clamp(0.65rem, 1.8vw, 0.75rem);
            opacity: 0.7;
            margin: 0;
            margin-top: 0.25rem;
            color: #666; /* æ·±ç°è‰² */
        }

        /* èŠå¤©åŒºåŸŸ */
        .chat-area {
            flex: 1;
            min-width: 0; /* å…è®¸æ”¶ç¼© */
            display: flex;
            flex-direction: column;
            overflow: hidden; /* é˜²æ­¢æº¢å‡º */
        }

        .chat-header {
            padding: clamp(0.5rem, 2vw, 1rem);
            background: transparent;
            color: #333;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            justify-content: space-between;
            height: clamp(50px, 8vh, 70px); /* å“åº”å¼é«˜åº¦ */
            flex-shrink: 0; /* é˜²æ­¢æ ‡é¢˜è¢«å‹ç¼© */
        }

        .chat-header h5 {
            margin: 0;
            color: #FDFBF7; /* ç±³ç™½è‰² */
            font-weight: 600;
        }

        .chat-messages {
            flex: 1;
            padding: clamp(0.5rem, 2vw, 1rem);
            overflow-y: auto;
            overflow-x: hidden; /* é˜²æ­¢æ°´å¹³æº¢å‡º */
            background: rgba(255, 255, 255, 0.95);
            min-height: 0; /* å…è®¸æ”¶ç¼© */
        }

        /* æ¶ˆæ¯æ ·å¼ */
        .message {
            margin-bottom: 1rem;
            animation: fadeInUp 0.3s ease;
        }

        .message-user {
            display: flex;
            justify-content: flex-end;
        }

        .message-assistant {
            display: flex;
            justify-content: flex-start;
        }

        .message-system {
            display: flex;
            justify-content: center;
        }

        .message-bubble {
            max-width: clamp(250px, 75vw, 600px); /* å“åº”å¼æœ€å¤§å®½åº¦ */
            padding: clamp(0.5rem, 1.5vw, 0.75rem) clamp(0.75rem, 2vw, 1rem);
            border-radius: 18px;
            position: relative;
            word-wrap: break-word;
            font-size: clamp(0.8rem, 2.2vw, 0.9rem); /* å“åº”å¼å­—ä½“å¤§å° */
            line-height: 1.4;
        }

        .message-user .message-bubble {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
        }

        .message-assistant .message-bubble {
            background: linear-gradient(135deg, #e3f2fd, #bbdefb);
            color: #1565c0;
            border: 1px solid rgba(25, 118, 210, 0.2);
        }

        .message-system .message-bubble {
            background: rgba(255, 193, 7, 0.2);
            color: #856404;
            border: 1px solid rgba(255, 193, 7, 0.3);
            text-align: center;
            font-style: italic;
        }

        .message-header {
            display: flex;
            align-items: center;
            margin-bottom: 0.25rem;
            font-size: 0.75rem;
            opacity: 0.8;
        }

        /* AIåŠ©æ‰‹åå­—ç‰¹æ®Šé¢œè‰² */
        .message-assistant .message-header span:first-child {
            color: #1A1A1A !important; /* ç‚­é»‘è‰² */
        }

        .message-time {
            margin-left: auto;
            font-size: 0.7rem;
        }

        /* æ¶ˆæ¯æ“ä½œæŒ‰é’®æ ·å¼ */
        .message-actions {
            display: flex;
            gap: 6px;
            opacity: 0;
            transition: opacity 0.3s ease;
            margin-top: 8px;
            justify-content: flex-end;
            align-items: center;
        }
        
        .message:hover .message-actions {
            opacity: 1;
        }
        
        .message-action-btn {
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid rgba(0, 0, 0, 0.1);
            padding: 4px 8px;
            border-radius: 6px;
            cursor: pointer;
            color: #666;
            font-size: 10px;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .message-action-btn:hover {
            background: #28a745;
            color: white;
            border-color: #28a745;
            transform: scale(1.05);
        }
        
        /* ç‰ˆæœ¬å¯¼èˆªæ ·å¼ */
        .version-navigation {
            display: flex;
            align-items: center;
            gap: 4px;
            margin-right: 8px;
            padding: 2px 6px;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 4px;
            border: 1px solid rgba(0, 0, 0, 0.1);
        }
        
        .version-btn {
            background: none;
            border: none;
            color: #666;
            cursor: pointer;
            padding: 2px;
            border-radius: 3px;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 20px;
            height: 20px;
        }
        
        .version-btn:hover:not(:disabled) {
            background: #28a745;
            color: white;
        }
        
        .version-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }
        
        .version-info {
            font-size: 9px;
            color: #666;
            margin: 0 2px;
            min-width: 20px;
            text-align: center;
        }
        
        .message-user .message-actions {
            justify-content: flex-start;
        }
        
        .message-user .message-action-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: rgba(255, 255, 255, 0.8);
        }
        
        .message-user .message-action-btn:hover {
            background: rgba(255, 255, 255, 0.9);
            color: #28a745;
        }

        /* è¾“å…¥åŒºåŸŸ */
        .chat-input {
            padding: clamp(0.5rem, 2vw, 1rem);
            background: rgba(255, 255, 255, 0.95);
            border-top: 1px solid rgba(0, 0, 0, 0.1);
            flex-shrink: 0; /* é˜²æ­¢è¾“å…¥åŒºåŸŸè¢«å‹ç¼© */
        }

        .input-group {
            display: flex;
            gap: clamp(0.3rem, 1vw, 0.5rem);
            align-items: flex-end;
        }

        .input-group textarea {
            flex: 1;
            min-width: 0; /* å…è®¸æ”¶ç¼© */
            border-radius: 20px;
            border: 1px solid rgba(0, 0, 0, 0.2);
            padding: clamp(0.5rem, 1.5vw, 0.75rem) clamp(0.75rem, 2vw, 1rem);
            resize: none;
            font-size: clamp(0.8rem, 2vw, 0.9rem);
            max-width: 100%; /* é˜²æ­¢æº¢å‡º */
            box-sizing: border-box;
        }

        .input-group textarea:focus {
            border-color: #28a745;
            box-shadow: 0 0 0 0.2rem rgba(40, 167, 69, 0.25);
        }

        .send-button {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: none;
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .send-button:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
        }

        .send-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        /* åŠ è½½çŠ¶æ€ */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* å“åº”å¼è®¾è®¡ - ç§»åŠ¨ç«¯ä¼˜åŒ– */
        @media (max-width: 768px) {
            /* ç§»åŠ¨ç«¯é¡µé¢å®¹å™¨è°ƒæ•´ */
            body {
                /* ä½¿ç”¨ 100dvhï¼ˆåŠ¨æ€è§†çª—é«˜åº¦ï¼‰æ¥é€‚åº”ç§»åŠ¨ç«¯è™šæ‹Ÿé”®ç›˜ */
                min-height: 100dvh;
                height: 100dvh;
                overflow: hidden;
            }

            .chat-container {
                /* ä½¿ç”¨ 100dvh ç¡®ä¿åœ¨è™šæ‹Ÿé”®ç›˜å¼¹å‡ºæ—¶æ­£ç¡®é€‚åº” */
                height: calc(100dvh - 56px);
                width: 100%;
                position: relative;
            }

            .sidebar {
                position: fixed;
                left: -100%;
                top: 56px;
                height: calc(100dvh - 56px);
                z-index: 1000;
                transition: left 0.3s ease;
                background: rgba(255, 255, 255, 0.98) !important;
                backdrop-filter: blur(10px);
                width: 80vw !important;
                max-width: 320px;
                box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            }

            .sidebar.show {
                left: 0;
            }

            .chat-area {
                width: 100%;
                height: 100%;
                display: flex;
                flex-direction: column;
                position: relative;
            }

            /* ç§»åŠ¨ç«¯æ¶ˆæ¯åŒºåŸŸä¼˜åŒ– */
            .chat-messages {
                /* ç¡®ä¿æ¶ˆæ¯åŒºåŸŸèƒ½å¤Ÿæ­£ç¡®æ»šåŠ¨ */
                flex: 1;
                min-height: 0;
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
                /* ä¸ºè¾“å…¥æ¡†ç•™å‡ºç©ºé—´ */
                padding-bottom: 1rem;
            }

            /* ç§»åŠ¨ç«¯è¾“å…¥åŒºåŸŸä¼˜åŒ– */
            .chat-input {
                /* å›ºå®šåœ¨åº•éƒ¨ï¼Œé¿å…è¢«è™šæ‹Ÿé”®ç›˜é®æŒ¡ */
                position: sticky;
                bottom: 0;
                z-index: 100;
                background: rgba(255, 255, 255, 0.98);
                backdrop-filter: blur(10px);
                border-top: 1px solid rgba(0, 0, 0, 0.1);
                /* å¢åŠ ä¸€äº›paddingæ¥ç¡®ä¿å¯è§æ€§ */
                padding: 0.75rem;
                margin: 0;
                /* ç¡®ä¿è¾“å…¥æ¡†åœ¨å®‰å…¨åŒºåŸŸå†… */
                padding-bottom: calc(0.75rem + env(safe-area-inset-bottom, 0px));
            }

            /* ç§»åŠ¨ç«¯æ™ºèƒ½ä½“é€‰ä¸­çŠ¶æ€ä¿®å¤ - æœ€é«˜ä¼˜å…ˆçº§ */
            .agent-item.active {
                background: linear-gradient(135deg, #28a745, #20c997) !important;
                color: white !important;
                box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3) !important;
            }

            .agent-item.active .agent-name {
                color: white !important;
            }

            .agent-item.active .agent-description {
                color: rgba(255, 255, 255, 0.8) !important;
            }

            .agent-item.active .agent-avatar {
                background: rgba(255, 255, 255, 0.2) !important;
            }

            /* ç§»åŠ¨ç«¯æ™ºèƒ½ä½“è§¦æ‘¸ä¼˜åŒ– */
            .agent-item {
                /* ç§»é™¤300mså»¶è¿Ÿ */
                touch-action: manipulation !important;
                /* å¢å¤§ç‚¹å‡»åŒºåŸŸ */
                min-height: 60px !important;
                /* ç¡®ä¿è§¦æ‘¸åé¦ˆ */
                -webkit-tap-highlight-color: rgba(40, 167, 69, 0.2) !important;
                /* é˜²æ­¢é•¿æŒ‰é€‰æ‹© */
                -webkit-user-select: none !important;
                -webkit-touch-callout: none !important;
                user-select: none !important;
            }

            /* è§¦æ‘¸æ—¶çš„è§†è§‰åé¦ˆ */
            .agent-item:active {
                transform: scale(0.98) !important;
                background: rgba(40, 167, 69, 0.15) !important;
            }

            /* ç§»åŠ¨ç«¯è¾“å…¥æ¡†æ ·å¼è°ƒæ•´ */
            .input-group textarea {
                /* ç¡®ä¿è¾“å…¥æ¡†æœ‰è¶³å¤Ÿçš„ç‚¹å‡»åŒºåŸŸ */
                min-height: 48px;
                font-size: 16px; /* é˜²æ­¢iOSè‡ªåŠ¨ç¼©æ”¾ */
                border-radius: 24px;
                padding: 0.75rem 1rem;
            }

            /* ç§»åŠ¨ç«¯å‘é€æŒ‰é’®ä¼˜åŒ– */
            .send-button {
                width: 48px;
                height: 48px;
                border-radius: 50%;
                flex-shrink: 0;
            }
            
            .message-bubble {
                max-width: 85%;
                font-size: 0.85rem;
                padding: 0.65rem 0.875rem;
            }
            
            .message-header {
                font-size: 0.7rem;
                margin-bottom: 0.2rem;
            }
            
            /* ç¡®ä¿ç§»åŠ¨è®¾å¤‡ä¸‹æ–‡å­—æ¸…æ™° */
            .sidebar-header h6 {
                color: #1A1A1A !important;
                font-size: 1.3rem !important;
                font-weight: 700 !important;
            }
            
            .agent-item {
                padding: 1rem 0.75rem;
                background: rgba(255, 255, 255, 0.9) !important;
                border: 1px solid rgba(0,0,0,0.08);
                box-shadow: 0 1px 3px rgba(0,0,0,0.08);
            }
            
            .agent-name {
                font-size: 1rem !important;
                color: #1A1A1A !important;
                font-weight: 600 !important;
            }
            
            .agent-description {
                font-size: 0.85rem !important;
                color: #555 !important;
                opacity: 1 !important;
                margin-top: 0.3rem;
            }

            .navbar-brand {
                font-size: 1.25rem;
            }

            .chat-header {
                padding: 0.5rem;
                height: auto !important;
                min-height: 50px;
                flex-wrap: nowrap;
                align-items: center;
            }

            .chat-header h5 {
                font-size: 0.9rem;
                flex: 1;
                min-width: 0;
                margin-right: 0.5rem;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }

            .chat-header > div {
                display: flex;
                align-items: center;
                gap: 0.25rem;
                flex-shrink: 0;
            }

            .chat-header .btn {
                font-size: 0.7rem !important;
                padding: 0.25rem 0.4rem !important;
                min-width: auto;
                border-radius: 4px !important;
            }

            .chat-header .btn .fas {
                font-size: 0.7rem;
            }

            /* åœ¨ç§»åŠ¨ç«¯éšè—æŒ‰é’®æ–‡å­—ï¼Œåªä¿ç•™å›¾æ ‡ */
            .chat-header .btn span {
                display: none;
            }

            .chat-header .btn .fas {
                margin-right: 0 !important;
            }

            /* ç¡®ä¿åœ¨è™šæ‹Ÿé”®ç›˜å¼¹å‡ºæ—¶é¡µé¢ä¸ä¼šè¢«æ¨ä¸Šå» */
            .chat-area:focus-within {
                transform: translateY(0);
            }
        }

        /* æ”¯æŒæ›´æ–°çš„è§†çª—å•ä½çš„æµè§ˆå™¨ */
        @supports (height: 100dvh) {
            @media (max-width: 768px) {
                body {
                    height: 100dvh;
                    min-height: 100dvh;
                }

                .chat-container {
                    height: calc(100dvh - 56px);
                }

                .sidebar {
                    height: calc(100dvh - 56px);
                }
            }
        }

        /* æ»šåŠ¨æ¡æ ·å¼ */
        .sidebar-content::-webkit-scrollbar,
        .chat-messages::-webkit-scrollbar {
            width: 6px;
        }

        .sidebar-content::-webkit-scrollbar-track,
        .chat-messages::-webkit-scrollbar-track {
            background: transparent;
        }

        .sidebar-content::-webkit-scrollbar-thumb,
        .chat-messages::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 3px;
        }

        .sidebar-content::-webkit-scrollbar-thumb:hover,
        .chat-messages::-webkit-scrollbar-thumb:hover {
            background: rgba(0, 0, 0, 0.3);
        }

        /* ä¾§è¾¹æ é®ç½©å±‚ */
        .sidebar-overlay {
            display: none;
            position: fixed;
            top: 56px;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 999;
        }

        @media (max-width: 768px) {
            .sidebar.show + .sidebar-overlay,
            .sidebar-overlay.show {
                display: block !important;
            }
        }
        
        /* æ»šåŠ¨æ¡æ ·å¼ */
        .sidebar-content::-webkit-scrollbar,
        .chat-messages::-webkit-scrollbar {
            width: 6px;
        }

        .sidebar-content::-webkit-scrollbar-track,
        .chat-messages::-webkit-scrollbar-track {
            background: transparent;
        }

        .sidebar-content::-webkit-scrollbar-thumb,
        .chat-messages::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 3px;
        }

        .sidebar-content::-webkit-scrollbar-thumb:hover,
        .chat-messages::-webkit-scrollbar-thumb:hover {
            background: rgba(0, 0, 0, 0.3);
        }
        
        /* ä¸­ç­‰å±å¹•ä¼˜åŒ– */
        @media (max-width: 992px) and (min-width: 769px) {
            .sidebar {
                width: 280px;
            }
            
            .agent-name {
                font-size: 0.85rem !important;
            }
            
            .agent-description {
                font-size: 0.7rem !important;
            }
        }
        
        /* å°å±å¹•è¿›ä¸€æ­¥ä¼˜åŒ– */
        @media (max-width: 576px) {
            .sidebar-header {
                padding: 0.75rem;
                height: 55px;
            }
            
            .sidebar-header h6 {
                font-size: 1.15rem !important;
            }
            
            .agent-item {
                padding: 0.875rem;
                margin-bottom: 0.5rem;
            }
            
            .agent-avatar {
                width: 36px;
                height: 36px;
                font-size: 1.1rem;
                margin-right: 0.65rem;
            }
            
            .agent-name {
                font-size: 0.9rem !important;
            }
            
            .agent-description {
                font-size: 0.8rem !important;
            }
        }

        /* è½¬åœˆåœˆåŠ¨ç”» */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .fa-spin {
            animation: spin 1s linear infinite;
        }

        /* çœç•¥å·åŠ¨ç”» */
        @keyframes dots {
            0%, 20% {
                content: '';
            }
            40% {
                content: '.';
            }
            60% {
                content: '..';
            }
            80%, 100% {
                content: '...';
            }
        }

        .loading-dots::after {
            content: '';
            animation: dots 1.5s infinite;
        }

        /* æ€è€ƒä¸­çš„æ–‡å­—åŠ¨ç”» */
        .thinking-text {
            position: relative;
        }

        .thinking-text::after {
            content: '...';
            display: inline-block;
            width: 1.5em;
            text-align: left;
            animation: thinking-dots 1.5s infinite;
        }

        @keyframes thinking-dots {
            0%, 33% {
                content: '.  ';
            }
            34%, 66% {
                content: '.. ';
            }
            67%, 100% {
                content: '...';
            }
        }

        /* Tokenä½¿ç”¨ä¿¡æ¯æ˜¾ç¤º */
        .token-usage {
            margin-top: 8px;
            padding: 6px 10px;
            background: linear-gradient(135deg, rgba(40, 167, 69, 0.08), rgba(32, 201, 151, 0.05));
            border-radius: 8px;
            font-size: 11px;
            color: #666;
            border-left: 3px solid #28a745;
            backdrop-filter: blur(5px);
            border: 1px solid rgba(40, 167, 69, 0.15);
        }

        .token-usage-item {
            display: inline-block;
            margin-right: 12px;
            padding: 2px 6px;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 6px;
            border: 1px solid rgba(40, 167, 69, 0.1);
        }

        .token-usage-item:last-child {
            margin-right: 0;
        }

        .token-usage-item .label {
            font-weight: 600;
            color: #28a745;
            margin-right: 2px;
        }

        .token-usage-item .value {
            color: #495057;
            font-weight: 700;
        }

        /* Toasté€šçŸ¥æ ·å¼ */
        #toastContainer {
            z-index: 1100;
        }

        .toast-notification {
            padding: 1rem 1.25rem;
            margin-bottom: 0.5rem;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            opacity: 0;
            transform: translateX(100%);
            transition: all 0.3s ease;
            max-width: 350px;
            word-wrap: break-word;
        }

        .toast-notification.show {
            opacity: 1;
            transform: translateX(0);
        }

        .toast-notification.toast-success {
            background: linear-gradient(135deg, #28a745, #20c997);
        }

        .toast-notification.toast-error {
            background: linear-gradient(135deg, #dc3545, #c82333);
        }

        .toast-notification.toast-warning {
            background: linear-gradient(135deg, #ffc107, #e0a800);
            color: #856404;
        }

        .toast-notification.toast-info {
            background: linear-gradient(135deg, #17a2b8, #138496);
        }
        
        /* èŠå¤©è®°å½•æ¨¡æ€æ¡†æ ·å¼ */
        .conversation-list {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            background: #f8f9fa;
        }
        
        .conversation-item {
            padding: 12px 15px;
            border-bottom: 1px solid #e9ecef;
            cursor: pointer;
            transition: all 0.2s ease;
            background: white;
        }
        
        .conversation-item:last-child {
            border-bottom: none;
        }
        
        .conversation-item:hover {
            background: #e3f2fd;
            transform: translateX(3px);
        }
        
        .conversation-item.active {
            background: #007bff;
            color: white;
        }
        
        .conversation-item.active .conversation-meta {
            color: rgba(255, 255, 255, 0.8);
        }
        
        .conversation-content {
            min-width: 0; /* é˜²æ­¢flexæº¢å‡º */
        }
        
        .conversation-actions {
            flex-shrink: 0;
            opacity: 0;
            transition: opacity 0.2s ease;
        }
        
        .conversation-item:hover .conversation-actions {
            opacity: 1;
        }
        
        .conversation-actions .btn {
            padding: 2px 6px;
            font-size: 12px;
        }
        
        .conversation-actions .dropdown-menu {
            min-width: 120px;
            font-size: 13px;
        }
        
        .conversation-title {
            font-weight: 600;
            margin-bottom: 4px;
            font-size: 0.9rem;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        .conversation-meta {
            font-size: 0.75rem;
            color: #6c757d;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .conversation-agent {
            display: flex;
            align-items: center;
        }
        
        .conversation-agent i {
            margin-right: 4px;
        }
        
        .message-history {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            background: #f8f9fa;
        }
        
        .history-message {
            margin-bottom: 15px;
            display: flex;
            align-items: flex-start;
        }
        
        .history-message.user {
            flex-direction: row-reverse;
        }
        
        .history-message-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            color: white;
            margin: 0 8px;
            flex-shrink: 0;
        }
        
        .history-message.user .history-message-avatar {
            background: #007bff;
        }
        
        .history-message.assistant .history-message-avatar {
            background: #28a745;
        }
        
        .history-message-bubble {
            max-width: 70%;
            padding: 8px 12px;
            border-radius: 12px;
            background: white;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
            border: 1px solid #e9ecef;
        }
        
        .history-message.user .history-message-bubble {
            background: #007bff;
            color: white;
            border: 1px solid #007bff;
        }
        
        .history-message.assistant .history-message-bubble {
            background: linear-gradient(135deg, #e3f2fd, #bbdefb);
            color: #1565c0;
            border: 1px solid #2196f3;
            box-shadow: 0 2px 4px rgba(33, 150, 243, 0.1);
        }
        
        .history-message-content {
            font-size: 0.85rem;
            line-height: 1.4;
            margin-bottom: 4px;
        }
        
        .history-message-time {
            font-size: 0.7rem;
            opacity: 0.7;
            text-align: right;
        }
        
        .history-message.assistant .history-message-time {
            text-align: left;
        }
        
        /* èŠå¤©è®°å½•æ¨¡æ€æ¡†æ»šåŠ¨æ¡æ ·å¼ */
        .conversation-list::-webkit-scrollbar,
        .message-history::-webkit-scrollbar {
            width: 6px;
        }
        
        .conversation-list::-webkit-scrollbar-track,
        .message-history::-webkit-scrollbar-track {
            background: transparent;
        }
        
        .conversation-list::-webkit-scrollbar-thumb,
        .message-history::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 3px;
        }
        
        .conversation-list::-webkit-scrollbar-thumb:hover,
        .message-history::-webkit-scrollbar-thumb:hover {
            background: rgba(0, 0, 0, 0.3);
        }
    </style>
</head>
<body>
    <!-- å¯¼èˆªæ  -->
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="./index.html">
                <i class="fas fa-robot me-2"></i>
                DifyChat
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="./index.html">é¦–é¡µ</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="./chat.html">èŠå¤©</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="./chatroom.html">èŠå¤©å®¤</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="./profile.html">ä¸ªäººèµ„æ–™</a>
                    </li>
                    <li class="nav-item" id="adminNavItem" style="display: none;">
                        <a class="nav-link" href="./admin.html">
                            <i class="fas fa-cogs me-1"></i>ç®¡ç†åå°
                        </a>
                    </li>
                </ul>
                <ul class="navbar-nav">
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle user-dropdown-toggle" href="#" id="userDropdown" role="button" data-bs-toggle="dropdown">
                            <i class="fas fa-user-circle me-1"></i>
                            <span id="currentUsername">ç”¨æˆ·</span>
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item" href="./profile.html">
                                <i class="fas fa-user me-2"></i>ä¸ªäººèµ„æ–™
                            </a></li>
                            <li><a class="dropdown-item" href="./settings.html">
                                <i class="fas fa-cog me-2"></i>è®¾ç½®
                            </a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="#" id="nav-logout">
                                <i class="fas fa-sign-out-alt me-2"></i>é€€å‡ºç™»å½•
                            </a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="chat-container">
        <!-- ç§»åŠ¨ç«¯ä¾§è¾¹æ é®ç½© -->
        <div class="sidebar-overlay" onclick="toggleSidebar()"></div>
        
        <!-- ä¾§è¾¹æ  -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h6 class="mb-0">
                    <i class="fas fa-robot me-2"></i>
                    æ™ºèƒ½ä½“åˆ—è¡¨
                </h6>
            </div>
            <div class="sidebar-content" id="agentList">
                <div class="loading">
                    <div class="spinner"></div>
                </div>
            </div>
        </div>

        <!-- èŠå¤©åŒºåŸŸ -->
        <div class="chat-area">
            <!-- èŠå¤©å¤´éƒ¨ -->
            <div class="chat-header">
                <h5 id="currentAgentName">
                    <i class="fas fa-comments me-2"></i>
                    è¯·é€‰æ‹©æ™ºèƒ½ä½“å¼€å§‹å¯¹è¯
                </h5>
                <div>
                    <button class="btn btn-outline-light btn-sm me-2" onclick="showCreateConversationModal()" title="æ–°å»ºå¯¹è¯">
                        <i class="fas fa-plus me-1"></i><span>æ–°å»º</span>
                    </button>
                    <button class="btn btn-outline-light btn-sm me-2" onclick="showSelectConversationModal()" title="é€‰æ‹©ä¼šè¯">
                        <i class="fas fa-list me-1"></i><span>é€‰æ‹©</span>
                    </button>
                    <button class="btn btn-outline-light btn-sm me-2" onclick="showChatHistory()" title="æŸ¥çœ‹èŠå¤©è®°å½•">
                        <i class="fas fa-history me-1"></i><span>è®°å½•</span>
                    </button>
                    <button class="btn btn-outline-light btn-sm me-2" onclick="clearChat()" title="æ¸…ç©ºå¯¹è¯">
                        <i class="fas fa-trash me-1"></i><span>æ¸…ç©º</span>
                    </button>
                    <button class="btn btn-outline-light btn-sm d-md-none" onclick="toggleSidebar()" title="æ˜¾ç¤º/éšè—ä¾§è¾¹æ ">
                        <i class="fas fa-bars"></i>
                    </button>
                </div>
            </div>

            <!-- æ¶ˆæ¯åŒºåŸŸ -->
            <div class="chat-messages" id="chatMessages">
                <div class="text-center text-white-50 mt-5">
                    <i class="fas fa-comments fa-3x mb-3"></i>
                    <h5>æ¬¢è¿ä½¿ç”¨ DifyChat</h5>
                    <p>è¯·ä»å·¦ä¾§é€‰æ‹©ä¸€ä¸ªæ™ºèƒ½ä½“å¼€å§‹å¯¹è¯</p>
                </div>
            </div>

            <!-- è¾“å…¥åŒºåŸŸ -->
            <div class="chat-input">
                <div class="input-group">
                    <textarea 
                        id="messageInput" 
                        placeholder="è¾“å…¥æ‚¨çš„æ¶ˆæ¯... (Shift+Enteræ¢è¡Œï¼ŒEnterå‘é€)"
                        rows="1"
                    ></textarea>
                    <button id="sendButton" class="send-button" type="button">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toasté€šçŸ¥å®¹å™¨ -->
    <div id="toastContainer" class="position-fixed top-0 end-0 p-3" style="z-index: 1100;">
        <!-- Toastæ¶ˆæ¯å°†åŠ¨æ€æ·»åŠ åˆ°è¿™é‡Œ -->
    </div>

    <!-- èŠå¤©è®°å½•æ¨¡æ€æ¡† -->
    <div class="modal fade" id="chatHistoryModal" tabindex="-1" aria-labelledby="chatHistoryModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="chatHistoryModalLabel">
                        <i class="fas fa-history me-2"></i>èŠå¤©è®°å½•
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <!-- å·¦ä¾§ï¼šå¯¹è¯åˆ—è¡¨ -->
                        <div class="col-md-4">
                            <h6 class="mb-3">
                                <i class="fas fa-list me-1"></i>å¯¹è¯åˆ—è¡¨
                                <button class="btn btn-sm btn-outline-primary float-end" onclick="refreshConversationList()" title="åˆ·æ–°åˆ—è¡¨">
                                    <i class="fas fa-refresh"></i>
                                </button>
                            </h6>
                            <div id="conversationList" class="conversation-list">
                                <div class="text-center text-muted py-4">
                                    <i class="fas fa-spinner fa-spin"></i>
                                    <div class="mt-2">åŠ è½½ä¸­...</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- å³ä¾§ï¼šæ¶ˆæ¯å†å² -->
                        <div class="col-md-8">
                            <div id="messageHistoryHeader" class="mb-3" style="display: none;">
                                <h6>
                                    <i class="fas fa-comments me-1"></i>æ¶ˆæ¯è®°å½•
                                    <small class="text-muted ms-2" id="selectedConversationInfo">è¯·é€‰æ‹©ä¸€ä¸ªå¯¹è¯æŸ¥çœ‹æ¶ˆæ¯</small>
                                </h6>
                            </div>
                            <div id="messageHistory" class="message-history">
                                <div class="text-center text-muted py-5">
                                    <i class="fas fa-arrow-left fa-2x mb-3"></i>
                                    <h6>è¯·ä»å·¦ä¾§é€‰æ‹©ä¸€ä¸ªå¯¹è¯</h6>
                                    <p>é€‰æ‹©å¯¹è¯åå°†æ˜¾ç¤ºå®Œæ•´çš„æ¶ˆæ¯å†å²è®°å½•</p>
                                </div>
                            </div>
                            
                            <!-- åŠ è½½æ›´å¤šæŒ‰é’® -->
                            <div id="loadMoreMessages" class="text-center mt-3" style="display: none;">
                                <button class="btn btn-outline-secondary btn-sm" onclick="loadMoreMessages()">
                                    <i class="fas fa-chevron-down me-1"></i>æŸ¥çœ‹æ›´æ—©æ¶ˆæ¯
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button>
                </div>
            </div>
        </div>
    </div>

    <!-- é‡å‘½åå¯¹è¯æ¨¡æ€æ¡† -->
    <div class="modal fade" id="renameConversationModal" tabindex="-1" aria-labelledby="renameConversationModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="renameConversationModalLabel">
                        <i class="fas fa-edit me-2"></i>é‡å‘½åå¯¹è¯
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="renameConversationForm">
                        <div class="mb-3">
                            <label for="renameConversationTitle" class="form-label">æ–°æ ‡é¢˜ *</label>
                            <input type="text" class="form-control" id="renameConversationTitle" 
                                   placeholder="è¯·è¾“å…¥æ–°çš„å¯¹è¯æ ‡é¢˜" maxlength="100" required>
                            <div class="form-text">æ ‡é¢˜é•¿åº¦ä¸èƒ½è¶…è¿‡100ä¸ªå­—ç¬¦</div>
                        </div>
                        <input type="hidden" id="renameConversationId">
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                    <button type="button" class="btn btn-primary" onclick="confirmRenameConversation()">
                        <i class="fas fa-save me-1"></i>ä¿å­˜
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- é€‰æ‹©ä¼šè¯æ¨¡æ€æ¡† -->
    <div class="modal fade" id="selectConversationModal" tabindex="-1" aria-labelledby="selectConversationModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="selectConversationModalLabel">
                        <i class="fas fa-list me-2"></i>é€‰æ‹©ä¼šè¯
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="selectConversationList" class="conversation-list">
                        <div class="loading text-center py-4">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">åŠ è½½ä¸­...</span>
                            </div>
                            <div class="mt-2">æ­£åœ¨åŠ è½½ä¼šè¯åˆ—è¡¨...</div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button>
                    <button type="button" class="btn btn-success" onclick="createNewConversationFromSelect()" title="åˆ›å»ºæ–°ä¼šè¯">
                        <i class="fas fa-plus me-1"></i>æ–°å»ºä¼šè¯
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- å¼€å‘å·¥å…· -->
    <script src="js/utils/dev-tools.js?v=1.0.0"></script>
    <script src="js/utils/health-checker.js?v=1.0.0"></script>
    
    <!-- ES6 æ¨¡å—åŒ–èŠå¤©ç³»ç»Ÿ -->
    <script type="module">
        import { ENV_CONFIG } from './config/env.js';
        import { SimpleChatController } from './js/controllers/chat-controller-v2.js';
        import apiClient from './js/api/api-client.js';

        // å…¨å±€å˜é‡
        window.chatController = null;
        window.ENV_CONFIG = ENV_CONFIG; // å°† ENV_CONFIG æ·»åŠ åˆ°å…¨å±€ä½œç”¨åŸŸ
        ENV_CONFIG.apiClient = apiClient; // å°† apiClient æ·»åŠ åˆ° ENV_CONFIG ä¸­

        // åˆå§‹åŒ–èŠå¤©ç³»ç»Ÿ
        async function initChatSystem() {
            try {
                console.log('ğŸš€ åˆå§‹åŒ–DifyChatèŠå¤©ç³»ç»Ÿ...');
                
                // å…ˆåˆå§‹åŒ–å…¨å±€é”™è¯¯å¤„ç†å™¨
                try {
                    const { ErrorHandler } = await import('./js/utils/error-handler.js');
                    window.errorHandler = new ErrorHandler();
                    console.log('âœ… å…¨å±€é”™è¯¯å¤„ç†å™¨åˆå§‹åŒ–å®Œæˆ');
                } catch (errorHandlerError) {
                    console.warn('âš ï¸ å…¨å±€é”™è¯¯å¤„ç†å™¨åˆå§‹åŒ–å¤±è´¥:', errorHandlerError);
                }
                
                // åˆ›å»ºèŠå¤©æ§åˆ¶å™¨
                window.chatController = new SimpleChatController();
                
                // åˆå§‹åŒ–æ§åˆ¶å™¨
                await window.chatController.init();
                
                // ç»‘å®šsendMessageåˆ°å…¨å±€ä½œç”¨åŸŸ
                window.sendMessage = function() {
                    if (window.chatController && typeof window.chatController.sendMessage === 'function') {
                        return window.chatController.sendMessage();
                    } else {
                        console.error('âŒ chatController æˆ– sendMessage æ–¹æ³•ä¸å­˜åœ¨');
                        showToast('èŠå¤©ç³»ç»Ÿæœªåˆå§‹åŒ–å®Œæˆ', 'error');
                    }
                };
                
                console.log('âœ… èŠå¤©ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ');
                
            } catch (error) {
                console.error('âŒ èŠå¤©ç³»ç»Ÿåˆå§‹åŒ–å¤±è´¥:', error);
                
                // æ£€æŸ¥æ˜¯å¦æ˜¯è®¤è¯é”™è¯¯
                if (error.response && error.response.status === 401 || 
                    (error.message && (error.message.includes('ä»¤ç‰Œå·²è¿‡æœŸ') || error.message.includes('Unauthorized')))) {
                    
                    // è·³è½¬åˆ°ç™»å½•é¡µé¢
                    console.log('ğŸ” åˆå§‹åŒ–æ—¶æ£€æµ‹åˆ°è®¤è¯é”™è¯¯ï¼Œè·³è½¬åˆ°ç™»å½•é¡µé¢');
                    const returnUrl = encodeURIComponent(window.location.href);
                    window.location.href = `./login.html?return=${returnUrl}`;
                    return;
                }
                
                // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
                const chatMessages = document.getElementById('chatMessages');
                if (chatMessages) {
                    chatMessages.innerHTML = `
                        <div class="text-center text-white mt-5">
                            <i class="fas fa-exclamation-triangle fa-3x mb-3"></i>
                            <h5>ç³»ç»Ÿåˆå§‹åŒ–å¤±è´¥</h5>
                            <p>${error.message}</p>
                            <button class="btn btn-light btn-sm" onclick="location.reload()">
                                <i class="fas fa-redo me-1"></i>é‡æ–°åŠ è½½
                            </button>
                        </div>
                    `;
                }
            }
        }

        // å…¨å±€å‡½æ•°
        window.clearChat = function() {
            if (window.chatController) {
                window.chatController.clearMessages();
            }
        };

        window.toggleSidebar = function() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.querySelector('.sidebar-overlay');
            
            if (sidebar) {
                const isShowing = sidebar.classList.contains('show');
                
                if (isShowing) {
                    // å…³é—­ä¾§è¾¹æ 
                    sidebar.classList.remove('show');
                    if (overlay) {
                        overlay.style.display = 'none';
                        overlay.classList.remove('show');
                    }
                } else {
                    // æ˜¾ç¤ºä¾§è¾¹æ 
                    sidebar.classList.add('show');
                    if (overlay) {
                        overlay.style.display = 'block';
                        overlay.classList.add('show');
                    }
                }
                
                console.log('ğŸ“± ä¾§è¾¹æ çŠ¶æ€åˆ‡æ¢:', isShowing ? 'å…³é—­' : 'æ˜¾ç¤º');
                console.log('ğŸ“± é®ç½©å±‚çŠ¶æ€:', overlay ? overlay.style.display : 'æœªæ‰¾åˆ°é®ç½©å±‚');
            }
        };

        // Toasté€šçŸ¥åŠŸèƒ½
        window.showToast = function(message, type = 'info') {
            const toastContainer = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast-notification toast-${type}`;
            toast.textContent = message;
            
            toastContainer.appendChild(toast);
            
            // è§¦å‘æ˜¾ç¤ºåŠ¨ç”»
            setTimeout(() => toast.classList.add('show'), 100);
            
            // 3ç§’åè‡ªåŠ¨æ¶ˆå¤±
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.parentNode.removeChild(toast);
                    }
                }, 300);
            }, 3000);
        };

        // å¤åˆ¶æ–‡æœ¬åˆ°å‰ªè´´æ¿
        window.copyToClipboard = async function(text) {
            try {
                await navigator.clipboard.writeText(text);
                showToast('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
            } catch (err) {
                // é™çº§æ–¹æ¡ˆ
                const textArea = document.createElement('textarea');
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                showToast('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
            }
        };

        // ç¼–è¾‘ç”¨æˆ·æ¶ˆæ¯
        window.editUserMessage = function(content) {
            const messageInput = document.getElementById('messageInput');
            if (messageInput) {
                messageInput.value = content;
                messageInput.focus();
                
                // æ»šåŠ¨åˆ°è¾“å…¥æ¡†
                messageInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
                
                showToast('æ¶ˆæ¯å·²å¤åˆ¶åˆ°è¾“å…¥æ¡†ï¼Œå¯ä»¥ä¿®æ”¹åé‡æ–°å‘é€', 'info');
            }
        };

        // é‡æ–°ç”ŸæˆAIå›å¤
        window.regenerateAIMessage = function(messageElement) {
            if (!window.chatController) {
                showToast('èŠå¤©ç³»ç»Ÿæœªåˆå§‹åŒ–', 'error');
                return;
            }

            // æ‰¾åˆ°å¯¹åº”çš„ç”¨æˆ·æ¶ˆæ¯
            let userMessage = '';
            let currentElement = messageElement.previousElementSibling;
            
            // å‘ä¸ŠæŸ¥æ‰¾æœ€è¿‘çš„ç”¨æˆ·æ¶ˆæ¯
            while (currentElement) {
                if (currentElement.classList.contains('message-user')) {
                    const messageContent = currentElement.querySelector('.message-content');
                    if (messageContent) {
                        userMessage = messageContent.textContent || messageContent.innerText;
                        break;
                    }
                }
                currentElement = currentElement.previousElementSibling;
            }
            
            if (userMessage && userMessage.trim() !== '') {
                // åˆ é™¤å½“å‰AIæ¶ˆæ¯
                messageElement.remove();
                
                // é‡æ–°å‘é€ç”¨æˆ·æ¶ˆæ¯ï¼ˆä¸æ·»åŠ åˆ°ç•Œé¢ï¼Œç›´æ¥å‘ç»™AIï¼‰
                window.chatController.sendToAI(userMessage.trim());
                showToast('æ­£åœ¨é‡æ–°ç”Ÿæˆå›å¤...', 'info');
            } else {
                showToast('æ— æ³•æ‰¾åˆ°å¯¹åº”çš„ç”¨æˆ·æ¶ˆæ¯', 'error');
            }
        };

        // å…¨å±€å‡½æ•°
        window.clearChat = function() {
            if (window.chatController) {
                window.chatController.clearMessages();
            }
        };

        // æ¶ˆæ¯æ“ä½œå‡½æ•°
        window.copyMessage = async function(button) {
            const content = button.getAttribute('data-content');
            try {
                await navigator.clipboard.writeText(content);
                console.log('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
            } catch (err) {
                // é™çº§æ–¹æ¡ˆ
                const textArea = document.createElement('textarea');
                textArea.value = content;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                console.log('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
            }
        };

        window.editMessage = function(button) {
            const content = button.getAttribute('data-content');
            const messageInput = document.getElementById('messageInput');
            if (messageInput) {
                messageInput.value = content;
                messageInput.focus();
                // è°ƒæ•´è¾“å…¥æ¡†é«˜åº¦
                if (window.chatController) {
                    window.chatController.adjustTextareaHeight();
                }
            }
        };

        window.regenerateMessage = async function(button) {
            const messageElement = button.closest('.message');
            if (!messageElement) return;

            const messageId = messageElement.id;
            if (!window.chatController || !window.chatController.currentAgent) {
                return;
            }

            try {
                // æ˜¾ç¤ºç”Ÿæˆä¸­çŠ¶æ€
                button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                button.disabled = true;

                // è°ƒç”¨AIé‡æ–°ç”Ÿæˆï¼ˆä¸éœ€è¦ä¼ é€’ç”¨æˆ·æ¶ˆæ¯ï¼Œæ–¹æ³•ä¼šè‡ªåŠ¨æ‰¾åˆ°ï¼‰
                const result = await window.chatController.regenerateAIResponse(messageId);
                
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                button.innerHTML = '<i class="fas fa-redo"></i>';
                button.disabled = false;
                
            } catch (error) {
                console.error('é‡æ–°ç”Ÿæˆå¤±è´¥:', error);
                button.innerHTML = '<i class="fas fa-redo"></i>';
                button.disabled = false;
                
                // æ˜¾ç¤ºé”™è¯¯æç¤º
                alert('é‡æ–°ç”Ÿæˆå¤±è´¥: ' + error.message);
            }
        };

        // ç‰ˆæœ¬å¯¼èˆªå‡½æ•°
        window.previousVersion = function(messageId) {
            if (window.chatController) {
                const currentIndex = window.chatController.currentVersions.get(messageId) || 0;
                if (currentIndex > 0) {
                    window.chatController.switchToVersion(messageId, currentIndex - 1);
                }
            }
        };

        window.nextVersion = function(messageId) {
            if (window.chatController) {
                const versions = window.chatController.messageVersions.get(messageId);
                const currentIndex = window.chatController.currentVersions.get(messageId) || 0;
                if (versions && currentIndex < versions.length - 1) {
                    window.chatController.switchToVersion(messageId, currentIndex + 1);
                }
            }
        };

        // ===== èŠå¤©è®°å½•åŠŸèƒ½ =====
        
        window.currentConversations = [];
        let selectedConversationId = null;
        let currentMessagePage = 1;
        const messagePageSize = 50;
        
        // æ˜¾ç¤ºèŠå¤©è®°å½•æ¨¡æ€æ¡†
        window.showChatHistory = async function() {
            try {
                const modal = new bootstrap.Modal(document.getElementById('chatHistoryModal'));
                modal.show();
                
                // åŠ è½½å¯¹è¯åˆ—è¡¨
                await window.loadConversationList();
            } catch (error) {
                console.error('æ˜¾ç¤ºèŠå¤©è®°å½•å¤±è´¥:', error);
                alert('åŠ è½½èŠå¤©è®°å½•å¤±è´¥: ' + error.message);
            }
        };
        
        // åŠ è½½å¯¹è¯åˆ—è¡¨
        window.loadConversationList = async function() {
            const conversationListElement = document.getElementById('conversationList');
            
            try {
                conversationListElement.innerHTML = `
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-spinner fa-spin"></i>
                        <div class="mt-2">åŠ è½½ä¸­...</div>
                    </div>
                `;
                
                const response = await fetch(`${ENV_CONFIG.getApiUrl('/conversations')}?limit=100&sort=-updated_at`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('dify_access_token')}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                // è°ƒè¯•ï¼šæ‰“å°APIå“åº”æ•°æ®
                console.log('ğŸ” å¯¹è¯åˆ—è¡¨APIå“åº”:', data);
                console.log('ğŸ” å“åº”çŠ¶æ€:', response.status);
                console.log('ğŸ” å“åº”å¤´:', Object.fromEntries(response.headers.entries()));
                
                if (data.success) {
                    // æ ¹æ®APIæ–‡æ¡£ï¼Œæ•°æ®åœ¨ data.conversations ä¸­
                    window.currentConversations = data.data?.conversations || [];
                    console.log('âœ… æˆåŠŸè·å–å¯¹è¯åˆ—è¡¨ï¼Œæ•°é‡:', window.currentConversations.length);
                    console.log('ğŸ“‹ å¯¹è¯æ•°æ®ç¤ºä¾‹:', window.currentConversations[0]);
                    window.renderConversationList();
                } else {
                    throw new Error(data.message || 'åŠ è½½å¯¹è¯åˆ—è¡¨å¤±è´¥');
                }
                
            } catch (error) {
                console.error('åŠ è½½å¯¹è¯åˆ—è¡¨å¤±è´¥:', error);
                conversationListElement.innerHTML = `
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-exclamation-triangle text-warning fa-2x mb-2"></i>
                        <div>åŠ è½½å¤±è´¥</div>
                        <small class="text-muted">${error.message}</small>
                        <div class="mt-2">
                            <button class="btn btn-sm btn-outline-primary" onclick="window.loadConversationList()">
                                <i class="fas fa-refresh me-1"></i>é‡è¯•
                            </button>
                        </div>
                    </div>
                `;
            }
        }
        
        // æ¸²æŸ“å¯¹è¯åˆ—è¡¨
        window.renderConversationList = function() {
            const conversationListElement = document.getElementById('conversationList');
            
            if (window.currentConversations.length === 0) {
                conversationListElement.innerHTML = `
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-comments fa-2x mb-2 opacity-50"></i>
                        <div>è¿˜æ²¡æœ‰å¯¹è¯è®°å½•</div>
                        <small class="text-muted">å¼€å§‹ä¸€ä¸ªæ–°å¯¹è¯å§</small>
                    </div>
                `;
                return;
            }
            
            const conversationHtml = window.currentConversations.map(conversation => {
                const createdAt = new Date(conversation.created_at).toLocaleDateString('zh-CN', {
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                const updatedAt = new Date(conversation.updated_at).toLocaleDateString('zh-CN', {
                    month: 'short', 
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                // æ ¹æ®APIæ–‡æ¡£ï¼Œå¯¹è¯æ ‡é¢˜å­—æ®µå¯èƒ½æ˜¯ name æˆ– title
                const conversationTitle = conversation.title || conversation.name || 'æ–°å¯¹è¯';
                // æ™ºèƒ½ä½“IDæ”¹ä¸º agent_id
                const agentId = conversation.agent_id || 'æœªçŸ¥æ™ºèƒ½ä½“';
                const messageCount = conversation.message_count || 0;
                
                return `
                    <div class="conversation-item ${conversation.id === selectedConversationId ? 'active' : ''}" 
                         onclick="selectConversation('${conversation.id}')">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="conversation-content flex-grow-1">
                                <div class="conversation-title">${conversationTitle}</div>
                                <div class="conversation-meta">
                                    <div class="conversation-agent">
                                        <i class="fas fa-robot"></i>
                                        ${agentId}
                                    </div>
                                    <div>${messageCount}æ¡æ¶ˆæ¯</div>
                                </div>
                                <div class="conversation-meta mt-1">
                                    <small>åˆ›å»º: ${createdAt}</small>
                                    <small>æ›´æ–°: ${updatedAt}</small>
                                </div>
                            </div>
                            <div class="conversation-actions">
                                <div class="dropdown">
                                    <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" 
                                            data-bs-toggle="dropdown" aria-expanded="false" 
                                            onclick="event.stopPropagation();">
                                        <i class="fas fa-ellipsis-h"></i>
                                    </button>
                                    <ul class="dropdown-menu">
                                        <li><a class="dropdown-item" href="#" onclick="event.stopPropagation(); renameConversation('${conversation.id}', '${conversationTitle.replace(/'/g, "\\'")}')">
                                            <i class="fas fa-edit me-1"></i>é‡å‘½å
                                        </a></li>
                                        <li><a class="dropdown-item text-danger" href="#" onclick="event.stopPropagation(); deleteConversation('${conversation.id}', '${conversationTitle.replace(/'/g, "\\'")}')">
                                            <i class="fas fa-trash me-1"></i>åˆ é™¤
                                        </a></li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            conversationListElement.innerHTML = conversationHtml;
        }
        
        // é€‰æ‹©å¯¹è¯
        window.selectConversation = async function(conversationId) {
            console.log('ğŸ¯ é€‰æ‹©å¯¹è¯:', conversationId);
            selectedConversationId = conversationId;
            currentMessagePage = 1;
            
            // éšè—åŠ è½½æ›´å¤šæŒ‰é’®ï¼Œç­‰å¾…æ–°å¯¹è¯åŠ è½½å®Œæˆåå†å†³å®šæ˜¯å¦æ˜¾ç¤º
            const loadMoreButton = document.getElementById('loadMoreMessages');
            loadMoreButton.style.display = 'none';
            
            // æ›´æ–°UIé€‰ä¸­çŠ¶æ€
            document.querySelectorAll('.conversation-item').forEach(item => {
                item.classList.remove('active');
            });
            
            const selectedItem = document.querySelector(`[onclick="selectConversation('${conversationId}')"]`);
            if (selectedItem) {
                selectedItem.classList.add('active');
            }
            
            // è·å–å¯¹è¯ä¿¡æ¯å¹¶æ˜¾ç¤ºåœ¨æ ‡é¢˜ä¸­
            const conversation = window.currentConversations.find(c => c.id === conversationId);
            if (conversation) {
                const infoElement = document.getElementById('selectedConversationInfo');
                // æ ¹æ®APIæ–‡æ¡£ï¼Œå¯¹è¯æ ‡é¢˜å­—æ®µæ˜¯ nameï¼Œæ™ºèƒ½ä½“IDæ˜¯ agent_id
                infoElement.textContent = `${conversation.name || 'æ–°å¯¹è¯'} - ${conversation.agent_id || 'æœªçŸ¥æ™ºèƒ½ä½“'}`;
                console.log('ğŸ“ å¯¹è¯ä¿¡æ¯å·²æ›´æ–°:', conversation.name, 'æ¶ˆæ¯æ•°:', conversation.message_count);
            }
            
            // æ˜¾ç¤ºæ¶ˆæ¯å†å²å¤´éƒ¨
            const headerElement = document.getElementById('messageHistoryHeader');
            headerElement.style.display = 'block';
            
            // åŠ è½½æ¶ˆæ¯å†å²
            await loadMessageHistory(conversationId);
        };
        
        // åŠ è½½æ¶ˆæ¯å†å²
        async function loadMessageHistory(conversationId, page = 1) {
            const messageHistoryElement = document.getElementById('messageHistory');
            const loadMoreButton = document.getElementById('loadMoreMessages');
            
            try {
                if (page === 1) {
                    messageHistoryElement.innerHTML = `
                        <div class="text-center text-muted py-4">
                            <i class="fas fa-spinner fa-spin"></i>
                            <div class="mt-2">åŠ è½½æ¶ˆæ¯ä¸­...</div>
                        </div>
                    `;
                }
                
                const response = await fetch(`${ENV_CONFIG.getApiUrl(`/conversations/${conversationId}/messages`)}?page=${page}&limit=${messagePageSize}&sort=-created_at`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('dify_access_token')}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                if (data.success) {
                    // æ ¹æ®APIæ–‡æ¡£ï¼Œæ¶ˆæ¯æ•°æ®åœ¨ data.messages ä¸­
                    let messages = data.data?.messages || [];
                    
                    console.log(`ğŸ“„ ç¬¬${page}é¡µæ¶ˆæ¯åŠ è½½æˆåŠŸï¼Œæ¶ˆæ¯æ•°é‡:`, messages.length);
                    console.log('ğŸ” APIå“åº”åˆ†é¡µä¿¡æ¯:', data.data?.pagination);
                    if (messages.length > 0) {
                        console.log('ğŸ“¨ ç¬¬ä¸€æ¡æ¶ˆæ¯æ—¶é—´:', messages[0]?.created_at, 'å†…å®¹:', messages[0]?.content?.substring(0, 30) + '...');
                        console.log('ï¿½ æœ€åä¸€æ¡æ¶ˆæ¯æ—¶é—´:', messages[messages.length - 1]?.created_at, 'å†…å®¹:', messages[messages.length - 1]?.content?.substring(0, 30) + '...');
                    }
                    
                    if (page === 1) {
                        renderMessageHistory(messages);
                    } else {
                        appendMessageHistory(messages);
                    }
                    
                    // æ˜¾ç¤º/éšè—åŠ è½½æ›´å¤šæŒ‰é’®
                    const pagination = data.data?.pagination;
                    console.log('ğŸ“Š åˆ†é¡µä¿¡æ¯:', pagination);
                    
                    if (pagination) {
                        if (pagination.has_next || pagination.hasNext || (pagination.page < pagination.total_pages)) {
                            loadMoreButton.style.display = 'block';
                            console.log('âœ… è¿˜æœ‰æ›´å¤šæ¶ˆæ¯ï¼Œæ˜¾ç¤ºåŠ è½½æŒ‰é’®');
                        } else {
                            loadMoreButton.style.display = 'none';
                            console.log('ğŸ”š æ²¡æœ‰æ›´å¤šæ¶ˆæ¯äº†ï¼Œéšè—åŠ è½½æŒ‰é’®');
                        }
                    } else {
                        // å¦‚æœæ²¡æœ‰åˆ†é¡µä¿¡æ¯ï¼Œä½†æ¶ˆæ¯æ•°é‡ç­‰äºlimitï¼Œå¯èƒ½è¿˜æœ‰æ›´å¤š
                        if (messages.length === messagePageSize) {
                            loadMoreButton.style.display = 'block';
                            console.log('âš ï¸ æ²¡æœ‰åˆ†é¡µä¿¡æ¯ï¼Œä½†æ¶ˆæ¯æ•°é‡æ»¡é¡µï¼Œå°è¯•æ˜¾ç¤ºåŠ è½½æŒ‰é’®');
                        } else {
                            loadMoreButton.style.display = 'none';
                        }
                    }
                    
                } else {
                    throw new Error(data.message || 'åŠ è½½æ¶ˆæ¯å†å²å¤±è´¥');
                }
                
            } catch (error) {
                console.error('åŠ è½½æ¶ˆæ¯å†å²å¤±è´¥:', error);
                if (page === 1) {
                    messageHistoryElement.innerHTML = `
                        <div class="text-center text-muted py-4">
                            <i class="fas fa-exclamation-triangle text-warning fa-2x mb-2"></i>
                            <div>åŠ è½½å¤±è´¥</div>
                            <small class="text-muted">${error.message}</small>
                            <div class="mt-2">
                                <button class="btn btn-sm btn-outline-primary" onclick="selectConversation('${conversationId}')">
                                    <i class="fas fa-refresh me-1"></i>é‡è¯•
                                </button>
                            </div>
                        </div>
                    `;
                }
                loadMoreButton.style.display = 'none';
            }
        }
        
        // æ¸²æŸ“æ¶ˆæ¯å†å²
        function renderMessageHistory(messages) {
            const messageHistoryElement = document.getElementById('messageHistory');
            
            if (messages.length === 0) {
                messageHistoryElement.innerHTML = `
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-comment-slash fa-2x mb-2 opacity-50"></i>
                        <div>è¿™ä¸ªå¯¹è¯è¿˜æ²¡æœ‰æ¶ˆæ¯</div>
                    </div>
                `;
                return;
            }
            
            console.log('ğŸ¨ æ¸²æŸ“ç¬¬ä¸€é¡µæ¶ˆæ¯ï¼Œæ•°é‡:', messages.length);
            
            const messagesHtml = messages.map(message => {
                return renderSingleMessage(message);
            }).join('');
            
            messageHistoryElement.innerHTML = messagesHtml;
        }
        
        // è¿½åŠ æ¶ˆæ¯å†å²ï¼ˆç”¨äºåˆ†é¡µåŠ è½½ï¼‰
        function appendMessageHistory(messages) {
            const messageHistoryElement = document.getElementById('messageHistory');
            
            console.log('â• è¿½åŠ æ¶ˆæ¯åˆ°åº•éƒ¨ï¼Œæ•°é‡:', messages.length);
            
            const messagesHtml = messages.map(message => {
                return renderSingleMessage(message);
            }).join('');
            
            // ç›´æ¥è¿½åŠ åˆ°åº•éƒ¨ï¼Œå› ä¸ºæ¶ˆæ¯å·²ç»åœ¨APIå¤„ç†æ—¶æ•´ä½“æ’åºå¥½äº†
            messageHistoryElement.insertAdjacentHTML('beforeend', messagesHtml);
        }
        
        // æ¸²æŸ“å•ä¸ªæ¶ˆæ¯
        function renderSingleMessage(message) {
            const createdAt = new Date(message.created_at).toLocaleString('zh-CN');
            const messageType = message.role || 'user';
            const content = message.content || '';
            
            // å¤„ç†é•¿æ–‡æœ¬ï¼Œæ·»åŠ å±•å¼€/æ”¶èµ·åŠŸèƒ½
            const isLongText = content.length > 500;
            const displayContent = isLongText ? content.substring(0, 500) + '...' : content;
            
            const avatarIcon = messageType === 'user' ? 'ğŸ‘¤' : 'ğŸ¤–';
            
            return `
                <div class="history-message ${messageType}">
                    <div class="history-message-avatar">
                        ${avatarIcon}
                    </div>
                    <div class="history-message-bubble">
                        <div class="history-message-content" data-full-content="${encodeURIComponent(content)}">
                            ${formatMessageContent(displayContent)}
                            ${isLongText ? '<br><button class="btn btn-link btn-sm p-0 expand-message" onclick="expandMessage(this)">æ˜¾ç¤ºå…¨éƒ¨</button>' : ''}
                        </div>
                        <div class="history-message-time">${createdAt}</div>
                    </div>
                </div>
            `;
        }
        
        // æ ¼å¼åŒ–æ¶ˆæ¯å†…å®¹
        function formatMessageContent(content) {
            return content
                .replace(/\n/g, '<br>')
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/`(.*?)`/g, '<code>$1</code>');
        }
        
        // å±•å¼€/æ”¶èµ·æ¶ˆæ¯
        window.expandMessage = function(button) {
            const contentElement = button.parentElement;
            const fullContent = decodeURIComponent(contentElement.getAttribute('data-full-content'));
            const isExpanded = button.textContent === 'æ”¶èµ·';
            
            if (isExpanded) {
                const shortContent = fullContent.substring(0, 500) + '...';
                contentElement.innerHTML = formatMessageContent(shortContent) + 
                    '<br><button class="btn btn-link btn-sm p-0 expand-message" onclick="expandMessage(this)">æ˜¾ç¤ºå…¨éƒ¨</button>';
            } else {
                contentElement.innerHTML = formatMessageContent(fullContent) + 
                    '<br><button class="btn btn-link btn-sm p-0 expand-message" onclick="expandMessage(this)">æ”¶èµ·</button>';
            }
        };
        
        // åŠ è½½æ›´å¤šæ¶ˆæ¯
        window.loadMoreMessages = function() {
            if (selectedConversationId) {
                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                const loadMoreButton = document.getElementById('loadMoreMessages');
                const originalText = loadMoreButton.innerHTML;
                loadMoreButton.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>åŠ è½½ä¸­...';
                loadMoreButton.disabled = true;
                
                // é€’å¢é¡µç æ¥è·å–ä¸‹ä¸€é¡µæ¶ˆæ¯
                currentMessagePage++;
                console.log('ğŸ“„ åŠ è½½ä¸‹ä¸€é¡µæ¶ˆæ¯ï¼Œé¡µç :', currentMessagePage);
                
                loadMessageHistory(selectedConversationId, currentMessagePage).then(() => {
                    // æ¢å¤æŒ‰é’®çŠ¶æ€
                    loadMoreButton.innerHTML = originalText;
                    loadMoreButton.disabled = false;
                }).catch(() => {
                    // å‡ºé”™æ—¶é‡ç½®é¡µç å¹¶æ¢å¤æŒ‰é’®
                    currentMessagePage--;
                    loadMoreButton.innerHTML = originalText;
                    loadMoreButton.disabled = false;
                });
            }
        };
        
        // åˆ·æ–°å¯¹è¯åˆ—è¡¨
        window.refreshConversationList = function() {
            loadConversationList();
        };

        // æ£€æŸ¥ç®¡ç†å‘˜æƒé™å¹¶æ˜¾ç¤ºç®¡ç†åå°é“¾æ¥
        function checkAdminPermission() {
            try {
                const userInfo = JSON.parse(localStorage.getItem('userInfo') || '{}');
                const userRole = userInfo.role || '';
                
                // å¦‚æœæ˜¯ç®¡ç†å‘˜æˆ–è¶…çº§ç®¡ç†å‘˜ï¼Œæ˜¾ç¤ºç®¡ç†åå°é“¾æ¥
                if (userRole === 'admin' || userRole === 'superadmin' || userRole === 'administrator') {
                    const adminNavItem = document.getElementById('adminNavItem');
                    if (adminNavItem) {
                        adminNavItem.style.display = 'block';
                    }
                }
            } catch (error) {
                console.log('æ£€æŸ¥ç®¡ç†å‘˜æƒé™æ—¶å‡ºé”™:', error);
            }
        }

        // é€€å‡ºç™»å½•åŠŸèƒ½
        function setupLogout() {
            const logoutBtn = document.getElementById('nav-logout');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    // ç¡®è®¤é€€å‡º
                    if (confirm('ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ')) {
                        // æ¸…é™¤æœ¬åœ°å­˜å‚¨çš„ç”¨æˆ·ä¿¡æ¯
                        localStorage.removeItem('userToken');
                        localStorage.removeItem('userInfo');
                        localStorage.removeItem('currentUser');
                        
                        // æ¸…é™¤ä¼šè¯å­˜å‚¨
                        sessionStorage.clear();
                        
                        // è·³è½¬åˆ°ç™»å½•é¡µé¢
                        window.location.href = './login.html';
                    }
                });
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸ”§ é¡µé¢DOMåŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–...');
            
            initChatSystem();
            setupLogout();
            checkAdminPermission();
            
            // ç§»åŠ¨ç«¯è¾“å…¥æ¡†ä¼˜åŒ–å¤„ç†
            if (window.innerWidth <= 768) {
                setupMobileInputOptimization();
            }
            
            // =============================================================================
            // å¯¹è¯ç®¡ç†åŠŸèƒ½ (æ–°å»ºã€é‡å‘½åã€åˆ é™¤)
            // =============================================================================
            
            // ç›´æ¥åˆ›å»ºæ–°å¯¹è¯ï¼ˆåŸºäºå½“å‰æ™ºèƒ½ä½“ï¼‰
            window.showCreateConversationModal = async function() {
                console.log('ğŸ“ å¼€å§‹åˆ›å»ºæ–°å¯¹è¯');
                
                try {
                    // è·å–å½“å‰æ™ºèƒ½ä½“ä¿¡æ¯
                    const currentAgent = window.chatController?.currentAgent;
                    if (!currentAgent || !currentAgent.id) {
                        alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªæ™ºèƒ½ä½“');
                        return;
                    }
                    
                    console.log('ğŸ¤– åŸºäºå½“å‰æ™ºèƒ½ä½“åˆ›å»ºå¯¹è¯:', currentAgent.id);
                    
                    // ç”Ÿæˆå”¯ä¸€çš„å¯¹è¯æ ‡é¢˜ä»¥ç¡®ä¿åˆ›å»ºæ–°å¯¹è¯
                    const timestamp = new Date().getTime();
                    const uniqueTitle = `æ–°å¯¹è¯_${timestamp}`;
                    
                    // å…ˆæ¸…ç©ºå½“å‰èŠå¤©ç•Œé¢
                    if (window.chatController) {
                        window.chatController.clearMessages();
                        window.chatController.conversationId = null; // é‡ç½®å¯¹è¯ID
                        console.log('ğŸ§¹ å·²æ¸…ç©ºå½“å‰èŠå¤©ç•Œé¢');
                    }
                    
                    // ç›´æ¥è°ƒç”¨APIåˆ›å»ºå¯¹è¯
                    const response = await fetch(`${ENV_CONFIG.getApiUrl('/conversations')}`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('dify_access_token')}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            agent_id: currentAgent.id,
                            title: uniqueTitle,
                            auto_generate_title: false
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (response.ok && data.success) {
                        console.log('âœ… å¯¹è¯åˆ›å»ºæˆåŠŸ:', data.data);
                        
                        // APIè¿”å›çš„æ•°æ®ç»“æ„å¯èƒ½æ˜¯ data.data ç›´æ¥å°±æ˜¯å¯¹è¯å¯¹è±¡
                        const newConversation = data.data?.conversation || data.data;
                        
                        console.log('ğŸ” è§£æåçš„å¯¹è¯å¯¹è±¡:', newConversation);
                        console.log('ğŸ” æ£€æŸ¥å¯¹è¯å¯¹è±¡æ˜¯å¦æœ‰ID:', !!newConversation, !!newConversation?.id);
                        
                        if (newConversation && newConversation.id) {
                            console.log('ğŸ†” æ–°åˆ›å»ºçš„å¯¹è¯ID:', newConversation.id);
                            console.log('ğŸ“ æ–°åˆ›å»ºçš„å¯¹è¯æ ‡é¢˜:', newConversation.title || newConversation.name || 'æ–°å¯¹è¯');
                            console.log('ğŸ¤– å…³è”çš„æ™ºèƒ½ä½“ID:', newConversation.agent_id);
                            
                            // é‡ç½®å½“å‰å¯¹è¯çŠ¶æ€ï¼Œåˆ‡æ¢åˆ°æ–°å¯¹è¯
                            window.currentConversationId = newConversation.id;
                            
                            // é‡è¦ï¼šæ›´æ–°chat controllerçš„å¯¹è¯ID
                            if (window.chatController) {
                                console.log('ğŸ“Š æ›´æ–°å‰chatControllerçŠ¶æ€:', {
                                    conversationId: window.chatController.conversationId,
                                    currentAgent: window.chatController.currentAgent?.id
                                });
                                
                                window.chatController.conversationId = newConversation.id;
                                console.log('âœ… æ›´æ–°chatControllerå¯¹è¯ID:', newConversation.id);
                                
                                // éªŒè¯æ›´æ–°æ˜¯å¦æˆåŠŸ
                                console.log('ğŸ“Š æ›´æ–°åchatControllerçŠ¶æ€:', {
                                    conversationId: window.chatController.conversationId,
                                    currentAgent: window.chatController.currentAgent?.id
                                });
                            } else {
                                console.error('âŒ chatController ä¸å­˜åœ¨ï¼Œæ— æ³•æ›´æ–°å¯¹è¯ID');
                            }
                            
                            // æ¸…ç©ºèŠå¤©åŒºåŸŸ
                            const chatMessages = document.getElementById('chatMessages');
                            if (chatMessages) {
                                chatMessages.innerHTML = `
                                    <div class="welcome-message text-center py-4">
                                        <i class="fas fa-robot fa-3x text-primary mb-3"></i>
                                        <h5>æ–°å¯¹è¯å·²åˆ›å»º</h5>
                                        <p class="text-muted">æ‚¨å¯ä»¥å¼€å§‹ä¸ ${currentAgent.name || currentAgent.id} å¯¹è¯äº†</p>
                                    </div>
                                `;
                            }
                            
                            // æ›´æ–°èŠå¤©å¤´éƒ¨æ ‡é¢˜
                            const agentName = document.getElementById('currentAgentName');
                            if (agentName) {
                                agentName.innerHTML = `
                                    <i class="fas fa-comments me-2"></i>
                                    ${newConversation.title || newConversation.name || 'æ–°å¯¹è¯'}
                                    <small class="text-muted">- ${currentAgent.name || currentAgent.id}</small>
                                `;
                            }
                            
                            // ç¡®ä¿è¾“å…¥åŒºåŸŸå¯ç”¨
                            const messageInput = document.getElementById('messageInput');
                            const sendButton = document.querySelector('button[onclick="sendMessage()"]');
                            if (messageInput) {
                                messageInput.disabled = false;
                                messageInput.placeholder = 'è¾“å…¥æ‚¨çš„æ¶ˆæ¯...';
                            }
                            if (sendButton) sendButton.disabled = false;
                            
                            // é‡è¦ï¼šåˆ·æ–°å¯¹è¯åˆ—è¡¨ä»¥æ˜¾ç¤ºæ–°å»ºçš„ä¼šè¯
                            console.log('ğŸ”„ å‡†å¤‡åˆ·æ–°å¯¹è¯åˆ—è¡¨...');
                            console.log('ğŸ” æ£€æŸ¥ loadConversationList å‡½æ•°:', typeof window.loadConversationList);
                            
                            if (typeof window.loadConversationList === 'function') {
                                try {
                                    console.log('ğŸ“ è°ƒç”¨ loadConversationList å‡½æ•°...');
                                    await window.loadConversationList();
                                    console.log('âœ… å·²åˆ·æ–°å¯¹è¯åˆ—è¡¨ï¼Œæ–°å¯¹è¯åº”è¯¥å¯è§');
                                    
                                    // ç­‰å¾…ä¸€å°æ®µæ—¶é—´ç¡®ä¿æ•°æ®å·²ç»æ›´æ–°
                                    await new Promise(resolve => setTimeout(resolve, 100));
                                    
                                    // æ£€æŸ¥å¯¹è¯åˆ—è¡¨æ˜¯å¦åŒ…å«æ–°å¯¹è¯
                                    if (window.currentConversations && Array.isArray(window.currentConversations)) {
                                        console.log('ğŸ“Š å½“å‰å¯¹è¯åˆ—è¡¨é•¿åº¦:', window.currentConversations.length);
                                        console.log('ğŸ” å¯»æ‰¾æ–°å¯¹è¯ID:', newConversation.id);
                                        
                                        const newConvInList = window.currentConversations.find(conv => conv.id === newConversation.id);
                                        if (newConvInList) {
                                            console.log('âœ… æ–°å¯¹è¯å·²åœ¨åˆ—è¡¨ä¸­æ‰¾åˆ°:', newConvInList.title || newConvInList.name || 'æ–°å¯¹è¯');
                                        } else {
                                            console.warn('âš ï¸ æ–°å¯¹è¯æœªåœ¨åˆ—è¡¨ä¸­æ‰¾åˆ°');
                                            console.log('ğŸ“‹ å½“å‰å¯¹è¯åˆ—è¡¨ID:', window.currentConversations.map(c => c.id).slice(0, 5));
                                            
                                            // å¯èƒ½éœ€è¦å†æ¬¡åˆ·æ–°
                                            console.log('ï¿½ å°è¯•å†æ¬¡åˆ·æ–°å¯¹è¯åˆ—è¡¨...');
                                            setTimeout(async () => {
                                                try {
                                                    await window.loadConversationList();
                                                    console.log('ğŸ”„ ç¬¬äºŒæ¬¡åˆ·æ–°å®Œæˆ');
                                                } catch (e) {
                                                    console.error('ç¬¬äºŒæ¬¡åˆ·æ–°å¤±è´¥:', e);
                                                }
                                            }, 500);
                                        }
                                    } else {
                                        console.error('âŒ currentConversations ä¸æ˜¯æœ‰æ•ˆæ•°ç»„');
                                    }
                                } catch (error) {
                                    console.error('âŒ åˆ·æ–°å¯¹è¯åˆ—è¡¨å¤±è´¥:', error);
                                }
                            } else {
                                console.error('âŒ loadConversationList å‡½æ•°ä¸å­˜åœ¨');
                            }
                            
                            console.log('ğŸ†• æ–°å¯¹è¯å·²åœ¨ä¸»ç•Œé¢å¯ç”¨:', newConversation.id);
                        } else {
                            console.error('âŒ æ— æ³•è§£æå¯¹è¯å¯¹è±¡ï¼ŒnewConversation:', newConversation);
                            console.log('ğŸ” åŸå§‹ data.data:', data.data);
                            console.log('ğŸ” data.data çš„ç±»å‹:', typeof data.data);
                            console.log('ğŸ” data.data çš„é”®:', data.data ? Object.keys(data.data) : 'null');
                        }
                        
                    } else {
                        throw new Error(data.message || 'åˆ›å»ºå¯¹è¯å¤±è´¥');
                    }
                    
                } catch (error) {
                    console.error('åˆ›å»ºå¯¹è¯å¤±è´¥:', error);
                    alert(`åˆ›å»ºå¯¹è¯å¤±è´¥ï¼š${error.message}`);
                }
            };
            
            // æ˜¾ç¤ºé‡å‘½åå¯¹è¯æ¨¡æ€æ¡†
            window.renameConversation = function(conversationId, currentTitle) {
                console.log('âœï¸ é‡å‘½åå¯¹è¯:', conversationId, currentTitle);
                
                // è®¾ç½®è¡¨å•æ•°æ®
                document.getElementById('renameConversationId').value = conversationId;
                document.getElementById('renameConversationTitle').value = currentTitle;
                
                // æ˜¾ç¤ºæ¨¡æ€æ¡†
                const modal = new bootstrap.Modal(document.getElementById('renameConversationModal'));
                modal.show();
                
                // èšç„¦åˆ°è¾“å…¥æ¡†å¹¶é€‰ä¸­æ–‡æœ¬
                setTimeout(() => {
                    const input = document.getElementById('renameConversationTitle');
                    input.focus();
                    input.select();
                }, 300);
            };
            
            // ç¡®è®¤é‡å‘½åå¯¹è¯
            window.confirmRenameConversation = async function() {
                const form = document.getElementById('renameConversationForm');
                const submitBtn = event.target;
                const originalText = submitBtn.innerHTML;
                
                try {
                    // éªŒè¯è¡¨å•
                    if (!form.checkValidity()) {
                        form.reportValidity();
                        return;
                    }
                    
                    const conversationId = document.getElementById('renameConversationId').value;
                    const newTitle = document.getElementById('renameConversationTitle').value.trim();
                    
                    if (!newTitle) {
                        alert('è¯·è¾“å…¥æ–°æ ‡é¢˜');
                        return;
                    }
                    
                    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>ä¿å­˜ä¸­...';
                    submitBtn.disabled = true;
                    
                    console.log('âœï¸ é‡å‘½åå¯¹è¯è¯·æ±‚:', conversationId, newTitle);
                    
                    const response = await fetch(`${ENV_CONFIG.getApiUrl(`/conversations/${conversationId}`)}`, {
                        method: 'PUT',
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('dify_access_token')}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            title: newTitle  // æ›´æ–°å¯¹è¯ä½¿ç”¨titleå­—æ®µ
                        })
                    });
                    
                    const data = await response.json();
                    
                    console.log('ğŸ” é‡å‘½åAPIå“åº”:', data);
                    console.log('ğŸ” å“åº”çŠ¶æ€:', response.status);
                    
                    if (response.ok && data.success) {
                        console.log('âœ… å¯¹è¯é‡å‘½åæˆåŠŸ');
                        
                        // å…³é—­æ¨¡æ€æ¡†
                        const modal = bootstrap.Modal.getInstance(document.getElementById('renameConversationModal'));
                        modal.hide();
                        
                        // å¦‚æœé‡å‘½åçš„æ˜¯å½“å‰é€‰ä¸­çš„å¯¹è¯ï¼Œæ›´æ–°æ¶ˆæ¯å†å²æ ‡é¢˜æ˜¾ç¤º
                        if (selectedConversationId === conversationId) {
                            const selectedConversationInfo = document.getElementById('selectedConversationInfo');
                            if (selectedConversationInfo) {
                                selectedConversationInfo.textContent = newTitle;
                            }
                        }
                        
                        // åˆ·æ–°å¯¹è¯åˆ—è¡¨
                        await refreshConversationList();
                        
                        // é‡æ–°é€‰æ‹©å½“å‰å¯¹è¯ä»¥åˆ·æ–°æ˜¾ç¤º
                        if (selectedConversationId === conversationId) {
                            await selectConversation(conversationId);
                        }
                        
                        console.log('âœ… å¯¹è¯é‡å‘½åå®Œæˆï¼Œç•Œé¢å·²æ›´æ–°');
                        
                    } else {
                        console.error('âŒ é‡å‘½åå¤±è´¥ - å“åº”è¯¦æƒ…:', {
                            status: response.status,
                            statusText: response.statusText,
                            data: data
                        });
                        throw new Error(data.message || 'é‡å‘½åå¤±è´¥');
                    }
                    
                } catch (error) {
                    console.error('é‡å‘½åå¯¹è¯å¤±è´¥:', error);
                    alert(`é‡å‘½åå¤±è´¥ï¼š${error.message}`);
                } finally {
                    // æ¢å¤æŒ‰é’®çŠ¶æ€
                    submitBtn.innerHTML = originalText;
                    submitBtn.disabled = false;
                }
            };
            
            // åˆ é™¤å¯¹è¯
            window.deleteConversation = function(conversationId, title) {
                console.log('ğŸ—‘ï¸ åˆ é™¤å¯¹è¯:', conversationId, title);
                
                // ç¡®è®¤åˆ é™¤
                if (!confirm(`ç¡®å®šè¦åˆ é™¤å¯¹è¯ "${title}" å—ï¼Ÿ\n\næ­¤æ“ä½œæ— æ³•æ’¤é”€ï¼Œå¯¹è¯ä¸­çš„æ‰€æœ‰æ¶ˆæ¯éƒ½å°†è¢«æ°¸ä¹…åˆ é™¤ã€‚`)) {
                    return;
                }
                
                confirmDeleteConversation(conversationId);
            };
            
            // ç¡®è®¤åˆ é™¤å¯¹è¯
            async function confirmDeleteConversation(conversationId) {
                try {
                    console.log('ğŸ—‘ï¸ æ‰§è¡Œåˆ é™¤å¯¹è¯:', conversationId);
                    
                    const response = await fetch(`${ENV_CONFIG.getApiUrl(`/conversations/${conversationId}`)}`, {
                        method: 'DELETE',
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('dify_access_token')}`,
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    const data = await response.json();
                    
                    if (response.ok && data.success) {
                        console.log('âœ… å¯¹è¯åˆ é™¤æˆåŠŸ');
                        
                        // å¦‚æœåˆ é™¤çš„æ˜¯å½“å‰é€‰ä¸­çš„å¯¹è¯ï¼Œæ¸…ç©ºé€‰æ‹©
                        if (selectedConversationId === conversationId) {
                            selectedConversationId = null;
                            
                            // æ¸…ç©ºæ¶ˆæ¯å†å²æ˜¾ç¤º
                            const messageHistoryElement = document.getElementById('messageHistory');
                            messageHistoryElement.innerHTML = `
                                <div class="text-center text-muted py-5">
                                    <i class="fas fa-arrow-left fa-2x mb-3"></i>
                                    <h6>è¯·ä»å·¦ä¾§é€‰æ‹©ä¸€ä¸ªå¯¹è¯</h6>
                                    <p>é€‰æ‹©å¯¹è¯åå°†æ˜¾ç¤ºå®Œæ•´çš„æ¶ˆæ¯å†å²è®°å½•</p>
                                </div>
                            `;
                            
                            // éšè—æ¶ˆæ¯æ ‡é¢˜
                            document.getElementById('messageHistoryHeader').style.display = 'none';
                            
                            // éšè—åŠ è½½æ›´å¤šæŒ‰é’®
                            document.getElementById('loadMoreMessages').style.display = 'none';
                        }
                        
                        // åˆ·æ–°å¯¹è¯åˆ—è¡¨
                        await refreshConversationList();
                        
                        console.log('âœ… å¯¹è¯åˆ é™¤å®Œæˆ');
                        
                    } else {
                        throw new Error(data.message || 'åˆ é™¤å¯¹è¯å¤±è´¥');
                    }
                    
                } catch (error) {
                    console.error('åˆ é™¤å¯¹è¯å¤±è´¥:', error);
                    alert(`åˆ é™¤å¯¹è¯å¤±è´¥ï¼š${error.message}`);
                }
            }
            
            // åˆ·æ–°å¯¹è¯åˆ—è¡¨
            window.refreshConversationList = async function() {
                console.log('ğŸ”„ åˆ·æ–°å¯¹è¯åˆ—è¡¨');
                try {
                    await loadConversationList();
                } catch (error) {
                    console.error('åˆ·æ–°å¯¹è¯åˆ—è¡¨å¤±è´¥:', error);
                }
            };

            // ===== é€‰æ‹©ä¼šè¯åŠŸèƒ½ =====
            
            // æ˜¾ç¤ºé€‰æ‹©ä¼šè¯æ¨¡æ€æ¡†
            window.showSelectConversationModal = async function() {
                console.log('ğŸ“‹ æ˜¾ç¤ºé€‰æ‹©ä¼šè¯æ¨¡æ€æ¡†');
                const modal = new bootstrap.Modal(document.getElementById('selectConversationModal'));
                modal.show();
                
                // åŠ è½½ä¼šè¯åˆ—è¡¨
                await loadSelectConversationList();
            };
            
            // åŠ è½½é€‰æ‹©ä¼šè¯åˆ—è¡¨
            window.loadSelectConversationList = async function() {
                console.log('ğŸ“‹ åŠ è½½é€‰æ‹©ä¼šè¯åˆ—è¡¨');
                const listElement = document.getElementById('selectConversationList');
                
                try {
                    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                    listElement.innerHTML = `
                        <div class="loading text-center py-4">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">åŠ è½½ä¸­...</span>
                            </div>
                            <div class="mt-2">æ­£åœ¨åŠ è½½ä¼šè¯åˆ—è¡¨...</div>
                        </div>
                    `;
                    
                    const currentAgent = window.chatController?.currentAgent;
                    
                    if (!currentAgent || !currentAgent.id) {
                        listElement.innerHTML = `
                            <div class="text-center text-muted py-4">
                                <i class="fas fa-exclamation-circle fa-2x mb-3"></i>
                                <div>è¯·å…ˆé€‰æ‹©ä¸€ä¸ªæ™ºèƒ½ä½“</div>
                            </div>
                        `;
                        return;
                    }
                    
                    const response = await ENV_CONFIG.apiClient.get(`/conversations?limit=50&sort=-updated_at&agent_id=${currentAgent.id}`);
                    
                    console.log('ğŸ” é€‰æ‹©ä¼šè¯APIå“åº”:', response);
                    
                    if (response.success) {
                        // å¤„ç†å®é™…çš„ä¸šåŠ¡æ•°æ®
                        const data = response.data;
                        let conversations = [];
                        
                        if (Array.isArray(data.conversations)) {
                            // æ ‡å‡†çš„åˆ†é¡µç»“æ„: { conversations: [], pagination: {} }
                            conversations = data.conversations;
                        } else if (Array.isArray(data)) {
                            // ç›´æ¥æ˜¯æ•°ç»„çš„æƒ…å†µ
                            conversations = data;
                        } else if (data.items && Array.isArray(data.items)) {
                            // items ç»“æ„: { items: [], total: number }
                            conversations = data.items;
                        }
                        
                        // è¿‡æ»¤å‡ºå½“å‰æ™ºèƒ½ä½“çš„å¯¹è¯
                        const filteredConversations = conversations.filter(conv => conv.agent_id === currentAgent.id);
                        console.log('ğŸ“‹ æ‰¾åˆ°çš„ä¼šè¯æ•°é‡:', filteredConversations.length);
                        
                        renderSelectConversationList(filteredConversations);
                    } else {
                        throw new Error(response.message || 'åŠ è½½å¯¹è¯åˆ—è¡¨å¤±è´¥');
                    }
                    
                } catch (error) {
                    console.error('åŠ è½½é€‰æ‹©ä¼šè¯åˆ—è¡¨å¤±è´¥:', error);
                    listElement.innerHTML = `
                        <div class="text-center text-danger py-4">
                            <i class="fas fa-exclamation-triangle fa-2x mb-3"></i>
                            <div>åŠ è½½å¤±è´¥: ${error.message}</div>
                            <button class="btn btn-sm btn-outline-primary mt-2" onclick="loadSelectConversationList()">
                                <i class="fas fa-redo me-1"></i>é‡è¯•
                            </button>
                        </div>
                    `;
                }
            };
            
            // æ¸²æŸ“é€‰æ‹©ä¼šè¯åˆ—è¡¨
            function renderSelectConversationList(conversations) {
                const listElement = document.getElementById('selectConversationList');
                
                if (conversations.length === 0) {
                    listElement.innerHTML = `
                        <div class="text-center text-muted py-4">
                            <i class="fas fa-comments fa-2x mb-3"></i>
                            <div>æš‚æ— ä¼šè¯è®°å½•</div>
                            <div class="text-sm">ç‚¹å‡»"æ–°å»ºä¼šè¯"å¼€å§‹å¯¹è¯</div>
                        </div>
                    `;
                    return;
                }
                
                const currentConversationId = window.chatController?.conversationId;
                
                const html = conversations.map(conv => {
                    const isActive = conv.id === currentConversationId;
                    const displayTitle = conv.title || `ä¼šè¯ ${conv.id.substring(0, 8)}`;
                    const formatTime = (timeStr) => {
                        if (!timeStr) return '';
                        try {
                            const date = new Date(timeStr);
                            return date.toLocaleDateString('zh-CN') + ' ' + date.toLocaleTimeString('zh-CN', { hour12: false });
                        } catch (e) {
                            return timeStr;
                        }
                    };
                    
                    return `
                        <div class="conversation-item d-flex align-items-center ${isActive ? 'active' : ''}" 
                             onclick="selectConversationFromModal('${conv.id}')">
                            <div class="conversation-content flex-grow-1">
                                <div class="conversation-title">${displayTitle}</div>
                                <div class="conversation-meta">
                                    <div class="conversation-agent">
                                        <i class="fas fa-robot"></i>
                                        ${window.chatController?.currentAgent?.name || 'æ™ºèƒ½ä½“'}
                                    </div>
                                    <div class="conversation-time">${formatTime(conv.updated_at || conv.created_at)}</div>
                                </div>
                            </div>
                            <div class="conversation-actions">
                                <div class="dropdown">
                                    <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" 
                                            data-bs-toggle="dropdown" onclick="event.stopPropagation()">
                                        <i class="fas fa-ellipsis-v"></i>
                                    </button>
                                    <ul class="dropdown-menu">
                                        <li><a class="dropdown-item" href="#" onclick="event.stopPropagation(); selectConversationFromModal('${conv.id}')">
                                            <i class="fas fa-check me-2"></i>é€‰æ‹©
                                        </a></li>
                                        <li><a class="dropdown-item" href="#" onclick="event.stopPropagation(); renameConversationFromModal('${conv.id}', '${displayTitle.replace(/'/g, "\\'")}')">
                                            <i class="fas fa-edit me-2"></i>é‡å‘½å
                                        </a></li>
                                        <li><hr class="dropdown-divider"></li>
                                        <li><a class="dropdown-item text-danger" href="#" onclick="event.stopPropagation(); deleteConversationFromModal('${conv.id}')">
                                            <i class="fas fa-trash me-2"></i>åˆ é™¤
                                        </a></li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
                
                listElement.innerHTML = html;
            }
            
            // ä»æ¨¡æ€æ¡†é€‰æ‹©ä¼šè¯
            window.selectConversationFromModal = async function(conversationId) {
                try {
                    console.log('ğŸ¯ ä»æ¨¡æ€æ¡†é€‰æ‹©ä¼šè¯:', conversationId);
                    
                    if (!window.chatController) {
                        throw new Error('èŠå¤©æ§åˆ¶å™¨æœªåˆå§‹åŒ–');
                    }
                    
                    // åˆ‡æ¢ä¼šè¯
                    await window.chatController.switchConversation(conversationId);
                    
                    // å…³é—­æ¨¡æ€æ¡†
                    const modal = bootstrap.Modal.getInstance(document.getElementById('selectConversationModal'));
                    if (modal) {
                        modal.hide();
                    }
                    
                    showToast('å·²åˆ‡æ¢åˆ°é€‰ä¸­çš„ä¼šè¯', 'success');
                    
                } catch (error) {
                    console.error('é€‰æ‹©ä¼šè¯å¤±è´¥:', error);
                    showToast(`åˆ‡æ¢ä¼šè¯å¤±è´¥: ${error.message}`, 'error');
                }
            };
            
            // ä»é€‰æ‹©æ¨¡æ€æ¡†åˆ›å»ºæ–°ä¼šè¯
            window.createNewConversationFromSelect = async function() {
                try {
                    console.log('ğŸ”„ ä»é€‰æ‹©æ¨¡æ€æ¡†åˆ›å»ºæ–°ä¼šè¯');
                    
                    const currentAgent = window.chatController?.currentAgent;
                    if (!currentAgent || !currentAgent.id) {
                        showToast('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªæ™ºèƒ½ä½“', 'warning');
                        return;
                    }
                    
                    console.log('ğŸ¤– åŸºäºå½“å‰æ™ºèƒ½ä½“åˆ›å»ºå¯¹è¯:', currentAgent.id);
                    
                    // åˆ›å»ºæ–°ä¼šè¯
                    const response = await ENV_CONFIG.apiClient.post('/conversations', {
                        title: `ä¸${currentAgent.name}çš„å¯¹è¯`,
                        agent_id: currentAgent.id,
                        metadata: {
                            created_from: 'select_modal',
                            agent_name: currentAgent.name,
                            created_at: new Date().toISOString(),
                            client_info: {
                                user_agent: navigator.userAgent,
                                page_url: window.location.href,
                                timestamp: Date.now()
                            }
                        }
                    });
                    
                    console.log('ğŸ“ åˆ›å»ºä¼šè¯APIå“åº”:', response);
                    
                    if (response.success && response.data) {
                        const newConversation = response.data;
                        console.log('âœ… æ–°ä¼šè¯åˆ›å»ºæˆåŠŸ:', newConversation.id);
                        
                        // åˆ‡æ¢åˆ°æ–°ä¼šè¯
                        await window.chatController.switchConversation(newConversation.id);
                        
                        // å…³é—­æ¨¡æ€æ¡†
                        const modal = bootstrap.Modal.getInstance(document.getElementById('selectConversationModal'));
                        if (modal) {
                            modal.hide();
                        }
                        
                        // æ·»åŠ ç³»ç»Ÿæ¶ˆæ¯
                        if (window.chatController.addSystemMessage) {
                            window.chatController.addSystemMessage(`å·²åˆ›å»ºæ–°ä¼šè¯ï¼Œæ­£åœ¨ä¸ ${currentAgent.name} å¯¹è¯`);
                        }
                        
                        showToast('æ–°ä¼šè¯åˆ›å»ºæˆåŠŸï¼', 'success');
                        
                        // è®°å½•åˆ›å»ºä¼šè¯çš„è¯¦ç»†ä¿¡æ¯
                        console.log('ğŸ¯ ä¼šè¯åˆ›å»ºè¯¦æƒ…:', {
                            conversationId: newConversation.id,
                            agentId: currentAgent.id,
                            agentName: currentAgent.name,
                            title: newConversation.title,
                            timestamp: new Date().toISOString(),
                            metadata: {
                                currentAgent: window.chatController.currentAgent?.id
                            }
                        });
                        
                    } else {
                        throw new Error(response.message || 'åˆ›å»ºä¼šè¯å¤±è´¥');
                    }
                    
                } catch (error) {
                    console.error('åˆ›å»ºæ–°ä¼šè¯å¤±è´¥:', error);
                    showToast(`åˆ›å»ºä¼šè¯å¤±è´¥: ${error.message}`, 'error');
                }
            };
            
            // ä»é€‰æ‹©æ¨¡æ€æ¡†é‡å‘½åä¼šè¯
            window.renameConversationFromModal = function(conversationId, currentTitle) {
                // å¡«å……é‡å‘½åæ¨¡æ€æ¡†
                document.getElementById('renameConversationId').value = conversationId;
                document.getElementById('renameConversationTitle').value = currentTitle;
                
                // æ˜¾ç¤ºé‡å‘½åæ¨¡æ€æ¡†
                const renameModal = new bootstrap.Modal(document.getElementById('renameConversationModal'));
                renameModal.show();
                
                // å…³é—­é€‰æ‹©æ¨¡æ€æ¡†
                const selectModal = bootstrap.Modal.getInstance(document.getElementById('selectConversationModal'));
                if (selectModal) {
                    selectModal.hide();
                }
            };
            
            // ä»é€‰æ‹©æ¨¡æ€æ¡†åˆ é™¤ä¼šè¯
            window.deleteConversationFromModal = async function(conversationId) {
                if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªä¼šè¯å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚')) {
                    return;
                }
                
                try {
                    console.log('ğŸ—‘ï¸ ä»é€‰æ‹©æ¨¡æ€æ¡†åˆ é™¤ä¼šè¯:', conversationId);
                    
                    const response = await ENV_CONFIG.apiClient.delete(`/conversations/${conversationId}`);
                    
                    if (response.success) {
                        showToast('ä¼šè¯åˆ é™¤æˆåŠŸ', 'success');
                        
                        // å¦‚æœåˆ é™¤çš„æ˜¯å½“å‰ä¼šè¯ï¼Œéœ€è¦æ¸…ç©ºèŠå¤©åŒºåŸŸ
                        if (window.chatController?.conversationId === conversationId) {
                            window.chatController.clearMessages();
                            window.chatController.conversationId = null;
                        }
                        
                        // åˆ·æ–°é€‰æ‹©ä¼šè¯åˆ—è¡¨
                        await loadSelectConversationList();
                        
                    } else {
                        throw new Error(response.message || 'åˆ é™¤ä¼šè¯å¤±è´¥');
                    }
                    
                } catch (error) {
                    console.error('åˆ é™¤ä¼šè¯å¤±è´¥:', error);
                    showToast(`åˆ é™¤ä¼šè¯å¤±è´¥: ${error.message}`, 'error');
                }
            };
            
            console.log('âœ… é¡µé¢åˆå§‹åŒ–å®Œæˆ');
        });

        // ========================================
        // ğŸ“± ç§»åŠ¨ç«¯è¾“å…¥æ¡†ä¼˜åŒ–
        // ========================================
        function setupMobileInputOptimization() {
            const messageInput = document.getElementById('messageInput');
            const chatMessages = document.getElementById('chatMessages');
            const chatInput = document.querySelector('.chat-input');
            
            if (!messageInput || !chatMessages || !chatInput) {
                console.log('ç§»åŠ¨ç«¯ä¼˜åŒ–ï¼šæœªæ‰¾åˆ°å¿…è¦å…ƒç´ ');
                return;
            }

            console.log('ğŸ“± è®¾ç½®ç§»åŠ¨ç«¯è¾“å…¥æ¡†ä¼˜åŒ–...');

            // è¾“å…¥æ¡†è·å¾—ç„¦ç‚¹æ—¶çš„å¤„ç†
            messageInput.addEventListener('focus', function() {
                console.log('ğŸ“± è¾“å…¥æ¡†è·å¾—ç„¦ç‚¹');
                
                // å°å»¶è¿Ÿç¡®ä¿è™šæ‹Ÿé”®ç›˜å·²ç»å¼¹å‡º
                setTimeout(() => {
                    // æ»šåŠ¨åˆ°è¾“å…¥æ¡†ä½ç½®ï¼Œç¡®ä¿è¾“å…¥æ¡†å¯è§
                    messageInput.scrollIntoView({ 
                        behavior: 'smooth', 
                        block: 'center' 
                    });
                }, 150);

                // å†æ¬¡å»¶è¿Ÿç¡®ä¿æ»šåŠ¨åˆ°åº•éƒ¨
                setTimeout(() => {
                    if (chatMessages.scrollHeight > chatMessages.clientHeight) {
                        chatMessages.scrollTop = chatMessages.scrollHeight;
                    }
                }, 300);
            });

            // è¾“å…¥æ¡†å¤±å»ç„¦ç‚¹æ—¶çš„å¤„ç†
            messageInput.addEventListener('blur', function() {
                console.log('ğŸ“± è¾“å…¥æ¡†å¤±å»ç„¦ç‚¹');
            });

            // å¤„ç†è¾“å…¥æ¡†å¤§å°å˜åŒ–ï¼ˆè™šæ‹Ÿé”®ç›˜å¼¹å‡º/æ”¶èµ·ï¼‰
            let initialHeight = window.innerHeight;
            
            function handleResize() {
                const currentHeight = window.innerHeight;
                const heightDifference = initialHeight - currentHeight;
                
                // å¦‚æœé«˜åº¦å‡å°‘è¶…è¿‡150pxï¼Œè®¤ä¸ºæ˜¯è™šæ‹Ÿé”®ç›˜å¼¹å‡º
                if (heightDifference > 150) {
                    console.log('ğŸ“± æ£€æµ‹åˆ°è™šæ‹Ÿé”®ç›˜å¼¹å‡ºï¼Œé«˜åº¦å˜åŒ–:', heightDifference);
                    
                    // ç¡®ä¿è¾“å…¥æ¡†å¯è§
                    setTimeout(() => {
                        messageInput.scrollIntoView({ 
                            behavior: 'smooth', 
                            block: 'end'
                        });
                    }, 100);
                } else if (heightDifference < 50) {
                    console.log('ğŸ“± æ£€æµ‹åˆ°è™šæ‹Ÿé”®ç›˜æ”¶èµ·');
                }
            }

            // ç›‘å¬çª—å£å¤§å°å˜åŒ–
            window.addEventListener('resize', handleResize);

            // ç›‘å¬è¾“å…¥äº‹ä»¶ï¼Œç¡®ä¿è¾“å…¥æ—¶è¾“å…¥æ¡†å§‹ç»ˆå¯è§
            messageInput.addEventListener('input', function() {
                // é˜²æŠ–å¤„ç†
                clearTimeout(this.inputTimer);
                this.inputTimer = setTimeout(() => {
                    if (document.activeElement === messageInput) {
                        messageInput.scrollIntoView({ 
                            behavior: 'smooth', 
                            block: 'center' 
                        });
                    }
                }, 100);
            });

            // Visual Viewport API æ”¯æŒï¼ˆæ›´ç²¾ç¡®çš„è™šæ‹Ÿé”®ç›˜æ£€æµ‹ï¼‰
            if (window.visualViewport) {
                console.log('ğŸ“± ä½¿ç”¨ Visual Viewport API');
                
                window.visualViewport.addEventListener('resize', () => {
                    const heightDiff = window.innerHeight - window.visualViewport.height;
                    
                    if (heightDiff > 150 && document.activeElement === messageInput) {
                        console.log('ğŸ“± Visual Viewport æ£€æµ‹åˆ°è™šæ‹Ÿé”®ç›˜ï¼Œé«˜åº¦å·®:', heightDiff);
                        
                        setTimeout(() => {
                            messageInput.scrollIntoView({ 
                                behavior: 'smooth', 
                                block: 'center' 
                            });
                        }, 150);
                    }
                });
            }

            // æ·»åŠ ç‚¹å‡»èŠå¤©åŒºåŸŸè‡ªåŠ¨èšç„¦è¾“å…¥æ¡†çš„åŠŸèƒ½ï¼ˆä»…ç§»åŠ¨ç«¯ï¼‰
            chatMessages.addEventListener('click', function(e) {
                // å¦‚æœç‚¹å‡»çš„ä¸æ˜¯é“¾æ¥ã€æŒ‰é’®ç­‰äº¤äº’å…ƒç´ 
                if (!e.target.closest('a, button, .message-actions')) {
                    messageInput.focus();
                }
            });

            console.log('âœ… ç§»åŠ¨ç«¯è¾“å…¥æ¡†ä¼˜åŒ–è®¾ç½®å®Œæˆ');
        }

        // çª—å£å¤§å°æ”¹å˜æ—¶é‡æ–°æ£€æŸ¥æ˜¯å¦éœ€è¦ç§»åŠ¨ç«¯ä¼˜åŒ–
        window.addEventListener('resize', function() {
            if (window.innerWidth <= 768 && !window.mobileOptimizationEnabled) {
                setupMobileInputOptimization();
                window.mobileOptimizationEnabled = true;
            } else if (window.innerWidth > 768) {
                window.mobileOptimizationEnabled = false;
            }
        });
    </script>
</body>
</html>
