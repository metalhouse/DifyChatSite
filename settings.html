<!DOCTYPE html>
<html lang="zh-CN" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>系统设置 - DifyChat</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="assets/images/favicon.svg">
    <link rel="icon" type="image/svg+xml" href="assets/images/favicon-16.svg" sizes="16x16">
    <link rel="alternate icon" href="assets/images/favicon.svg">
    <meta name="theme-color" content="#007bff">
    
    <!-- Bootstrap 5.3 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Font Awesome 6.4 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* 添加与聊天页面一致的样式 */
        body { 
            padding-top: 56px; /* 为固定导航栏留出空间 */
        }
        
        .settings-header {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            padding: 2rem 0;
        }
        
        .settings-card {
            border: none;
            box-shadow: 0 2px 12px rgba(0,0,0,0.1);
            border-radius: 12px;
            transition: transform 0.2s ease;
        }
        
        .settings-card:hover {
            transform: translateY(-2px);
        }
        
        .settings-icon {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #007bff, #0056b3);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
        }
        
        .form-switch .form-check-input {
            width: 3rem;
            height: 1.5rem;
        }
        
        .form-switch .form-check-input:checked {
            background-color: #28a745;
            border-color: #28a745;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #007bff, #0056b3);
            border: none;
        }
        
        .btn-success {
            background: linear-gradient(135deg, #28a745, #20c997);
            border: none;
        }
        
        .theme-preview {
            width: 40px;
            height: 30px;
            border-radius: 6px;
            border: 2px solid #dee2e6;
            cursor: pointer;
            transition: border-color 0.2s ease;
        }
        
        .theme-preview.active {
            border-color: #007bff;
            box-shadow: 0 0 0 2px rgba(0,123,255,0.25);
        }
        
        .light-theme { background: linear-gradient(to bottom, #fff 50%, #f8f9fa 50%); }
        .dark-theme { background: linear-gradient(to bottom, #343a40 50%, #212529 50%); }
        .blue-theme { background: linear-gradient(to bottom, #007bff 50%, #0056b3 50%); }
        .green-theme { background: linear-gradient(to bottom, #28a745 50%, #20c997 50%); }
        
        /* 用户下拉菜单样式 */
        .user-dropdown-toggle {
            color: rgba(255,255,255,0.8) !important;
            transition: color 0.3s ease;
        }
        
        .user-dropdown-toggle:hover,
        .user-dropdown-toggle:focus,
        .user-dropdown-toggle.show {
            color: rgba(255,255,255,1) !important;
        }
    </style>
</head>
<body>
    <!-- 导航栏 -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="./index.html">
                <i class="fas fa-robot me-2"></i>
                DifyChat
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="./index.html">首页</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="./chat.html">聊天</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="./chatroom.html">聊天室</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="./profile.html">个人资料</a>
                    </li>
                    <li class="nav-item" id="adminNavItem" style="display: none;">
                        <a class="nav-link" href="./admin.html">
                            <i class="fas fa-cogs me-1"></i>管理后台
                        </a>
                    </li>
                </ul>
                <ul class="navbar-nav">
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle user-dropdown-toggle" href="#" id="navUserDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="fas fa-user-circle me-1"></i>
                            <span id="navCurrentUsername">用户</span>
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="navUserDropdown">
                            <li><a class="dropdown-item" href="./profile.html">
                                <i class="fas fa-user me-2"></i>个人资料
                            </a></li>
                            <li><a class="dropdown-item" href="./settings.html">
                                <i class="fas fa-cog me-2"></i>设置
                            </a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="#" id="nav-logout">
                                <i class="fas fa-sign-out-alt me-2"></i>退出登录
                            </a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- 设置头部 -->
    <div class="settings-header">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h2>
                        <i class="fas fa-cog me-3"></i>
                        系统设置
                    </h2>
                    <p class="mb-0">个性化您的 DifyChat 体验</p>
                </div>
                <div class="col-md-4 text-end">
                    <button class="btn btn-light" id="resetAllSettings">
                        <i class="fas fa-undo me-2"></i>
                        重置所有设置
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 主要内容 -->
    <div class="container my-5">
        <div class="row">
            <!-- 左侧：设置菜单 -->
            <div class="col-lg-3">
                <div class="list-group" id="settingsMenu">
                    <a href="#appearance" class="list-group-item list-group-item-action active" data-bs-toggle="list">
                        <i class="fas fa-palette me-2"></i>
                        外观设置
                    </a>
                    <a href="#notifications" class="list-group-item list-group-item-action" data-bs-toggle="list">
                        <i class="fas fa-bell me-2"></i>
                        通知设置
                    </a>
                    <a href="#chat" class="list-group-item list-group-item-action" data-bs-toggle="list">
                        <i class="fas fa-comments me-2"></i>
                        聊天设置
                    </a>
                    <a href="#privacy" class="list-group-item list-group-item-action" data-bs-toggle="list">
                        <i class="fas fa-shield-alt me-2"></i>
                        隐私安全
                    </a>
                    <a href="#advanced" class="list-group-item list-group-item-action" data-bs-toggle="list">
                        <i class="fas fa-cogs me-2"></i>
                        高级设置
                    </a>
                </div>
            </div>

            <!-- 右侧：设置内容 -->
            <div class="col-lg-9">
                <div class="tab-content" id="settingsContent">
                    <!-- 外观设置 -->
                    <div class="tab-pane fade show active" id="appearance">
                        <div class="settings-card card mb-4">
                            <div class="card-header bg-white">
                                <h5 class="mb-0">
                                    <i class="fas fa-palette me-2 text-primary"></i>
                                    主题设置
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">选择主题</label>
                                        <div class="d-flex gap-3">
                                            <div class="text-center">
                                                <div class="theme-preview light-theme active" data-theme="light"></div>
                                                <small class="text-muted mt-1 d-block">浅色</small>
                                            </div>
                                            <div class="text-center">
                                                <div class="theme-preview dark-theme" data-theme="dark"></div>
                                                <small class="text-muted mt-1 d-block">深色</small>
                                            </div>
                                            <div class="text-center">
                                                <div class="theme-preview blue-theme" data-theme="blue"></div>
                                                <small class="text-muted mt-1 d-block">蓝色</small>
                                            </div>
                                            <div class="text-center">
                                                <div class="theme-preview green-theme" data-theme="green"></div>
                                                <small class="text-muted mt-1 d-block">绿色</small>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="fontSize" class="form-label">字体大小</label>
                                        <select class="form-select" id="fontSize">
                                            <option value="small">小号 (12px)</option>
                                            <option value="normal" selected>正常 (14px)</option>
                                            <option value="large">大号 (16px)</option>
                                            <option value="xlarge">特大 (18px)</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="enableAnimations" checked>
                                            <label class="form-check-label" for="enableAnimations">
                                                启用动画效果
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="compactMode">
                                            <label class="form-check-label" for="compactMode">
                                                紧凑模式
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="settings-card card">
                            <div class="card-header bg-white">
                                <h5 class="mb-0">
                                    <i class="fas fa-language me-2 text-success"></i>
                                    语言设置
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <label for="language" class="form-label">界面语言</label>
                                        <select class="form-select" id="language">
                                            <option value="zh-CN" selected>简体中文</option>
                                            <option value="zh-TW">繁體中文</option>
                                            <option value="en-US">English</option>
                                            <option value="ja-JP">日本語</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="timezone" class="form-label">时区</label>
                                        <select class="form-select" id="timezone">
                                            <option value="Asia/Shanghai" selected>中国标准时间 (GMT+8)</option>
                                            <option value="Asia/Tokyo">日本标准时间 (GMT+9)</option>
                                            <option value="America/New_York">美国东部时间 (GMT-5)</option>
                                            <option value="Europe/London">格林威治时间 (GMT+0)</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 通知设置 -->
                    <div class="tab-pane fade" id="notifications">
                        <div class="settings-card card mb-4">
                            <div class="card-header bg-white">
                                <h5 class="mb-0">
                                    <i class="fas fa-bell me-2 text-warning"></i>
                                    推送通知
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="browserNotifications" checked>
                                            <label class="form-check-label" for="browserNotifications">
                                                浏览器通知
                                            </label>
                                        </div>
                                        <small class="text-muted">在浏览器中显示桌面通知</small>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="soundNotifications" checked>
                                            <label class="form-check-label" for="soundNotifications">
                                                声音提醒
                                            </label>
                                        </div>
                                        <small class="text-muted">新消息时播放提示音</small>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="emailNotifications">
                                            <label class="form-check-label" for="emailNotifications">
                                                邮件通知
                                            </label>
                                        </div>
                                        <small class="text-muted">重要消息发送邮件提醒</small>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="notificationSound" class="form-label">提示音</label>
                                        <select class="form-select" id="notificationSound">
                                            <option value="default" selected>默认</option>
                                            <option value="bell">铃声</option>
                                            <option value="chime">风铃</option>
                                            <option value="ding">叮咚</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="settings-card card">
                            <div class="card-header bg-white">
                                <h5 class="mb-0">
                                    <i class="fas fa-clock me-2 text-info"></i>
                                    免打扰时间
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="form-check form-switch mb-3">
                                    <input class="form-check-input" type="checkbox" id="doNotDisturb">
                                    <label class="form-check-label" for="doNotDisturb">
                                        启用免打扰模式
                                    </label>
                                </div>
                                <div class="row" id="dndTimeSettings" style="display: none;">
                                    <div class="col-md-6">
                                        <label for="dndStartTime" class="form-label">开始时间</label>
                                        <input type="time" class="form-control" id="dndStartTime" value="22:00">
                                    </div>
                                    <div class="col-md-6">
                                        <label for="dndEndTime" class="form-label">结束时间</label>
                                        <input type="time" class="form-control" id="dndEndTime" value="08:00">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 聊天设置 -->
                    <div class="tab-pane fade" id="chat">
                        <div class="settings-card card mb-4">
                            <div class="card-header bg-white">
                                <h5 class="mb-0">
                                    <i class="fas fa-comments me-2 text-primary"></i>
                                    聊天行为
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="enterToSend" checked>
                                            <label class="form-check-label" for="enterToSend">
                                                回车键发送消息
                                            </label>
                                        </div>
                                        <small class="text-muted">取消勾选后使用 Ctrl+Enter 发送</small>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="showTyping" checked>
                                            <label class="form-check-label" for="showTyping">
                                                显示正在输入状态
                                            </label>
                                        </div>
                                        <small class="text-muted">让其他用户看到您正在输入</small>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="autoScroll" checked>
                                            <label class="form-check-label" for="autoScroll">
                                                自动滚动到新消息
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="messageHistory" class="form-label">消息历史记录</label>
                                        <select class="form-select" id="messageHistory">
                                            <option value="50" selected>最近50条</option>
                                            <option value="100">最近100条</option>
                                            <option value="200">最近200条</option>
                                            <option value="all">全部</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="settings-card card">
                            <div class="card-header bg-white">
                                <h5 class="mb-0">
                                    <i class="fas fa-file-upload me-2 text-success"></i>
                                    文件上传
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="maxFileSize" class="form-label">最大文件大小</label>
                                        <select class="form-select" id="maxFileSize">
                                            <option value="1">1 MB</option>
                                            <option value="5" selected>5 MB</option>
                                            <option value="10">10 MB</option>
                                            <option value="20">20 MB</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="autoPreview" checked>
                                            <label class="form-check-label" for="autoPreview">
                                                自动预览图片
                                            </label>
                                        </div>
                                        <small class="text-muted">自动显示上传的图片</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 隐私安全 -->
                    <div class="tab-pane fade" id="privacy">
                        <div class="settings-card card mb-4">
                            <div class="card-header bg-white">
                                <h5 class="mb-0">
                                    <i class="fas fa-shield-alt me-2 text-danger"></i>
                                    隐私控制
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="showOnlineStatus" checked>
                                            <label class="form-check-label" for="showOnlineStatus">
                                                显示在线状态
                                            </label>
                                        </div>
                                        <small class="text-muted">让其他用户看到您的在线状态</small>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="allowDirectMessages" checked>
                                            <label class="form-check-label" for="allowDirectMessages">
                                                允许私聊
                                            </label>
                                        </div>
                                        <small class="text-muted">允许其他用户向您发送私信</small>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="encryptMessages" checked>
                                            <label class="form-check-label" for="encryptMessages">
                                                消息加密
                                            </label>
                                        </div>
                                        <small class="text-muted">使用端到端加密保护消息</small>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="saveHistory" checked>
                                            <label class="form-check-label" for="saveHistory">
                                                保存聊天记录
                                            </label>
                                        </div>
                                        <small class="text-muted">在服务器上保存聊天记录</small>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="settings-card card">
                            <div class="card-header bg-white">
                                <h5 class="mb-0">
                                    <i class="fas fa-user-shield me-2 text-warning"></i>
                                    数据管理
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <div>
                                        <h6 class="mb-1">导出数据</h6>
                                        <small class="text-muted">下载您的聊天记录和个人数据</small>
                                    </div>
                                    <button class="btn btn-outline-primary" id="exportData">
                                        <i class="fas fa-download me-2"></i>
                                        导出
                                    </button>
                                </div>
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <div>
                                        <h6 class="mb-1">清除聊天记录</h6>
                                        <small class="text-muted">删除所有本地聊天记录</small>
                                    </div>
                                    <button class="btn btn-outline-warning" id="clearHistory">
                                        <i class="fas fa-trash me-2"></i>
                                        清除
                                    </button>
                                </div>
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6 class="mb-1 text-danger">删除账户</h6>
                                        <small class="text-muted">永久删除您的账户和所有数据</small>
                                    </div>
                                    <button class="btn btn-outline-danger" id="deleteAccount">
                                        <i class="fas fa-user-times me-2"></i>
                                        删除
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 高级设置 -->
                    <div class="tab-pane fade" id="advanced">
                        <div class="settings-card card mb-4">
                            <div class="card-header bg-white">
                                <h5 class="mb-0">
                                    <i class="fas fa-cogs me-2 text-secondary"></i>
                                    开发者选项
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="debugMode">
                                            <label class="form-check-label" for="debugMode">
                                                调试模式
                                            </label>
                                        </div>
                                        <small class="text-muted">在控制台显示详细日志</small>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="betaFeatures">
                                            <label class="form-check-label" for="betaFeatures">
                                                测试功能
                                            </label>
                                        </div>
                                        <small class="text-muted">启用实验性功能</small>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="apiEndpoint" class="form-label">API 端点</label>
                                        <input type="url" class="form-control" id="apiEndpoint" placeholder="后端API地址 (自动检测)">
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="wsEndpoint" class="form-label">WebSocket 端点</label>
                                        <input type="url" class="form-control" id="wsEndpoint" placeholder="ws://localhost:6000">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="settings-card card">
                            <div class="card-header bg-white">
                                <h5 class="mb-0">
                                    <i class="fas fa-database me-2 text-info"></i>
                                    存储管理
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <h6>本地存储使用情况</h6>
                                        <div class="progress mb-2" style="height: 10px;">
                                            <div class="progress-bar" role="progressbar" style="width: 25%" id="storageUsage"></div>
                                        </div>
                                        <small class="text-muted">已使用 <span id="usedStorage">2.5 MB</span> / 10 MB</small>
                                    </div>
                                    <div class="col-md-6 text-end">
                                        <button class="btn btn-outline-secondary" id="clearCache">
                                            <i class="fas fa-broom me-2"></i>
                                            清理缓存
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 保存按钮 -->
                <div class="d-flex justify-content-end gap-2 mt-4">
                    <button class="btn btn-outline-secondary" id="cancelSettings">
                        <i class="fas fa-times me-2"></i>
                        取消
                    </button>
                    <button class="btn btn-success" id="saveSettings">
                        <i class="fas fa-save me-2"></i>
                        保存设置
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast 提示容器 -->
    <div class="toast-container position-fixed top-0 end-0 p-3"></div>

    <!-- Bootstrap 5.3 JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- 配置文件 - 统一配置管理 -->
    <script type="module" src="config/env.js?v=2.0.0"></script>
    <script type="module" src="config/global-config.js?v=2.0.1"></script>
    <script src="config/app-config.js?v=1.0.1"></script>
    
    <!-- API依赖 - 使用兼容版本 -->
    <script src="js/api/dify-api-compat.js?v=1.0.0"></script>
    
    <!-- 退出登录工具 -->
    <script src="js/utils/logout-manager.js?v=1.0.1"></script>

    <script>
        // 设置管理器
        class SettingsManager {
            constructor() {
                this.difyApi = window.difyApi;
                this.settings = this.loadSettings();
                this.init();
            }

            async init() {
                // 检查登录状态
                if (!this.difyApi || !this.difyApi.isLoggedIn()) {
                    this.showToast('请先登录', 'warning');
                    setTimeout(() => {
                        window.location.href = './login.html';
                    }, 1500);
                    return;
                }

                // 更新导航栏用户名
                const userInfo = this.difyApi.getUserInfo();
                if (userInfo) {
                    const username = userInfo.username || userInfo.display_name || '用户';
                    const navUsername = document.getElementById('navCurrentUsername');
                    if (navUsername) {
                        navUsername.textContent = username;
                    }
                }

                this.applySettings();
                this.bindEvents();
                this.updateStorageInfo();
            }

            // 加载设置
            loadSettings() {
                const defaultSettings = {
                    // 外观设置
                    theme: 'light',
                    fontSize: 'normal',
                    enableAnimations: true,
                    compactMode: false,
                    language: 'zh-CN',
                    timezone: 'Asia/Shanghai',
                    
                    // 通知设置
                    browserNotifications: true,
                    soundNotifications: true,
                    emailNotifications: false,
                    notificationSound: 'default',
                    doNotDisturb: false,
                    dndStartTime: '22:00',
                    dndEndTime: '08:00',
                    
                    // 聊天设置
                    enterToSend: true,
                    showTyping: true,
                    autoScroll: true,
                    messageHistory: '50',
                    maxFileSize: '5',
                    autoPreview: true,
                    
                    // 隐私安全
                    showOnlineStatus: true,
                    allowDirectMessages: true,
                    encryptMessages: true,
                    saveHistory: true,
                    
                    // 高级设置
                    debugMode: false,
                    betaFeatures: false,
                    apiEndpoint: '',
                    wsEndpoint: ''
                };

                try {
                    const saved = JSON.parse(localStorage.getItem('dify_settings') || '{}');
                    return { ...defaultSettings, ...saved };
                } catch (error) {
                    console.error('加载设置失败:', error);
                    return defaultSettings;
                }
            }

            // 保存设置
            saveSettings() {
                try {
                    localStorage.setItem('dify_settings', JSON.stringify(this.settings));
                    this.showToast('设置保存成功', 'success');
                } catch (error) {
                    console.error('保存设置失败:', error);
                    this.showToast('设置保存失败', 'error');
                }
            }

            // 应用设置到界面
            applySettings() {
                // 外观设置
                document.querySelector(`[data-theme="${this.settings.theme}"]`)?.classList.add('active');
                document.getElementById('fontSize').value = this.settings.fontSize;
                document.getElementById('enableAnimations').checked = this.settings.enableAnimations;
                document.getElementById('compactMode').checked = this.settings.compactMode;
                document.getElementById('language').value = this.settings.language;
                document.getElementById('timezone').value = this.settings.timezone;

                // 通知设置
                document.getElementById('browserNotifications').checked = this.settings.browserNotifications;
                document.getElementById('soundNotifications').checked = this.settings.soundNotifications;
                document.getElementById('emailNotifications').checked = this.settings.emailNotifications;
                document.getElementById('notificationSound').value = this.settings.notificationSound;
                document.getElementById('doNotDisturb').checked = this.settings.doNotDisturb;
                document.getElementById('dndStartTime').value = this.settings.dndStartTime;
                document.getElementById('dndEndTime').value = this.settings.dndEndTime;

                // 聊天设置
                document.getElementById('enterToSend').checked = this.settings.enterToSend;
                document.getElementById('showTyping').checked = this.settings.showTyping;
                document.getElementById('autoScroll').checked = this.settings.autoScroll;
                document.getElementById('messageHistory').value = this.settings.messageHistory;
                document.getElementById('maxFileSize').value = this.settings.maxFileSize;
                document.getElementById('autoPreview').checked = this.settings.autoPreview;

                // 隐私安全
                document.getElementById('showOnlineStatus').checked = this.settings.showOnlineStatus;
                document.getElementById('allowDirectMessages').checked = this.settings.allowDirectMessages;
                document.getElementById('encryptMessages').checked = this.settings.encryptMessages;
                document.getElementById('saveHistory').checked = this.settings.saveHistory;

                // 高级设置
                document.getElementById('debugMode').checked = this.settings.debugMode;
                document.getElementById('betaFeatures').checked = this.settings.betaFeatures;
                document.getElementById('apiEndpoint').value = this.settings.apiEndpoint;
                document.getElementById('wsEndpoint').value = this.settings.wsEndpoint;

                // 应用主题
                this.applyTheme(this.settings.theme);
                
                // 应用字体大小
                this.applyFontSize(this.settings.fontSize);

                // 免打扰时间显示控制
                this.toggleDndSettings();
            }

            // 绑定事件
            bindEvents() {
                // 主题选择
                document.querySelectorAll('.theme-preview').forEach(theme => {
                    theme.addEventListener('click', () => {
                        document.querySelectorAll('.theme-preview').forEach(t => t.classList.remove('active'));
                        theme.classList.add('active');
                        this.settings.theme = theme.dataset.theme;
                        this.applyTheme(this.settings.theme);
                    });
                });

                // 字体大小
                document.getElementById('fontSize').addEventListener('change', (e) => {
                    this.settings.fontSize = e.target.value;
                    this.applyFontSize(this.settings.fontSize);
                });

                // 免打扰开关
                document.getElementById('doNotDisturb').addEventListener('change', () => {
                    this.toggleDndSettings();
                });

                // 保存设置
                document.getElementById('saveSettings').addEventListener('click', () => {
                    this.collectSettings();
                    this.saveSettings();
                });

                // 取消设置
                document.getElementById('cancelSettings').addEventListener('click', () => {
                    this.applySettings(); // 重新应用原有设置
                    this.showToast('已取消更改', 'info');
                });

                // 重置所有设置
                document.getElementById('resetAllSettings').addEventListener('click', () => {
                    if (confirm('确定要重置所有设置吗？这将恢复默认配置。')) {
                        this.resetSettings();
                    }
                });

                // 数据管理
                document.getElementById('exportData').addEventListener('click', () => {
                    this.exportData();
                });

                document.getElementById('clearHistory').addEventListener('click', () => {
                    if (confirm('确定要清除所有聊天记录吗？此操作不可撤销。')) {
                        this.clearHistory();
                    }
                });

                document.getElementById('clearCache').addEventListener('click', () => {
                    this.clearCache();
                });

                document.getElementById('deleteAccount').addEventListener('click', () => {
                    this.deleteAccount();
                });

                // 登出
                document.getElementById('nav-logout').addEventListener('click', (e) => {
                    e.preventDefault();
                    this.logout();
                });

                // 通知权限请求
                document.getElementById('browserNotifications').addEventListener('change', (e) => {
                    if (e.target.checked) {
                        this.requestNotificationPermission();
                    }
                });
            }

            // 收集当前设置
            collectSettings() {
                // 外观设置
                this.settings.theme = document.querySelector('.theme-preview.active')?.dataset.theme || 'light';
                this.settings.fontSize = document.getElementById('fontSize').value;
                this.settings.enableAnimations = document.getElementById('enableAnimations').checked;
                this.settings.compactMode = document.getElementById('compactMode').checked;
                this.settings.language = document.getElementById('language').value;
                this.settings.timezone = document.getElementById('timezone').value;

                // 通知设置
                this.settings.browserNotifications = document.getElementById('browserNotifications').checked;
                this.settings.soundNotifications = document.getElementById('soundNotifications').checked;
                this.settings.emailNotifications = document.getElementById('emailNotifications').checked;
                this.settings.notificationSound = document.getElementById('notificationSound').value;
                this.settings.doNotDisturb = document.getElementById('doNotDisturb').checked;
                this.settings.dndStartTime = document.getElementById('dndStartTime').value;
                this.settings.dndEndTime = document.getElementById('dndEndTime').value;

                // 聊天设置
                this.settings.enterToSend = document.getElementById('enterToSend').checked;
                this.settings.showTyping = document.getElementById('showTyping').checked;
                this.settings.autoScroll = document.getElementById('autoScroll').checked;
                this.settings.messageHistory = document.getElementById('messageHistory').value;
                this.settings.maxFileSize = document.getElementById('maxFileSize').value;
                this.settings.autoPreview = document.getElementById('autoPreview').checked;

                // 隐私安全
                this.settings.showOnlineStatus = document.getElementById('showOnlineStatus').checked;
                this.settings.allowDirectMessages = document.getElementById('allowDirectMessages').checked;
                this.settings.encryptMessages = document.getElementById('encryptMessages').checked;
                this.settings.saveHistory = document.getElementById('saveHistory').checked;

                // 高级设置
                this.settings.debugMode = document.getElementById('debugMode').checked;
                this.settings.betaFeatures = document.getElementById('betaFeatures').checked;
                this.settings.apiEndpoint = document.getElementById('apiEndpoint').value;
                this.settings.wsEndpoint = document.getElementById('wsEndpoint').value;
            }

            // 应用主题
            applyTheme(theme) {
                document.documentElement.setAttribute('data-theme', theme);
                
                // 保存主题到localStorage
                this.settings.theme = theme;
                this.saveSettings();
                
                console.log('已应用主题:', theme);
            }

            // 应用字体大小
            applyFontSize(size) {
                const sizeMap = {
                    'small': '12px',
                    'normal': '14px',
                    'large': '16px',
                    'xlarge': '18px'
                };
                document.documentElement.style.fontSize = sizeMap[size] || '14px';
            }

            // 切换免打扰时间设置显示
            toggleDndSettings() {
                const dndSettings = document.getElementById('dndTimeSettings');
                const dndEnabled = document.getElementById('doNotDisturb').checked;
                dndSettings.style.display = dndEnabled ? 'block' : 'none';
            }

            // 请求通知权限
            async requestNotificationPermission() {
                if ('Notification' in window) {
                    const permission = await Notification.requestPermission();
                    if (permission !== 'granted') {
                        document.getElementById('browserNotifications').checked = false;
                        this.showToast('通知权限被拒绝', 'warning');
                    }
                } else {
                    this.showToast('浏览器不支持通知功能', 'error');
                }
            }

            // 重置设置
            resetSettings() {
                localStorage.removeItem('dify_settings');
                this.settings = this.loadSettings();
                this.applySettings();
                this.showToast('设置已重置为默认值', 'success');
            }

            // 导出数据
            exportData() {
                try {
                    const userData = {
                        settings: this.settings,
                        userInfo: this.difyApi.getUserInfo(),
                        chatHistory: JSON.parse(localStorage.getItem('dify_chat_history') || '[]'),
                        exportTime: new Date().toISOString()
                    };

                    const blob = new Blob([JSON.stringify(userData, null, 2)], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `dify_data_${new Date().toISOString().split('T')[0]}.json`;
                    a.click();
                    URL.revokeObjectURL(url);

                    this.showToast('数据导出成功', 'success');
                } catch (error) {
                    console.error('导出数据失败:', error);
                    this.showToast('导出数据失败', 'error');
                }
            }

            // 清除聊天记录
            clearHistory() {
                localStorage.removeItem('dify_chat_history');
                this.showToast('聊天记录已清除', 'success');
            }

            // 清理缓存
            clearCache() {
                // 清理应用缓存
                const keysToKeep = ['dify_access_token', 'dify_refresh_token', 'dify_user_info', 'dify_settings'];
                const keysToRemove = [];
                
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key && !keysToKeep.includes(key)) {
                        keysToRemove.push(key);
                    }
                }
                
                keysToRemove.forEach(key => localStorage.removeItem(key));
                
                this.updateStorageInfo();
                this.showToast('缓存清理完成', 'success');
            }

            // 删除账户
            deleteAccount() {
                const confirmText = prompt('请输入 "DELETE" 确认删除账户（此操作不可撤销）:');
                if (confirmText === 'DELETE') {
                    // 这里应该调用真实的API删除账户
                    this.showToast('账户删除功能需要后端支持', 'warning');
                } else if (confirmText !== null) {
                    this.showToast('确认文本不正确', 'error');
                }
            }

            // 更新存储信息
            updateStorageInfo() {
                try {
                    let totalSize = 0;
                    for (let key in localStorage) {
                        if (localStorage.hasOwnProperty(key)) {
                            totalSize += localStorage[key].length;
                        }
                    }
                    
                    const usedMB = (totalSize / 1024 / 1024).toFixed(2);
                    const maxMB = 10; // 假设最大10MB
                    const percentage = Math.min((usedMB / maxMB) * 100, 100);
                    
                    document.getElementById('usedStorage').textContent = `${usedMB} MB`;
                    document.getElementById('storageUsage').style.width = `${percentage}%`;
                } catch (error) {
                    console.error('更新存储信息失败:', error);
                }
            }

            // 登出
            logout() {
                LogoutManager.logout({
                    redirectUrl: './index.html',
                    onSuccess: () => {
                        this.showToast('已退出登录', 'success');
                    }
                });
            }

            // 显示提示消息
            showToast(message, type = 'info') {
                let toastContainer = document.querySelector('.toast-container');
                if (!toastContainer) {
                    toastContainer = document.createElement('div');
                    toastContainer.className = 'toast-container position-fixed top-0 end-0 p-3';
                    toastContainer.style.zIndex = '9999';
                    document.body.appendChild(toastContainer);
                }
                
                const toastId = 'toast-' + Date.now();
                const bgClass = {
                    'success': 'bg-success',
                    'error': 'bg-danger',
                    'warning': 'bg-warning',
                    'info': 'bg-info'
                }[type] || 'bg-info';
                
                const iconClass = {
                    'success': 'fa-check-circle',
                    'error': 'fa-exclamation-circle',
                    'warning': 'fa-exclamation-triangle',
                    'info': 'fa-info-circle'
                }[type] || 'fa-info-circle';
                
                const toastHTML = `
                    <div id="${toastId}" class="toast ${bgClass} text-white" role="alert">
                        <div class="toast-body">
                            <i class="fas ${iconClass} me-2"></i>
                            ${message}
                        </div>
                    </div>
                `;
                
                toastContainer.insertAdjacentHTML('beforeend', toastHTML);
                
                const toastElement = document.getElementById(toastId);
                const bsToast = new bootstrap.Toast(toastElement, { delay: 3000 });
                bsToast.show();
                
                toastElement.addEventListener('hidden.bs.toast', () => {
                    toastElement.remove();
                });
            }
        }

        // 检查管理员权限并显示管理后台链接
        function checkAdminPermission() {
            try {
                const userInfo = JSON.parse(localStorage.getItem('userInfo') || '{}');
                const userRole = userInfo.role || '';
                
                // 如果是管理员或超级管理员，显示管理后台链接
                if (userRole === 'admin' || userRole === 'superadmin' || userRole === 'administrator') {
                    const adminNavItem = document.getElementById('adminNavItem');
                    if (adminNavItem) {
                        adminNavItem.style.display = 'block';
                    }
                }
            } catch (error) {
                console.log('检查管理员权限时出错:', error);
            }
        }

        // 页面初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 检查管理员权限
            checkAdminPermission();
            
            // 等待依赖加载完成
            function waitForDependencies(callback, maxAttempts = 50) {
                let attempts = 0;
                
                function check() {
                    attempts++;
                    
                    if (window.DifyApiService && window.ENV_CONFIG) {
                        console.log('✅ 依赖加载完成，初始化API实例');
                        window.difyApi = new window.DifyApiService();
                        callback();
                    } else if (attempts < maxAttempts) {
                        setTimeout(check, 100);
                    } else {
                        console.error('❌ 依赖加载超时');
                    }
                }
                
                check();
            }
            
            waitForDependencies(function() {
                new SettingsManager();
            });
        });
    </script>
</body>
</html>
