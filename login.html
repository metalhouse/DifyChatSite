<!DOCTYPE html>
<html lang="zh-CN" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta name="description" content="DifyChat - ç”¨æˆ·ç™»å½•">
    <meta name="keywords" content="èŠå¤©,æ™ºèƒ½å¯¹è¯,DifyChat,ç™»å½•">
    <meta name="author" content="DifyChat Team">
    
    <!-- å®‰å…¨é…ç½® -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval' data: https: http:; connect-src 'self' http: https: ws: wss:;">
    
    <!-- Bootstrap 5.3 CSS -->
    <link href="./vendor/bootstrap/bootstrap.min.css?v=5.3.0" rel="stylesheet">
    
    <!-- Font Awesome 6.4 -->
    <link rel="stylesheet" href="./vendor/font-awesome/all.min.css?v=6.4.0">
    
    <!-- è‡ªå®šä¹‰æ ·å¼ -->
    <link rel="stylesheet" href="./assets/css/variables.css">
    <link rel="stylesheet" href="./assets/css/base.css">
    <link rel="stylesheet" href="./assets/css/components.css">
    <link rel="stylesheet" href="./assets/css/themes.css">
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="assets/images/favicon.svg">
    <link rel="icon" type="image/svg+xml" href="assets/images/favicon-16.svg" sizes="16x16">
    <link rel="alternate icon" href="assets/images/favicon.svg">
    <meta name="theme-color" content="#007bff">
    
    <title>ç™»å½• - DifyChat</title>
    
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            word-wrap: break-word;
            overflow-wrap: break-word;
            hyphens: auto;
        }
        
        /* å…¨å±€æ–‡å­—å¤„ç† */
        * {
            box-sizing: border-box;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }
        
        /* ç¡®ä¿å®¹å™¨ä¸ä¼šè¶…å‡ºè§†å£ */
        .container, .container-fluid, .container-sm, .container-md, .container-lg, .container-xl {
            max-width: calc(100vw - 40px);
            word-wrap: break-word;
        }
        
        .login-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            padding: 0;
            overflow: hidden;
            max-width: min(900px, calc(100vw - 40px));
            width: 100%;
            margin: 20px;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }
        
        .login-left {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            color: white;
            padding: 60px 40px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        
        .login-left::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="25" cy="25" r="1" fill="%23ffffff" opacity="0.1"/><circle cx="75" cy="75" r="1" fill="%23ffffff" opacity="0.1"/><circle cx="25" cy="75" r="1" fill="%23ffffff" opacity="0.05"/><circle cx="75" cy="25" r="1" fill="%23ffffff" opacity="0.05"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>');
            animation: float 20s infinite linear;
        }
        
        @keyframes float {
            0% { transform: translate(-50%, -50%) rotate(0deg); }
            100% { transform: translate(-50%, -50%) rotate(360deg); }
        }
        
        .login-logo {
            font-size: 4rem;
            margin-bottom: 20px;
            position: relative;
            z-index: 1;
        }
        
        .login-title {
            font-size: 2.7rem;
            font-weight: 800;
            margin-bottom: 15px;
            position: relative;
            z-index: 1;
            letter-spacing: 0.08em;
            background: linear-gradient(90deg, #5b9df9 0%, #2193b0 40%, #a770ef 80%, #fff 100%);
            background-clip: text;
            -webkit-background-clip: text;
            color: transparent;
            -webkit-text-fill-color: transparent;
            text-shadow:
                0 4px 16px rgba(91,157,249,0.28),
                0 12px 48px rgba(167,112,239,0.28),
                0 1px 0 #fff,
                0 0px 4px #2193b0,
                0 2px 8px #a770ef;
            font-family: 'Segoe UI', 'Arial Black', 'Arial', sans-serif;
            word-wrap: break-word;
            overflow-wrap: break-word;
            hyphens: auto;
        }
        
        .login-subtitle {
            font-size: 1.1rem;
            opacity: 1;
            line-height: 1.6;
            position: relative;
            z-index: 1;
            color: #f3f6ff; /* åè°ƒçš„æµ…è‰²ï¼Œé€‚åˆæ·±è‰²èƒŒæ™¯ */
            text-shadow: 0 1px 8px rgba(0,0,0,0.18); /* å¢å¼ºå¯è¯»æ€§ */
            word-wrap: break-word;
            overflow-wrap: break-word;
            hyphens: auto;
        }
        
        .login-right {
            padding: 60px 40px;
            word-wrap: break-word;
            overflow-wrap: break-word;
            max-width: 100%;
        }
        
        .form-floating {
            margin-bottom: 20px;
        }
        
        .form-floating input {
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 1rem 0.75rem;
            transition: all 0.3s ease;
        }
        
        .form-floating input:focus {
            border-color: #007bff;
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
        }
        
        .form-floating label {
            color: #6c757d;
        }
        
        .btn-login {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            border: none;
            border-radius: 12px;
            padding: 12px 30px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .btn-login:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0, 123, 255, 0.3);
        }
        
        .btn-login::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }
        
        .btn-login:hover::before {
            left: 100%;
        }
        
        .divider {
            text-align: center;
            margin: 30px 0;
            position: relative;
        }
        
        .divider::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 1px;
            background: #dee2e6;
        }
        
        .divider span {
            background: white;
            padding: 0 20px;
            color: #6c757d;
            font-size: 14px;
        }
        
        .social-login {
            display: flex;
            gap: 15px;
            justify-content: center;
        }
        
        .btn-social {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: 2px solid #e9ecef;
            display: flex;
            align-items: center;
            justify-content: center;
            text-decoration: none;
            transition: all 0.3s ease;
            background: white;
        }
        
        .btn-social:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .btn-social.google {
            color: #db4437;
        }
        
        .btn-social.github {
            color: #333;
        }
        
        .btn-social.wechat {
            color: #09bb07;
        }
        
        .btn-social:hover.google {
            border-color: #db4437;
            background: #db4437;
            color: white;
        }
        
        .btn-social:hover.github {
            border-color: #333;
            background: #333;
            color: white;
        }
        
        .btn-social:hover.wechat {
            border-color: #09bb07;
            background: #09bb07;
            color: white;
        }
        
        .forgot-password {
            text-align: center;
            margin-top: 20px;
        }
        
        .forgot-password a {
            color: #007bff;
            text-decoration: none;
            font-weight: 500;
        }
        
        .forgot-password a:hover {
            text-decoration: underline;
        }
        
        .register-link {
            text-align: center;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #e9ecef;
        }
        
        .register-link a {
            color: #007bff;
            text-decoration: none;
            font-weight: 600;
        }
        
        .register-link a:hover {
            text-decoration: underline;
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        
        .loading-overlay.show {
            display: flex;
        }
        
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            .login-container {
                margin: 10px;
                max-width: calc(100vw - 20px);
                border-radius: 15px;
            }
            
            .login-left, .login-right {
                padding: 40px 20px;
            }
            
            .login-logo {
                font-size: 3rem;
            }
            
            .login-title {
                font-size: 2.2rem !important;
                letter-spacing: 0.05em;
                word-break: break-word;
            }
            
            .login-subtitle {
                font-size: 1rem !important;
                line-height: 1.5;
                word-break: break-word;
            }
            
            h2, .h3 {
                font-size: 1.5rem !important;
                word-wrap: break-word;
            }
            
            p {
                font-size: 0.9rem;
                line-height: 1.4;
                word-wrap: break-word;
            }
        }
        
        @media (max-width: 576px) {
            .login-container {
                margin: 5px;
                max-width: calc(100vw - 10px);
                border-radius: 10px;
            }
            
            .login-left, .login-right {
                padding: 30px 15px;
            }
            
            .login-logo {
                font-size: 2.5rem;
            }
            
            .login-title {
                font-size: 1.8rem !important;
                letter-spacing: 0.03em;
                word-break: break-word;
            }
            
            .login-subtitle {
                font-size: 0.9rem !important;
                line-height: 1.4;
                word-break: break-word;
            }
            
            .form-floating input {
                font-size: 14px;
            }
            
            .btn {
                font-size: 14px;
                padding: 10px 20px;
            }
        }
    </style>
</head>
<body>
    <!-- åŠ è½½é®ç½© -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="text-center">
            <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status">
                <span class="visually-hidden">ç™»å½•ä¸­...</span>
            </div>
            <p class="mt-3 text-muted">æ­£åœ¨ç™»å½•ï¼Œè¯·ç¨å€™...</p>
        </div>
    </div>

    <!-- ä¸»ç™»å½•å®¹å™¨ -->
    <div class="login-container row m-0">
        <!-- å·¦ä¾§å“ç‰ŒåŒºåŸŸ -->
        <div class="col-lg-6 login-left p-0">
            <div class="login-logo">
                <i class="fas fa-robot"></i>
            </div>
            <h1 class="login-title">DifyChat</h1>
            <p class="login-subtitle">
                æ‚¨çš„æ™ºèƒ½å¯¹è¯ä¼™ä¼´<br>
                ä½“éªŒAIé©±åŠ¨çš„å…¨æ–°èŠå¤©æ–¹å¼<br>
                è®©æ¯ä¸€æ¬¡å¯¹è¯éƒ½å……æ»¡æ™ºæ…§
            </p>
            <div class="mt-4">
                <div class="d-flex justify-content-center gap-4 mt-4">
                    <div class="text-center">
                        <div class="fs-4 mb-2">ğŸ¤–</div>
                        <small>æ™ºèƒ½AI</small>
                    </div>
                    <div class="text-center">
                        <div class="fs-4 mb-2">ğŸš€</div>
                        <small>å¿«é€Ÿå“åº”</small>
                    </div>
                    <div class="text-center">
                        <div class="fs-4 mb-2">ğŸ”’</div>
                        <small>å®‰å…¨å¯é </small>
                    </div>
                </div>
            </div>
        </div>

        <!-- å³ä¾§ç™»å½•è¡¨å• -->
        <div class="col-lg-6 login-right">
            <div class="mb-4">
                <h2 class="h3 mb-3 fw-bold text-dark">æ¬¢è¿å›æ¥</h2>
                <p class="text-muted">è¯·ç™»å½•æ‚¨çš„è´¦æˆ·ä»¥ç»§ç»­ä½¿ç”¨</p>
            </div>

            <!-- ç™»å½•è¡¨å• -->
            <form id="loginForm" novalidate>
                <div class="form-floating mb-3">
                    <input type="text" class="form-control" id="identifier" placeholder="ç”¨æˆ·å/é‚®ç®±/æ‰‹æœºå·" required>
                    <label for="identifier">ç”¨æˆ·å/é‚®ç®±/æ‰‹æœºå·</label>
                    <div class="error-message" style="display: none; color: #dc3545; font-size: 0.875rem; margin-top: 0.25rem;"></div>
                </div>

                <div class="form-floating mb-3">
                    <input type="password" class="form-control" id="password" placeholder="å¯†ç " required>
                    <label for="password">å¯†ç </label>
                    <div class="error-message" style="display: none; color: #dc3545; font-size: 0.875rem; margin-top: 0.25rem;"></div>
                </div>

                <div class="row mb-3">
                    <div class="col-auto">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="rememberMe">
                            <label class="form-check-label" for="rememberMe">
                                è®°ä½æˆ‘
                            </label>
                        </div>
                    </div>
                    <div class="col-auto">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="showPassword">
                            <label class="form-check-label" for="showPassword">
                                æ˜¾ç¤ºå¯†ç 
                            </label>
                        </div>
                    </div>
                </div>

                <div class="d-grid">
                    <button type="submit" id="loginSubmit" class="btn btn-primary btn-login btn-lg">
                        <i class="fas fa-sign-in-alt me-2"></i>
                        ç™»å½•
                    </button>
                </div>
            </form>

            <!-- ç¤¾äº¤ç™»å½•åˆ†å‰²çº¿ -->
            <!-- å·²åˆ é™¤ç¤¾äº¤ç™»å½•ï¼Œä»…æ”¯æŒè´¦å·å¯†ç ç™»å½• -->

            <!-- å¿˜è®°å¯†ç å’Œæ³¨å†Œé“¾æ¥ -->
            <div class="d-flex justify-content-between mt-3">
                <a href="#" id="forgotPasswordLink" class="text-decoration-none">å¿˜è®°å¯†ç ï¼Ÿ</a>
                <a href="#" id="registerLink" class="text-decoration-none">è¿˜æ²¡æœ‰è´¦æˆ·ï¼Ÿæ³¨å†Œ</a>
            </div>

            <!-- åç«¯è¿æ¥çŠ¶æ€åŒºåŸŸ -->
            <div id="connectionStatusArea"></div>

        </div>
    </div>

    <!-- Toast æç¤ºå®¹å™¨ -->
    <div id="toastContainer" class="toast-container position-fixed top-0 end-0 p-3"></div>

    <!-- Bootstrap JS -->
    <script src="./vendor/bootstrap/bootstrap.bundle.min.js?v=5.3.0"></script>
    
    <!-- æ–°çš„æ¨¡å—åŒ–æ¶æ„ -->
    <!-- é…ç½®ç³»ç»Ÿ -->
    <script type="module" src="config/env.js?v=2.0.1"></script>
    <script type="module" src="config/global-config.js?v=2.0.1"></script>
    
    <!-- APIå±‚ -->
    <script type="module" src="js/api/endpoints.js?v=2.0.0"></script>
    <script type="module" src="js/api/api-client.js?v=2.0.0"></script>
    <script type="module" src="js/api/dify-api.js?v=2.0.0"></script>
    
    <!-- å·¥å…·ç±» -->
    <script type="module" src="js/utils/validation.js?v=2.0.0"></script>
    <script type="module" src="js/utils/storage.js?v=2.0.0"></script>
    <script type="module" src="js/utils/error-handler.js?v=2.0.0"></script>
    <script type="module" src="js/utils/loading.js?v=2.0.0"></script>
    
    <!-- æœåŠ¡å±‚ -->
    <script type="module" src="js/services/auth-service.js?v=2.0.0"></script>
    
    <!-- é¡µé¢æ§åˆ¶å™¨ -->
        <!-- JavaScript æ¨¡å—å¯¼å…¥ -->
    <script type="module">
        console.log('ğŸš€ æ­£åœ¨åˆå§‹åŒ–DifyChat v2.0æ¨¡å—åŒ–ç™»å½•ç³»ç»Ÿ...');
        
        // å¼€å‘ç¯å¢ƒå®‰å…¨æç¤º
        if (window.location.protocol === 'http:' && window.location.hostname !== 'localhost' && window.location.hostname !== '127.0.0.1') {
            console.warn('ğŸ”’ å®‰å…¨æé†’: å½“å‰ä½¿ç”¨HTTPåè®®ï¼Œåœ¨ç”Ÿäº§ç¯å¢ƒä¸­è¯·ä½¿ç”¨HTTPSæ¥ä¿æŠ¤ç”¨æˆ·æ•°æ®å®‰å…¨');
            
            // æ˜¾ç¤ºå®‰å…¨æé†’æ¨ªå¹…
            const securityBanner = document.createElement('div');
            securityBanner.innerHTML = `
                <div class="alert alert-warning alert-dismissible fade show position-fixed w-100" style="top: 0; z-index: 9999;" role="alert">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>å®‰å…¨æé†’:</strong> å½“å‰è¿æ¥æœªåŠ å¯†ã€‚åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œè¯·ä½¿ç”¨HTTPSåè®®æ¥ä¿æŠ¤æ‚¨çš„ç™»å½•ä¿¡æ¯ã€‚
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            document.body.appendChild(securityBanner);
        }
        
        try {
            // åŠ¨æ€å¯¼å…¥æ¨¡å— - æ­£ç¡®çš„åŠ è½½é¡ºåº
            const [
                envConfig,
                { AuthService },
                { FormValidator },
                { ErrorHandler },
                { LoadingManager }
            ] = await Promise.all([
                import('./config/env.js'),
                import('./js/services/auth-service.js'),
                import('./js/utils/validation.js'),
                import('./js/utils/error-handler.js'),
                import('./js/utils/loading.js')
            ]);

            console.log('âœ… æ‰€æœ‰æ¨¡å—åŠ è½½æˆåŠŸ');

            // åˆå§‹åŒ–æœåŠ¡
            const authService = new AuthService();
            const formValidator = new FormValidator();
            const errorHandler = new ErrorHandler();
            const loadingManager = new LoadingManager();

            // ç°ä»£åŒ–ç™»å½•æ§åˆ¶å™¨
            class ModernLoginController {
                constructor() {
                    this.authService = authService;
                    this.formValidator = formValidator;
                    this.errorHandler = errorHandler;
                    this.loadingManager = loadingManager;
                    
                    this.form = document.getElementById('loginForm');
                    this.identifierField = document.getElementById('identifier');
                    this.passwordField = document.getElementById('password');
                    this.submitBtn = document.getElementById('loginSubmit');
                    this.rememberMeCheckbox = document.getElementById('rememberMe');
                    
                    this.init();
                }

                init() {
                    console.log('ğŸ”§ åˆå§‹åŒ–ç°ä»£åŒ–ç™»å½•æ§åˆ¶å™¨...');
                    
                    // æ£€æŸ¥å·²ç™»å½•çŠ¶æ€
                    this.checkExistingAuth();
                    
                    // è®¾ç½®è¡¨å•éªŒè¯
                    this.setupFormValidation();
                    
                    // ç»‘å®šè¡¨å•æäº¤
                    this.form.addEventListener('submit', this.handleSubmit.bind(this));
                    
                    // ç»‘å®šå…¶ä»–äº‹ä»¶
                    this.bindEvents();
                    
                    console.log('âœ… ç™»å½•æ§åˆ¶å™¨åˆå§‹åŒ–å®Œæˆ');
                }

                async checkExistingAuth() {
                    const urlParams = new URLSearchParams(window.location.search);
                    
                    // å¤„ç†é€€å‡ºç™»å½•
                    if (urlParams.get('logout') === 'true') {
                        console.log('ğŸšª å¤„ç†é€€å‡ºç™»å½•...');
                        await this.authService.logout();
                        window.history.replaceState({}, document.title, window.location.pathname);
                        this.errorHandler.showSuccess('å·²æˆåŠŸé€€å‡ºç™»å½•');
                        return;
                    }

                    // æ£€æŸ¥ç°æœ‰è®¤è¯
                    if (await this.authService.isAuthenticated()) {
                        console.log('ğŸ” æ£€æµ‹åˆ°æœ‰æ•ˆè®¤è¯ï¼Œå‡†å¤‡è·³è½¬...');
                        this.errorHandler.showInfo('æ‚¨å·²ç™»å½•ï¼Œæ­£åœ¨è·³è½¬...');
                        setTimeout(() => {
                            // æ£€æŸ¥æ˜¯å¦æœ‰é‡å®šå‘å‚æ•°
                            const urlParams = new URLSearchParams(window.location.search);
                            const redirectUrl = urlParams.get('redirect') || urlParams.get('return');
                            
                            if (redirectUrl) {
                                console.log('ğŸ”„ é‡å®šå‘åˆ°æŒ‡å®šé¡µé¢:', redirectUrl);
                                window.location.href = decodeURIComponent(redirectUrl);
                            } else {
                                window.location.href = './chat.html';
                            }
                        }, 1000);
                    }
                    
                    // æ£€æŸ¥åç«¯è¿æ¥
                    await this.checkBackendConnection();
                }

                async checkBackendConnection() {
                    try {
                        console.log('ğŸ” æ£€æŸ¥åç«¯è¿æ¥...');
                        console.log('ğŸ”§ ENV_CONFIGçŠ¶æ€:', window.ENV_CONFIG);
                        
                        const healthUrl = window.ENV_CONFIG?.getApiUrl('/health') || 'http://localhost:4005/api/health';
                        console.log('ğŸ“¡ å¥åº·æ£€æŸ¥åœ°å€:', healthUrl);
                        console.log('ğŸ” API_BASE_URL:', window.ENV_CONFIG?.API_BASE_URL);
                        console.log('ğŸ” getApiUrl():', window.ENV_CONFIG?.getApiUrl());
                        
                        // å°è¯•å¥åº·æ£€æŸ¥
                        const response = await fetch(healthUrl, {
                            method: 'GET',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            // ç§»é™¤timeoutï¼Œä½¿ç”¨æµè§ˆå™¨é»˜è®¤
                        });
                        
                        if (response.ok) {
                            const data = await response.json();
                            console.log('âœ… åç«¯è¿æ¥æˆåŠŸ:', data);
                            this.showConnectionStatus(true, `åç«¯æœåŠ¡è¿æ¥æ­£å¸¸ - ${data.service || 'DifyChat Backend'} ${data.version || 'v1.0.0'}`);
                        } else {
                            console.error('âŒ åç«¯å“åº”é”™è¯¯:', response.status, response.statusText);
                            this.showConnectionStatus(false, `åç«¯å“åº”é”™è¯¯: ${response.status} ${response.statusText}`);
                        }
                    } catch (error) {
                        console.error('âŒ åç«¯è¿æ¥å¤±è´¥:', error);
                        this.showConnectionStatus(false, `è¿æ¥å¤±è´¥: ${error.message}`);
                    }
                }
                
                showConnectionStatus(isConnected, message) {
                    // åœ¨æŒ‡å®šåŒºåŸŸæ˜¾ç¤ºçŠ¶æ€
                    const statusArea = document.getElementById('connectionStatusArea');
                    if (!statusArea) return;
                    
                    const baseUrl = window.ENV_CONFIG?.API_BASE_URL || 'http://localhost:4005';
                    const healthUrl = window.ENV_CONFIG?.getApiUrl('/health') || `${baseUrl}/api/health`;
                    const apiUrl = window.ENV_CONFIG?.getApiUrl() || `${baseUrl}/api`;
                    
                    if (isConnected) {
                        // è¿æ¥æˆåŠŸæ—¶æ˜¾ç¤ºç®€æ´çš„æˆåŠŸçŠ¶æ€
                        statusArea.innerHTML = `
                            <div class="alert alert-success alert-dismissible fade show mb-3">
                                <i class="fas fa-check-circle me-2"></i>
                                <strong>${message}</strong>
                                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                            </div>
                        `;
                    } else {
                        // è¿æ¥å¤±è´¥æ—¶æ˜¾ç¤ºè¯¦ç»†ä¿¡æ¯
                        statusArea.innerHTML = `
                            <div class="alert alert-warning alert-dismissible fade show mb-3">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                <strong>åç«¯çŠ¶æ€ï¼š</strong>${message}
                                <div class="mt-2 small">
                                    <strong>é…ç½®ä¿¡æ¯ï¼š</strong><br>
                                    æœåŠ¡åœ°å€: ${baseUrl}<br>
                                    APIåœ°å€: ${apiUrl}<br>
                                    å¥åº·æ£€æŸ¥: ${healthUrl}<br>
                                    <strong>è§£å†³æ–¹æ¡ˆï¼š</strong><br>
                                    1. ç¡®ä¿åç«¯æœåŠ¡åœ¨ ${baseUrl} è¿è¡Œ<br>
                                    2. æ£€æŸ¥é˜²ç«å¢™è®¾ç½®<br>
                                    3. éªŒè¯CORSé…ç½®<br>
                                    4. å°è¯•æ‰‹åŠ¨è®¿é—®: <a href="${healthUrl}" target="_blank">å¥åº·æ£€æŸ¥æ¥å£</a><br>
                                    5. å°è¯•è®¿é—®: <a href="${baseUrl}/api" target="_blank">APIæ–‡æ¡£</a>
                                </div>
                                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                            </div>
                        `;
                    }
                }

                setupFormValidation() {
                    // ä¸ºæ¯ä¸ªå­—æ®µè®¾ç½®å®æ—¶éªŒè¯
                    this.formValidator.setupRealTimeValidation(this.identifierField, 'username');
                    this.formValidator.setupRealTimeValidation(this.passwordField, 'password');
                    
                    // å¯†ç æ˜¾ç¤ºåˆ‡æ¢
                    const togglePassword = document.getElementById('togglePassword');
                    if (togglePassword) {
                        togglePassword.addEventListener('click', () => {
                            const type = this.passwordField.type === 'password' ? 'text' : 'password';
                            this.passwordField.type = type;
                            togglePassword.innerHTML = type === 'password' ? 
                                '<i class="fas fa-eye"></i>' : 
                                '<i class="fas fa-eye-slash"></i>';
                        });
                    }
                }

                bindEvents() {
                    // å¿˜è®°å¯†ç 
                    const forgotLink = document.getElementById('forgotPassword');
                    if (forgotLink) {
                        forgotLink.addEventListener('click', (e) => {
                            e.preventDefault();
                            this.errorHandler.showInfo('å¿˜è®°å¯†ç åŠŸèƒ½æ­£åœ¨å¼€å‘ä¸­...');
                        });
                    }

                    // æ³¨å†Œé“¾æ¥
                    const registerLink = document.querySelector('a[href*="register"]');
                    if (registerLink) {
                        registerLink.addEventListener('click', (e) => {
                            e.preventDefault();
                            this.errorHandler.showInfo('æ³¨å†ŒåŠŸèƒ½æ­£åœ¨å¼€å‘ä¸­...');
                        });
                    }
                }

                async handleSubmit(e) {
                    e.preventDefault();
                    
                    console.log('ğŸ“ å¤„ç†ç™»å½•è¡¨å•æäº¤...');
                    
                    // è·å–è¡¨å•æ•°æ®
                    const identifier = this.identifierField.value.trim();
                    const password = this.passwordField.value;
                    const rememberMe = this.rememberMeCheckbox.checked;
                    
                    // éªŒè¯è¡¨å•
                    const validationResult = this.formValidator.validateLoginForm({
                        identifier: identifier,
                        password: password
                    });
                    
                    if (!validationResult.isValid) {
                        console.log('è¡¨å•éªŒè¯å¤±è´¥:', validationResult.errors);
                        
                        // æ˜¾ç¤ºå…·ä½“çš„éªŒè¯é”™è¯¯
                        let errorMessage = 'è¡¨å•éªŒè¯å¤±è´¥ï¼š\n';
                        if (validationResult.errors.identifier) {
                            errorMessage += `â€¢ ç”¨æˆ·å/é‚®ç®±: ${validationResult.errors.identifier}\n`;
                        }
                        if (validationResult.errors.password) {
                            errorMessage += `â€¢ å¯†ç : ${validationResult.errors.password}\n`;
                        }
                        
                        this.errorHandler.showError(errorMessage);
                        return;
                    }

                    try {
                        console.log('ğŸ” æ‰§è¡Œç™»å½•...', { identifier, rememberMe });
                        
                        // æ‰§è¡Œç™»å½• - ä¼ é€’æ­£ç¡®çš„å‚æ•°æ ¼å¼
                        const formData = {
                            identifier: identifier,
                            password: password,
                            rememberMe: rememberMe
                        };
                        const result = await this.authService.login(formData, this.submitBtn);
                        
                        console.log('ğŸ” ç™»å½•ç»“æœ:', result);
                        
                        if (result.success) {
                            console.log('âœ… ç™»å½•æˆåŠŸ');
                            this.errorHandler.showSuccess('ç™»å½•æˆåŠŸï¼æ­£åœ¨è·³è½¬...');
                            
                            // å»¶è¿Ÿè·³è½¬ç¡®ä¿ç”¨æˆ·çœ‹åˆ°æˆåŠŸæç¤º
                            setTimeout(() => {
                                // æ£€æŸ¥æ˜¯å¦æœ‰é‡å®šå‘å‚æ•°
                                const urlParams = new URLSearchParams(window.location.search);
                                const redirectUrl = urlParams.get('redirect') || urlParams.get('return');
                                
                                if (redirectUrl) {
                                    console.log('ğŸ”„ é‡å®šå‘åˆ°æŒ‡å®šé¡µé¢:', redirectUrl);
                                    window.location.href = decodeURIComponent(redirectUrl);
                                } else {
                                    window.location.href = './chat.html';
                                }
                            }, 1500);
                        } else {
                            console.error('âŒ ç™»å½•å¤±è´¥:', result.message);
                            let errorMessage = result.message || 'ç™»å½•å¤±è´¥ï¼Œè¯·é‡è¯•';
                            
                            // æ ¹æ®é”™è¯¯ç±»å‹æä¾›æ›´æœ‰å¸®åŠ©çš„ä¿¡æ¯
                            if (result.message?.includes('ç½‘ç»œ') || result.message?.includes('è¿æ¥')) {
                                errorMessage += '\n\nè¯·æ£€æŸ¥ï¼š\n1. åç«¯æœåŠ¡æ˜¯å¦è¿è¡Œ\n2. ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸\n3. é˜²ç«å¢™è®¾ç½®';
                            } else if (result.message?.includes('ç”¨æˆ·å') || result.message?.includes('å¯†ç ') || result.message?.includes('credentials')) {
                                errorMessage = 'ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯ï¼Œè¯·æ£€æŸ¥åé‡è¯•';
                            }
                            
                            this.errorHandler.showError(errorMessage);
                        }
                        
                    } catch (error) {
                        console.error('ğŸ’¥ ç™»å½•å¼‚å¸¸:', error);
                        this.errorHandler.handleApiError(error);
                    }
                }
            }

            // åˆå§‹åŒ–ç™»å½•æ§åˆ¶å™¨
            const loginController = new ModernLoginController();
            
            // å…¨å±€å¯¼å‡ºä¾›è°ƒè¯•ä½¿ç”¨
            window.loginController = loginController;
            window.authService = authService;
            
            console.log('ğŸ‰ DifyChat v2.0 ç™»å½•ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆï¼');
            
        } catch (error) {
            console.error('âŒ æ¨¡å—åŠ è½½å¤±è´¥:', error);
            
            // é™çº§å¤„ç†ï¼šæ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
            const errorDiv = document.createElement('div');
            errorDiv.className = 'alert alert-danger mt-3';
            errorDiv.innerHTML = `
                <i class="fas fa-exclamation-triangle me-2"></i>
                <strong>ç³»ç»ŸåŠ è½½å¤±è´¥ï¼š</strong>${error.message}
                <div class="mt-2 small">
                    <strong>å¯èƒ½çš„åŸå› ï¼š</strong><br>
                    1. JavaScriptæ¨¡å—æœªæ­£ç¡®åŠ è½½<br>
                    2. æ–‡ä»¶è·¯å¾„é”™è¯¯<br>
                    3. æµè§ˆå™¨ä¸æ”¯æŒES6æ¨¡å—<br>
                    4. ç½‘ç»œè¿æ¥é—®é¢˜
                </div>
            `;
            
            const container = document.querySelector('.container-sm');
            if (container) {
                container.appendChild(errorDiv);
            }
        }
    </script>
    
    <!-- å‘åå…¼å®¹çš„å…¨å±€å˜é‡è®¾ç½® -->
    <script>
        // è®¾ç½®å…¨å±€å˜é‡ä¾›æ—§ä»£ç ä½¿ç”¨
        window.ENV_CONFIG = window.ENV_CONFIG || {};
        
        // é¡µé¢é”™è¯¯å¤„ç†
        window.addEventListener('error', (event) => {
            console.error('é¡µé¢é”™è¯¯:', event.error);
        });
        
        window.addEventListener('unhandledrejection', (event) => {
            console.error('æœªå¤„ç†çš„Promiseé”™è¯¯:', event.reason);
        });
    </script>
    <script>
        // åˆå§‹åŒ–æç¤ºä¿¡æ¯
        console.log('ğŸ”‘ DifyChatç™»å½•é¡µé¢ - v2.0 æ¶æ„');
        console.log('ğŸ“‚ ä½¿ç”¨æ¨¡å—åŒ–ES6æ¶æ„ï¼Œæ”¯æŒæœ€æ–°çš„è®¤è¯å’ŒéªŒè¯åŠŸèƒ½');
        
        // åŸºæœ¬çš„é¡µé¢åŠŸèƒ½ï¼ˆéæ¨¡å—åŒ–ï¼Œå‘åå…¼å®¹ï¼‰
        document.addEventListener('DOMContentLoaded', () => {
            console.log('âœ… ç™»å½•é¡µé¢DOMåŠ è½½å®Œæˆ');
            
            // åŸºç¡€çš„è¡¨å•ç¾åŒ–
            const inputs = document.querySelectorAll('.form-floating input');
            inputs.forEach(input => {
                input.addEventListener('focus', () => {
                    input.parentElement.classList.add('focused');
                });
                
                input.addEventListener('blur', () => {
                    if (!input.value) {
                        input.parentElement.classList.remove('focused');
                    }
                });
            });
            
            // é”™è¯¯çŠ¶æ€æ ·å¼
            const style = document.createElement('style');
            style.textContent = `
                .form-control.error {
                    border-color: #dc3545;
                    box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25);
                }
                
                .form-control.valid {
                    border-color: #28a745;
                    box-shadow: 0 0 0 0.2rem rgba(40, 167, 69, 0.25);
                }
                
                .error-message {
                    display: none;
                    color: #dc3545;
                    font-size: 0.875rem;
                    margin-top: 0.25rem;
                }
                
                .loading .loading-spinner {
                    display: inline-block;
                    width: 1rem;
                    height: 1rem;
                    border: 2px solid #f3f3f3;
                    border-top: 2px solid #007bff;
                    border-radius: 50%;
                    animation: spin 1s linear infinite;
                    margin-right: 0.5rem;
                }
                
                @keyframes spin {
                    0% { transform: rotate(0deg); }
                    100% { transform: rotate(360deg); }
                }
            `;
            document.head.appendChild(style);
            
            // é”®ç›˜å¿«æ·é”®æ”¯æŒ
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && e.ctrlKey) {
                    const form = document.getElementById('loginForm');
                    if (form) {
                        form.dispatchEvent(new Event('submit'));
                    }
                }
            });
        });
    </script>
</body>
</html>
