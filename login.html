<!DOCTYPE html>
<html lang="zh-CN" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta name="description" content="DifyChat - 用户登录">
    <meta name="keywords" cont    <!-- 工具层 -->
    <script type="module" src="js/utils/validation.js?v=2.0.0"></script>
    <script type="module" src="js/utils/storage.js?v=2.0.0"></script>
    <script type="module" src="js/utils/error-handler.js?v=2.0.0"></script>
    <script type="module" src="js/utils/loading.js?v=2.0.0"></script>
    
    <!-- 开发工具 -->
    <script src="js/utils/dev-tools.js?v=1.0.0"></script>
    <script src="js/utils/health-checker.js?v=1.0.0"></script>
    
    <!-- 服务层 -->
    <script type="module" src="js/services/auth-service.js?v=2.0.0"></script>天,智能对话,DifyChat,登录">
    <meta name="author" content="DifyChat Team">
    
    <!-- 安全配置 -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval' data: https: http:; connect-src 'self' http: https: ws: wss:;">
    
    <!-- Bootstrap 5.3 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Font Awesome 6.4 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- 自定义样式 -->
    <link rel="stylesheet" href="./assets/css/variables.css">
    <link rel="stylesheet" href="./assets/css/base.css">
    <link rel="stylesheet" href="./assets/css/components.css">
    <link rel="stylesheet" href="./assets/css/themes.css">
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="assets/images/favicon.svg">
    <link rel="icon" type="image/svg+xml" href="assets/images/favicon-16.svg" sizes="16x16">
    <link rel="alternate icon" href="assets/images/favicon.svg">
    <meta name="theme-color" content="#007bff">
    
    <title>登录 - DifyChat</title>
    
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }
        
        .login-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            padding: 0;
            overflow: hidden;
            max-width: 900px;
            width: 100%;
            margin: 20px;
        }
        
        .login-left {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            color: white;
            padding: 60px 40px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        
        .login-left::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="25" cy="25" r="1" fill="%23ffffff" opacity="0.1"/><circle cx="75" cy="75" r="1" fill="%23ffffff" opacity="0.1"/><circle cx="25" cy="75" r="1" fill="%23ffffff" opacity="0.05"/><circle cx="75" cy="25" r="1" fill="%23ffffff" opacity="0.05"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>');
            animation: float 20s infinite linear;
        }
        
        @keyframes float {
            0% { transform: translate(-50%, -50%) rotate(0deg); }
            100% { transform: translate(-50%, -50%) rotate(360deg); }
        }
        
        .login-logo {
            font-size: 4rem;
            margin-bottom: 20px;
            position: relative;
            z-index: 1;
        }
        
        .login-title {
            font-size: 2.7rem;
            font-weight: 800;
            margin-bottom: 15px;
            position: relative;
            z-index: 1;
            letter-spacing: 0.08em;
            background: linear-gradient(90deg, #5b9df9 0%, #2193b0 40%, #a770ef 80%, #fff 100%);
            background-clip: text;
            -webkit-background-clip: text;
            color: transparent;
            -webkit-text-fill-color: transparent;
            text-shadow:
                0 4px 16px rgba(91,157,249,0.28),
                0 12px 48px rgba(167,112,239,0.28),
                0 1px 0 #fff,
                0 0px 4px #2193b0,
                0 2px 8px #a770ef;
            font-family: 'Segoe UI', 'Arial Black', 'Arial', sans-serif;
        }
        
        .login-subtitle {
            font-size: 1.1rem;
            opacity: 1;
            line-height: 1.6;
            position: relative;
            z-index: 1;
            color: #f3f6ff; /* 协调的浅色，适合深色背景 */
            text-shadow: 0 1px 8px rgba(0,0,0,0.18); /* 增强可读性 */
        }
        
        .login-right {
            padding: 60px 40px;
        }
        
        .form-floating {
            margin-bottom: 20px;
        }
        
        .form-floating input {
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 1rem 0.75rem;
            transition: all 0.3s ease;
        }
        
        .form-floating input:focus {
            border-color: #007bff;
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
        }
        
        .form-floating label {
            color: #6c757d;
        }
        
        .btn-login {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            border: none;
            border-radius: 12px;
            padding: 12px 30px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .btn-login:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0, 123, 255, 0.3);
        }
        
        .btn-login::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }
        
        .btn-login:hover::before {
            left: 100%;
        }
        
        .divider {
            text-align: center;
            margin: 30px 0;
            position: relative;
        }
        
        .divider::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 1px;
            background: #dee2e6;
        }
        
        .divider span {
            background: white;
            padding: 0 20px;
            color: #6c757d;
            font-size: 14px;
        }
        
        .social-login {
            display: flex;
            gap: 15px;
            justify-content: center;
        }
        
        .btn-social {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: 2px solid #e9ecef;
            display: flex;
            align-items: center;
            justify-content: center;
            text-decoration: none;
            transition: all 0.3s ease;
            background: white;
        }
        
        .btn-social:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .btn-social.google {
            color: #db4437;
        }
        
        .btn-social.github {
            color: #333;
        }
        
        .btn-social.wechat {
            color: #09bb07;
        }
        
        .btn-social:hover.google {
            border-color: #db4437;
            background: #db4437;
            color: white;
        }
        
        .btn-social:hover.github {
            border-color: #333;
            background: #333;
            color: white;
        }
        
        .btn-social:hover.wechat {
            border-color: #09bb07;
            background: #09bb07;
            color: white;
        }
        
        .forgot-password {
            text-align: center;
            margin-top: 20px;
        }
        
        .forgot-password a {
            color: #007bff;
            text-decoration: none;
            font-weight: 500;
        }
        
        .forgot-password a:hover {
            text-decoration: underline;
        }
        
        .register-link {
            text-align: center;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #e9ecef;
        }
        
        .register-link a {
            color: #007bff;
            text-decoration: none;
            font-weight: 600;
        }
        
        .register-link a:hover {
            text-decoration: underline;
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        
        .loading-overlay.show {
            display: flex;
        }
        
        @media (max-width: 768px) {
            .login-container {
                margin: 10px;
            .login-logo {
                font-size: 3rem;
            }
        }
    </style>
</head>
<body>
    <!-- 加载遮罩 -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="text-center">
            <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status">
                <span class="visually-hidden">登录中...</span>
            </div>
            <p class="mt-3 text-muted">正在登录，请稍候...</p>
        </div>
    </div>

    <!-- 主登录容器 -->
    <div class="login-container row m-0">
        <!-- 左侧品牌区域 -->
        <div class="col-lg-6 login-left p-0">
            <div class="login-logo">
                <i class="fas fa-robot"></i>
            </div>
            <h1 class="login-title">DifyChat</h1>
            <p class="login-subtitle">
                您的智能对话伙伴<br>
                体验AI驱动的全新聊天方式<br>
                让每一次对话都充满智慧
            </p>
            <div class="mt-4">
                <div class="d-flex justify-content-center gap-4 mt-4">
                    <div class="text-center">
                        <div class="fs-4 mb-2">🤖</div>
                        <small>智能AI</small>
                    </div>
                    <div class="text-center">
                        <div class="fs-4 mb-2">🚀</div>
                        <small>快速响应</small>
                    </div>
                    <div class="text-center">
                        <div class="fs-4 mb-2">🔒</div>
                        <small>安全可靠</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- 右侧登录表单 -->
        <div class="col-lg-6 login-right">
            <div class="mb-4">
                <h2 class="h3 mb-3 fw-bold text-dark">欢迎回来</h2>
                <p class="text-muted">请登录您的账户以继续使用</p>
            </div>

            <!-- 登录表单 -->
            <form id="loginForm" novalidate>
                <div class="form-floating mb-3">
                    <input type="text" class="form-control" id="identifier" placeholder="用户名/邮箱/手机号" required>
                    <label for="identifier">用户名/邮箱/手机号</label>
                    <div class="error-message" style="display: none; color: #dc3545; font-size: 0.875rem; margin-top: 0.25rem;"></div>
                </div>

                <div class="form-floating mb-3">
                    <input type="password" class="form-control" id="password" placeholder="密码" required>
                    <label for="password">密码</label>
                    <div class="error-message" style="display: none; color: #dc3545; font-size: 0.875rem; margin-top: 0.25rem;"></div>
                </div>

                <div class="row mb-3">
                    <div class="col-auto">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="rememberMe">
                            <label class="form-check-label" for="rememberMe">
                                记住我
                            </label>
                        </div>
                    </div>
                    <div class="col-auto">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="showPassword">
                            <label class="form-check-label" for="showPassword">
                                显示密码
                            </label>
                        </div>
                    </div>
                </div>

                <div class="d-grid">
                    <button type="submit" id="loginSubmit" class="btn btn-primary btn-login btn-lg">
                        <i class="fas fa-sign-in-alt me-2"></i>
                        登录
                    </button>
                </div>
            </form>

            <!-- 社交登录分割线 -->
            <!-- 已删除社交登录，仅支持账号密码登录 -->

            <!-- 忘记密码和注册链接 -->
            <div class="d-flex justify-content-between mt-3">
                <a href="#" id="forgotPasswordLink" class="text-decoration-none">忘记密码？</a>
                <a href="#" id="registerLink" class="text-decoration-none">还没有账户？注册</a>
            </div>

            <!-- 后端连接状态区域 -->
            <div id="connectionStatusArea"></div>

        </div>
    </div>

    <!-- Toast 提示容器 -->
    <div id="toastContainer" class="toast-container position-fixed top-0 end-0 p-3"></div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- 新的模块化架构 -->
    <!-- 配置系统 -->
    <script type="module" src="config/env.js?v=2.0.0"></script>
    <script type="module" src="config/global-config.js?v=2.0.0"></script>
    
    <!-- API层 -->
    <script type="module" src="js/api/endpoints.js?v=2.0.0"></script>
    <script type="module" src="js/api/api-client.js?v=2.0.0"></script>
    <script type="module" src="js/api/dify-api.js?v=2.0.0"></script>
    
    <!-- 工具类 -->
    <script type="module" src="js/utils/validation.js?v=2.0.0"></script>
    <script type="module" src="js/utils/storage.js?v=2.0.0"></script>
    <script type="module" src="js/utils/error-handler.js?v=2.0.0"></script>
    <script type="module" src="js/utils/loading.js?v=2.0.0"></script>
    
    <!-- 服务层 -->
    <script type="module" src="js/services/auth-service.js?v=2.0.0"></script>
    
    <!-- 页面控制器 -->
        <!-- JavaScript 模块导入 -->
    <script type="module">
        console.log('🚀 正在初始化DifyChat v2.0模块化登录系统...');
        
        // 开发环境安全提示
        if (window.location.protocol === 'http:' && window.location.hostname !== 'localhost' && window.location.hostname !== '127.0.0.1') {
            console.warn('🔒 安全提醒: 当前使用HTTP协议，在生产环境中请使用HTTPS来保护用户数据安全');
            
            // 显示安全提醒横幅
            const securityBanner = document.createElement('div');
            securityBanner.innerHTML = `
                <div class="alert alert-warning alert-dismissible fade show position-fixed w-100" style="top: 0; z-index: 9999;" role="alert">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>安全提醒:</strong> 当前连接未加密。在生产环境中，请使用HTTPS协议来保护您的登录信息。
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            document.body.appendChild(securityBanner);
        }
        
        try {
            // 动态导入模块 - 正确的加载顺序
            const [
                envConfig,
                { AuthService },
                { FormValidator },
                { ErrorHandler },
                { LoadingManager }
            ] = await Promise.all([
                import('./config/env.js'),
                import('./js/services/auth-service.js'),
                import('./js/utils/validation.js'),
                import('./js/utils/error-handler.js'),
                import('./js/utils/loading.js')
            ]);

            console.log('✅ 所有模块加载成功');

            // 初始化服务
            const authService = new AuthService();
            const formValidator = new FormValidator();
            const errorHandler = new ErrorHandler();
            const loadingManager = new LoadingManager();

            // 现代化登录控制器
            class ModernLoginController {
                constructor() {
                    this.authService = authService;
                    this.formValidator = formValidator;
                    this.errorHandler = errorHandler;
                    this.loadingManager = loadingManager;
                    
                    this.form = document.getElementById('loginForm');
                    this.identifierField = document.getElementById('identifier');
                    this.passwordField = document.getElementById('password');
                    this.submitBtn = document.getElementById('loginSubmit');
                    this.rememberMeCheckbox = document.getElementById('rememberMe');
                    
                    this.init();
                }

                init() {
                    console.log('🔧 初始化现代化登录控制器...');
                    
                    // 检查已登录状态
                    this.checkExistingAuth();
                    
                    // 设置表单验证
                    this.setupFormValidation();
                    
                    // 绑定表单提交
                    this.form.addEventListener('submit', this.handleSubmit.bind(this));
                    
                    // 绑定其他事件
                    this.bindEvents();
                    
                    console.log('✅ 登录控制器初始化完成');
                }

                async checkExistingAuth() {
                    const urlParams = new URLSearchParams(window.location.search);
                    
                    // 处理退出登录
                    if (urlParams.get('logout') === 'true') {
                        console.log('🚪 处理退出登录...');
                        await this.authService.logout();
                        window.history.replaceState({}, document.title, window.location.pathname);
                        this.errorHandler.showSuccess('已成功退出登录');
                        return;
                    }

                    // 检查现有认证
                    if (await this.authService.isAuthenticated()) {
                        console.log('🔐 检测到有效认证，准备跳转...');
                        this.errorHandler.showInfo('您已登录，正在跳转...');
                        setTimeout(() => {
                            window.location.href = './chat.html';
                        }, 1000);
                    }
                    
                    // 检查后端连接
                    await this.checkBackendConnection();
                }

                async checkBackendConnection() {
                    try {
                        console.log('🔍 检查后端连接...');
                        const baseUrl = window.ENV_CONFIG?.API_BASE_URL || 'http://localhost:4005';
                        const healthUrl = `${baseUrl}/health`;
                        console.log('📡 健康检查地址:', healthUrl);
                        
                        // 尝试健康检查
                        const response = await fetch(healthUrl, {
                            method: 'GET',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            // 移除timeout，使用浏览器默认
                        });
                        
                        if (response.ok) {
                            const data = await response.json();
                            console.log('✅ 后端连接成功:', data);
                            this.showConnectionStatus(true, `后端服务连接正常 - ${data.service || 'DifyChat Backend'} ${data.version || 'v1.0.0'}`);
                        } else {
                            console.error('❌ 后端响应错误:', response.status, response.statusText);
                            this.showConnectionStatus(false, `后端响应错误: ${response.status} ${response.statusText}`);
                        }
                    } catch (error) {
                        console.error('❌ 后端连接失败:', error);
                        this.showConnectionStatus(false, `连接失败: ${error.message}`);
                    }
                }
                
                showConnectionStatus(isConnected, message) {
                    // 在指定区域显示状态
                    const statusArea = document.getElementById('connectionStatusArea');
                    if (!statusArea) return;
                    
                    const baseUrl = window.ENV_CONFIG?.API_BASE_URL || 'http://localhost:4005';
                    const healthUrl = `${baseUrl}/health`;
                    const apiUrl = window.ENV_CONFIG?.getApiUrl() || `${baseUrl}/api`;
                    
                    if (isConnected) {
                        // 连接成功时显示简洁的成功状态
                        statusArea.innerHTML = `
                            <div class="alert alert-success alert-dismissible fade show mb-3">
                                <i class="fas fa-check-circle me-2"></i>
                                <strong>${message}</strong>
                                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                            </div>
                        `;
                    } else {
                        // 连接失败时显示详细信息
                        statusArea.innerHTML = `
                            <div class="alert alert-warning alert-dismissible fade show mb-3">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                <strong>后端状态：</strong>${message}
                                <div class="mt-2 small">
                                    <strong>配置信息：</strong><br>
                                    服务地址: ${baseUrl}<br>
                                    API地址: ${apiUrl}<br>
                                    健康检查: ${healthUrl}<br>
                                    <strong>解决方案：</strong><br>
                                    1. 确保后端服务在 ${baseUrl} 运行<br>
                                    2. 检查防火墙设置<br>
                                    3. 验证CORS配置<br>
                                    4. 尝试手动访问: <a href="${healthUrl}" target="_blank">健康检查接口</a><br>
                                    5. 尝试访问: <a href="${baseUrl}/api" target="_blank">API文档</a>
                                </div>
                                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                            </div>
                        `;
                    }
                }

                setupFormValidation() {
                    // 为每个字段设置实时验证
                    this.formValidator.setupRealTimeValidation(this.identifierField, 'username');
                    this.formValidator.setupRealTimeValidation(this.passwordField, 'password');
                    
                    // 密码显示切换
                    const togglePassword = document.getElementById('togglePassword');
                    if (togglePassword) {
                        togglePassword.addEventListener('click', () => {
                            const type = this.passwordField.type === 'password' ? 'text' : 'password';
                            this.passwordField.type = type;
                            togglePassword.innerHTML = type === 'password' ? 
                                '<i class="fas fa-eye"></i>' : 
                                '<i class="fas fa-eye-slash"></i>';
                        });
                    }
                }

                bindEvents() {
                    // 忘记密码
                    const forgotLink = document.getElementById('forgotPassword');
                    if (forgotLink) {
                        forgotLink.addEventListener('click', (e) => {
                            e.preventDefault();
                            this.errorHandler.showInfo('忘记密码功能正在开发中...');
                        });
                    }

                    // 注册链接
                    const registerLink = document.querySelector('a[href*="register"]');
                    if (registerLink) {
                        registerLink.addEventListener('click', (e) => {
                            e.preventDefault();
                            this.errorHandler.showInfo('注册功能正在开发中...');
                        });
                    }
                }

                async handleSubmit(e) {
                    e.preventDefault();
                    
                    console.log('📝 处理登录表单提交...');
                    
                    // 获取表单数据
                    const identifier = this.identifierField.value.trim();
                    const password = this.passwordField.value;
                    const rememberMe = this.rememberMeCheckbox.checked;
                    
                    // 验证表单
                    const validationResult = this.formValidator.validateLoginForm({
                        identifier: identifier,
                        password: password
                    });
                    
                    if (!validationResult.isValid) {
                        console.log('表单验证失败:', validationResult.errors);
                        
                        // 显示具体的验证错误
                        let errorMessage = '表单验证失败：\n';
                        if (validationResult.errors.identifier) {
                            errorMessage += `• 用户名/邮箱: ${validationResult.errors.identifier}\n`;
                        }
                        if (validationResult.errors.password) {
                            errorMessage += `• 密码: ${validationResult.errors.password}\n`;
                        }
                        
                        this.errorHandler.showError(errorMessage);
                        return;
                    }

                    try {
                        console.log('🔐 执行登录...', { identifier, rememberMe });
                        
                        // 执行登录 - 传递正确的参数格式
                        const formData = {
                            identifier: identifier,
                            password: password,
                            rememberMe: rememberMe
                        };
                        const result = await this.authService.login(formData, this.submitBtn);
                        
                        console.log('🔐 登录结果:', result);
                        
                        if (result.success) {
                            console.log('✅ 登录成功');
                            this.errorHandler.showSuccess('登录成功！正在跳转...');
                            
                            // 延迟跳转确保用户看到成功提示
                            setTimeout(() => {
                                window.location.href = './chat.html';
                            }, 1500);
                        } else {
                            console.error('❌ 登录失败:', result.message);
                            let errorMessage = result.message || '登录失败，请重试';
                            
                            // 根据错误类型提供更有帮助的信息
                            if (result.message?.includes('网络') || result.message?.includes('连接')) {
                                errorMessage += '\n\n请检查：\n1. 后端服务是否运行\n2. 网络连接是否正常\n3. 防火墙设置';
                            } else if (result.message?.includes('用户名') || result.message?.includes('密码') || result.message?.includes('credentials')) {
                                errorMessage = '用户名或密码错误，请检查后重试';
                            }
                            
                            this.errorHandler.showError(errorMessage);
                        }
                        
                    } catch (error) {
                        console.error('💥 登录异常:', error);
                        this.errorHandler.handleApiError(error);
                    }
                }
            }

            // 初始化登录控制器
            const loginController = new ModernLoginController();
            
            // 全局导出供调试使用
            window.loginController = loginController;
            window.authService = authService;
            
            console.log('🎉 DifyChat v2.0 登录系统初始化完成！');
            
        } catch (error) {
            console.error('❌ 模块加载失败:', error);
            
            // 降级处理：显示错误信息
            const errorDiv = document.createElement('div');
            errorDiv.className = 'alert alert-danger mt-3';
            errorDiv.innerHTML = `
                <i class="fas fa-exclamation-triangle me-2"></i>
                <strong>系统加载失败：</strong>${error.message}
                <div class="mt-2 small">
                    <strong>可能的原因：</strong><br>
                    1. JavaScript模块未正确加载<br>
                    2. 文件路径错误<br>
                    3. 浏览器不支持ES6模块<br>
                    4. 网络连接问题
                </div>
            `;
            
            const container = document.querySelector('.container-sm');
            if (container) {
                container.appendChild(errorDiv);
            }
        }
    </script>
    
    <!-- 向后兼容的全局变量设置 -->
    <script>
        // 设置全局变量供旧代码使用
        window.ENV_CONFIG = window.ENV_CONFIG || {};
        
        // 页面错误处理
        window.addEventListener('error', (event) => {
            console.error('页面错误:', event.error);
        });
        
        window.addEventListener('unhandledrejection', (event) => {
            console.error('未处理的Promise错误:', event.reason);
        });
    </script>
    <script>
        // 初始化提示信息
        console.log('🔑 DifyChat登录页面 - v2.0 架构');
        console.log('📂 使用模块化ES6架构，支持最新的认证和验证功能');
        
        // 基本的页面功能（非模块化，向后兼容）
        document.addEventListener('DOMContentLoaded', () => {
            console.log('✅ 登录页面DOM加载完成');
            
            // 基础的表单美化
            const inputs = document.querySelectorAll('.form-floating input');
            inputs.forEach(input => {
                input.addEventListener('focus', () => {
                    input.parentElement.classList.add('focused');
                });
                
                input.addEventListener('blur', () => {
                    if (!input.value) {
                        input.parentElement.classList.remove('focused');
                    }
                });
            });
            
            // 错误状态样式
            const style = document.createElement('style');
            style.textContent = `
                .form-control.error {
                    border-color: #dc3545;
                    box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25);
                }
                
                .form-control.valid {
                    border-color: #28a745;
                    box-shadow: 0 0 0 0.2rem rgba(40, 167, 69, 0.25);
                }
                
                .error-message {
                    display: none;
                    color: #dc3545;
                    font-size: 0.875rem;
                    margin-top: 0.25rem;
                }
                
                .loading .loading-spinner {
                    display: inline-block;
                    width: 1rem;
                    height: 1rem;
                    border: 2px solid #f3f3f3;
                    border-top: 2px solid #007bff;
                    border-radius: 50%;
                    animation: spin 1s linear infinite;
                    margin-right: 0.5rem;
                }
                
                @keyframes spin {
                    0% { transform: rotate(0deg); }
                    100% { transform: rotate(360deg); }
                }
            `;
            document.head.appendChild(style);
            
            // 键盘快捷键支持
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && e.ctrlKey) {
                    const form = document.getElementById('loginForm');
                    if (form) {
                        form.dispatchEvent(new Event('submit'));
                    }
                }
            });
        });
    </script>
</body>
</html>
